

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>LMRt.utils &mdash; LMRt  documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home"> LMRt
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../utils.html">Utilities</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">LMRt</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../index.html">Module code</a> &raquo;</li>
        
      <li>LMRt.utils</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for LMRt.utils</h1><div class="highlight"><pre>
<span></span><span class="sd">&#39;&#39;&#39; The utility library</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="k">import</span> <span class="n">namedtuple</span>
<span class="kn">import</span> <span class="nn">xarray</span> <span class="k">as</span> <span class="nn">xr</span>
<span class="kn">import</span> <span class="nn">netCDF4</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="k">import</span> <span class="n">datetime</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="k">import</span> <span class="n">timedelta</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">from</span> <span class="nn">spharm</span> <span class="k">import</span> <span class="n">Spharmt</span><span class="p">,</span> <span class="n">regrid</span>
<span class="kn">import</span> <span class="nn">prysm</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">from</span> <span class="nn">tqdm</span> <span class="k">import</span> <span class="n">tqdm</span>
<span class="kn">import</span> <span class="nn">pickle</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="k">import</span> <span class="n">signal</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="k">import</span> <span class="n">optimize</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="k">import</span> <span class="n">stats</span>
<span class="kn">import</span> <span class="nn">statsmodels.api</span> <span class="k">as</span> <span class="nn">sm</span>
<span class="kn">import</span> <span class="nn">statsmodels.formula.api</span> <span class="k">as</span> <span class="nn">smf</span>
<span class="kn">import</span> <span class="nn">glob</span>
<span class="kn">from</span> <span class="nn">scipy.stats.mstats</span> <span class="k">import</span> <span class="n">mquantiles</span>
<span class="kn">from</span> <span class="nn">scipy.stats.mstats</span> <span class="k">import</span> <span class="n">gmean</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="k">import</span> <span class="n">spatial</span>
<span class="kn">from</span> <span class="nn">scipy.special</span> <span class="k">import</span> <span class="n">factorial</span>
<span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="k">import</span> <span class="n">gaussian_kde</span>
<span class="kn">import</span> <span class="nn">cftime</span>
<span class="kn">from</span> <span class="nn">pprint</span> <span class="k">import</span> <span class="n">pprint</span>
<span class="kn">from</span> <span class="nn">time</span> <span class="k">import</span> <span class="n">time</span> <span class="k">as</span> <span class="n">ttime</span>
<span class="kn">from</span> <span class="nn">IPython</span> <span class="k">import</span> <span class="n">embed</span>
<span class="kn">from</span> <span class="nn">pathos.multiprocessing</span> <span class="k">import</span> <span class="n">ProcessingPool</span> <span class="k">as</span> <span class="n">Pool</span>
<span class="kn">import</span> <span class="nn">itertools</span>
<span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="k">import</span> <span class="n">pearsonr</span>
<span class="kn">from</span> <span class="nn">sklearn</span> <span class="k">import</span> <span class="n">preprocessing</span>
<span class="kn">import</span> <span class="nn">nitime.algorithms</span> <span class="k">as</span> <span class="nn">tsa</span>

<span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">load_gridded_data</span>  <span class="c1"># original file from LMR</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">nn</span>

<span class="kn">import</span> <span class="nn">warnings</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="n">action</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">,</span> <span class="n">module</span><span class="o">=</span><span class="s1">&#39;pandas&#39;</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="ne">FutureWarning</span><span class="p">)</span>

<span class="n">Proxy</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span>
    <span class="s1">&#39;Proxy&#39;</span><span class="p">,</span>
    <span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;type&#39;</span><span class="p">,</span> <span class="s1">&#39;start_yr&#39;</span><span class="p">,</span> <span class="s1">&#39;end_yr&#39;</span><span class="p">,</span> <span class="s1">&#39;lat&#39;</span><span class="p">,</span> <span class="s1">&#39;lon&#39;</span><span class="p">,</span> <span class="s1">&#39;elev&#39;</span><span class="p">,</span> <span class="s1">&#39;seasonality&#39;</span><span class="p">,</span> <span class="s1">&#39;values&#39;</span><span class="p">,</span> <span class="s1">&#39;time&#39;</span><span class="p">,</span> <span class="s1">&#39;psm_obj&#39;</span><span class="p">]</span>
<span class="p">)</span>

<span class="n">PSM</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span><span class="s1">&#39;PSM&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;psm_key&#39;</span><span class="p">,</span> <span class="s1">&#39;R&#39;</span><span class="p">,</span> <span class="s1">&#39;SNR&#39;</span><span class="p">])</span>

<span class="n">Grid</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span><span class="s1">&#39;Grid&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;lat&#39;</span><span class="p">,</span> <span class="s1">&#39;lon&#39;</span><span class="p">,</span> <span class="s1">&#39;nlat&#39;</span><span class="p">,</span> <span class="s1">&#39;nlon&#39;</span><span class="p">,</span> <span class="s1">&#39;nens&#39;</span><span class="p">])</span>


<span class="k">def</span> <span class="nf">setup_cfg</span><span class="p">(</span><span class="n">cfg</span><span class="p">):</span>
    <span class="n">proxy_db_cfg</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;LMRdb&#39;</span><span class="p">:</span> <span class="n">cfg</span><span class="o">.</span><span class="n">proxies</span><span class="o">.</span><span class="n">LMRdb</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="k">for</span> <span class="n">db_name</span><span class="p">,</span> <span class="n">db_cfg</span> <span class="ow">in</span> <span class="n">proxy_db_cfg</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">db_cfg</span><span class="o">.</span><span class="n">proxy_type_mapping</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">ptype</span><span class="p">,</span> <span class="n">measurements</span> <span class="ow">in</span> <span class="n">db_cfg</span><span class="o">.</span><span class="n">proxy_assim2</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="c1"># Fetch proxy type name that occurs before underscore</span>
            <span class="n">type_name</span> <span class="o">=</span> <span class="n">ptype</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">measure</span> <span class="ow">in</span> <span class="n">measurements</span><span class="p">:</span>
                <span class="n">db_cfg</span><span class="o">.</span><span class="n">proxy_type_mapping</span><span class="p">[(</span><span class="n">type_name</span><span class="p">,</span> <span class="n">measure</span><span class="p">)]</span> <span class="o">=</span> <span class="n">ptype</span>

    <span class="k">return</span> <span class="n">cfg</span>


<span class="k">def</span> <span class="nf">get_prior</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="n">datatype</span><span class="p">,</span> <span class="n">cfg</span><span class="p">,</span> <span class="n">anom_reference_period</span><span class="o">=</span><span class="p">(</span><span class="mi">1951</span><span class="p">,</span> <span class="mi">1980</span><span class="p">),</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">avgInterval</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">read_func</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;CMIP5&#39;</span><span class="p">:</span> <span class="n">load_gridded_data</span><span class="o">.</span><span class="n">read_gridded_data_CMIP5_model</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="n">prior_datadir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>
    <span class="n">prior_datafile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">prior</span><span class="o">.</span><span class="n">state_variables</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="n">statevars</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">prior</span><span class="o">.</span><span class="n">state_variables</span><span class="o">.</span><span class="n">toDict</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">statevars</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">prior</span><span class="o">.</span><span class="n">state_variables</span>
    <span class="n">statevars_info</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">prior</span><span class="o">.</span><span class="n">state_variables_info</span><span class="o">.</span><span class="n">toDict</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">avgInterval</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">cfg</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">recon_timescale</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">avgInterval</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;annual&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">12</span><span class="p">]}</span>
        <span class="k">elif</span> <span class="n">cfg</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">recon_timescale</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">avgInterval</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;multiyear&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">cfg</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">recon_timescale</span><span class="p">]}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;ERROR in config.: unrecognized job.cfg.core.recon_timescale!&#39;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">SystemExit</span><span class="p">()</span>

    <span class="n">detrend</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">prior</span><span class="o">.</span><span class="n">detrend</span>

    <span class="n">datadict</span> <span class="o">=</span> <span class="n">read_func</span><span class="p">[</span><span class="n">datatype</span><span class="p">](</span>
        <span class="n">prior_datadir</span><span class="p">,</span> <span class="n">prior_datafile</span><span class="p">,</span> <span class="n">statevars</span><span class="p">,</span> <span class="n">avgInterval</span><span class="p">,</span>
        <span class="n">detrend</span><span class="o">=</span><span class="n">detrend</span><span class="p">,</span> <span class="n">anom_ref</span><span class="o">=</span><span class="n">anom_reference_period</span><span class="p">,</span>
        <span class="n">var_info</span><span class="o">=</span><span class="n">statevars_info</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">datadict</span>


<span class="k">def</span> <span class="nf">populate_ensemble</span><span class="p">(</span><span class="n">datadict</span><span class="p">,</span> <span class="n">cfg</span><span class="p">,</span> <span class="n">seed</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; Populate the prior ensemble from gridded model/analysis data</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">state_vect_info</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">Nx</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">timedim</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">datadict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">vartype</span> <span class="o">=</span> <span class="n">datadict</span><span class="p">[</span><span class="n">var</span><span class="p">][</span><span class="s1">&#39;vartype&#39;</span><span class="p">]</span>
        <span class="n">dct</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">timedim</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">datadict</span><span class="p">[</span><span class="n">var</span><span class="p">][</span><span class="s1">&#39;years&#39;</span><span class="p">]))</span>
        <span class="n">spacecoords</span> <span class="o">=</span> <span class="n">datadict</span><span class="p">[</span><span class="n">var</span><span class="p">][</span><span class="s1">&#39;spacecoords&#39;</span><span class="p">]</span>
        <span class="n">dim1</span><span class="p">,</span> <span class="n">dim2</span> <span class="o">=</span> <span class="n">spacecoords</span>
        <span class="n">ndim1</span><span class="p">,</span> <span class="n">ndim2</span> <span class="o">=</span> <span class="n">datadict</span><span class="p">[</span><span class="n">var</span><span class="p">][</span><span class="n">dim1</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span>
        <span class="n">ndimtot</span> <span class="o">=</span> <span class="n">ndim1</span><span class="o">*</span><span class="n">ndim2</span>
        <span class="n">dct</span><span class="p">[</span><span class="s1">&#39;pos&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">Nx</span><span class="p">,</span> <span class="n">Nx</span><span class="o">+</span><span class="n">ndimtot</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">dct</span><span class="p">[</span><span class="s1">&#39;spacecoords&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">spacecoords</span>
        <span class="n">dct</span><span class="p">[</span><span class="s1">&#39;spacedims&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">ndim1</span><span class="p">,</span> <span class="n">ndim2</span><span class="p">)</span>
        <span class="n">dct</span><span class="p">[</span><span class="s1">&#39;vartype&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">vartype</span>
        <span class="n">state_vect_info</span><span class="p">[</span><span class="n">var</span><span class="p">]</span> <span class="o">=</span> <span class="n">dct</span>
        <span class="n">Nx</span> <span class="o">+=</span> <span class="n">ndimtot</span>

    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;State vector information:&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">state_vect_info</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">x</span> <span class="o">==</span> <span class="n">timedim</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">timedim</span><span class="p">):</span>
        <span class="n">ntime</span> <span class="o">=</span> <span class="n">timedim</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">SystemExit</span><span class="p">(</span><span class="s1">&#39;ERROR im populate_ensemble: time dimension not consistent across all state variables. Exiting!&#39;</span><span class="p">)</span>

    <span class="n">Xb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">Nx</span><span class="p">,</span> <span class="n">cfg</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">nens</span><span class="p">))</span>

    <span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
    <span class="n">ind_ens</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">ntime</span><span class="p">)),</span> <span class="n">cfg</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">nens</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;shape of Xb: (</span><span class="si">{Nx}</span><span class="s1"> x </span><span class="si">{cfg.core.nens}</span><span class="s1">)&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;seed=&#39;</span><span class="p">,</span> <span class="n">seed</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;sampled inds=&#39;</span><span class="p">,</span> <span class="n">ind_ens</span><span class="p">)</span>

    <span class="n">Xb_coords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">Nx</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
    <span class="n">Xb_coords</span><span class="p">[:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

    <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">datadict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">vartype</span> <span class="o">=</span> <span class="n">datadict</span><span class="p">[</span><span class="n">var</span><span class="p">][</span><span class="s1">&#39;vartype&#39;</span><span class="p">]</span>
        <span class="n">indstart</span> <span class="o">=</span> <span class="n">state_vect_info</span><span class="p">[</span><span class="n">var</span><span class="p">][</span><span class="s1">&#39;pos&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">indend</span> <span class="o">=</span> <span class="n">state_vect_info</span><span class="p">[</span><span class="n">var</span><span class="p">][</span><span class="s1">&#39;pos&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">nens</span><span class="p">):</span>
            <span class="n">Xb</span><span class="p">[</span><span class="n">indstart</span><span class="p">:</span><span class="n">indend</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">datadict</span><span class="p">[</span><span class="n">var</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">][</span><span class="n">ind_ens</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="p">:,</span> <span class="p">:]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>

        <span class="n">coordname1</span><span class="p">,</span> <span class="n">coordname2</span> <span class="o">=</span> <span class="n">state_vect_info</span><span class="p">[</span><span class="n">var</span><span class="p">][</span><span class="s1">&#39;spacecoords&#39;</span><span class="p">]</span>
        <span class="n">coord1</span><span class="p">,</span> <span class="n">coord2</span> <span class="o">=</span> <span class="n">datadict</span><span class="p">[</span><span class="n">var</span><span class="p">][</span><span class="n">coordname1</span><span class="p">],</span> <span class="n">datadict</span><span class="p">[</span><span class="n">var</span><span class="p">][</span><span class="n">coordname2</span><span class="p">]</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">coord1</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">coord2</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">ndim1</span> <span class="o">=</span> <span class="n">coord1</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">ndim2</span> <span class="o">=</span> <span class="n">coord2</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">X_coord1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">coord1</span><span class="p">,</span> <span class="p">]</span><span class="o">*</span><span class="n">ndim2</span><span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span>
            <span class="n">X_coord2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">coord2</span><span class="p">,</span> <span class="p">]</span><span class="o">*</span><span class="n">ndim1</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">coord1</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">coord2</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">ndim1</span><span class="p">,</span> <span class="n">ndim2</span> <span class="o">=</span> <span class="n">coord1</span><span class="o">.</span><span class="n">shape</span>
            <span class="n">X_coord1</span> <span class="o">=</span> <span class="n">coord1</span>
            <span class="n">X_coord2</span> <span class="o">=</span> <span class="n">coord2</span>

        <span class="n">Xb_coords</span><span class="p">[</span><span class="n">indstart</span><span class="p">:</span><span class="n">indend</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">X_coord1</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
        <span class="n">Xb_coords</span><span class="p">[</span><span class="n">indstart</span><span class="p">:</span><span class="n">indend</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">X_coord2</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">Xb</span><span class="p">)):</span>
            <span class="c1"># Returning state vector Xb as masked array</span>
            <span class="n">Xb_res</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_invalid</span><span class="p">(</span><span class="n">Xb</span><span class="p">)</span>
            <span class="c1"># Set fill_value to np.nan</span>
            <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">set_fill_value</span><span class="p">(</span><span class="n">Xb_res</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">Xb_res</span> <span class="o">=</span> <span class="n">Xb</span>

    <span class="k">return</span> <span class="n">Xb_res</span><span class="p">,</span> <span class="n">ind_ens</span><span class="p">,</span> <span class="n">Xb_coords</span><span class="p">,</span> <span class="n">state_vect_info</span>


<span class="k">def</span> <span class="nf">regrid_prior</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="n">nens</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">nens</span>
    <span class="n">regrid_method</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">prior</span><span class="o">.</span><span class="n">regrid_method</span>
    <span class="n">regrid_resolution</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">prior</span><span class="o">.</span><span class="n">regrid_resolution</span>

    <span class="n">regrid_func</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;spherical_harmonics&#39;</span><span class="p">:</span> <span class="n">regrid_sphere</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="n">new_state_info</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">Nx</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">full_state_info</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
        <span class="n">dct</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="n">dct</span><span class="p">[</span><span class="s1">&#39;vartype&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">full_state_info</span><span class="p">[</span><span class="n">var</span><span class="p">][</span><span class="s1">&#39;vartype&#39;</span><span class="p">]</span>

        <span class="c1"># variable indices in full state vector</span>
        <span class="n">ibeg_full</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">full_state_info</span><span class="p">[</span><span class="n">var</span><span class="p">][</span><span class="s1">&#39;pos&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">iend_full</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">full_state_info</span><span class="p">[</span><span class="n">var</span><span class="p">][</span><span class="s1">&#39;pos&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
        <span class="c1"># extract array corresponding to state variable &quot;var&quot;</span>
        <span class="n">var_array_full</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">ens</span><span class="p">[</span><span class="n">ibeg_full</span><span class="p">:</span><span class="n">iend_full</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span>
        <span class="c1"># corresponding spatial coordinates</span>
        <span class="n">coords_array_full</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="n">ibeg_full</span><span class="p">:</span><span class="n">iend_full</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span>

        <span class="n">nlat</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">full_state_info</span><span class="p">[</span><span class="n">var</span><span class="p">][</span><span class="s1">&#39;spacedims&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">nlon</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">full_state_info</span><span class="p">[</span><span class="n">var</span><span class="p">][</span><span class="s1">&#39;spacedims&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>

        <span class="n">var_array_new</span><span class="p">,</span> <span class="n">lat_new</span><span class="p">,</span> <span class="n">lon_new</span> <span class="o">=</span> <span class="n">regrid_func</span><span class="p">[</span><span class="n">regrid_method</span><span class="p">](</span><span class="n">nlat</span><span class="p">,</span> <span class="n">nlon</span><span class="p">,</span> <span class="n">nens</span><span class="p">,</span> <span class="n">var_array_full</span><span class="p">,</span> <span class="n">regrid_resolution</span><span class="p">)</span>

        <span class="n">nlat_new</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">lat_new</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">nlon_new</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">lat_new</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">((</span><span class="s1">&#39;=&gt; Full array:      &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">var_array_full</span><span class="p">))</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span>
                   <span class="nb">str</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">var_array_full</span><span class="p">))</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">var_array_full</span><span class="p">))</span> <span class="o">+</span>
                   <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">var_array_full</span><span class="p">))))</span>
            <span class="nb">print</span><span class="p">((</span><span class="s1">&#39;=&gt; Truncated array: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">var_array_new</span><span class="p">))</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span>
                   <span class="nb">str</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">var_array_new</span><span class="p">))</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">var_array_new</span><span class="p">))</span> <span class="o">+</span>
                   <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">var_array_new</span><span class="p">))))</span>

        <span class="c1"># corresponding indices in truncated state vector</span>
        <span class="n">ibeg_new</span> <span class="o">=</span> <span class="n">Nx</span>
        <span class="n">iend_new</span> <span class="o">=</span> <span class="n">Nx</span><span class="o">+</span><span class="p">(</span><span class="n">nlat_new</span><span class="o">*</span><span class="n">nlon_new</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span>
        <span class="c1"># for new state info dictionary</span>
        <span class="n">dct</span><span class="p">[</span><span class="s1">&#39;pos&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">ibeg_new</span><span class="p">,</span> <span class="n">iend_new</span><span class="p">)</span>
        <span class="n">dct</span><span class="p">[</span><span class="s1">&#39;spacecoords&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">full_state_info</span><span class="p">[</span><span class="n">var</span><span class="p">][</span><span class="s1">&#39;spacecoords&#39;</span><span class="p">]</span>
        <span class="n">dct</span><span class="p">[</span><span class="s1">&#39;spacedims&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">nlat_new</span><span class="p">,</span> <span class="n">nlon_new</span><span class="p">)</span>
        <span class="c1"># updated dimension</span>
        <span class="n">new_dims</span> <span class="o">=</span> <span class="p">(</span><span class="n">nlat_new</span><span class="o">*</span><span class="n">nlon_new</span><span class="p">)</span>

        <span class="c1"># array with new spatial coords</span>
        <span class="n">coords_array_new</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">[</span><span class="n">new_dims</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span>
        <span class="n">coords_array_new</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">lat_new</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
        <span class="n">coords_array_new</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">lon_new</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>

        <span class="c1"># fill in new state info dictionary</span>
        <span class="n">new_state_info</span><span class="p">[</span><span class="n">var</span><span class="p">]</span> <span class="o">=</span> <span class="n">dct</span>

        <span class="c1"># if 1st time in loop over state variables, create Xb_one array as copy</span>
        <span class="c1"># of var_array_new</span>
        <span class="k">if</span> <span class="n">Nx</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">Xb_one</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">var_array_new</span><span class="p">)</span>
            <span class="n">Xb_one_coords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">coords_array_new</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># if not 1st time, append to existing array</span>
            <span class="n">Xb_one</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Xb_one</span><span class="p">,</span> <span class="n">var_array_new</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">Xb_one_coords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Xb_one_coords</span><span class="p">,</span> <span class="n">coords_array_new</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="c1"># making sure Xb_one has proper mask, if it contains</span>
        <span class="c1"># at least one invalid value</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">Xb_one</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
            <span class="n">Xb_one</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_invalid</span><span class="p">(</span><span class="n">Xb_one</span><span class="p">)</span>
            <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">set_fill_value</span><span class="p">(</span><span class="n">Xb_one</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>

        <span class="c1"># updating dimension of new state vector</span>
        <span class="n">Nx</span> <span class="o">=</span> <span class="n">Nx</span> <span class="o">+</span> <span class="n">new_dims</span>

    <span class="k">return</span> <span class="n">Xb_one</span><span class="p">,</span> <span class="n">Xb_one_coords</span><span class="p">,</span> <span class="n">new_state_info</span>


<span class="k">def</span> <span class="nf">get_proxy</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="n">proxies_df_filepath</span><span class="p">,</span> <span class="n">metadata_df_filepath</span><span class="p">,</span> <span class="n">precalib_filesdict</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
              <span class="n">exclude_list</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">select_box_lf</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">select_box_ur</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
              <span class="n">detrend_proxy</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">detrend_method</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">detrend_kws</span><span class="o">=</span><span class="p">{},</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
              <span class="n">NH_only</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">SH_only</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>

    <span class="n">db_proxies</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_pickle</span><span class="p">(</span><span class="n">proxies_df_filepath</span><span class="p">)</span>
    <span class="n">db_metadata</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_pickle</span><span class="p">(</span><span class="n">metadata_df_filepath</span><span class="p">)</span>

    <span class="n">proxy_db_cfg</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;LMRdb&#39;</span><span class="p">:</span> <span class="n">cfg</span><span class="o">.</span><span class="n">proxies</span><span class="o">.</span><span class="n">LMRdb</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="n">db_name</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">proxies</span><span class="o">.</span><span class="n">use_from</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">cfg</span><span class="o">.</span><span class="n">proxies</span><span class="o">.</span><span class="n">target_sites</span><span class="p">:</span>
        <span class="c1"># if target sites are given, then just use them regardeless of other filters</span>
        <span class="n">all_proxy_ids</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">proxies</span><span class="o">.</span><span class="n">target_sites</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">all_proxy_ids</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">proxy_db_cfg</span><span class="p">[</span><span class="n">db_name</span><span class="p">]</span><span class="o">.</span><span class="n">proxy_order</span><span class="p">:</span>
            <span class="n">archive</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">archive_mask</span> <span class="o">=</span> <span class="n">db_metadata</span><span class="p">[</span><span class="s1">&#39;Archive type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">archive</span>

            <span class="n">measure_mask</span> <span class="o">=</span> <span class="n">db_metadata</span><span class="p">[</span><span class="s1">&#39;Proxy measurement&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span>
            <span class="n">measure_mask</span> <span class="o">&amp;=</span> <span class="kc">False</span>

            <span class="k">for</span> <span class="n">measure</span> <span class="ow">in</span> <span class="n">proxy_db_cfg</span><span class="p">[</span><span class="n">db_name</span><span class="p">]</span><span class="o">.</span><span class="n">proxy_assim2</span><span class="p">[</span><span class="n">name</span><span class="p">]:</span>
                <span class="n">measure_mask</span> <span class="o">|=</span> <span class="n">db_metadata</span><span class="p">[</span><span class="s1">&#39;Proxy measurement&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">measure</span>

            <span class="n">resolution_mask</span> <span class="o">=</span> <span class="n">db_metadata</span><span class="p">[</span><span class="s1">&#39;Resolution (yr)&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span>
            <span class="n">resolution_mask</span> <span class="o">&amp;=</span> <span class="kc">False</span>
            <span class="k">for</span> <span class="n">proxy_resolution</span> <span class="ow">in</span> <span class="n">proxy_db_cfg</span><span class="p">[</span><span class="n">db_name</span><span class="p">]</span><span class="o">.</span><span class="n">proxy_resolution</span><span class="p">:</span>
                <span class="n">resolution_mask</span> <span class="o">|=</span> <span class="n">db_metadata</span><span class="p">[</span><span class="s1">&#39;Resolution (yr)&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">proxy_resolution</span>

            <span class="n">dbase_mask</span> <span class="o">=</span> <span class="n">db_metadata</span><span class="p">[</span><span class="s1">&#39;Databases&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span>
            <span class="n">dbase_mask</span> <span class="o">&amp;=</span> <span class="kc">False</span>
            <span class="k">for</span> <span class="n">proxy_database</span> <span class="ow">in</span> <span class="n">proxy_db_cfg</span><span class="p">[</span><span class="n">db_name</span><span class="p">]</span><span class="o">.</span><span class="n">database_filter</span><span class="p">:</span>
                <span class="n">sub_mask</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">db_metadata</span><span class="p">[</span><span class="s1">&#39;Databases&#39;</span><span class="p">]:</span>
                    <span class="n">sub_mask</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">proxy_database</span> <span class="ow">in</span> <span class="n">p</span><span class="p">)</span>

                <span class="n">dbase_mask</span> <span class="o">|=</span> <span class="n">sub_mask</span>

            <span class="n">proxies</span> <span class="o">=</span> <span class="n">db_metadata</span><span class="p">[</span><span class="s1">&#39;Proxy ID&#39;</span><span class="p">][</span><span class="n">archive_mask</span> <span class="o">&amp;</span> <span class="n">measure_mask</span> <span class="o">&amp;</span> <span class="n">resolution_mask</span> <span class="o">&amp;</span> <span class="n">dbase_mask</span><span class="p">]</span>
            <span class="n">proxies_list</span> <span class="o">=</span> <span class="n">proxies</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

            <span class="n">all_proxy_ids</span> <span class="o">+=</span> <span class="n">proxies_list</span>

    <span class="n">picked_proxies</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">picked_proxy_ids</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c1">#  start, finish = cfg.core.recon_period</span>

    <span class="k">if</span> <span class="n">exclude_list</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">pid</span> <span class="ow">in</span> <span class="n">exclude_list</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">pid</span> <span class="ow">in</span> <span class="n">all_proxy_ids</span><span class="p">:</span>
                <span class="n">all_proxy_ids</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">pid</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">site</span> <span class="ow">in</span> <span class="n">all_proxy_ids</span><span class="p">:</span>
        <span class="n">site_meta</span> <span class="o">=</span> <span class="n">db_metadata</span><span class="p">[</span><span class="n">db_metadata</span><span class="p">[</span><span class="s1">&#39;Proxy ID&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">site</span><span class="p">]</span>
        <span class="n">start_yr</span> <span class="o">=</span> <span class="n">site_meta</span><span class="p">[</span><span class="s1">&#39;Oldest (C.E.)&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">end_yr</span> <span class="o">=</span> <span class="n">site_meta</span><span class="p">[</span><span class="s1">&#39;Youngest (C.E.)&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">lat</span> <span class="o">=</span> <span class="n">site_meta</span><span class="p">[</span><span class="s1">&#39;Lat (N)&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">lon</span> <span class="o">=</span> <span class="n">site_meta</span><span class="p">[</span><span class="s1">&#39;Lon (E)&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">elev</span> <span class="o">=</span> <span class="n">site_meta</span><span class="p">[</span><span class="s1">&#39;Elev&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">seasonality</span> <span class="o">=</span> <span class="n">site_meta</span><span class="p">[</span><span class="s1">&#39;Seasonality&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">site_data</span> <span class="o">=</span> <span class="n">db_proxies</span><span class="p">[</span><span class="n">site</span><span class="p">]</span>
        <span class="c1">#  values = site_data[(site_data.index &gt;= start) &amp; (site_data.index &lt;= finish)]</span>
        <span class="n">values</span> <span class="o">=</span> <span class="n">site_data</span><span class="p">[:]</span>
        <span class="n">values</span> <span class="o">=</span> <span class="n">values</span><span class="p">[</span><span class="n">values</span><span class="o">.</span><span class="n">notnull</span><span class="p">()]</span>
        <span class="n">time</span> <span class="o">=</span> <span class="n">values</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">values</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">values</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">site_meta</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;ERROR: No obs in specified time range!&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">proxy_db_cfg</span><span class="p">[</span><span class="n">db_name</span><span class="p">]</span><span class="o">.</span><span class="n">proxy_timeseries_kind</span> <span class="o">==</span> <span class="s1">&#39;anom&#39;</span><span class="p">:</span>
            <span class="n">values</span> <span class="o">=</span> <span class="n">values</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">detrend_proxy</span><span class="p">:</span>
            <span class="n">detrended_values</span> <span class="o">=</span> <span class="n">detrend</span><span class="p">(</span><span class="n">values</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="n">detrend_method</span><span class="p">,</span> <span class="n">detrend_kws</span><span class="o">=</span><span class="n">detrend_kws</span><span class="p">)</span>
            <span class="n">values</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">time</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">detrended_values</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">pmeasure</span> <span class="o">=</span> <span class="n">site_meta</span><span class="p">[</span><span class="s1">&#39;Proxy measurement&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">db_type</span> <span class="o">=</span> <span class="n">site_meta</span><span class="p">[</span><span class="s1">&#39;Archive type&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">proxy_type</span> <span class="o">=</span> <span class="n">proxy_db_cfg</span><span class="p">[</span><span class="n">db_name</span><span class="p">]</span><span class="o">.</span><span class="n">proxy_type_mapping</span><span class="p">[(</span><span class="n">db_type</span><span class="p">,</span> <span class="n">pmeasure</span><span class="p">)]</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">KeyError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;Proxy type/measurement not found in mapping: </span><span class="si">{e}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

        <span class="n">psm_key</span> <span class="o">=</span> <span class="n">proxy_db_cfg</span><span class="p">[</span><span class="n">db_name</span><span class="p">]</span><span class="o">.</span><span class="n">proxy_psm_type</span><span class="p">[</span><span class="n">proxy_type</span><span class="p">]</span>

        <span class="c1"># check if pre-calibration files are provided</span>

        <span class="k">if</span> <span class="n">precalib_filesdict</span> <span class="ow">and</span> <span class="n">psm_key</span> <span class="ow">in</span> <span class="n">precalib_filesdict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">psm_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_pickle</span><span class="p">(</span><span class="n">precalib_filesdict</span><span class="p">[</span><span class="n">psm_key</span><span class="p">])</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="n">site</span><span class="p">,</span> <span class="n">psm_key</span><span class="p">)</span>
                <span class="n">psm_site_data</span> <span class="o">=</span> <span class="n">psm_data</span><span class="p">[(</span><span class="n">proxy_type</span><span class="p">,</span> <span class="n">site</span><span class="p">)]</span>
                <span class="n">psm_obj</span> <span class="o">=</span> <span class="n">PSM</span><span class="p">(</span><span class="n">psm_key</span><span class="p">,</span> <span class="n">psm_site_data</span><span class="p">[</span><span class="s1">&#39;PSMmse&#39;</span><span class="p">],</span> <span class="n">psm_site_data</span><span class="p">[</span><span class="s1">&#39;SNR&#39;</span><span class="p">])</span>
                <span class="n">pobj</span> <span class="o">=</span> <span class="n">Proxy</span><span class="p">(</span><span class="n">site</span><span class="p">,</span> <span class="n">proxy_type</span><span class="p">,</span> <span class="n">start_yr</span><span class="p">,</span> <span class="n">end_yr</span><span class="p">,</span> <span class="n">lat</span><span class="p">,</span> <span class="n">lon</span><span class="p">,</span> <span class="n">elev</span><span class="p">,</span> <span class="n">seasonality</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">psm_obj</span><span class="p">)</span>
                <span class="n">picked_proxies</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pobj</span><span class="p">)</span>
                <span class="n">picked_proxy_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">site</span><span class="p">)</span>

            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="c1">#  err_msg = f&#39;Proxy in database but not found in pre-calibration file {precalib_filesdict[psm_key]}...\nSkipping: {site}&#39;</span>
                <span class="n">err_msg</span> <span class="o">=</span> <span class="n">f</span><span class="s1">&#39;Proxy in database but not found in pre-calibration files...</span><span class="se">\n</span><span class="s1">Skipping: </span><span class="si">{site}</span><span class="s1">&#39;</span>
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="n">err_msg</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">proxy_std</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanstd</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>
            <span class="n">proxy_var</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanvar</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>
            <span class="n">SNR</span> <span class="o">=</span> <span class="n">proxy_db_cfg</span><span class="p">[</span><span class="n">db_name</span><span class="p">]</span><span class="o">.</span><span class="n">SNR</span><span class="p">[</span><span class="n">proxy_type</span><span class="p">]</span>
            <span class="n">ob_err_std</span> <span class="o">=</span> <span class="n">proxy_std</span> <span class="o">/</span> <span class="n">SNR</span>
            <span class="n">ob_err_var</span> <span class="o">=</span> <span class="n">ob_err_std</span><span class="o">**</span><span class="mi">2</span>

            <span class="n">psm_obj</span> <span class="o">=</span> <span class="n">PSM</span><span class="p">(</span><span class="n">psm_key</span><span class="p">,</span> <span class="n">ob_err_var</span><span class="p">,</span> <span class="n">SNR</span><span class="p">)</span>
            <span class="n">pobj</span> <span class="o">=</span> <span class="n">Proxy</span><span class="p">(</span><span class="n">site</span><span class="p">,</span> <span class="n">proxy_type</span><span class="p">,</span> <span class="n">start_yr</span><span class="p">,</span> <span class="n">end_yr</span><span class="p">,</span> <span class="n">lat</span><span class="p">,</span> <span class="n">lon</span><span class="p">,</span> <span class="n">elev</span><span class="p">,</span> <span class="n">seasonality</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">psm_obj</span><span class="p">)</span>
            <span class="n">picked_proxies</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pobj</span><span class="p">)</span>
            <span class="n">picked_proxy_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">site</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">pid={os.getpid()} &gt;&gt;&gt; SNR = </span><span class="si">{SNR}</span><span class="s1">, proxy_var = </span><span class="si">{proxy_var:.5f}</span><span class="s1">, ob_err_var = </span><span class="si">{ob_err_var:.5f}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">select_box_lf</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">select_box_ur</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># pick the proxies only inside the selected box defined with the</span>
            <span class="c1"># (lat, lon) of the lower-left and upper-right corner</span>
            <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">pobj</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">picked_proxies</span><span class="p">):</span>
                <span class="n">lf_lat</span><span class="p">,</span> <span class="n">lf_lon</span> <span class="o">=</span> <span class="n">select_box_lf</span>
                <span class="n">ur_lat</span><span class="p">,</span> <span class="n">ur_lon</span> <span class="o">=</span> <span class="n">select_box_ur</span>
                <span class="n">lf_lon</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mod</span><span class="p">(</span><span class="n">lf_lon</span><span class="p">,</span> <span class="mi">360</span><span class="p">)</span>
                <span class="n">ur_lon</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mod</span><span class="p">(</span><span class="n">ur_lon</span><span class="p">,</span> <span class="mi">360</span><span class="p">)</span>
                <span class="n">p_lon</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mod</span><span class="p">(</span><span class="n">pobj</span><span class="o">.</span><span class="n">lon</span><span class="p">,</span> <span class="mi">360</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">pobj</span><span class="o">.</span><span class="n">lat</span> <span class="o">&lt;</span> <span class="n">lf_lat</span> <span class="ow">or</span> <span class="n">pobj</span><span class="o">.</span><span class="n">lat</span> <span class="o">&gt;</span> <span class="n">ur_lat</span> <span class="ow">or</span> <span class="n">p_lon</span> <span class="o">&lt;</span> <span class="n">lf_lon</span> <span class="ow">or</span> <span class="n">p_lon</span> <span class="o">&gt;</span> <span class="n">ur_lon</span><span class="p">:</span>
                    <span class="n">picked_proxies</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>
                    <span class="n">picked_proxy_ids</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">NH_only</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">pobj</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">picked_proxies</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">pobj</span><span class="o">.</span><span class="n">lat</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">picked_proxies</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>
                    <span class="n">picked_proxy_ids</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">SH_only</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">pobj</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">picked_proxies</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">pobj</span><span class="o">.</span><span class="n">lat</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">picked_proxies</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>
                    <span class="n">picked_proxy_ids</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">picked_proxy_ids</span><span class="p">,</span> <span class="n">picked_proxies</span>


<span class="k">def</span> <span class="nf">get_precalib_data</span><span class="p">(</span><span class="n">psm_name</span><span class="p">,</span> <span class="n">precalib_filepath</span><span class="p">):</span>
    <span class="n">psm_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_pickle</span><span class="p">(</span><span class="n">precalib_filepath</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_linear_precalib_data</span><span class="p">(</span><span class="n">psm_data</span><span class="p">):</span>
        <span class="n">pid_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">slope_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">intercept_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">seasonality_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">psm_data</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">ptype</span><span class="p">,</span> <span class="n">pid</span> <span class="o">=</span> <span class="n">i</span>
            <span class="n">slope</span> <span class="o">=</span> <span class="n">v</span><span class="p">[</span><span class="s1">&#39;PSMslope&#39;</span><span class="p">]</span>
            <span class="n">intercept</span> <span class="o">=</span> <span class="n">v</span><span class="p">[</span><span class="s1">&#39;PSMintercept&#39;</span><span class="p">]</span>
            <span class="n">seasonality</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="s1">&#39;Seasonality&#39;</span><span class="p">])</span>

            <span class="n">pid_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pid</span><span class="p">)</span>
            <span class="n">slope_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">slope</span><span class="p">)</span>
            <span class="n">intercept_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">intercept</span><span class="p">)</span>
            <span class="n">seasonality_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">seasonality</span><span class="p">)</span>

        <span class="n">precalib_data_dict</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;pid&#39;</span><span class="p">:</span> <span class="n">pid_list</span><span class="p">,</span>
            <span class="s1">&#39;slope&#39;</span><span class="p">:</span> <span class="n">slope_list</span><span class="p">,</span>
            <span class="s1">&#39;intercept&#39;</span><span class="p">:</span> <span class="n">intercept_list</span><span class="p">,</span>
            <span class="s1">&#39;seasonality&#39;</span><span class="p">:</span> <span class="n">seasonality_list</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">precalib_data_dict</span>

    <span class="k">def</span> <span class="nf">get_bilinear_precalib_data</span><span class="p">(</span><span class="n">psm_data</span><span class="p">):</span>
        <span class="n">pid_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">slope_temperature_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">slope_moisture_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">intercept_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">seasonality_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">psm_data</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">ptype</span><span class="p">,</span> <span class="n">pid</span> <span class="o">=</span> <span class="n">i</span>
            <span class="n">slope_temperature</span> <span class="o">=</span> <span class="n">v</span><span class="p">[</span><span class="s1">&#39;PSMslope_temperature&#39;</span><span class="p">]</span>
            <span class="n">slope_moisture</span> <span class="o">=</span> <span class="n">v</span><span class="p">[</span><span class="s1">&#39;PSMslope_moisture&#39;</span><span class="p">]</span>
            <span class="n">intercept</span> <span class="o">=</span> <span class="n">v</span><span class="p">[</span><span class="s1">&#39;PSMintercept&#39;</span><span class="p">]</span>
            <span class="n">seasonality</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="s1">&#39;Seasonality&#39;</span><span class="p">])</span>

            <span class="n">pid_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pid</span><span class="p">)</span>
            <span class="n">slope_temperature_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">slope_temperature</span><span class="p">)</span>
            <span class="n">slope_moisture_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">slope_moisture</span><span class="p">)</span>
            <span class="n">intercept_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">intercept</span><span class="p">)</span>
            <span class="n">seasonality_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">seasonality</span><span class="p">)</span>

        <span class="n">precalib_data_dict</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;pid&#39;</span><span class="p">:</span> <span class="n">pid_list</span><span class="p">,</span>
            <span class="s1">&#39;slope_temperature&#39;</span><span class="p">:</span> <span class="n">slope_temperature_list</span><span class="p">,</span>
            <span class="s1">&#39;slope_moisture&#39;</span><span class="p">:</span> <span class="n">slope_moisture_list</span><span class="p">,</span>
            <span class="s1">&#39;intercept&#39;</span><span class="p">:</span> <span class="n">intercept_list</span><span class="p">,</span>
            <span class="s1">&#39;seasonality&#39;</span><span class="p">:</span> <span class="n">seasonality_list</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">precalib_data_dict</span>

    <span class="n">get_precalib_data_func</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;linear&#39;</span><span class="p">:</span> <span class="n">get_linear_precalib_data</span><span class="p">,</span>
        <span class="s1">&#39;bilinear&#39;</span><span class="p">:</span> <span class="n">get_bilinear_precalib_data</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">get_precalib_data_func</span><span class="p">[</span><span class="n">psm_name</span><span class="p">](</span><span class="n">psm_data</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">calc_ye_linearPSM</span><span class="p">(</span><span class="n">proxy_manager</span><span class="p">,</span> <span class="n">ptypes</span><span class="p">,</span> <span class="n">psm_name</span><span class="p">,</span>
                      <span class="n">precalib_data</span><span class="p">,</span> <span class="n">precalc_avg</span><span class="p">,</span> <span class="n">nproc</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; Calculate Ye with linear/bilinear PSMs</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">pid_map</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">ye_out</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">pid_obs</span> <span class="o">=</span> <span class="p">[</span><span class="n">pid</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">pid</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">precalib_data</span><span class="o">.</span><span class="n">items</span><span class="p">()]</span>

    <span class="n">var_names</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;linear&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">],</span>
        <span class="s1">&#39;bilinear&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">,</span> <span class="s1">&#39;M&#39;</span><span class="p">],</span>
    <span class="p">}</span>

    <span class="n">env_var</span><span class="p">,</span> <span class="n">env_time</span><span class="p">,</span> <span class="n">env_lat</span><span class="p">,</span> <span class="n">env_lon</span> <span class="o">=</span> <span class="p">{},</span> <span class="p">{},</span> <span class="p">{},</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">var_name</span> <span class="ow">in</span> <span class="n">var_names</span><span class="p">[</span><span class="n">psm_name</span><span class="p">]:</span>
        <span class="n">env_var</span><span class="p">[</span><span class="n">var_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">precalc_avg</span><span class="p">[</span><span class="n">var_name</span><span class="p">][</span><span class="s1">&#39;var_ann_dict&#39;</span><span class="p">]</span>
        <span class="n">env_time</span><span class="p">[</span><span class="n">var_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">precalc_avg</span><span class="p">[</span><span class="n">var_name</span><span class="p">][</span><span class="s1">&#39;year_ann&#39;</span><span class="p">]</span>
        <span class="n">env_lat</span><span class="p">[</span><span class="n">var_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">precalc_avg</span><span class="p">[</span><span class="n">var_name</span><span class="p">][</span><span class="s1">&#39;lat&#39;</span><span class="p">]</span>
        <span class="n">env_lon</span><span class="p">[</span><span class="n">var_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">precalc_avg</span><span class="p">[</span><span class="n">var_name</span><span class="p">][</span><span class="s1">&#39;lon&#39;</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">func_wrapper</span><span class="p">(</span><span class="n">pobj</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">total_n</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;pid={os.getpid()} &gt;&gt;&gt; {idx+1}/</span><span class="si">{total_n}</span><span class="s1">: </span><span class="si">{pobj.id}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">pobj</span><span class="o">.</span><span class="n">type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ptypes</span><span class="p">:</span>
            <span class="c1"># PSM not available; skip</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;pid={os.getpid()} &gt;&gt;&gt; The proxy type </span><span class="si">{pobj.type}</span><span class="s1"> is not in specified types: </span><span class="si">{ptypes}</span><span class="s1">; skipping ...&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># PSM available</span>
            <span class="k">if</span> <span class="n">pobj</span><span class="o">.</span><span class="n">id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">pid_obs</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;pid={os.getpid()} &gt;&gt;&gt; No calibration data; skipping </span><span class="si">{pobj.id}</span><span class="s1"> ...&#39;</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">None</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">lat_model</span> <span class="o">=</span> <span class="n">env_lat</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span>
                <span class="n">lon_model</span> <span class="o">=</span> <span class="n">env_lon</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span>
                <span class="n">lat_ind</span><span class="p">,</span> <span class="n">lon_ind</span> <span class="o">=</span> <span class="n">find_closest_loc</span><span class="p">(</span><span class="n">lat_model</span><span class="p">,</span> <span class="n">lon_model</span><span class="p">,</span> <span class="n">pobj</span><span class="o">.</span><span class="n">lat</span><span class="p">,</span> <span class="n">pobj</span><span class="o">.</span><span class="n">lon</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;pid={os.getpid()} &gt;&gt;&gt; Target: (</span><span class="si">{pobj.lat}</span><span class="s1">, </span><span class="si">{pobj.lon}</span><span class="s1">); Found: (</span><span class="si">{lat_model[lat_ind]:.2f}</span><span class="s1">, </span><span class="si">{lon_model[lon_ind]:.2f}</span><span class="s1">)&#39;</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">psm_name</span> <span class="o">==</span> <span class="s1">&#39;linear&#39;</span><span class="p">:</span>
                    <span class="n">avgMonths</span> <span class="o">=</span> <span class="n">precalib_data</span><span class="p">[(</span><span class="n">pobj</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="n">pobj</span><span class="o">.</span><span class="n">id</span><span class="p">)][</span><span class="s1">&#39;Seasonality&#39;</span><span class="p">]</span>

                    <span class="n">intercept</span> <span class="o">=</span> <span class="n">precalib_data</span><span class="p">[(</span><span class="n">pobj</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="n">pobj</span><span class="o">.</span><span class="n">id</span><span class="p">)][</span><span class="s1">&#39;PSMintercept&#39;</span><span class="p">]</span>
                    <span class="n">slope</span> <span class="o">=</span> <span class="n">precalib_data</span><span class="p">[(</span><span class="n">pobj</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="n">pobj</span><span class="o">.</span><span class="n">id</span><span class="p">)][</span><span class="s1">&#39;PSMslope&#39;</span><span class="p">]</span>

                    <span class="n">season_tag</span> <span class="o">=</span> <span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">m</span><span class="p">)</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">avgMonths</span><span class="p">)</span>
                    <span class="n">tas_ann</span> <span class="o">=</span> <span class="n">env_var</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">][</span><span class="n">season_tag</span><span class="p">][:,</span> <span class="n">lat_ind</span><span class="p">,</span> <span class="n">lon_ind</span><span class="p">]</span>

                    <span class="n">pseudo_value</span> <span class="o">=</span> <span class="n">slope</span><span class="o">*</span><span class="n">tas_ann</span> <span class="o">+</span> <span class="n">intercept</span>

                <span class="k">elif</span> <span class="n">psm_name</span> <span class="o">==</span> <span class="s1">&#39;bilinear&#39;</span><span class="p">:</span>
                    <span class="n">avgMonths_T</span><span class="p">,</span> <span class="n">avgMonths_M</span> <span class="o">=</span> <span class="n">precalib_data</span><span class="p">[(</span><span class="n">pobj</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="n">pobj</span><span class="o">.</span><span class="n">id</span><span class="p">)][</span><span class="s1">&#39;Seasonality&#39;</span><span class="p">]</span>

                    <span class="n">intercept</span> <span class="o">=</span> <span class="n">precalib_data</span><span class="p">[(</span><span class="n">pobj</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="n">pobj</span><span class="o">.</span><span class="n">id</span><span class="p">)][</span><span class="s1">&#39;PSMintercept&#39;</span><span class="p">]</span>
                    <span class="n">slope_temperature</span> <span class="o">=</span> <span class="n">precalib_data</span><span class="p">[(</span><span class="n">pobj</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="n">pobj</span><span class="o">.</span><span class="n">id</span><span class="p">)][</span><span class="s1">&#39;PSMslope_temperature&#39;</span><span class="p">]</span>
                    <span class="n">slope_moisture</span> <span class="o">=</span> <span class="n">precalib_data</span><span class="p">[(</span><span class="n">pobj</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="n">pobj</span><span class="o">.</span><span class="n">id</span><span class="p">)][</span><span class="s1">&#39;PSMslope_moisture&#39;</span><span class="p">]</span>

                    <span class="n">season_tag_T</span> <span class="o">=</span> <span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">m</span><span class="p">)</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">avgMonths_T</span><span class="p">)</span>
                    <span class="n">season_tag_M</span> <span class="o">=</span> <span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">m</span><span class="p">)</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">avgMonths_M</span><span class="p">)</span>
                    <span class="n">tas_ann</span> <span class="o">=</span> <span class="n">env_var</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">][</span><span class="n">season_tag_T</span><span class="p">][:,</span> <span class="n">lat_ind</span><span class="p">,</span> <span class="n">lon_ind</span><span class="p">]</span>
                    <span class="n">pr_ann</span> <span class="o">=</span> <span class="n">env_var</span><span class="p">[</span><span class="s1">&#39;M&#39;</span><span class="p">][</span><span class="n">season_tag_M</span><span class="p">][:,</span> <span class="n">lat_ind</span><span class="p">,</span> <span class="n">lon_ind</span><span class="p">]</span>

                    <span class="n">t1</span><span class="p">,</span> <span class="n">t2</span> <span class="o">=</span> <span class="n">env_time</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">],</span> <span class="n">env_time</span><span class="p">[</span><span class="s1">&#39;M&#39;</span><span class="p">]</span>
                    <span class="n">overlap_yrs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">intersect1d</span><span class="p">(</span><span class="n">t1</span><span class="p">,</span> <span class="n">t2</span><span class="p">)</span>
                    <span class="n">ind1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">t1</span><span class="p">,</span> <span class="n">overlap_yrs</span><span class="p">)</span>
                    <span class="n">ind2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">t2</span><span class="p">,</span> <span class="n">overlap_yrs</span><span class="p">)</span>

                    <span class="n">pseudo_value</span> <span class="o">=</span> <span class="n">slope_temperature</span><span class="o">*</span><span class="n">tas_ann</span><span class="p">[</span><span class="n">ind1</span><span class="p">]</span> <span class="o">+</span> <span class="n">slope_moisture</span><span class="o">*</span><span class="n">pr_ann</span><span class="p">[</span><span class="n">ind2</span><span class="p">]</span> <span class="o">+</span> <span class="n">intercept</span>

                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                    <span class="n">mean_value</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">pseudo_value</span><span class="p">)</span>
                    <span class="n">std_value</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanstd</span><span class="p">(</span><span class="n">pseudo_value</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;pid={os.getpid()} &gt;&gt;&gt; shape: {np.shape(pseudo_value)}&#39;</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;pid={os.getpid()} &gt;&gt;&gt; mean: </span><span class="si">{mean_value:.2f}</span><span class="s1">; std: </span><span class="si">{std_value:.2f}</span><span class="s1">&#39;</span><span class="p">)</span>

                <span class="k">return</span> <span class="n">pseudo_value</span>

    <span class="k">if</span> <span class="n">nproc</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">Pool</span><span class="p">(</span><span class="n">nproc</span><span class="p">)</span> <span class="k">as</span> <span class="n">pool</span><span class="p">:</span>
            <span class="n">nproxies</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">proxy_manager</span><span class="o">.</span><span class="n">all_proxies</span><span class="p">)</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">nproxies</span><span class="p">)</span>
            <span class="n">total_n</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">nproxies</span><span class="p">)</span><span class="o">*</span><span class="n">nproxies</span><span class="p">]</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">pool</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">func_wrapper</span><span class="p">,</span> <span class="n">proxy_manager</span><span class="o">.</span><span class="n">all_proxies</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">total_n</span><span class="p">)</span>

        <span class="n">k</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">pobj</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">proxy_manager</span><span class="o">.</span><span class="n">all_proxies</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">res</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">ye_out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span>
                <span class="n">pid_map</span><span class="p">[</span><span class="n">pobj</span><span class="o">.</span><span class="n">id</span><span class="p">]</span> <span class="o">=</span> <span class="n">k</span>
                <span class="n">k</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">total_n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">proxy_manager</span><span class="o">.</span><span class="n">all_proxies</span><span class="p">)</span>
        <span class="n">k</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">pobj</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">proxy_manager</span><span class="o">.</span><span class="n">all_proxies</span><span class="p">):</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">func_wrapper</span><span class="p">(</span><span class="n">pobj</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">total_n</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">res</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">ye_out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
                <span class="n">pid_map</span><span class="p">[</span><span class="n">pobj</span><span class="o">.</span><span class="n">id</span><span class="p">]</span> <span class="o">=</span> <span class="n">k</span>
                <span class="n">k</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="n">ye_out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ye_out</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">pid_map</span><span class="p">,</span> <span class="n">ye_out</span>


<span class="k">def</span> <span class="nf">calc_ye</span><span class="p">(</span><span class="n">proxy_manager</span><span class="p">,</span> <span class="n">ptypes</span><span class="p">,</span> <span class="n">psm_name</span><span class="p">,</span>
            <span class="n">lat_model</span><span class="p">,</span> <span class="n">lon_model</span><span class="p">,</span> <span class="n">time_model</span><span class="p">,</span>
            <span class="n">prior_vars</span><span class="p">,</span>
            <span class="n">elev_model</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">match_std</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">match_mean</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">psm_params</span><span class="p">):</span>

    <span class="c1"># load parameters for specific PSMs from precalculated files</span>

    <span class="c1"># load parameters for VS-Lite</span>
    <span class="k">if</span> <span class="s1">&#39;vslite_params_path&#39;</span> <span class="ow">in</span> <span class="n">psm_params</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">psm_params</span><span class="p">[</span><span class="s1">&#39;vslite_params_path&#39;</span><span class="p">],</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
            <span class="n">pid_obs</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="s1">&#39;pid_obs&#39;</span><span class="p">]</span>
            <span class="n">T1</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="s1">&#39;T1&#39;</span><span class="p">]</span>
            <span class="n">T2</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="s1">&#39;T2&#39;</span><span class="p">]</span>
            <span class="n">M1</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="s1">&#39;M1&#39;</span><span class="p">]</span>
            <span class="n">M2</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="s1">&#39;M2&#39;</span><span class="p">]</span>

    <span class="c1"># load parameters for VS-Lite</span>
    <span class="k">if</span> <span class="s1">&#39;coral_species_info&#39;</span> <span class="ow">in</span> <span class="n">psm_params</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">psm_params</span><span class="p">[</span><span class="s1">&#39;coral_species_info&#39;</span><span class="p">],</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
            <span class="n">pid_obs</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="s1">&#39;pid_obs&#39;</span><span class="p">]</span>
            <span class="n">species_obs</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="s1">&#39;species_obs&#39;</span><span class="p">]</span>

    <span class="n">pid_map</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">ye_out</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">k</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="c1"># generate pseudoproxy values</span>
    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">pobj</span> <span class="ow">in</span> <span class="p">(</span><span class="nb">enumerate</span><span class="p">(</span><span class="n">tqdm</span><span class="p">(</span><span class="n">proxy_manager</span><span class="o">.</span><span class="n">all_proxies</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s1">&#39;Forward modeling&#39;</span><span class="p">))</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">verbose</span> <span class="k">else</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">proxy_manager</span><span class="o">.</span><span class="n">all_proxies</span><span class="p">)):</span>
        <span class="k">if</span> <span class="n">pobj</span><span class="o">.</span><span class="n">type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ptypes</span><span class="p">:</span>
            <span class="c1"># PSM not available; skip</span>
            <span class="k">continue</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Processing #</span><span class="si">{count}</span><span class="s1"> - </span><span class="si">{pobj.id}</span><span class="s1"> ...&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="s1">&#39;vslite_params_path&#39;</span> <span class="ow">in</span> <span class="n">psm_params</span> <span class="ow">and</span> <span class="n">pobj</span><span class="o">.</span><span class="n">id</span> <span class="ow">in</span> <span class="n">pid_obs</span><span class="p">:</span>
                <span class="c1"># load parameters for VS-Lite</span>
                <span class="n">ind</span> <span class="o">=</span> <span class="n">pid_obs</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">pobj</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
                <span class="n">psm_params</span><span class="p">[</span><span class="s1">&#39;T1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">T1</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span>
                <span class="n">psm_params</span><span class="p">[</span><span class="s1">&#39;T2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">T2</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span>
                <span class="n">psm_params</span><span class="p">[</span><span class="s1">&#39;M1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">M1</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span>
                <span class="n">psm_params</span><span class="p">[</span><span class="s1">&#39;M2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">M2</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span>
                <span class="n">psm_params</span><span class="p">[</span><span class="s1">&#39;pid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pobj</span><span class="o">.</span><span class="n">id</span>

            <span class="k">if</span> <span class="s1">&#39;coral_species_info&#39;</span> <span class="ow">in</span> <span class="n">psm_params</span><span class="p">:</span>
                <span class="c1"># load parameters for coral d18O</span>
                <span class="n">ind</span> <span class="o">=</span> <span class="n">pid_obs</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">pobj</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
                <span class="n">psm_params</span><span class="p">[</span><span class="s1">&#39;species&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">species_obs</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span>

            <span class="n">res</span> <span class="o">=</span> <span class="n">prysm</span><span class="o">.</span><span class="n">forward</span><span class="p">(</span>
                <span class="n">psm_name</span><span class="p">,</span> <span class="n">pobj</span><span class="o">.</span><span class="n">lat</span><span class="p">,</span> <span class="n">pobj</span><span class="o">.</span><span class="n">lon</span><span class="p">,</span>
                <span class="n">lat_model</span><span class="p">,</span> <span class="n">lon_model</span><span class="p">,</span> <span class="n">time_model</span><span class="p">,</span>
                <span class="n">prior_vars</span><span class="p">,</span>
                <span class="n">elev_obs</span><span class="o">=</span><span class="n">pobj</span><span class="o">.</span><span class="n">elev</span><span class="p">,</span> <span class="n">elev_model</span><span class="o">=</span><span class="n">elev_model</span><span class="p">,</span>
                <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span> <span class="o">**</span><span class="n">psm_params</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="n">ye_time</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="s1">&#39;pseudo_time&#39;</span><span class="p">]</span>
            <span class="n">ye_tmp</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="s1">&#39;pseudo_value&#39;</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">ye_tmp</span><span class="p">)):</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;Fail to forward; skipping </span><span class="si">{pobj.id}</span><span class="s1"> ...&#39;</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="n">res_dict</span> <span class="o">=</span> <span class="n">ts_matching</span><span class="p">(</span><span class="n">ye_time</span><span class="p">,</span> <span class="n">ye_tmp</span><span class="p">,</span> <span class="n">pobj</span><span class="o">.</span><span class="n">time</span><span class="p">,</span> <span class="n">pobj</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">match_std</span><span class="o">=</span><span class="n">match_std</span><span class="p">,</span> <span class="n">match_mean</span><span class="o">=</span><span class="n">match_mean</span><span class="p">)</span>
            <span class="n">ye_tmp</span> <span class="o">=</span> <span class="n">res_dict</span><span class="p">[</span><span class="s1">&#39;value_target&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="n">factor</span> <span class="o">=</span> <span class="n">res_dict</span><span class="p">[</span><span class="s1">&#39;factor&#39;</span><span class="p">]</span>
                <span class="n">bias</span> <span class="o">=</span> <span class="n">res_dict</span><span class="p">[</span><span class="s1">&#39;bias&#39;</span><span class="p">]</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;TS matching: factor=</span><span class="si">{factor:.2f}</span><span class="s1">, bias=</span><span class="si">{bias:.2f}</span><span class="s1">&#39;</span><span class="p">)</span>

            <span class="n">ye_out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ye_tmp</span><span class="p">)</span>
            <span class="n">pid_map</span><span class="p">[</span><span class="n">pobj</span><span class="o">.</span><span class="n">id</span><span class="p">]</span> <span class="o">=</span> <span class="n">k</span>
            <span class="n">k</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="n">ye_out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">ye_out</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">pid_map</span><span class="p">,</span> <span class="n">ye_out</span>


<span class="k">def</span> <span class="nf">combine_yes</span><span class="p">(</span><span class="n">ye_path_dict</span><span class="p">,</span> <span class="n">output_path</span><span class="p">):</span>
    <span class="c1"># load Ye&#39;s</span>
    <span class="n">ye</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">ye_path_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">ye</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">allow_pickle</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">pid_index_map</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">ye_vals</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">ye_path_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">pid_index_map</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">ye</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;pid_index_map&#39;</span><span class="p">][()]</span>
        <span class="n">ye_vals</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">ye</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;ye_vals&#39;</span><span class="p">]</span>

    <span class="c1"># total ye</span>
    <span class="n">ye_all_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">ye_path_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">ye_all_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ye_vals</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>

    <span class="n">ye_all</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">ye_all_list</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="c1"># total pid_map</span>
    <span class="n">pid_map_all</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="c1"># combine all of them</span>
    <span class="n">tot_count</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">ye_path_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="k">for</span> <span class="n">pid</span><span class="p">,</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">pid_index_map</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">pid_map_all</span><span class="p">[</span><span class="n">pid</span><span class="p">]</span> <span class="o">=</span> <span class="n">idx</span> <span class="o">+</span> <span class="n">tot_count</span>

        <span class="n">tot_count</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">pid_map_all</span><span class="p">))</span>

    <span class="n">np</span><span class="o">.</span><span class="n">savez</span><span class="p">(</span><span class="n">output_path</span><span class="p">,</span> <span class="n">pid_index_map</span><span class="o">=</span><span class="n">pid_map_all</span><span class="p">,</span> <span class="n">ye_vals</span><span class="o">=</span><span class="n">ye_all</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;Saving the combined Ye&#39;s to: </span><span class="si">{output_path}</span><span class="s2"> ...&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">ye_all</span><span class="p">,</span> <span class="n">pid_map_all</span>


<span class="k">def</span> <span class="nf">est_vslite_params</span><span class="p">(</span><span class="n">proxy_manager</span><span class="p">,</span> <span class="n">tas</span><span class="p">,</span> <span class="n">pr</span><span class="p">,</span> <span class="n">lat_grid</span><span class="p">,</span> <span class="n">lon_grid</span><span class="p">,</span> <span class="n">time_grid</span><span class="p">,</span>
                      <span class="n">matlab_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">func_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                      <span class="n">restart_matlab_period</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
                      <span class="n">lat_lon_idx_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">save_lat_lon_idx_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                      <span class="n">nsamp</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">errormod</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">gparpriors</span><span class="o">=</span><span class="s1">&#39;fourbet&#39;</span><span class="p">,</span>
                      <span class="n">pt_ests</span><span class="o">=</span><span class="s1">&#39;med&#39;</span><span class="p">,</span> <span class="n">nargout</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                      <span class="n">beta_params</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">matrix</span><span class="p">([</span>
                          <span class="p">[</span><span class="mi">9</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">9</span><span class="p">],</span>
                          <span class="p">[</span><span class="mf">3.5</span><span class="p">,</span> <span class="mf">3.5</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">24</span><span class="p">],</span>
                          <span class="p">[</span><span class="mf">1.5</span><span class="p">,</span> <span class="mf">2.8</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">],</span>
                          <span class="p">[</span><span class="mf">1.5</span><span class="p">,</span> <span class="mf">2.5</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">],</span>
                      <span class="p">]),</span>
                      <span class="n">seed</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">syear</span><span class="o">=</span><span class="mi">1901</span><span class="p">,</span> <span class="n">eyear</span><span class="o">=</span><span class="mi">2001</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; Run the VSL parameter estimatino Matlab precedure</span>

<span class="sd">    Args:</span>
<span class="sd">        pt_ests (str): &#39;med&#39; or &#39;mle&#39;</span>
<span class="sd">        nsamp (int): the number of MCMC iterations</span>
<span class="sd">        errmod (int): 0: white noise, 1: AR(1) noise</span>
<span class="sd">        gparpriors (str): &#39;fourbet&#39;: beta distribution, &#39;uniform&#39;: uniform distribution</span>
<span class="sd">        beta_params (matrix): the beta distribution parameters for T1, T2, M1, M2</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="kn">from</span> <span class="nn">pymatbridge</span> <span class="k">import</span> <span class="n">Matlab</span>

    <span class="n">pid_obs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">lat_obs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">lon_obs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">elev_obs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">values_obs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">pobj</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">proxy_manager</span><span class="o">.</span><span class="n">all_proxies</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">pobj</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;Tree Rings_WidthPages2&#39;</span><span class="p">:</span>
            <span class="n">pid_obs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pobj</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
            <span class="n">lat_obs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pobj</span><span class="o">.</span><span class="n">lat</span><span class="p">)</span>
            <span class="n">lon_obs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pobj</span><span class="o">.</span><span class="n">lon</span><span class="p">)</span>
            <span class="n">elev_obs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pobj</span><span class="o">.</span><span class="n">elev</span><span class="p">)</span>
            <span class="n">values_obs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pobj</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>

    <span class="n">lon_grid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mod</span><span class="p">(</span><span class="n">lon_grid</span><span class="p">,</span> <span class="mi">360</span><span class="p">)</span>  <span class="c1"># convert to range (0, 360)</span>

    <span class="k">if</span> <span class="n">lat_lon_idx_path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">lat_ind</span><span class="p">,</span> <span class="n">lon_ind</span> <span class="o">=</span> <span class="n">find_closest_loc</span><span class="p">(</span><span class="n">lat_grid</span><span class="p">,</span> <span class="n">lon_grid</span><span class="p">,</span> <span class="n">lat_obs</span><span class="p">,</span> <span class="n">lon_obs</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;latlon&#39;</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">save_lat_lon_idx_path</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">save_lat_lon_idx_path</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">([</span><span class="n">lat_ind</span><span class="p">,</span> <span class="n">lon_ind</span><span class="p">],</span> <span class="n">f</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;Saving the found lat_ind, lon_ind to: </span><span class="si">{save_lat_lon_idx_path}</span><span class="s1"> ...&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">lat_lon_idx_path</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">lat_ind</span><span class="p">,</span> <span class="n">lon_ind</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

    <span class="n">T</span> <span class="o">=</span> <span class="n">tas</span><span class="p">[:,</span> <span class="n">lat_ind</span><span class="p">,</span> <span class="n">lon_ind</span><span class="p">]</span>
    <span class="n">P</span> <span class="o">=</span> <span class="n">pr</span><span class="p">[:,</span> <span class="n">lat_ind</span><span class="p">,</span> <span class="n">lon_ind</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">matlab_path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;ERROR: matlab_path must be set!&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">func_path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">root_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span>
        <span class="n">func_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root_path</span><span class="p">,</span> <span class="s1">&#39;estimate_vslite_params_v2_3.m&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">func_path</span><span class="p">)</span>

    <span class="n">mlab</span> <span class="o">=</span> <span class="n">Matlab</span><span class="p">(</span><span class="n">matlab_path</span><span class="p">)</span>
    <span class="n">mlab</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

    <span class="n">T1</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">T2</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">M1</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">M2</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">params_est</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">trw_data</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">tqdm</span><span class="p">(</span><span class="n">values_obs</span><span class="p">)):</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;#{i+1} - Target: (</span><span class="si">{lat_obs[i]}</span><span class="s1">, </span><span class="si">{lon_obs[i]}</span><span class="s1">); Found: ({lat_grid[lat_ind[i]]:.2f}, {lon_grid[lon_ind[i]]:.2f});&#39;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
        <span class="n">trw_year</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">trw_data</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
        <span class="n">trw_value</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">trw_data</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
        <span class="n">trw_year</span><span class="p">,</span> <span class="n">trw_value</span> <span class="o">=</span> <span class="n">pick_range</span><span class="p">(</span><span class="n">trw_year</span><span class="p">,</span> <span class="n">trw_value</span><span class="p">,</span> <span class="n">syear</span><span class="p">,</span> <span class="n">eyear</span><span class="p">)</span>
        <span class="n">grid_year</span><span class="p">,</span> <span class="n">grid_tas</span> <span class="o">=</span> <span class="n">pick_years</span><span class="p">(</span><span class="n">trw_year</span><span class="p">,</span> <span class="n">time_grid</span><span class="p">,</span> <span class="n">T</span><span class="p">[:,</span> <span class="n">i</span><span class="p">])</span>
        <span class="n">grid_year</span><span class="p">,</span> <span class="n">grid_pr</span> <span class="o">=</span> <span class="n">pick_years</span><span class="p">(</span><span class="n">trw_year</span><span class="p">,</span> <span class="n">time_grid</span><span class="p">,</span> <span class="n">P</span><span class="p">[:,</span> <span class="n">i</span><span class="p">])</span>
        <span class="n">nyr</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">grid_year</span><span class="p">)</span><span class="o">/</span><span class="mi">12</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;</span><span class="si">{nyr}</span><span class="s1"> available years&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;Running estimate_vslite_params_v2_3.m ...&#39;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">)</span>

        <span class="c1"># restart Matlab kernel</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">mod</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">restart_matlab_period</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">mlab</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
            <span class="n">mlab</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

        <span class="n">add_samps</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">converge_flag</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">while</span> <span class="p">(</span><span class="n">converge_flag</span> <span class="o">==</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">start_time</span> <span class="o">=</span> <span class="n">ttime</span><span class="p">()</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">mlab</span><span class="o">.</span><span class="n">run_func</span><span class="p">(</span>
                <span class="n">func_path</span><span class="p">,</span>
                <span class="n">grid_tas</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">nyr</span><span class="p">,</span> <span class="mi">12</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">grid_pr</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">nyr</span><span class="p">,</span> <span class="mi">12</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">lat_obs</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">trw_value</span><span class="p">,</span>
                <span class="s1">&#39;seed&#39;</span><span class="p">,</span> <span class="n">seed</span><span class="p">,</span> <span class="s1">&#39;nsamp&#39;</span><span class="p">,</span> <span class="n">nsamp</span><span class="o">+</span><span class="n">add_samps</span><span class="p">,</span> <span class="s1">&#39;errormod&#39;</span><span class="p">,</span> <span class="n">errormod</span><span class="p">,</span>
                <span class="s1">&#39;gparpriors&#39;</span><span class="p">,</span> <span class="n">gparpriors</span><span class="p">,</span> <span class="s1">&#39;fourbetparams&#39;</span><span class="p">,</span> <span class="n">beta_params</span><span class="p">,</span>
                <span class="s1">&#39;pt_ests&#39;</span><span class="p">,</span> <span class="n">pt_ests</span><span class="p">,</span>
                <span class="n">nargout</span><span class="o">=</span><span class="n">nargout</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="n">used_time</span> <span class="o">=</span> <span class="n">ttime</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;</span><span class="si">{used_time:.2f}</span><span class="s1"> sec&#39;</span><span class="p">)</span>

            <span class="n">converge_flag</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="s1">&#39;result&#39;</span><span class="p">][</span><span class="mi">9</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">converge_flag</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">add_samps</span> <span class="o">+=</span> <span class="mi">1000</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;Inference not converged. Re-running with nsamp={nsamp+add_samps} ...&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">add_samps</span> <span class="o">&gt;</span> <span class="mi">1000</span><span class="p">:</span>
            <span class="n">mlab</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
            <span class="n">mlab</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

        <span class="n">T1_tmp</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="s1">&#39;result&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">T2_tmp</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="s1">&#39;result&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">M1_tmp</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="s1">&#39;result&#39;</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">M2_tmp</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="s1">&#39;result&#39;</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;T1=</span><span class="si">{T1_tmp}</span><span class="s1">, T2=</span><span class="si">{T2_tmp}</span><span class="s1">, M1=</span><span class="si">{M1_tmp}</span><span class="s1">, M2=</span><span class="si">{M2_tmp}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="n">T1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">T1_tmp</span><span class="p">)</span>
        <span class="n">T2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">T2_tmp</span><span class="p">)</span>
        <span class="n">M1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">M1_tmp</span><span class="p">)</span>
        <span class="n">M2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">M2_tmp</span><span class="p">)</span>
        <span class="n">params_est</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="s1">&#39;result&#39;</span><span class="p">])</span>

    <span class="n">res_dict</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;pid_obs&#39;</span><span class="p">:</span> <span class="n">pid_obs</span><span class="p">,</span>
        <span class="s1">&#39;lat_obs&#39;</span><span class="p">:</span> <span class="n">lat_obs</span><span class="p">,</span>
        <span class="s1">&#39;lon_obs&#39;</span><span class="p">:</span> <span class="n">lon_obs</span><span class="p">,</span>
        <span class="s1">&#39;elev_obs&#39;</span><span class="p">:</span> <span class="n">elev_obs</span><span class="p">,</span>
        <span class="s1">&#39;values_obs&#39;</span><span class="p">:</span> <span class="n">values_obs</span><span class="p">,</span>
        <span class="s1">&#39;T1&#39;</span><span class="p">:</span> <span class="n">T1</span><span class="p">,</span>
        <span class="s1">&#39;T2&#39;</span><span class="p">:</span> <span class="n">T2</span><span class="p">,</span>
        <span class="s1">&#39;M1&#39;</span><span class="p">:</span> <span class="n">M1</span><span class="p">,</span>
        <span class="s1">&#39;M2&#39;</span><span class="p">:</span> <span class="n">M2</span><span class="p">,</span>
        <span class="s1">&#39;params_est&#39;</span><span class="p">:</span> <span class="n">params_est</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">res_dict</span>


<span class="k">def</span> <span class="nf">est_vslite_params_from_df</span><span class="p">(</span><span class="n">df_TRW</span><span class="p">,</span> <span class="n">tas_env</span><span class="p">,</span> <span class="n">pr_env</span><span class="p">,</span> <span class="n">lat_env</span><span class="p">,</span> <span class="n">lon_env</span><span class="p">,</span> <span class="n">time_env</span><span class="p">,</span> <span class="n">latlon_ind_dict_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                              <span class="n">matlab_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">func_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">tas_bias_dict_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                              <span class="n">restart_matlab_period</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
                              <span class="n">nsamp</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">errormod</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">gparpriors</span><span class="o">=</span><span class="s1">&#39;fourbet&#39;</span><span class="p">,</span>
                              <span class="n">pt_ests</span><span class="o">=</span><span class="s1">&#39;med&#39;</span><span class="p">,</span> <span class="n">nargout</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                              <span class="n">beta_params</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">matrix</span><span class="p">([</span>
                                  <span class="p">[</span><span class="mi">9</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">9</span><span class="p">],</span>
                                  <span class="p">[</span><span class="mf">3.5</span><span class="p">,</span> <span class="mf">3.5</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">24</span><span class="p">],</span>
                                  <span class="p">[</span><span class="mf">1.5</span><span class="p">,</span> <span class="mf">2.8</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">],</span>
                                  <span class="p">[</span><span class="mf">1.5</span><span class="p">,</span> <span class="mf">2.5</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">],</span>
                              <span class="p">]),</span>
                              <span class="n">seed</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">syear</span><span class="o">=</span><span class="mi">1901</span><span class="p">,</span> <span class="n">eyear</span><span class="o">=</span><span class="mi">2001</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; Run the VSL parameter estimatino Matlab precedure</span>

<span class="sd">    Args:</span>
<span class="sd">        tas_env (3-D array): monthly surface air temperature [degC]</span>
<span class="sd">        pr_env (3-D array): monthly accumulated precipitation [mm]</span>
<span class="sd">        lat_env (1-D array): latitude dim of tas/pr</span>
<span class="sd">        lon_env (1-D array): longitude dim of tas/pr</span>
<span class="sd">        time_env (1-D array): temporal dim of tas/pr</span>
<span class="sd">        pt_ests (str): &#39;med&#39; or &#39;mle&#39;</span>
<span class="sd">        nsamp (int): the number of MCMC iterations</span>
<span class="sd">        errmod (int): 0: white noise, 1: AR(1) noise</span>
<span class="sd">        gparpriors (str): &#39;fourbet&#39;: beta distribution, &#39;uniform&#39;: uniform distribution</span>
<span class="sd">        beta_params (matrix): the beta distribution parameters for T1, T2, M1, M2</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="kn">from</span> <span class="nn">pymatbridge</span> <span class="k">import</span> <span class="n">Matlab</span>

    <span class="k">if</span> <span class="n">matlab_path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;ERROR: matlab_path must be set!&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">func_path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">root_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span>
        <span class="n">func_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root_path</span><span class="p">,</span> <span class="s1">&#39;estimate_vslite_params_v2_3.m&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">func_path</span><span class="p">)</span>

    <span class="n">lon_env</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mod</span><span class="p">(</span><span class="n">lon_env</span><span class="p">,</span> <span class="mi">360</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">tas_bias_dict_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">tas_bias_dict_path</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">tas_bias_dict</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">tas_bias_dict</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">latlon_ind_dict_path</span><span class="p">):</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">latlon_ind_dict_path</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">ind_dict</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Search nearest locations ...&#39;</span><span class="p">)</span>
        <span class="n">ind_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">df_TRW</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;#</span><span class="si">{i}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
            <span class="n">lat_obs</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;geo_meanLat&#39;</span><span class="p">]</span>
            <span class="n">lon_obs</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;geo_meanLon&#39;</span><span class="p">]</span>
            <span class="n">lon_obs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mod</span><span class="p">(</span><span class="n">lon_obs</span><span class="p">,</span> <span class="mi">360</span><span class="p">)</span>
            <span class="n">ind_id</span> <span class="o">=</span> <span class="p">(</span><span class="n">lat_obs</span><span class="p">,</span> <span class="n">lon_obs</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">ind_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ind_dict</span><span class="p">:</span>
                <span class="n">lat_ind</span><span class="p">,</span> <span class="n">lon_ind</span> <span class="o">=</span> <span class="n">find_closest_loc</span><span class="p">(</span><span class="n">lat_env</span><span class="p">,</span> <span class="n">lon_env</span><span class="p">,</span> <span class="n">lat_obs</span><span class="p">,</span> <span class="n">lon_obs</span><span class="p">)</span>
                <span class="n">ind_dict</span><span class="p">[</span><span class="n">ind_id</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">lat_ind</span><span class="p">,</span> <span class="n">lon_ind</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;Target: (</span><span class="si">{lat_obs}</span><span class="s1">, </span><span class="si">{lon_obs}</span><span class="s1">); Found: (</span><span class="si">{lat_env[lat_ind]:.2f}</span><span class="s1">, </span><span class="si">{lon_env[lon_ind]:.2f}</span><span class="s1">);&#39;</span><span class="p">)</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">latlon_ind_dict_path</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">ind_dict</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>

    <span class="n">T1</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">T2</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">M1</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">M2</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">params_est</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="c1"># run Matlab</span>
    <span class="n">mlab</span> <span class="o">=</span> <span class="n">Matlab</span><span class="p">(</span><span class="n">matlab_path</span><span class="p">)</span>
    <span class="n">mlab</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">df_TRW</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
        <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">p2k_id</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;paleoData_pages2kID&#39;</span><span class="p">]</span>
        <span class="n">lat_obs</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;geo_meanLat&#39;</span><span class="p">]</span>
        <span class="n">lon_obs</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;geo_meanLon&#39;</span><span class="p">]</span>
        <span class="n">lon_obs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mod</span><span class="p">(</span><span class="n">lon_obs</span><span class="p">,</span> <span class="mi">360</span><span class="p">)</span>
        <span class="n">elev_obs</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;geo_meanElev&#39;</span><span class="p">]</span>
        <span class="n">trw_obs</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;paleoData_values&#39;</span><span class="p">]</span>
        <span class="n">time_obs</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;year&#39;</span><span class="p">]</span>
        <span class="n">time_obs</span><span class="p">,</span> <span class="n">trw_obs</span> <span class="o">=</span> <span class="n">clean_ts</span><span class="p">(</span><span class="n">time_obs</span><span class="p">,</span> <span class="n">trw_obs</span><span class="p">)</span>
        <span class="n">lat_ind</span><span class="p">,</span> <span class="n">lon_ind</span> <span class="o">=</span> <span class="n">ind_dict</span><span class="p">[(</span><span class="n">lat_obs</span><span class="p">,</span> <span class="n">lon_obs</span><span class="p">)]</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;#</span><span class="si">{i}</span><span class="s1"> </span><span class="si">{p2k_id}</span><span class="s1"> - Target: (</span><span class="si">{lat_obs}</span><span class="s1">, </span><span class="si">{lon_obs}</span><span class="s1">); Found: (</span><span class="si">{lat_env[lat_ind]:.2f}</span><span class="s1">, </span><span class="si">{lon_env[lon_ind]:.2f}</span><span class="s1">);&#39;</span><span class="p">)</span>

        <span class="n">T</span> <span class="o">=</span> <span class="n">tas_env</span><span class="p">[:,</span> <span class="n">lat_ind</span><span class="p">,</span> <span class="n">lon_ind</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">tas_bias_dict</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">T</span> <span class="o">+=</span> <span class="n">tas_bias_dict</span><span class="p">[</span><span class="n">p2k_id</span><span class="p">]</span>

        <span class="n">P</span> <span class="o">=</span> <span class="n">pr_env</span><span class="p">[:,</span> <span class="n">lat_ind</span><span class="p">,</span> <span class="n">lon_ind</span><span class="p">]</span>

        <span class="n">trw_year</span><span class="p">,</span> <span class="n">trw_value</span> <span class="o">=</span> <span class="n">pick_range</span><span class="p">(</span><span class="n">time_obs</span><span class="p">,</span> <span class="n">trw_obs</span><span class="p">,</span> <span class="n">syear</span><span class="p">,</span> <span class="n">eyear</span><span class="p">)</span>
        <span class="n">env_year</span><span class="p">,</span> <span class="n">env_tas</span> <span class="o">=</span> <span class="n">pick_years</span><span class="p">(</span><span class="n">trw_year</span><span class="p">,</span> <span class="n">time_env</span><span class="p">,</span> <span class="n">T</span><span class="p">)</span>
        <span class="n">env_year</span><span class="p">,</span> <span class="n">env_pr</span> <span class="o">=</span> <span class="n">pick_years</span><span class="p">(</span><span class="n">trw_year</span><span class="p">,</span> <span class="n">time_env</span><span class="p">,</span> <span class="n">P</span><span class="p">)</span>
        <span class="n">nyr</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">env_year</span><span class="p">)</span><span class="o">/</span><span class="mi">12</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;</span><span class="si">{nyr}</span><span class="s1"> available years&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;Running estimate_vslite_params_v2_3.m ...&#39;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">)</span>

        <span class="c1"># restart Matlab kernel</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">mod</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">restart_matlab_period</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">mlab</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
            <span class="n">mlab</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

        <span class="n">add_samps</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">converge_flag</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">while</span> <span class="p">(</span><span class="n">converge_flag</span> <span class="o">==</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">mlab</span><span class="o">.</span><span class="n">run_func</span><span class="p">(</span>
                <span class="n">func_path</span><span class="p">,</span>
                <span class="n">env_tas</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">nyr</span><span class="p">,</span> <span class="mi">12</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">env_pr</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">nyr</span><span class="p">,</span> <span class="mi">12</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">lat_obs</span><span class="p">,</span> <span class="n">trw_value</span><span class="p">,</span>
                <span class="s1">&#39;seed&#39;</span><span class="p">,</span> <span class="n">seed</span><span class="p">,</span> <span class="s1">&#39;nsamp&#39;</span><span class="p">,</span> <span class="n">nsamp</span><span class="o">+</span><span class="n">add_samps</span><span class="p">,</span> <span class="s1">&#39;errormod&#39;</span><span class="p">,</span> <span class="n">errormod</span><span class="p">,</span>
                <span class="s1">&#39;gparpriors&#39;</span><span class="p">,</span> <span class="n">gparpriors</span><span class="p">,</span> <span class="s1">&#39;fourbetparams&#39;</span><span class="p">,</span> <span class="n">beta_params</span><span class="p">,</span>
                <span class="s1">&#39;pt_ests&#39;</span><span class="p">,</span> <span class="n">pt_ests</span><span class="p">,</span>
                <span class="n">nargout</span><span class="o">=</span><span class="n">nargout</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="n">converge_flag</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="s1">&#39;result&#39;</span><span class="p">][</span><span class="mi">9</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">converge_flag</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">add_samps</span> <span class="o">+=</span> <span class="mi">1000</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;Inference not converged. Re-running with nsamp={nsamp+add_samps} ...&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">add_samps</span> <span class="o">&gt;</span> <span class="mi">1000</span><span class="p">:</span>
            <span class="n">mlab</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
            <span class="n">mlab</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

        <span class="n">T1_tmp</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="s1">&#39;result&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">T2_tmp</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="s1">&#39;result&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">M1_tmp</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="s1">&#39;result&#39;</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">M2_tmp</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="s1">&#39;result&#39;</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;T1=</span><span class="si">{T1_tmp}</span><span class="s1">, T2=</span><span class="si">{T2_tmp}</span><span class="s1">, M1=</span><span class="si">{M1_tmp}</span><span class="s1">, M2=</span><span class="si">{M2_tmp}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="n">T1</span><span class="p">[</span><span class="n">p2k_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">T1_tmp</span>
        <span class="n">T2</span><span class="p">[</span><span class="n">p2k_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">T2_tmp</span>
        <span class="n">M1</span><span class="p">[</span><span class="n">p2k_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">M1_tmp</span>
        <span class="n">M2</span><span class="p">[</span><span class="n">p2k_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">M2_tmp</span>
        <span class="n">params_est</span><span class="p">[</span><span class="n">p2k_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="s1">&#39;result&#39;</span><span class="p">]</span>

    <span class="n">res_dict</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;T1&#39;</span><span class="p">:</span> <span class="n">T1</span><span class="p">,</span>
        <span class="s1">&#39;T2&#39;</span><span class="p">:</span> <span class="n">T2</span><span class="p">,</span>
        <span class="s1">&#39;M1&#39;</span><span class="p">:</span> <span class="n">M1</span><span class="p">,</span>
        <span class="s1">&#39;M2&#39;</span><span class="p">:</span> <span class="n">M2</span><span class="p">,</span>
        <span class="s1">&#39;params_est&#39;</span><span class="p">:</span> <span class="n">params_est</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">res_dict</span>


<span class="k">def</span> <span class="nf">est_vslite_params_single_site</span><span class="p">(</span>
    <span class="n">p2k_id</span><span class="p">,</span>
    <span class="n">tas_env</span><span class="p">,</span> <span class="n">pr_env</span><span class="p">,</span> <span class="n">lat_env</span><span class="p">,</span> <span class="n">lon_env</span><span class="p">,</span> <span class="n">time_env</span><span class="p">,</span>
    <span class="n">trw_obs</span><span class="p">,</span> <span class="n">lat_obs</span><span class="p">,</span> <span class="n">lon_obs</span><span class="p">,</span> <span class="n">time_obs</span><span class="p">,</span>
    <span class="n">matlab_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">func_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">tas_bias_dict_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">nsamp</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">errormod</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">gparpriors</span><span class="o">=</span><span class="s1">&#39;fourbet&#39;</span><span class="p">,</span>
    <span class="n">pt_ests</span><span class="o">=</span><span class="s1">&#39;med&#39;</span><span class="p">,</span> <span class="n">nargout</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
    <span class="n">beta_params</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">matrix</span><span class="p">([</span>
        <span class="p">[</span><span class="mi">9</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">9</span><span class="p">],</span>
        <span class="p">[</span><span class="mf">3.5</span><span class="p">,</span> <span class="mf">3.5</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">24</span><span class="p">],</span>
        <span class="p">[</span><span class="mf">1.5</span><span class="p">,</span> <span class="mf">2.8</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">],</span>
        <span class="p">[</span><span class="mf">1.5</span><span class="p">,</span> <span class="mf">2.5</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">],</span>
    <span class="p">]),</span>
    <span class="n">seed</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">syear</span><span class="o">=</span><span class="mi">1901</span><span class="p">,</span> <span class="n">eyear</span><span class="o">=</span><span class="mi">2001</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; Run the VSL parameter estimatino Matlab precedure</span>

<span class="sd">    Args:</span>
<span class="sd">        tas_env (1-D array): monthly surface air temperature [degC]</span>
<span class="sd">        pr_env (1-D array): monthly accumulated precipitation [mm]</span>
<span class="sd">        lat_env (float): latitude dim of tas/pr</span>
<span class="sd">        lon_env (float): longitude dim of tas/pr</span>
<span class="sd">        time_env (1-D array): temporal dim of tas/pr</span>
<span class="sd">        pt_ests (str): &#39;med&#39; or &#39;mle&#39;</span>
<span class="sd">        nsamp (int): the number of MCMC iterations</span>
<span class="sd">        errmod (int): 0: white noise, 1: AR(1) noise</span>
<span class="sd">        gparpriors (str): &#39;fourbet&#39;: beta distribution, &#39;uniform&#39;: uniform distribution</span>
<span class="sd">        beta_params (matrix): the beta distribution parameters for T1, T2, M1, M2</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="kn">from</span> <span class="nn">pymatbridge</span> <span class="k">import</span> <span class="n">Matlab</span>

    <span class="k">if</span> <span class="n">matlab_path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;ERROR: matlab_path must be set!&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">func_path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">root_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span>
        <span class="n">func_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root_path</span><span class="p">,</span> <span class="s1">&#39;estimate_vslite_params_v2_3.m&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">func_path</span><span class="p">)</span>

    <span class="n">lon_env</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mod</span><span class="p">(</span><span class="n">lon_env</span><span class="p">,</span> <span class="mi">360</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">tas_bias_dict_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">tas_bias_dict_path</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">tas_bias_dict</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">tas_bias_dict</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">if</span> <span class="n">tas_bias_dict</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">tas_env</span> <span class="o">+=</span> <span class="n">tas_bias_dict</span><span class="p">[</span><span class="n">p2k_id</span><span class="p">]</span>

    <span class="n">trw_year</span><span class="p">,</span> <span class="n">trw_value</span> <span class="o">=</span> <span class="n">pick_range</span><span class="p">(</span><span class="n">time_obs</span><span class="p">,</span> <span class="n">trw_obs</span><span class="p">,</span> <span class="n">syear</span><span class="p">,</span> <span class="n">eyear</span><span class="p">)</span>
    <span class="n">env_year</span><span class="p">,</span> <span class="n">env_tas</span> <span class="o">=</span> <span class="n">pick_years</span><span class="p">(</span><span class="n">trw_year</span><span class="p">,</span> <span class="n">time_env</span><span class="p">,</span> <span class="n">tas_env</span><span class="p">)</span>
    <span class="n">env_year</span><span class="p">,</span> <span class="n">env_pr</span> <span class="o">=</span> <span class="n">pick_years</span><span class="p">(</span><span class="n">trw_year</span><span class="p">,</span> <span class="n">time_env</span><span class="p">,</span> <span class="n">pr_env</span><span class="p">)</span>
    <span class="n">nyr</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">env_year</span><span class="p">)</span><span class="o">/</span><span class="mi">12</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;</span><span class="si">{nyr}</span><span class="s1"> available years&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;Running estimate_vslite_params_v2_3.m ...&#39;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">)</span>

    <span class="c1"># run Matlab</span>
    <span class="n">mlab</span> <span class="o">=</span> <span class="n">Matlab</span><span class="p">(</span><span class="n">matlab_path</span><span class="p">)</span>
    <span class="n">mlab</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

    <span class="n">add_samps</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">converge_flag</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">while</span> <span class="p">(</span><span class="n">converge_flag</span> <span class="o">==</span> <span class="mi">1</span><span class="p">):</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">mlab</span><span class="o">.</span><span class="n">run_func</span><span class="p">(</span>
            <span class="n">func_path</span><span class="p">,</span>
            <span class="n">env_tas</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">nyr</span><span class="p">,</span> <span class="mi">12</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">env_pr</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">nyr</span><span class="p">,</span> <span class="mi">12</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">lat_obs</span><span class="p">,</span> <span class="n">trw_value</span><span class="p">,</span>
            <span class="s1">&#39;seed&#39;</span><span class="p">,</span> <span class="n">seed</span><span class="p">,</span> <span class="s1">&#39;nsamp&#39;</span><span class="p">,</span> <span class="n">nsamp</span><span class="o">+</span><span class="n">add_samps</span><span class="p">,</span> <span class="s1">&#39;errormod&#39;</span><span class="p">,</span> <span class="n">errormod</span><span class="p">,</span>
            <span class="s1">&#39;gparpriors&#39;</span><span class="p">,</span> <span class="n">gparpriors</span><span class="p">,</span> <span class="s1">&#39;fourbetparams&#39;</span><span class="p">,</span> <span class="n">beta_params</span><span class="p">,</span>
            <span class="s1">&#39;pt_ests&#39;</span><span class="p">,</span> <span class="n">pt_ests</span><span class="p">,</span>
            <span class="n">nargout</span><span class="o">=</span><span class="n">nargout</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">converge_flag</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="s1">&#39;result&#39;</span><span class="p">][</span><span class="mi">9</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">converge_flag</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">add_samps</span> <span class="o">+=</span> <span class="mi">1000</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;Inference not converged. Re-running with nsamp={nsamp+add_samps} ...&#39;</span><span class="p">)</span>

    <span class="n">mlab</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>

    <span class="n">T1</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="s1">&#39;result&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">T2</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="s1">&#39;result&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">M1</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="s1">&#39;result&#39;</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">M2</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="s1">&#39;result&#39;</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span>
    <span class="n">params_est</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="s1">&#39;result&#39;</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;T1=</span><span class="si">{T1}</span><span class="s1">, T2=</span><span class="si">{T2}</span><span class="s1">, M1=</span><span class="si">{M1}</span><span class="s1">, M2=</span><span class="si">{M2}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="n">res_dict</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;T1&#39;</span><span class="p">:</span> <span class="n">T1</span><span class="p">,</span>
        <span class="s1">&#39;T2&#39;</span><span class="p">:</span> <span class="n">T2</span><span class="p">,</span>
        <span class="s1">&#39;M1&#39;</span><span class="p">:</span> <span class="n">M1</span><span class="p">,</span>
        <span class="s1">&#39;M2&#39;</span><span class="p">:</span> <span class="n">M2</span><span class="p">,</span>
        <span class="s1">&#39;params_est&#39;</span><span class="p">:</span> <span class="n">params_est</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">res_dict</span>


<span class="k">def</span> <span class="nf">est_vsl_params_bc</span><span class="p">(</span><span class="n">site</span><span class="p">,</span> <span class="n">latlon_ind_dict_path</span><span class="p">,</span>
                      <span class="n">tas_ref</span><span class="p">,</span> <span class="n">pr_ref</span><span class="p">,</span> <span class="n">lat_ref</span><span class="p">,</span> <span class="n">lon_ref</span><span class="p">,</span> <span class="n">time_ref</span><span class="p">,</span>
                      <span class="n">p_bar</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span>
                      <span class="n">matlab_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">func_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                      <span class="n">nsamp</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">errormod</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">gparpriors</span><span class="o">=</span><span class="s1">&#39;fourbet&#39;</span><span class="p">,</span>
                      <span class="n">pt_ests</span><span class="o">=</span><span class="s1">&#39;med&#39;</span><span class="p">,</span> <span class="n">nargout</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                      <span class="n">beta_params</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">matrix</span><span class="p">([</span>
                          <span class="p">[</span><span class="mi">9</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">9</span><span class="p">],</span>
                          <span class="p">[</span><span class="mf">3.5</span><span class="p">,</span> <span class="mf">3.5</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">24</span><span class="p">],</span>
                          <span class="p">[</span><span class="mf">1.5</span><span class="p">,</span> <span class="mf">2.8</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">],</span>
                          <span class="p">[</span><span class="mf">1.5</span><span class="p">,</span> <span class="mf">2.5</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">],</span>
                      <span class="p">]),</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>

    <span class="n">p2k_id</span> <span class="o">=</span> <span class="n">site</span><span class="p">[</span><span class="s1">&#39;paleoData_pages2kID&#39;</span><span class="p">]</span>
    <span class="n">trw_obs</span> <span class="o">=</span> <span class="n">site</span><span class="p">[</span><span class="s1">&#39;paleoData_values&#39;</span><span class="p">]</span>
    <span class="n">time_obs</span> <span class="o">=</span> <span class="n">site</span><span class="p">[</span><span class="s1">&#39;year&#39;</span><span class="p">]</span>
    <span class="n">lat_obs</span> <span class="o">=</span> <span class="n">site</span><span class="p">[</span><span class="s1">&#39;geo_meanLat&#39;</span><span class="p">]</span>
    <span class="n">lon_obs</span> <span class="o">=</span> <span class="n">site</span><span class="p">[</span><span class="s1">&#39;geo_meanLon&#39;</span><span class="p">]</span>
    <span class="n">lon_obs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mod</span><span class="p">(</span><span class="n">lon_obs</span><span class="p">,</span> <span class="mi">360</span><span class="p">)</span>
    <span class="n">time_obs</span><span class="p">,</span> <span class="n">trw_obs</span> <span class="o">=</span> <span class="n">clean_ts</span><span class="p">(</span><span class="n">time_obs</span><span class="p">,</span> <span class="n">trw_obs</span><span class="p">)</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">latlon_ind_dict_path</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">ind_dict</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

    <span class="n">lat_ind</span><span class="p">,</span> <span class="n">lon_ind</span> <span class="o">=</span> <span class="n">ind_dict</span><span class="p">[(</span><span class="n">lat_obs</span><span class="p">,</span> <span class="n">lon_obs</span><span class="p">)]</span>
    <span class="n">lat_env</span> <span class="o">=</span> <span class="n">lat_ref</span><span class="p">[</span><span class="n">lat_ind</span><span class="p">]</span>
    <span class="n">lon_env</span> <span class="o">=</span> <span class="n">lon_ref</span><span class="p">[</span><span class="n">lon_ind</span><span class="p">]</span>
    <span class="n">time_env</span> <span class="o">=</span> <span class="n">time_ref</span>

    <span class="n">tas_env</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">tas_ref</span><span class="p">[:,</span> <span class="n">lat_ind</span><span class="p">,</span> <span class="n">lon_ind</span><span class="p">])</span>
    <span class="n">pr_env</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">pr_ref</span><span class="p">[:,</span> <span class="n">lat_ind</span><span class="p">,</span> <span class="n">lon_ind</span><span class="p">])</span>

    <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;&gt;&gt;&gt; ID: </span><span class="si">{p2k_id}</span><span class="s1"> - Target: (</span><span class="si">{lat_obs}</span><span class="s1">, </span><span class="si">{lon_obs}</span><span class="s1">); Found: (</span><span class="si">{lat_env:.2f}</span><span class="s1">, </span><span class="si">{lon_env:.2f}</span><span class="s1">);&#39;</span><span class="p">)</span>

    <span class="c1"># loop</span>
    <span class="n">T_bias</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="n">loop_flag</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">dec_times</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="n">loop_flag</span> <span class="ow">is</span> <span class="kc">True</span> <span class="ow">and</span> <span class="n">dec_times</span> <span class="o">&lt;=</span> <span class="mi">3</span><span class="p">:</span>
        <span class="n">vsl_params</span> <span class="o">=</span> <span class="n">est_vslite_params_single_site</span><span class="p">(</span>
            <span class="n">p2k_id</span><span class="p">,</span> <span class="n">tas_env</span><span class="p">,</span> <span class="n">pr_env</span><span class="p">,</span> <span class="n">lat_env</span><span class="p">,</span> <span class="n">lon_env</span><span class="p">,</span> <span class="n">time_env</span><span class="p">,</span>
            <span class="n">trw_obs</span><span class="p">,</span> <span class="n">lat_obs</span><span class="p">,</span> <span class="n">lon_obs</span><span class="p">,</span> <span class="n">time_obs</span><span class="p">,</span>
            <span class="n">matlab_path</span><span class="o">=</span><span class="n">matlab_path</span><span class="p">,</span> <span class="n">func_path</span><span class="o">=</span><span class="n">func_path</span><span class="p">,</span>
            <span class="n">nsamp</span><span class="o">=</span><span class="n">nsamp</span><span class="p">,</span> <span class="n">errormod</span><span class="o">=</span><span class="n">errormod</span><span class="p">,</span> <span class="n">gparpriors</span><span class="o">=</span><span class="n">gparpriors</span><span class="p">,</span>
            <span class="n">pt_ests</span><span class="o">=</span><span class="n">pt_ests</span><span class="p">,</span> <span class="n">nargout</span><span class="o">=</span><span class="n">nargout</span><span class="p">,</span>
            <span class="n">beta_params</span><span class="o">=</span><span class="n">beta_params</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>

        <span class="n">T1</span> <span class="o">=</span> <span class="n">vsl_params</span><span class="p">[</span><span class="s1">&#39;T1&#39;</span><span class="p">]</span>
        <span class="n">T2</span> <span class="o">=</span> <span class="n">vsl_params</span><span class="p">[</span><span class="s1">&#39;T2&#39;</span><span class="p">]</span>

        <span class="n">tas_med</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmedian</span><span class="p">(</span><span class="n">tas_env</span><span class="p">)</span>
        <span class="n">T_within</span> <span class="o">=</span> <span class="n">tas_env</span><span class="p">[(</span><span class="n">tas_env</span><span class="o">&gt;=</span><span class="n">T1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">tas_env</span><span class="o">&lt;=</span><span class="n">T2</span><span class="p">)]</span>
        <span class="n">percentage</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">T_within</span><span class="p">)</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">tas_env</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">percentage</span> <span class="o">&gt;=</span> <span class="n">p_bar</span><span class="p">:</span>
            <span class="c1"># stop loop</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;&gt;&gt;&gt; T1: </span><span class="si">{T1:.2f}</span><span class="s1">, T2: </span><span class="si">{T2:.2f}</span><span class="s1">, median(tas_env): </span><span class="si">{tas_med:.2f}</span><span class="s1">, percentage: </span><span class="si">{percentage:.2f}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">loop_flag</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># bias</span>
            <span class="c1"># correction</span>
            <span class="k">if</span> <span class="n">tas_med</span> <span class="o">&gt;</span> <span class="n">T2</span><span class="p">:</span>
                <span class="n">delta_T</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
            <span class="k">elif</span> <span class="n">tas_med</span> <span class="o">&lt;</span> <span class="n">T1</span><span class="p">:</span>
                <span class="n">delta_T</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># skip</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;&gt;&gt;&gt; T1: </span><span class="si">{T1:.2f}</span><span class="s1">, T2: </span><span class="si">{T2:.2f}</span><span class="s1">, median(tas_env): </span><span class="si">{tas_med:.2f}</span><span class="s1">, percentage: </span><span class="si">{percentage:.2f}</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="n">loop_flag</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">continue</span>

            <span class="k">while</span> <span class="n">percentage</span> <span class="o">&lt;</span> <span class="n">p_bar</span><span class="p">:</span>
                <span class="n">p_last</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">percentage</span><span class="p">)</span>
                <span class="n">T_within</span> <span class="o">=</span> <span class="n">tas_env</span><span class="p">[(</span><span class="n">tas_env</span><span class="o">&gt;=</span><span class="n">T1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">tas_env</span><span class="o">&lt;=</span><span class="n">T2</span><span class="p">)]</span>
                <span class="n">percentage</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">T_within</span><span class="p">)</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">tas_env</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;&gt;&gt;&gt; T1: </span><span class="si">{T1:.2f}</span><span class="s1">, T2: </span><span class="si">{T2:.2f}</span><span class="s1">, median(tas_env): {np.nanmedian(tas_env):.2f}, percentage: </span><span class="si">{percentage:.2f}</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">percentage</span> <span class="o">&lt;</span> <span class="n">p_last</span><span class="p">:</span>
                    <span class="n">dec_times</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">tas_env</span> <span class="o">-=</span> <span class="n">delta_T</span>
                    <span class="n">T_bias</span> <span class="o">-=</span> <span class="n">delta_T</span>
                    <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;&gt;&gt;&gt; percentage is decreasing, break; finalize median(tas_env): {np.nanmedian(tas_env):.2f}&#39;</span><span class="p">)</span>
                    <span class="k">break</span>
                <span class="k">if</span> <span class="n">percentage</span> <span class="o">&lt;</span> <span class="n">p_bar</span><span class="p">:</span>
                    <span class="n">tas_old</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">tas_env</span><span class="p">)</span>
                    <span class="n">tas_env</span> <span class="o">+=</span> <span class="n">delta_T</span>
                    <span class="n">T_bias</span> <span class="o">+=</span> <span class="n">delta_T</span>
                    <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;&gt;&gt;&gt; median(tas_env): {np.nanmedian(tas_old):.2f} -&gt; {np.nanmedian(tas_env):.2f}&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">vsl_params</span><span class="p">,</span> <span class="n">T_bias</span>


<span class="k">def</span> <span class="nf">calibrate_psm</span><span class="p">(</span>
    <span class="n">proxy_manager</span><span class="p">,</span> <span class="n">ptypes</span><span class="p">,</span> <span class="n">psm_name</span><span class="p">,</span>
    <span class="n">precalc_avg</span><span class="p">,</span>
    <span class="n">ref_period</span><span class="o">=</span><span class="p">[</span><span class="mi">1951</span><span class="p">,</span> <span class="mi">1980</span><span class="p">],</span>
    <span class="n">calib_period</span><span class="o">=</span><span class="p">[</span><span class="mi">1850</span><span class="p">,</span> <span class="mi">2015</span><span class="p">],</span>
    <span class="n">seasonality</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;Tree Rings_WidthBreit&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s1">&#39;seasons_T&#39;</span><span class="p">:</span> <span class="p">[[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">11</span><span class="p">,</span><span class="mi">12</span><span class="p">],[</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">],[</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">],[</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">11</span><span class="p">],[</span><span class="o">-</span><span class="mi">12</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">],[</span><span class="o">-</span><span class="mi">9</span><span class="p">,</span><span class="o">-</span><span class="mi">10</span><span class="p">,</span><span class="o">-</span><span class="mi">11</span><span class="p">,</span><span class="o">-</span><span class="mi">12</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">],[</span><span class="o">-</span><span class="mi">12</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">]],</span>
            <span class="s1">&#39;seasons_M&#39;</span><span class="p">:</span> <span class="p">[[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">11</span><span class="p">,</span><span class="mi">12</span><span class="p">],[</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">],[</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">],[</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">11</span><span class="p">],[</span><span class="o">-</span><span class="mi">12</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">],[</span><span class="o">-</span><span class="mi">9</span><span class="p">,</span><span class="o">-</span><span class="mi">10</span><span class="p">,</span><span class="o">-</span><span class="mi">11</span><span class="p">,</span><span class="o">-</span><span class="mi">12</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">],[</span><span class="o">-</span><span class="mi">12</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">]],</span>
        <span class="p">},</span>
        <span class="s1">&#39;Tree Rings_WidthPages2&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s1">&#39;seasons_T&#39;</span><span class="p">:</span> <span class="p">[[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">11</span><span class="p">,</span><span class="mi">12</span><span class="p">],[</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">],[</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">],[</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">11</span><span class="p">],[</span><span class="o">-</span><span class="mi">12</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">],[</span><span class="o">-</span><span class="mi">9</span><span class="p">,</span><span class="o">-</span><span class="mi">10</span><span class="p">,</span><span class="o">-</span><span class="mi">11</span><span class="p">,</span><span class="o">-</span><span class="mi">12</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">],[</span><span class="o">-</span><span class="mi">12</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">]],</span>
            <span class="s1">&#39;seasons_M&#39;</span><span class="p">:</span> <span class="p">[[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">11</span><span class="p">,</span><span class="mi">12</span><span class="p">],[</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">],[</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">],[</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">11</span><span class="p">],[</span><span class="o">-</span><span class="mi">12</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">],[</span><span class="o">-</span><span class="mi">9</span><span class="p">,</span><span class="o">-</span><span class="mi">10</span><span class="p">,</span><span class="o">-</span><span class="mi">11</span><span class="p">,</span><span class="o">-</span><span class="mi">12</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">],[</span><span class="o">-</span><span class="mi">12</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">]],</span>
        <span class="p">},</span>
        <span class="s1">&#39;Tree Rings_WoodDensity&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s1">&#39;seasons_T&#39;</span><span class="p">:</span> <span class="p">[[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">11</span><span class="p">,</span><span class="mi">12</span><span class="p">],[</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">],[</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">],[</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">11</span><span class="p">],[</span><span class="o">-</span><span class="mi">12</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">],[</span><span class="o">-</span><span class="mi">9</span><span class="p">,</span><span class="o">-</span><span class="mi">10</span><span class="p">,</span><span class="o">-</span><span class="mi">11</span><span class="p">,</span><span class="o">-</span><span class="mi">12</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">],[</span><span class="o">-</span><span class="mi">12</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">]],</span>
            <span class="s1">&#39;seasons_M&#39;</span><span class="p">:</span> <span class="p">[[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">11</span><span class="p">,</span><span class="mi">12</span><span class="p">],[</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">],[</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">],[</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">11</span><span class="p">],[</span><span class="o">-</span><span class="mi">12</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">],[</span><span class="o">-</span><span class="mi">9</span><span class="p">,</span><span class="o">-</span><span class="mi">10</span><span class="p">,</span><span class="o">-</span><span class="mi">11</span><span class="p">,</span><span class="o">-</span><span class="mi">12</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">],[</span><span class="o">-</span><span class="mi">12</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">]]},</span>
        <span class="s1">&#39;Tree Rings_Isotopes&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s1">&#39;seasons_T&#39;</span><span class="p">:</span> <span class="p">[[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">11</span><span class="p">,</span><span class="mi">12</span><span class="p">],[</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">],[</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">],[</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">11</span><span class="p">],[</span><span class="o">-</span><span class="mi">12</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">],[</span><span class="o">-</span><span class="mi">9</span><span class="p">,</span><span class="o">-</span><span class="mi">10</span><span class="p">,</span><span class="o">-</span><span class="mi">11</span><span class="p">,</span><span class="o">-</span><span class="mi">12</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">],[</span><span class="o">-</span><span class="mi">12</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">]],</span>
            <span class="s1">&#39;seasons_M&#39;</span><span class="p">:</span> <span class="p">[[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">11</span><span class="p">,</span><span class="mi">12</span><span class="p">],[</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">],[</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">],[</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">11</span><span class="p">],[</span><span class="o">-</span><span class="mi">12</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">],[</span><span class="o">-</span><span class="mi">9</span><span class="p">,</span><span class="o">-</span><span class="mi">10</span><span class="p">,</span><span class="o">-</span><span class="mi">11</span><span class="p">,</span><span class="o">-</span><span class="mi">12</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">],[</span><span class="o">-</span><span class="mi">12</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">]],</span>
        <span class="p">},</span>
    <span class="p">},</span> <span class="n">nproc</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">nobs_lb</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">output_optimal_reg</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; Calibrate linear/bilinear PSMs</span>

<span class="sd">    Args:</span>
<span class="sd">        proxy_manager (namedtuple): the proxy_manager</span>
<span class="sd">        ptypes (list of str): the list of proxy types</span>
<span class="sd">        psm_name (str): &#39;linear&#39; or &#39;bilinear&#39;</span>
<span class="sd">        precalc_avg (dict): the dict that stores the seasonal-averaged environmental variables</span>
<span class="sd">        seasonality (dict): the seasonality information for each proxy type</span>

<span class="sd">    Returns:</span>
<span class="sd">        precalib_dict (dict): a dict that stores the calibration information</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">var_names</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;linear&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">],</span>
        <span class="s1">&#39;bilinear&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">,</span> <span class="s1">&#39;M&#39;</span><span class="p">],</span>
    <span class="p">}</span>

    <span class="c1"># loop over proxy records</span>
    <span class="n">precalib_dict</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="n">ref_var</span><span class="p">,</span> <span class="n">ref_time</span><span class="p">,</span> <span class="n">ref_lat</span><span class="p">,</span> <span class="n">ref_lon</span> <span class="o">=</span> <span class="p">{},</span> <span class="p">{},</span> <span class="p">{},</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">var_name</span> <span class="ow">in</span> <span class="n">var_names</span><span class="p">[</span><span class="n">psm_name</span><span class="p">]:</span>
        <span class="n">ref_var</span><span class="p">[</span><span class="n">var_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">precalc_avg</span><span class="p">[</span><span class="n">var_name</span><span class="p">][</span><span class="s1">&#39;var_ann_dict&#39;</span><span class="p">]</span>
        <span class="n">ref_time</span><span class="p">[</span><span class="n">var_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">precalc_avg</span><span class="p">[</span><span class="n">var_name</span><span class="p">][</span><span class="s1">&#39;year_ann&#39;</span><span class="p">]</span>
        <span class="n">ref_lat</span><span class="p">[</span><span class="n">var_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">precalc_avg</span><span class="p">[</span><span class="n">var_name</span><span class="p">][</span><span class="s1">&#39;lat&#39;</span><span class="p">]</span>
        <span class="n">ref_lon</span><span class="p">[</span><span class="n">var_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">precalc_avg</span><span class="p">[</span><span class="n">var_name</span><span class="p">][</span><span class="s1">&#39;lon&#39;</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">func_wrapper</span><span class="p">(</span><span class="n">pobj</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">total_n</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;pid={os.getpid()} &gt;&gt;&gt; {idx+1}/</span><span class="si">{total_n}</span><span class="s1">: </span><span class="si">{pobj.id}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">pobj</span><span class="o">.</span><span class="n">type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ptypes</span><span class="p">:</span>
            <span class="c1"># PSM not available; skip</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">The proxy type </span><span class="si">{pobj.type}</span><span class="s1"> is not in specified types: </span><span class="si">{ptypes}</span><span class="s1">. Skipping ...&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># PSM available</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Processing </span><span class="si">{pobj.id}</span><span class="s1">, </span><span class="si">{pobj.type}</span><span class="s1"> ...&#39;</span><span class="p">)</span>

            <span class="n">seasons</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">ref_value</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">var_name</span> <span class="ow">in</span> <span class="n">var_names</span><span class="p">[</span><span class="n">psm_name</span><span class="p">]:</span>
                <span class="c1"># find the reference data closest to the proxy location</span>
                <span class="n">lat_ind</span><span class="p">,</span> <span class="n">lon_ind</span> <span class="o">=</span> <span class="n">find_closest_loc</span><span class="p">(</span><span class="n">ref_lat</span><span class="p">[</span><span class="n">var_name</span><span class="p">],</span> <span class="n">ref_lon</span><span class="p">[</span><span class="n">var_name</span><span class="p">],</span> <span class="n">pobj</span><span class="o">.</span><span class="n">lat</span><span class="p">,</span> <span class="n">pobj</span><span class="o">.</span><span class="n">lon</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;latlon&#39;</span><span class="p">)</span>
                <span class="c1">#  dist = get_distance(pobj.lon, pobj.lat, ref_lon[var_name], ref_lat[var_name])</span>
                <span class="c1">#  lat_idx, lon_idx = np.unravel_index(dist.argmin(), dist.shape)</span>

                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;&gt;&gt;&gt; Target: (</span><span class="si">{pobj.lat}</span><span class="s1">, </span><span class="si">{pobj.lon}</span><span class="s1">); Found: (</span><span class="si">{ref_lat[var_name][lat_ind]:.2f}</span><span class="s1">, </span><span class="si">{ref_lon[var_name][lon_ind]:.2f}</span><span class="s1">)&#39;</span><span class="p">)</span>

                <span class="c1"># load seasons for each variable</span>
                <span class="k">if</span> <span class="n">pobj</span><span class="o">.</span><span class="n">type</span> <span class="ow">in</span> <span class="n">seasonality</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="n">seasons</span><span class="p">[</span><span class="n">var_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">seasonality</span><span class="p">[</span><span class="n">pobj</span><span class="o">.</span><span class="n">type</span><span class="p">][</span><span class="n">f</span><span class="s1">&#39;seasons_</span><span class="si">{var_name}</span><span class="s1">&#39;</span><span class="p">]</span>
                    <span class="n">meta_season_in_list</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">for</span> <span class="n">avgMonths</span> <span class="ow">in</span> <span class="n">seasons</span><span class="p">[</span><span class="n">var_name</span><span class="p">]:</span>
                        <span class="k">if</span> <span class="nb">list</span><span class="p">(</span><span class="n">pobj</span><span class="o">.</span><span class="n">seasonality</span><span class="p">)</span> <span class="o">==</span> <span class="n">avgMonths</span><span class="p">:</span>
                            <span class="n">meta_season_in_list</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="k">break</span>

                    <span class="k">if</span> <span class="n">meta_season_in_list</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
                        <span class="n">seasons</span><span class="p">[</span><span class="n">var_name</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">pobj</span><span class="o">.</span><span class="n">seasonality</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">seasons</span><span class="p">[</span><span class="n">var_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">pobj</span><span class="o">.</span><span class="n">seasonality</span><span class="p">)]</span>

                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;seasons[</span><span class="si">{var_name}</span><span class="s1">]:&#39;</span><span class="p">,</span> <span class="n">seasons</span><span class="p">[</span><span class="n">var_name</span><span class="p">])</span>

                <span class="n">ref_value</span><span class="p">[</span><span class="n">var_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">for</span> <span class="n">season</span><span class="p">,</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">ref_var</span><span class="p">[</span><span class="n">var_name</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="n">ref_value</span><span class="p">[</span><span class="n">var_name</span><span class="p">][</span><span class="n">season</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">[:,</span> <span class="n">lat_ind</span><span class="p">,</span> <span class="n">lon_ind</span><span class="p">]</span>

            <span class="n">pobj_time_int</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">pobj</span><span class="o">.</span><span class="n">time</span><span class="p">])</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">pobj_time_int</span> <span class="o">&gt;=</span> <span class="n">calib_period</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">pobj_time_int</span> <span class="o">&lt;=</span> <span class="n">calib_period</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="c1"># test each season combination and find the optimal one</span>
            <span class="k">if</span> <span class="n">psm_name</span> <span class="o">==</span> <span class="s1">&#39;linear&#39;</span><span class="p">:</span>
                <span class="n">var_name</span> <span class="o">=</span> <span class="n">var_names</span><span class="p">[</span><span class="n">psm_name</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">optimal_seasonality</span><span class="p">,</span> <span class="n">optimal_reg</span> <span class="o">=</span> <span class="n">linear_regression</span><span class="p">(</span>
                    <span class="n">pobj</span><span class="o">.</span><span class="n">time</span><span class="p">[</span><span class="n">mask</span><span class="p">],</span> <span class="n">pobj</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">mask</span><span class="p">],</span>
                    <span class="n">ref_time</span><span class="p">[</span><span class="n">var_name</span><span class="p">],</span> <span class="n">ref_value</span><span class="p">[</span><span class="n">var_name</span><span class="p">],</span> <span class="n">seasons</span><span class="p">[</span><span class="n">var_name</span><span class="p">],</span>
                    <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span> <span class="n">nobs_lb</span><span class="o">=</span><span class="n">nobs_lb</span><span class="p">,</span>
                <span class="p">)</span>

                <span class="k">if</span> <span class="n">optimal_reg</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="c1"># not enough data for regression; skip</span>
                    <span class="k">return</span> <span class="kc">None</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">t1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">t2</span><span class="p">,</span> <span class="n">y2</span> <span class="o">=</span> <span class="n">overlap_ts</span><span class="p">(</span><span class="n">pobj</span><span class="o">.</span><span class="n">time</span><span class="p">[</span><span class="n">mask</span><span class="p">],</span> <span class="n">pobj</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">mask</span><span class="p">],</span> <span class="n">optimal_reg</span><span class="o">.</span><span class="n">resid</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">optimal_reg</span><span class="o">.</span><span class="n">resid</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
                    <span class="n">std_ye</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">optimal_reg</span><span class="o">.</span><span class="n">predict</span><span class="p">())</span>
                    <span class="n">std_resid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">optimal_reg</span><span class="o">.</span><span class="n">resid</span><span class="p">)</span>
                    <span class="n">SNR</span> <span class="o">=</span> <span class="n">std_ye</span> <span class="o">/</span> <span class="n">std_resid</span>
                    <span class="n">precalib_dict_pobj</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="s1">&#39;lat&#39;</span><span class="p">:</span> <span class="n">pobj</span><span class="o">.</span><span class="n">lat</span><span class="p">,</span>
                        <span class="s1">&#39;lon&#39;</span><span class="p">:</span> <span class="n">pobj</span><span class="o">.</span><span class="n">lon</span><span class="p">,</span>
                        <span class="s1">&#39;elev&#39;</span><span class="p">:</span> <span class="n">pobj</span><span class="o">.</span><span class="n">elev</span><span class="p">,</span>
                        <span class="s1">&#39;Seasonality&#39;</span><span class="p">:</span> <span class="n">optimal_seasonality</span><span class="p">,</span>
                        <span class="s1">&#39;NbCalPts&#39;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">optimal_reg</span><span class="o">.</span><span class="n">nobs</span><span class="p">),</span>
                        <span class="s1">&#39;PSMintercept&#39;</span><span class="p">:</span> <span class="n">optimal_reg</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                        <span class="s1">&#39;PSMslope&#39;</span><span class="p">:</span> <span class="n">optimal_reg</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                        <span class="s1">&#39;PSMcorrel&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">optimal_reg</span><span class="o">.</span><span class="n">rsquared</span><span class="p">),</span>
                        <span class="s1">&#39;PSMmse&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">optimal_reg</span><span class="o">.</span><span class="n">resid</span><span class="o">**</span><span class="mi">2</span><span class="p">),</span>
                        <span class="s1">&#39;fitAIC&#39;</span><span class="p">:</span> <span class="n">optimal_reg</span><span class="o">.</span><span class="n">aic</span><span class="p">,</span>
                        <span class="s1">&#39;fitBIC&#39;</span><span class="p">:</span> <span class="n">optimal_reg</span><span class="o">.</span><span class="n">bic</span><span class="p">,</span>
                        <span class="s1">&#39;fitR2adj&#39;</span><span class="p">:</span> <span class="n">optimal_reg</span><span class="o">.</span><span class="n">rsquared_adj</span><span class="p">,</span>
                        <span class="s1">&#39;PSMresid&#39;</span><span class="p">:</span> <span class="n">optimal_reg</span><span class="o">.</span><span class="n">resid</span><span class="p">,</span>
                        <span class="s1">&#39;SNR&#39;</span><span class="p">:</span> <span class="n">SNR</span><span class="p">,</span>
                    <span class="p">}</span>

                    <span class="k">if</span> <span class="n">output_optimal_reg</span><span class="p">:</span>
                        <span class="n">precalib_dict_pobj</span><span class="p">[</span><span class="s1">&#39;optimal_reg&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">optimal_reg</span>

                    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                        <span class="n">pprint</span><span class="p">(</span><span class="n">precalib_dict_pobj</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">psm_name</span> <span class="o">==</span> <span class="s1">&#39;bilinear&#39;</span><span class="p">:</span>
                <span class="n">var_name_1</span> <span class="o">=</span> <span class="n">var_names</span><span class="p">[</span><span class="n">psm_name</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">var_name_2</span> <span class="o">=</span> <span class="n">var_names</span><span class="p">[</span><span class="n">psm_name</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>

                <span class="n">optimal_seasonality_1</span><span class="p">,</span> <span class="n">optimal_seasonality_2</span><span class="p">,</span> <span class="n">optimal_reg</span> <span class="o">=</span> <span class="n">bilinear_regression</span><span class="p">(</span>
                    <span class="n">pobj</span><span class="o">.</span><span class="n">time</span><span class="p">[</span><span class="n">mask</span><span class="p">],</span> <span class="n">pobj</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">mask</span><span class="p">],</span>
                    <span class="n">ref_time</span><span class="p">[</span><span class="n">var_name_1</span><span class="p">],</span> <span class="n">ref_value</span><span class="p">[</span><span class="n">var_name_1</span><span class="p">],</span> <span class="n">seasons</span><span class="p">[</span><span class="n">var_name_1</span><span class="p">],</span>
                    <span class="n">ref_time</span><span class="p">[</span><span class="n">var_name_2</span><span class="p">],</span> <span class="n">ref_value</span><span class="p">[</span><span class="n">var_name_2</span><span class="p">],</span> <span class="n">seasons</span><span class="p">[</span><span class="n">var_name_2</span><span class="p">],</span>
                    <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span> <span class="n">nobs_lb</span><span class="o">=</span><span class="n">nobs_lb</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">optimal_reg</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="c1"># not enough data for regression; skip</span>
                    <span class="k">return</span> <span class="kc">None</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">t1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">t2</span><span class="p">,</span> <span class="n">y2</span> <span class="o">=</span> <span class="n">overlap_ts</span><span class="p">(</span><span class="n">pobj</span><span class="o">.</span><span class="n">time</span><span class="p">[</span><span class="n">mask</span><span class="p">],</span> <span class="n">pobj</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">mask</span><span class="p">],</span> <span class="n">optimal_reg</span><span class="o">.</span><span class="n">resid</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">optimal_reg</span><span class="o">.</span><span class="n">resid</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
                    <span class="n">std_ye</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">optimal_reg</span><span class="o">.</span><span class="n">predict</span><span class="p">())</span>
                    <span class="n">std_resid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">optimal_reg</span><span class="o">.</span><span class="n">resid</span><span class="p">)</span>
                    <span class="n">SNR</span> <span class="o">=</span> <span class="n">std_ye</span> <span class="o">/</span> <span class="n">std_resid</span>
                    <span class="n">precalib_dict_pobj</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="s1">&#39;lat&#39;</span><span class="p">:</span> <span class="n">pobj</span><span class="o">.</span><span class="n">lat</span><span class="p">,</span>
                        <span class="s1">&#39;lon&#39;</span><span class="p">:</span> <span class="n">pobj</span><span class="o">.</span><span class="n">lon</span><span class="p">,</span>
                        <span class="s1">&#39;elev&#39;</span><span class="p">:</span> <span class="n">pobj</span><span class="o">.</span><span class="n">elev</span><span class="p">,</span>
                        <span class="n">f</span><span class="s1">&#39;Seasonality&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">optimal_seasonality_1</span><span class="p">,</span> <span class="n">optimal_seasonality_2</span><span class="p">),</span>
                        <span class="s1">&#39;NbCalPts&#39;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">optimal_reg</span><span class="o">.</span><span class="n">nobs</span><span class="p">),</span>
                        <span class="s1">&#39;PSMintercept&#39;</span><span class="p">:</span> <span class="n">optimal_reg</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                        <span class="n">f</span><span class="s1">&#39;PSMslope_temperature&#39;</span><span class="p">:</span> <span class="n">optimal_reg</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                        <span class="n">f</span><span class="s1">&#39;PSMslope_moisture&#39;</span><span class="p">:</span> <span class="n">optimal_reg</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
                        <span class="s1">&#39;PSMcorrel&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">optimal_reg</span><span class="o">.</span><span class="n">rsquared</span><span class="p">),</span>
                        <span class="s1">&#39;PSMmse&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">optimal_reg</span><span class="o">.</span><span class="n">resid</span><span class="o">**</span><span class="mi">2</span><span class="p">),</span>
                        <span class="s1">&#39;fitAIC&#39;</span><span class="p">:</span> <span class="n">optimal_reg</span><span class="o">.</span><span class="n">aic</span><span class="p">,</span>
                        <span class="s1">&#39;fitBIC&#39;</span><span class="p">:</span> <span class="n">optimal_reg</span><span class="o">.</span><span class="n">bic</span><span class="p">,</span>
                        <span class="s1">&#39;fitR2adj&#39;</span><span class="p">:</span> <span class="n">optimal_reg</span><span class="o">.</span><span class="n">rsquared_adj</span><span class="p">,</span>
                        <span class="s1">&#39;PSMresid&#39;</span><span class="p">:</span> <span class="n">optimal_reg</span><span class="o">.</span><span class="n">resid</span><span class="p">,</span>
                        <span class="s1">&#39;SNR&#39;</span><span class="p">:</span> <span class="n">SNR</span><span class="p">,</span>
                    <span class="p">}</span>

                    <span class="k">if</span> <span class="n">output_optimal_reg</span><span class="p">:</span>
                        <span class="n">precalib_dict_pobj</span><span class="p">[</span><span class="s1">&#39;optimal_reg&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">optimal_reg</span>

                    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                        <span class="n">pprint</span><span class="p">(</span><span class="n">precalib_dict_pobj</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">precalib_dict_pobj</span>

    <span class="k">if</span> <span class="n">nproc</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">Pool</span><span class="p">(</span><span class="n">nproc</span><span class="p">)</span> <span class="k">as</span> <span class="n">pool</span><span class="p">:</span>
            <span class="n">nproxies</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">proxy_manager</span><span class="o">.</span><span class="n">all_proxies</span><span class="p">)</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">nproxies</span><span class="p">)</span>
            <span class="n">total_n</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">nproxies</span><span class="p">)</span><span class="o">*</span><span class="n">nproxies</span><span class="p">]</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">pool</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">func_wrapper</span><span class="p">,</span> <span class="n">proxy_manager</span><span class="o">.</span><span class="n">all_proxies</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">total_n</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">pobj</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">proxy_manager</span><span class="o">.</span><span class="n">all_proxies</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">res</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">precalib_dict</span><span class="p">[(</span><span class="n">pobj</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="n">pobj</span><span class="o">.</span><span class="n">id</span><span class="p">)]</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">total_n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">proxy_manager</span><span class="o">.</span><span class="n">all_proxies</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">pobj</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">proxy_manager</span><span class="o">.</span><span class="n">all_proxies</span><span class="p">):</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">func_wrapper</span><span class="p">(</span><span class="n">pobj</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">total_n</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">res</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">precalib_dict</span><span class="p">[(</span><span class="n">pobj</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="n">pobj</span><span class="o">.</span><span class="n">id</span><span class="p">)]</span> <span class="o">=</span> <span class="n">res</span>

    <span class="k">return</span> <span class="n">precalib_dict</span>


<span class="k">def</span> <span class="nf">linear_regression</span><span class="p">(</span><span class="n">proxy_time</span><span class="p">,</span> <span class="n">proxy_value</span><span class="p">,</span> <span class="n">ref_time</span><span class="p">,</span> <span class="n">ref_value</span><span class="p">,</span> <span class="n">seasons</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">nobs_lb</span><span class="o">=</span><span class="mi">25</span><span class="p">):</span>
    <span class="n">metric_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">reg_res_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">df_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">avgMonths</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">seasons</span><span class="p">):</span>
        <span class="n">season_tag</span> <span class="o">=</span> <span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">m</span><span class="p">)</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">avgMonths</span><span class="p">)</span>
        <span class="n">ref_var_avg</span> <span class="o">=</span> <span class="n">ref_value</span><span class="p">[</span><span class="n">season_tag</span><span class="p">]</span>
        <span class="n">yr_ann</span> <span class="o">=</span> <span class="n">ref_time</span>

        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;time&#39;</span><span class="p">:</span> <span class="n">proxy_time</span><span class="p">,</span> <span class="s1">&#39;Proxy&#39;</span><span class="p">:</span> <span class="n">proxy_value</span><span class="p">})</span>
        <span class="n">frame</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;time&#39;</span><span class="p">:</span> <span class="n">yr_ann</span><span class="p">,</span> <span class="s1">&#39;Temperature&#39;</span><span class="p">:</span> <span class="n">ref_var_avg</span><span class="p">})</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;outer&#39;</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s1">&#39;time&#39;</span><span class="p">)</span>
        <span class="n">df</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">,</span> <span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">df</span><span class="o">.</span><span class="n">sort_index</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">df</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">reg_res</span> <span class="o">=</span> <span class="n">smf</span><span class="o">.</span><span class="n">ols</span><span class="p">(</span><span class="n">formula</span><span class="o">=</span><span class="s1">&#39;Proxy ~ Temperature&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">df</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>
            <span class="n">R2_adj</span> <span class="o">=</span> <span class="n">reg_res</span><span class="o">.</span><span class="n">rsquared_adj</span>
            <span class="n">nobs</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">reg_res</span><span class="o">.</span><span class="n">nobs</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;SeasonT: </span><span class="si">{avgMonths}</span><span class="s1">, nobs: </span><span class="si">{nobs}</span><span class="s1">, R2_adj: </span><span class="si">{R2_adj:4f}</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="c1">#  print(df.to_string())</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">nobs</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">if</span> <span class="n">nobs</span> <span class="o">&lt;</span> <span class="n">nobs_lb</span><span class="p">:</span>
            <span class="c1"># Insufficent observation/calibration overlap to calibrate psm.</span>
            <span class="n">reg_res_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
            <span class="n">metric_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
            <span class="n">df_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
            <span class="k">continue</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">metric_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">R2_adj</span><span class="p">)</span>
            <span class="n">reg_res_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">reg_res</span><span class="p">)</span>
            <span class="n">df_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">metric_list</span><span class="p">)):</span>
        <span class="n">optimal_seasonality</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">optimal_reg</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">indmax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanargmax</span><span class="p">(</span><span class="n">metric_list</span><span class="p">)</span>
        <span class="n">optimal_seasonality</span> <span class="o">=</span> <span class="n">seasons</span><span class="p">[</span><span class="n">indmax</span><span class="p">]</span>
        <span class="n">optimal_reg</span> <span class="o">=</span> <span class="n">reg_res_list</span><span class="p">[</span><span class="n">indmax</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">optimal_seasonality</span><span class="p">,</span> <span class="n">optimal_reg</span>


<span class="k">def</span> <span class="nf">bilinear_regression</span><span class="p">(</span><span class="n">proxy_time</span><span class="p">,</span> <span class="n">proxy_value</span><span class="p">,</span>
                        <span class="n">ref_time_1</span><span class="p">,</span> <span class="n">ref_value_1</span><span class="p">,</span> <span class="n">seasons_1</span><span class="p">,</span>
                        <span class="n">ref_time_2</span><span class="p">,</span> <span class="n">ref_value_2</span><span class="p">,</span> <span class="n">seasons_2</span><span class="p">,</span>
                        <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">nobs_lb</span><span class="o">=</span><span class="mi">25</span><span class="p">):</span>

    <span class="n">i_idx_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">j_idx_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">metric_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">reg_res_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">df_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">avgMonths_1</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">seasons_1</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">avgMonths_2</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">seasons_2</span><span class="p">):</span>
            <span class="n">season_tag_1</span> <span class="o">=</span> <span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">m</span><span class="p">)</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">avgMonths_1</span><span class="p">)</span>
            <span class="n">season_tag_2</span> <span class="o">=</span> <span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">m</span><span class="p">)</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">avgMonths_2</span><span class="p">)</span>

            <span class="n">ref_var_avg_1</span> <span class="o">=</span> <span class="n">ref_value_1</span><span class="p">[</span><span class="n">season_tag_1</span><span class="p">]</span>
            <span class="n">ref_var_avg_2</span> <span class="o">=</span> <span class="n">ref_value_2</span><span class="p">[</span><span class="n">season_tag_2</span><span class="p">]</span>
            <span class="n">yr_ann_1</span> <span class="o">=</span> <span class="n">ref_time_1</span>
            <span class="n">yr_ann_2</span> <span class="o">=</span> <span class="n">ref_time_2</span>

            <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;time&#39;</span><span class="p">:</span> <span class="n">proxy_time</span><span class="p">,</span> <span class="s1">&#39;Proxy&#39;</span><span class="p">:</span> <span class="n">proxy_value</span><span class="p">})</span>
            <span class="n">frameT</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;time&#39;</span><span class="p">:</span> <span class="n">yr_ann_1</span><span class="p">,</span> <span class="s1">&#39;Temperature&#39;</span><span class="p">:</span> <span class="n">ref_var_avg_1</span><span class="p">})</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">frameT</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;outer&#39;</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s1">&#39;time&#39;</span><span class="p">)</span>
            <span class="n">frameP</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;time&#39;</span><span class="p">:</span> <span class="n">yr_ann_2</span><span class="p">,</span> <span class="s1">&#39;Moisture&#39;</span><span class="p">:</span> <span class="n">ref_var_avg_2</span><span class="p">})</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">frameP</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;outer&#39;</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s1">&#39;time&#39;</span><span class="p">)</span>
            <span class="n">df</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">,</span> <span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">df</span><span class="o">.</span><span class="n">sort_index</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">df</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">reg_res</span> <span class="o">=</span> <span class="n">smf</span><span class="o">.</span><span class="n">ols</span><span class="p">(</span><span class="n">formula</span><span class="o">=</span><span class="s1">&#39;Proxy ~ Temperature + Moisture&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">df</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>
                <span class="n">nobs</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">reg_res</span><span class="o">.</span><span class="n">nobs</span><span class="p">)</span>
                <span class="n">R2_adj</span> <span class="o">=</span> <span class="n">reg_res</span><span class="o">.</span><span class="n">rsquared_adj</span>
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;SeasonT: </span><span class="si">{avgMonths_1}</span><span class="s1">, SeasonP: </span><span class="si">{avgMonths_2}</span><span class="s1">, nobs: </span><span class="si">{nobs}</span><span class="s1">, R2_adj: </span><span class="si">{R2_adj:.4f}</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="c1">#  print(df.to_string())</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">nobs</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="k">if</span> <span class="n">nobs</span> <span class="o">&lt;</span> <span class="n">nobs_lb</span><span class="p">:</span>
                <span class="c1"># Insufficent observation/calibration overlap to calibrate psm.</span>
                <span class="n">reg_res_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
                <span class="n">metric_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
                <span class="n">i_idx_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
                <span class="n">j_idx_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
                <span class="n">df_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">metric_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">R2_adj</span><span class="p">)</span>
                <span class="n">reg_res_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">reg_res</span><span class="p">)</span>
                <span class="n">i_idx_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                <span class="n">j_idx_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>
                <span class="n">df_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">metric_list</span><span class="p">)):</span>
        <span class="n">optimal_seasonality_1</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">optimal_seasonality_2</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">optimal_reg</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">indmax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanargmax</span><span class="p">(</span><span class="n">metric_list</span><span class="p">)</span>
        <span class="n">optimal_seasonality_1</span> <span class="o">=</span> <span class="n">seasons_1</span><span class="p">[</span><span class="n">i_idx_list</span><span class="p">[</span><span class="n">indmax</span><span class="p">]]</span>
        <span class="n">optimal_seasonality_2</span> <span class="o">=</span> <span class="n">seasons_2</span><span class="p">[</span><span class="n">j_idx_list</span><span class="p">[</span><span class="n">indmax</span><span class="p">]]</span>
        <span class="n">optimal_reg</span> <span class="o">=</span> <span class="n">reg_res_list</span><span class="p">[</span><span class="n">indmax</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">optimal_seasonality_1</span><span class="p">,</span> <span class="n">optimal_seasonality_2</span><span class="p">,</span> <span class="n">optimal_reg</span>


<span class="k">def</span> <span class="nf">generate_proxy_ind</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="n">nsites</span><span class="p">,</span> <span class="n">seed</span><span class="p">):</span>
    <span class="n">nsites_assim</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">nsites</span> <span class="o">*</span> <span class="n">cfg</span><span class="o">.</span><span class="n">proxies</span><span class="o">.</span><span class="n">proxy_frac</span><span class="p">)</span>

    <span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>

    <span class="n">ind_assim</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">nsites</span><span class="p">),</span> <span class="n">nsites_assim</span><span class="p">)</span>
    <span class="n">ind_assim</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>

    <span class="n">ind_eval</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">nsites</span><span class="p">))</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">ind_assim</span><span class="p">))</span>
    <span class="n">ind_eval</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">ind_assim</span><span class="p">,</span> <span class="n">ind_eval</span>


<span class="k">def</span> <span class="nf">get_ye</span><span class="p">(</span><span class="n">proxy_manager</span><span class="p">,</span> <span class="n">prior_sample_idxs</span><span class="p">,</span> <span class="n">ye_filesdict</span><span class="p">,</span> <span class="n">proxy_set</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;-------------------------------------------&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;Loading Ye files for proxy set: </span><span class="si">{proxy_set}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;-------------------------------------------&#39;</span><span class="p">)</span>

    <span class="n">num_samples</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">prior_sample_idxs</span><span class="p">)</span>

    <span class="n">sites_proxy_objs</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;assim&#39;</span><span class="p">:</span> <span class="n">proxy_manager</span><span class="o">.</span><span class="n">sites_assim_proxy_objs</span><span class="p">,</span>
        <span class="s1">&#39;eval&#39;</span><span class="p">:</span> <span class="n">proxy_manager</span><span class="o">.</span><span class="n">sites_eval_proxy_objs</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="n">num_proxies</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;assim&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">proxy_manager</span><span class="o">.</span><span class="n">ind_assim</span><span class="p">),</span>
        <span class="s1">&#39;eval&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">proxy_manager</span><span class="o">.</span><span class="n">ind_eval</span><span class="p">),</span>
    <span class="p">}</span>

    <span class="n">psm_keys</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;assim&#39;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">([</span><span class="n">pobj</span><span class="o">.</span><span class="n">psm_obj</span><span class="o">.</span><span class="n">psm_key</span> <span class="k">for</span> <span class="n">pobj</span> <span class="ow">in</span> <span class="n">proxy_manager</span><span class="o">.</span><span class="n">sites_assim_proxy_objs</span><span class="p">])),</span>
        <span class="s1">&#39;eval&#39;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">([</span><span class="n">pobj</span><span class="o">.</span><span class="n">psm_obj</span><span class="o">.</span><span class="n">psm_key</span> <span class="k">for</span> <span class="n">pobj</span> <span class="ow">in</span> <span class="n">proxy_manager</span><span class="o">.</span><span class="n">sites_eval_proxy_objs</span><span class="p">])),</span>
    <span class="p">}</span>

    <span class="n">ye_all</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">num_proxies</span><span class="p">[</span><span class="n">proxy_set</span><span class="p">],</span> <span class="n">num_samples</span><span class="p">))</span>
    <span class="n">ye_all_coords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">num_proxies</span><span class="p">[</span><span class="n">proxy_set</span><span class="p">],</span> <span class="mi">2</span><span class="p">))</span>

    <span class="n">precalc_files</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">psm_key</span> <span class="ow">in</span> <span class="n">psm_keys</span><span class="p">[</span><span class="n">proxy_set</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;Loading precalculated Ye from:</span><span class="se">\n</span><span class="s1"> </span><span class="si">{ye_filesdict[psm_key]}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="n">precalc_files</span><span class="p">[</span><span class="n">psm_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">ye_filesdict</span><span class="p">[</span><span class="n">psm_key</span><span class="p">],</span> <span class="n">allow_pickle</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Now extracting proxy type-dependent Ye values...</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">pobj</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">sites_proxy_objs</span><span class="p">[</span><span class="n">proxy_set</span><span class="p">]):</span>
        <span class="n">psm_key</span> <span class="o">=</span> <span class="n">pobj</span><span class="o">.</span><span class="n">psm_obj</span><span class="o">.</span><span class="n">psm_key</span>
        <span class="n">pid_idx_map</span> <span class="o">=</span> <span class="n">precalc_files</span><span class="p">[</span><span class="n">psm_key</span><span class="p">][</span><span class="s1">&#39;pid_index_map&#39;</span><span class="p">][()]</span>
        <span class="n">precalc_vals</span> <span class="o">=</span> <span class="n">precalc_files</span><span class="p">[</span><span class="n">psm_key</span><span class="p">][</span><span class="s1">&#39;ye_vals&#39;</span><span class="p">]</span>

        <span class="n">pidx</span> <span class="o">=</span> <span class="n">pid_idx_map</span><span class="p">[</span><span class="n">pobj</span><span class="o">.</span><span class="n">id</span><span class="p">]</span>
        <span class="n">ye_all</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">precalc_vals</span><span class="p">[</span><span class="n">pidx</span><span class="p">,</span> <span class="n">prior_sample_idxs</span><span class="p">]</span>
        <span class="n">ye_all_coords</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="n">pobj</span><span class="o">.</span><span class="n">lat</span><span class="p">,</span> <span class="n">pobj</span><span class="o">.</span><span class="n">lon</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>

    <span class="c1"># delete nans</span>
    <span class="n">delete_site_rows</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ye</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ye_all</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">ye</span><span class="p">)):</span>
            <span class="n">delete_site_rows</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

    <span class="n">ye_all</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">ye_all</span><span class="p">,</span> <span class="n">delete_site_rows</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">ye_all_coords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">ye_all_coords</span><span class="p">,</span> <span class="n">delete_site_rows</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">ye_all</span><span class="p">,</span> <span class="n">ye_all_coords</span>


<span class="k">def</span> <span class="nf">get_valid_proxies</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="n">proxy_manager</span><span class="p">,</span> <span class="n">target_year</span><span class="p">,</span> <span class="n">Ye_assim</span><span class="p">,</span> <span class="n">Ye_assim_coords</span><span class="p">,</span> <span class="n">proxy_inds</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="n">recon_timescale</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">recon_timescale</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;finding proxy records for year: </span><span class="si">{target_year}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;recon_timescale = </span><span class="si">{recon_timescale}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="n">start_yr</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">target_year</span><span class="o">-</span><span class="n">recon_timescale</span><span class="o">//</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">end_yr</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">target_year</span><span class="o">+</span><span class="n">recon_timescale</span><span class="o">//</span><span class="mi">2</span><span class="p">)</span>

    <span class="n">vY</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">vR</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">vP</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">vT</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c1">#  for proxy_idx, Y in enumerate(proxy_manager.sites_assim_proxy_objs()):</span>
    <span class="k">for</span> <span class="n">proxy_idx</span><span class="p">,</span> <span class="n">Y</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">proxy_manager</span><span class="o">.</span><span class="n">sites_assim_proxy_objs</span><span class="p">):</span>
        <span class="c1"># Check if we have proxy ob for current time interval</span>
        <span class="k">if</span> <span class="n">recon_timescale</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1"># exclude lower bound to not include same obs in adjacent time intervals</span>
            <span class="n">Yvals</span> <span class="o">=</span> <span class="n">Y</span><span class="o">.</span><span class="n">values</span><span class="p">[(</span><span class="n">Y</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">index</span> <span class="o">&gt;</span> <span class="n">start_yr</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">Y</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">index</span> <span class="o">&lt;=</span> <span class="n">end_yr</span><span class="p">)]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># use all available proxies from config.yml</span>
            <span class="k">if</span> <span class="n">proxy_inds</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">Yvals</span> <span class="o">=</span> <span class="n">Y</span><span class="o">.</span><span class="n">values</span><span class="p">[(</span><span class="n">Y</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">index</span> <span class="o">&gt;=</span> <span class="n">start_yr</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">Y</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">index</span> <span class="o">&lt;=</span> <span class="n">end_yr</span><span class="p">)]</span>
                <span class="c1">#  Yvals = Y.values[(Y.time == target_year)]</span>
                <span class="c1"># use only the selected proxies (e.g., randomly filtered post-config)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">proxy_idx</span> <span class="ow">in</span> <span class="n">proxy_inds</span><span class="p">:</span>
                    <span class="c1">#Yvals = Y.values[(Y.values.index &gt;= start_yr) &amp; (Y.values.index &lt;= end_yr)]</span>
                    <span class="n">Yvals</span> <span class="o">=</span> <span class="n">Y</span><span class="o">.</span><span class="n">values</span><span class="p">[(</span><span class="n">Y</span><span class="o">.</span><span class="n">time</span> <span class="o">==</span> <span class="n">target_year</span><span class="p">)]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">Yvals</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">Yvals</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="c1">#  print(&#39;empty:&#39;, proxy_idx)</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;no obs for this year&#39;</span><span class="p">)</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">nYobs</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">Yvals</span><span class="p">)</span>
            <span class="n">Yobs</span> <span class="o">=</span> <span class="n">Yvals</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
            <span class="n">ob_err</span> <span class="o">=</span> <span class="n">Y</span><span class="o">.</span><span class="n">psm_obj</span><span class="o">.</span><span class="n">R</span><span class="o">/</span><span class="n">nYobs</span>
            <span class="c1">#           if (target_year &gt;=start_yr) &amp; (target_year &lt;= end_yr):</span>
            <span class="n">vY</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Yobs</span><span class="p">)</span>
            <span class="n">vR</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ob_err</span><span class="p">)</span>
            <span class="n">vP</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">proxy_idx</span><span class="p">)</span>
            <span class="n">vT</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Y</span><span class="o">.</span><span class="n">type</span><span class="p">)</span>

    <span class="n">vYe</span> <span class="o">=</span> <span class="n">Ye_assim</span><span class="p">[</span><span class="n">vP</span><span class="p">,</span> <span class="p">:]</span>
    <span class="n">vYe_coords</span> <span class="o">=</span> <span class="n">Ye_assim_coords</span><span class="p">[</span><span class="n">vP</span><span class="p">,</span> <span class="p">:]</span>

    <span class="k">return</span> <span class="n">vY</span><span class="p">,</span> <span class="n">vR</span><span class="p">,</span> <span class="n">vP</span><span class="p">,</span> <span class="n">vYe</span><span class="p">,</span> <span class="n">vT</span><span class="p">,</span> <span class="n">vYe_coords</span>


<span class="k">def</span> <span class="nf">make_grid</span><span class="p">(</span><span class="n">prior</span><span class="p">):</span>
    <span class="n">lat</span><span class="p">,</span> <span class="n">lon</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">prior</span><span class="o">.</span><span class="n">coords</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]))),</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">prior</span><span class="o">.</span><span class="n">coords</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">])))</span>
    <span class="n">nlat</span><span class="p">,</span> <span class="n">nlon</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">lat</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">lon</span><span class="p">)</span>
    <span class="n">nens</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">prior</span><span class="o">.</span><span class="n">ens</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

    <span class="n">g</span> <span class="o">=</span> <span class="n">Grid</span><span class="p">(</span><span class="n">lat</span><span class="p">,</span> <span class="n">lon</span><span class="p">,</span> <span class="n">nlat</span><span class="p">,</span> <span class="n">nlon</span><span class="p">,</span> <span class="n">nens</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">g</span>


<span class="k">def</span> <span class="nf">update_year_lite</span><span class="p">(</span><span class="n">target_year</span><span class="p">,</span> <span class="n">cfg</span><span class="p">,</span> <span class="n">Xb_one</span><span class="p">,</span> <span class="n">grid</span><span class="p">,</span> <span class="n">proxy_manager</span><span class="p">,</span> <span class="n">ye_all</span><span class="p">,</span> <span class="n">ye_all_coords</span><span class="p">,</span>
                     <span class="n">Xb_one_aug</span><span class="p">,</span> <span class="n">Xb_one_coords</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span>
                     <span class="n">ibeg_tas</span><span class="p">,</span> <span class="n">iend_tas</span><span class="p">,</span>
                     <span class="n">proxy_inds</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">da_solver</span><span class="o">=</span><span class="s1">&#39;ESRF&#39;</span><span class="p">,</span>
                     <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>

    <span class="n">vY</span><span class="p">,</span> <span class="n">vR</span><span class="p">,</span> <span class="n">vP</span><span class="p">,</span> <span class="n">vYe</span><span class="p">,</span> <span class="n">vT</span><span class="p">,</span> <span class="n">vYe_coords</span> <span class="o">=</span> <span class="n">get_valid_proxies</span><span class="p">(</span>
        <span class="n">cfg</span><span class="p">,</span> <span class="n">proxy_manager</span><span class="p">,</span> <span class="n">target_year</span><span class="p">,</span> <span class="n">ye_all</span><span class="p">,</span> <span class="n">ye_all_coords</span><span class="p">,</span> <span class="n">proxy_inds</span><span class="o">=</span><span class="n">proxy_inds</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">da_solver</span> <span class="o">==</span> <span class="s1">&#39;ESRF&#39;</span><span class="p">:</span>
        <span class="n">xam</span><span class="p">,</span> <span class="n">Xap</span><span class="p">,</span> <span class="n">Xa</span> <span class="o">=</span> <span class="n">Kalman_ESRF</span><span class="p">(</span>
            <span class="n">cfg</span><span class="p">,</span> <span class="n">vY</span><span class="p">,</span> <span class="n">vR</span><span class="p">,</span> <span class="n">vYe</span><span class="p">,</span> <span class="n">Xb_one</span><span class="p">,</span>
            <span class="n">proxy_manager</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">Xb_one_aug</span><span class="p">,</span> <span class="n">Xb_one_coords</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span>
        <span class="p">)</span>
    <span class="k">elif</span> <span class="n">da_solver</span> <span class="o">==</span> <span class="s1">&#39;optimal&#39;</span><span class="p">:</span>
        <span class="n">xam</span><span class="p">,</span> <span class="n">Xap</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">Kalman_optimal</span><span class="p">(</span><span class="n">vY</span><span class="p">,</span> <span class="n">vR</span><span class="p">,</span> <span class="n">vYe</span><span class="p">,</span> <span class="n">Xb_one</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;ERROR: Wrong da_solver!!!&#39;</span><span class="p">)</span>

    <span class="n">nens</span> <span class="o">=</span> <span class="n">grid</span><span class="o">.</span><span class="n">nens</span>
    <span class="n">gmt_ens</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nens</span><span class="p">)</span>
    <span class="n">nhmt_ens</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nens</span><span class="p">)</span>
    <span class="n">shmt_ens</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nens</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nens</span><span class="p">):</span>
        <span class="n">xam_lalo</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">Xa</span><span class="p">[</span><span class="n">ibeg_tas</span><span class="p">:</span><span class="n">iend_tas</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">k</span><span class="p">],</span> <span class="p">[</span><span class="n">grid</span><span class="o">.</span><span class="n">nlat</span><span class="p">,</span> <span class="n">grid</span><span class="o">.</span><span class="n">nlon</span><span class="p">])</span>
        <span class="n">gmt_ens</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">nhmt_ens</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">shmt_ens</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">global_hemispheric_means</span><span class="p">(</span><span class="n">xam_lalo</span><span class="p">,</span> <span class="n">grid</span><span class="o">.</span><span class="n">lat</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">gmt_ens</span><span class="p">,</span> <span class="n">nhmt_ens</span><span class="p">,</span> <span class="n">shmt_ens</span>


<span class="k">def</span> <span class="nf">update_year</span><span class="p">(</span><span class="n">yr_idx</span><span class="p">,</span> <span class="n">target_year</span><span class="p">,</span>
                <span class="n">cfg</span><span class="p">,</span> <span class="n">Xb_one_aug</span><span class="p">,</span> <span class="n">Xb_one_coords</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">sites_assim_proxy_objs</span><span class="p">,</span>
                <span class="n">assim_proxy_count</span><span class="p">,</span> <span class="n">eval_proxy_count</span><span class="p">,</span> <span class="n">grid</span><span class="p">,</span>
                <span class="n">ibeg</span><span class="p">,</span> <span class="n">iend</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>

    <span class="n">recon_timescale</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">recon_timescale</span>
    <span class="n">start_yr</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">target_year</span><span class="o">-</span><span class="n">recon_timescale</span><span class="o">//</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">end_yr</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">target_year</span><span class="o">+</span><span class="n">recon_timescale</span><span class="o">//</span><span class="mi">2</span><span class="p">)</span>

    <span class="n">Xb</span> <span class="o">=</span> <span class="n">Xb_one_aug</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="n">inflate</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">inflation_fact</span>

    <span class="k">for</span> <span class="n">proxy_idx</span><span class="p">,</span> <span class="n">Y</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">sites_assim_proxy_objs</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">recon_timescale</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="c1"># exclude lower bound to not include same obs in adjacent time intervals</span>
                <span class="n">Yvals</span> <span class="o">=</span> <span class="n">Y</span><span class="o">.</span><span class="n">values</span><span class="p">[(</span><span class="n">Y</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">index</span> <span class="o">&gt;</span> <span class="n">start_yr</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">Y</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">index</span> <span class="o">&lt;=</span> <span class="n">end_yr</span><span class="p">)]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">Yvals</span> <span class="o">=</span> <span class="n">Y</span><span class="o">.</span><span class="n">values</span><span class="p">[(</span><span class="n">Y</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">index</span> <span class="o">&gt;=</span> <span class="n">start_yr</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">Y</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">index</span> <span class="o">&lt;=</span> <span class="n">end_yr</span><span class="p">)]</span>

            <span class="k">if</span> <span class="n">Yvals</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">()</span>
            <span class="n">nYobs</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">Yvals</span><span class="p">)</span>
            <span class="n">Yobs</span> <span class="o">=</span> <span class="n">Yvals</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">continue</span>  <span class="c1"># skip to next loop iteration (proxy record)</span>

        <span class="n">loc</span> <span class="o">=</span> <span class="n">cov_localization</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">loc_rad</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">Xb_one_coords</span><span class="p">)</span>

        <span class="n">Ye</span> <span class="o">=</span> <span class="n">Xb</span><span class="p">[</span><span class="n">proxy_idx</span> <span class="o">-</span> <span class="p">(</span><span class="n">assim_proxy_count</span><span class="o">+</span><span class="n">eval_proxy_count</span><span class="p">)]</span>

        <span class="n">ob_err</span> <span class="o">=</span> <span class="n">Y</span><span class="o">.</span><span class="n">psm_obj</span><span class="o">.</span><span class="n">R</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="n">nYobs</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">cfg</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">output_details</span><span class="p">:</span>
            <span class="n">details_dict</span> <span class="o">=</span> <span class="n">enkf_update_array</span><span class="p">(</span><span class="n">Xb</span><span class="p">,</span> <span class="n">Yobs</span><span class="p">,</span> <span class="n">Ye</span><span class="p">,</span> <span class="n">ob_err</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="n">loc</span><span class="p">,</span> <span class="n">inflate</span><span class="o">=</span><span class="n">inflate</span><span class="p">,</span> <span class="n">output_details</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">Xa</span> <span class="o">=</span> <span class="n">details_dict</span><span class="p">[</span><span class="s1">&#39;Xa&#39;</span><span class="p">]</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">output_details_dirpath</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="n">f</span><span class="s1">&#39;enkf_details_</span><span class="si">{yr_idx}</span><span class="s1">_</span><span class="si">{Y.id}</span><span class="s1">.pkl&#39;</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">output_details_dirpath</span><span class="p">,</span> <span class="n">filename</span><span class="p">),</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">details_dict</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">Xa</span> <span class="o">=</span> <span class="n">enkf_update_array</span><span class="p">(</span><span class="n">Xb</span><span class="p">,</span> <span class="n">Yobs</span><span class="p">,</span> <span class="n">Ye</span><span class="p">,</span> <span class="n">ob_err</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="n">loc</span><span class="p">,</span> <span class="n">inflate</span><span class="o">=</span><span class="n">inflate</span><span class="p">,</span> <span class="n">output_details</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="n">xbvar</span> <span class="o">=</span> <span class="n">Xb</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ddof</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">xavar</span> <span class="o">=</span> <span class="n">Xa</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ddof</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">vardiff</span> <span class="o">=</span> <span class="n">xavar</span> <span class="o">-</span> <span class="n">xbvar</span>
        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">vardiff</span><span class="p">)))</span> <span class="ow">or</span> <span class="p">(</span><span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">vardiff</span><span class="p">))):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;ERROR: Reconstruction has blown-up. Exiting!&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;Y.id=</span><span class="si">{Y.id}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;np.max(Xb)={np.max(Xb)}&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;Y.psm_obj.psm_key=</span><span class="si">{Y.psm_obj.psm_key}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;Y.psm_obj.R=</span><span class="si">{Y.psm_obj.R}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;np.min(xbvar)={np.min(xbvar)}, np.max(xbvar)={np.max(xbvar)}&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;np.min(xavar)={np.min(xavar)}, np.max(xavar)={np.max(xavar)}&#39;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">SystemExit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;min/max change in variance: (&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">vardiff</span><span class="p">))</span><span class="o">+</span><span class="s1">&#39;,&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">vardiff</span><span class="p">))</span><span class="o">+</span><span class="s1">&#39;)&#39;</span><span class="p">)</span>

        <span class="n">Xb</span> <span class="o">=</span> <span class="n">Xa</span>

    <span class="n">xam_lalo</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">ibeg</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">xam_lalo</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">Xb</span><span class="p">[</span><span class="n">ibeg</span><span class="p">[</span><span class="n">name</span><span class="p">]:</span><span class="n">iend</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">grid</span><span class="o">.</span><span class="n">nens</span><span class="p">,</span> <span class="n">grid</span><span class="o">.</span><span class="n">nlat</span><span class="p">,</span> <span class="n">grid</span><span class="o">.</span><span class="n">nlon</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">xam_lalo</span>


<span class="k">def</span> <span class="nf">update_year_optimal</span><span class="p">(</span><span class="n">yr_idx</span><span class="p">,</span> <span class="n">target_year</span><span class="p">,</span>
                        <span class="n">cfg</span><span class="p">,</span> <span class="n">Xb_one_aug</span><span class="p">,</span> <span class="n">Xb_one_coords</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">sites_assim_proxy_objs</span><span class="p">,</span>
                        <span class="n">assim_proxy_count</span><span class="p">,</span> <span class="n">eval_proxy_count</span><span class="p">,</span> <span class="n">grid</span><span class="p">,</span>
                        <span class="n">ibeg</span><span class="p">,</span> <span class="n">iend</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>

    <span class="n">recon_timescale</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">recon_timescale</span>
    <span class="n">start_yr</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">target_year</span><span class="o">-</span><span class="n">recon_timescale</span><span class="o">//</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">end_yr</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">target_year</span><span class="o">+</span><span class="n">recon_timescale</span><span class="o">//</span><span class="mi">2</span><span class="p">)</span>

    <span class="n">Xb</span> <span class="o">=</span> <span class="n">Xb_one_aug</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="n">v_Yobs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">v_loc</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">v_Ye</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">v_ob_err</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">proxy_idx</span><span class="p">,</span> <span class="n">Y</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">sites_assim_proxy_objs</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">recon_timescale</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="c1"># exclude lower bound to not include same obs in adjacent time intervals</span>
                <span class="n">Yvals</span> <span class="o">=</span> <span class="n">Y</span><span class="o">.</span><span class="n">values</span><span class="p">[(</span><span class="n">Y</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">index</span> <span class="o">&gt;</span> <span class="n">start_yr</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">Y</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">index</span> <span class="o">&lt;=</span> <span class="n">end_yr</span><span class="p">)]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">Yvals</span> <span class="o">=</span> <span class="n">Y</span><span class="o">.</span><span class="n">values</span><span class="p">[(</span><span class="n">Y</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">index</span> <span class="o">&gt;=</span> <span class="n">start_yr</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">Y</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">index</span> <span class="o">&lt;=</span> <span class="n">end_yr</span><span class="p">)]</span>

            <span class="k">if</span> <span class="n">Yvals</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">()</span>
            <span class="n">nYobs</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">Yvals</span><span class="p">)</span>
            <span class="n">v_Yobs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Yvals</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span>

        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">continue</span>  <span class="c1"># skip to next loop iteration (proxy record)</span>

        <span class="n">v_loc</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cov_localization</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">loc_rad</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">Xb_one_coords</span><span class="p">))</span>
        <span class="n">v_Ye</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Xb</span><span class="p">[</span><span class="n">proxy_idx</span> <span class="o">-</span> <span class="p">(</span><span class="n">assim_proxy_count</span><span class="o">+</span><span class="n">eval_proxy_count</span><span class="p">)])</span>
        <span class="n">v_ob_err</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Y</span><span class="o">.</span><span class="n">psm_obj</span><span class="o">.</span><span class="n">R</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="n">nYobs</span><span class="p">))</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">v_Ye</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">Xa</span> <span class="o">=</span> <span class="n">Xb</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">v_Yobs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">v_Yobs</span><span class="p">)</span>
        <span class="n">v_loc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">v_loc</span><span class="p">)</span>
        <span class="n">v_Ye</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">v_Ye</span><span class="p">)</span>
        <span class="n">v_ob_err</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">v_ob_err</span><span class="p">)</span>

        <span class="c1"># EnKF update</span>
        <span class="n">nens</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">Xb</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">nobs</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">v_Ye</span><span class="p">)</span>

        <span class="n">xbm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">Xb</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">Xbp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">Xb</span><span class="p">,</span> <span class="n">xbm</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">])</span>
        <span class="n">mye</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">v_Ye</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">ye</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">v_Ye</span><span class="p">,</span> <span class="n">mye</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">])</span>

        <span class="n">Risr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">v_ob_err</span><span class="p">))</span>
        <span class="n">Htp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Risr</span><span class="p">,</span> <span class="n">ye</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">nens</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">Htm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Risr</span><span class="p">,</span> <span class="n">mye</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">])</span>
        <span class="n">Yt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Risr</span><span class="p">,</span> <span class="n">v_Yobs</span><span class="p">)</span>
        <span class="c1"># numpy svd quirk: V is actually V^T</span>
        <span class="n">U</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">V</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">svd</span><span class="p">(</span><span class="n">Htp</span><span class="p">,</span> <span class="n">full_matrices</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">nsvs</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="n">innov</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">U</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">Yt</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">Htm</span><span class="p">))</span>
        <span class="c1"># Kalman gain</span>
        <span class="n">Kpre</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">nsvs</span><span class="p">]</span><span class="o">/</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">nsvs</span><span class="p">]</span><span class="o">*</span><span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">nsvs</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">K</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">nens</span><span class="p">,</span> <span class="n">nobs</span><span class="p">])</span>
        <span class="n">np</span><span class="o">.</span><span class="n">fill_diagonal</span><span class="p">(</span><span class="n">K</span><span class="p">,</span> <span class="n">Kpre</span><span class="p">)</span>
        <span class="c1"># ensemble-mean analysis increment in transformed space</span>
        <span class="n">xhatinc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">K</span><span class="p">,</span> <span class="n">innov</span><span class="p">)</span>
        <span class="c1"># ensemble-mean analysis increment in the transformed ensemble space</span>
        <span class="n">xtinc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">V</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">xhatinc</span><span class="p">)</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">nens</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># ensemble-mean analysis increment in the original space</span>
        <span class="n">xinc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Xbp</span><span class="p">,</span> <span class="n">xtinc</span><span class="p">)</span>
        <span class="c1"># ensemble mean analysis in the original space</span>
        <span class="n">xam</span> <span class="o">=</span> <span class="n">xbm</span> <span class="o">+</span> <span class="n">xinc</span>

        <span class="c1"># transform the ensemble perturbations</span>
        <span class="n">lam</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">nobs</span><span class="p">,</span> <span class="n">nens</span><span class="p">])</span>
        <span class="n">np</span><span class="o">.</span><span class="n">fill_diagonal</span><span class="p">(</span><span class="n">lam</span><span class="p">,</span> <span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">nsvs</span><span class="p">])</span>
        <span class="n">tmp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">lam</span><span class="p">,</span> <span class="n">lam</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">identity</span><span class="p">(</span><span class="n">nobs</span><span class="p">))</span>
        <span class="n">sigsq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">identity</span><span class="p">(</span><span class="n">nens</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">lam</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">tmp</span><span class="p">),</span> <span class="n">lam</span><span class="p">)</span>
        <span class="n">sig</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">sigsq</span><span class="p">)</span>
        <span class="n">T</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">V</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">sig</span><span class="p">)</span>
        <span class="n">Xap</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Xbp</span><span class="p">,</span> <span class="n">T</span><span class="p">)</span>
        <span class="n">Xa</span> <span class="o">=</span> <span class="n">Xap</span> <span class="o">+</span> <span class="n">xam</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span>

    <span class="n">xam_lalo</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">ibeg</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">xam_lalo</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">Xa</span><span class="p">[</span><span class="n">ibeg</span><span class="p">[</span><span class="n">name</span><span class="p">]:</span><span class="n">iend</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">grid</span><span class="o">.</span><span class="n">nens</span><span class="p">,</span> <span class="n">grid</span><span class="o">.</span><span class="n">nlat</span><span class="p">,</span> <span class="n">grid</span><span class="o">.</span><span class="n">nlon</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">xam_lalo</span>


<span class="k">def</span> <span class="nf">regrid_sphere</span><span class="p">(</span><span class="n">nlat</span><span class="p">,</span> <span class="n">nlon</span><span class="p">,</span> <span class="n">Nens</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">ntrunc</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Truncate lat,lon grid to another resolution in spherical harmonic space. Triangular truncation</span>

<span class="sd">    Inputs:</span>
<span class="sd">    nlat            : number of latitudes</span>
<span class="sd">    nlon            : number of longitudes</span>
<span class="sd">    Nens            : number of ensemble members</span>
<span class="sd">    X               : data array of shape (nlat*nlon,Nens)</span>
<span class="sd">    ntrunc          : triangular truncation (e.g., use 42 for T42)</span>

<span class="sd">    Outputs :</span>
<span class="sd">    lat_new : 2D latitude array on the new grid (nlat_new,nlon_new)</span>
<span class="sd">    lon_new : 2D longitude array on the new grid (nlat_new,nlon_new)</span>
<span class="sd">    X_new   : truncated data array of shape (nlat_new*nlon_new, Nens)</span>

<span class="sd">    Originator: Greg Hakim</span>
<span class="sd">                University of Washington</span>
<span class="sd">                May 2015</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># create the spectral object on the original grid</span>
    <span class="n">specob_lmr</span> <span class="o">=</span> <span class="n">Spharmt</span><span class="p">(</span><span class="n">nlon</span><span class="p">,</span><span class="n">nlat</span><span class="p">,</span><span class="n">gridtype</span><span class="o">=</span><span class="s1">&#39;regular&#39;</span><span class="p">,</span><span class="n">legfunc</span><span class="o">=</span><span class="s1">&#39;computed&#39;</span><span class="p">)</span>

    <span class="c1"># truncate to a lower resolution grid (triangular truncation)</span>
    <span class="n">ifix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">remainder</span><span class="p">(</span><span class="n">ntrunc</span><span class="p">,</span><span class="mf">2.0</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">nlat_new</span> <span class="o">=</span> <span class="n">ntrunc</span> <span class="o">+</span> <span class="n">ifix</span>
    <span class="n">nlon_new</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">nlat_new</span><span class="o">*</span><span class="mf">1.5</span><span class="p">)</span>

    <span class="c1"># create the spectral object on the new grid</span>
    <span class="n">specob_new</span> <span class="o">=</span> <span class="n">Spharmt</span><span class="p">(</span><span class="n">nlon_new</span><span class="p">,</span><span class="n">nlat_new</span><span class="p">,</span><span class="n">gridtype</span><span class="o">=</span><span class="s1">&#39;regular&#39;</span><span class="p">,</span><span class="n">legfunc</span><span class="o">=</span><span class="s1">&#39;computed&#39;</span><span class="p">)</span>

    <span class="c1"># create new lat,lon grid arrays</span>
    <span class="c1"># Note: AP - According to github.com/jswhit/pyspharm documentation the</span>
    <span class="c1">#  latitudes will not include the equator or poles when nlats is even.</span>
    <span class="k">if</span> <span class="n">nlat_new</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">include_poles</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">include_poles</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="n">lat_new</span><span class="p">,</span> <span class="n">lon_new</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">generate_latlon</span><span class="p">(</span><span class="n">nlat_new</span><span class="p">,</span> <span class="n">nlon_new</span><span class="p">,</span>
                                             <span class="n">include_endpts</span><span class="o">=</span><span class="n">include_poles</span><span class="p">)</span>

    <span class="c1"># transform each ensemble member, one at a time</span>
    <span class="n">X_new</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">nlat_new</span><span class="o">*</span><span class="n">nlon_new</span><span class="p">,</span><span class="n">Nens</span><span class="p">])</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Nens</span><span class="p">):</span>
        <span class="n">X_lalo</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">X</span><span class="p">[:,</span><span class="n">k</span><span class="p">],(</span><span class="n">nlat</span><span class="p">,</span><span class="n">nlon</span><span class="p">))</span>
        <span class="n">Xbtrunc</span> <span class="o">=</span> <span class="n">regrid</span><span class="p">(</span><span class="n">specob_lmr</span><span class="p">,</span> <span class="n">specob_new</span><span class="p">,</span> <span class="n">X_lalo</span><span class="p">,</span> <span class="n">ntrunc</span><span class="o">=</span><span class="n">nlat_new</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">smooth</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="n">vectmp</span> <span class="o">=</span> <span class="n">Xbtrunc</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
        <span class="n">X_new</span><span class="p">[:,</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">vectmp</span>

    <span class="k">return</span> <span class="n">X_new</span><span class="p">,</span><span class="n">lat_new</span><span class="p">,</span><span class="n">lon_new</span>


<span class="k">def</span> <span class="nf">regrid_sphere_field</span><span class="p">(</span><span class="n">nlat</span><span class="p">,</span> <span class="n">nlon</span><span class="p">,</span> <span class="n">var_field</span><span class="p">,</span> <span class="n">ntrunc</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; Regrid a field</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="c1"># create the spectral object on the original grid</span>
    <span class="n">specob_lmr</span> <span class="o">=</span> <span class="n">Spharmt</span><span class="p">(</span><span class="n">nlon</span><span class="p">,</span><span class="n">nlat</span><span class="p">,</span><span class="n">gridtype</span><span class="o">=</span><span class="s1">&#39;regular&#39;</span><span class="p">,</span><span class="n">legfunc</span><span class="o">=</span><span class="s1">&#39;computed&#39;</span><span class="p">)</span>

    <span class="c1"># truncate to a lower resolution grid (triangular truncation)</span>
    <span class="n">ifix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">remainder</span><span class="p">(</span><span class="n">ntrunc</span><span class="p">,</span><span class="mf">2.0</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">nlat_new</span> <span class="o">=</span> <span class="n">ntrunc</span> <span class="o">+</span> <span class="n">ifix</span>
    <span class="n">nlon_new</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">nlat_new</span><span class="o">*</span><span class="mf">1.5</span><span class="p">)</span>

    <span class="c1"># create the spectral object on the new grid</span>
    <span class="n">specob_new</span> <span class="o">=</span> <span class="n">Spharmt</span><span class="p">(</span><span class="n">nlon_new</span><span class="p">,</span><span class="n">nlat_new</span><span class="p">,</span><span class="n">gridtype</span><span class="o">=</span><span class="s1">&#39;regular&#39;</span><span class="p">,</span><span class="n">legfunc</span><span class="o">=</span><span class="s1">&#39;computed&#39;</span><span class="p">)</span>

    <span class="c1"># create new lat,lon grid arrays</span>
    <span class="c1"># Note: AP - According to github.com/jswhit/pyspharm documentation the</span>
    <span class="c1">#  latitudes will not include the equator or poles when nlats is even.</span>
    <span class="k">if</span> <span class="n">nlat_new</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">include_poles</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">include_poles</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="n">lat_new</span><span class="p">,</span> <span class="n">lon_new</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">generate_latlon</span><span class="p">(</span><span class="n">nlat_new</span><span class="p">,</span> <span class="n">nlon_new</span><span class="p">,</span>
                                             <span class="n">include_endpts</span><span class="o">=</span><span class="n">include_poles</span><span class="p">)</span>

    <span class="c1"># transform each ensemble member, one at a time</span>
    <span class="n">var_regridded</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">var_field</span><span class="p">)[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="n">var_regridded</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="n">regrid</span><span class="p">(</span><span class="n">specob_lmr</span><span class="p">,</span> <span class="n">specob_new</span><span class="p">,</span> <span class="n">var_field</span><span class="p">,</span> <span class="n">ntrunc</span><span class="o">=</span><span class="n">nlat_new</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">smooth</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="p">)</span>

    <span class="k">return</span> <span class="n">var_regridded</span><span class="p">,</span> <span class="n">lat_new</span><span class="p">,</span> <span class="n">lon_new</span>


<span class="k">def</span> <span class="nf">find_closest_loc</span><span class="p">(</span><span class="n">lat</span><span class="p">,</span> <span class="n">lon</span><span class="p">,</span> <span class="n">target_lat</span><span class="p">,</span> <span class="n">target_lon</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; Find the closet model sites (lat, lon) based on the given target (lat, lon) list</span>

<span class="sd">    Args:</span>
<span class="sd">        lat, lon (array): the model latitude and longitude arrays</span>
<span class="sd">        target_lat, target_lon (array): the target latitude and longitude arrays</span>
<span class="sd">        mode (str):</span>
<span class="sd">        + latlon: the model lat/lon is a 1-D array</span>
<span class="sd">        + mesh: the model lat/lon is a 2-D array</span>

<span class="sd">    Returns:</span>
<span class="sd">        lat_ind, lon_ind (array): the indices of the found closest model sites</span>

<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="n">mode</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">lat</span><span class="p">))</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">mode</span> <span class="o">=</span> <span class="s1">&#39;latlon&#39;</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">lat</span><span class="p">))</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">mode</span> <span class="o">=</span> <span class="s1">&#39;mesh&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;ERROR: The shape of the lat/lon cannot be processed !!!&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">mode</span> <span class="ow">is</span> <span class="s1">&#39;latlon&#39;</span><span class="p">:</span>
        <span class="c1"># model locations</span>
        <span class="n">mesh</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">lon</span><span class="p">,</span> <span class="n">lat</span><span class="p">)</span>

        <span class="n">list_of_grids</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">grid</span><span class="o">.</span><span class="n">flat</span> <span class="k">for</span> <span class="n">grid</span> <span class="ow">in</span> <span class="n">mesh</span><span class="p">)))</span>
        <span class="n">model_lon</span><span class="p">,</span> <span class="n">model_lat</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">list_of_grids</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">mode</span> <span class="ow">is</span> <span class="s1">&#39;mesh&#39;</span><span class="p">:</span>
        <span class="n">model_lat</span> <span class="o">=</span> <span class="n">lat</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
        <span class="n">model_lon</span> <span class="o">=</span> <span class="n">lon</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>

    <span class="k">elif</span> <span class="n">mode</span> <span class="ow">is</span> <span class="s1">&#39;list&#39;</span><span class="p">:</span>
        <span class="n">model_lat</span> <span class="o">=</span> <span class="n">lat</span>
        <span class="n">model_lon</span> <span class="o">=</span> <span class="n">lon</span>

    <span class="n">model_locations</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">m_lat</span><span class="p">,</span> <span class="n">m_lon</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">model_lat</span><span class="p">,</span> <span class="n">model_lon</span><span class="p">):</span>
        <span class="n">model_locations</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">m_lat</span><span class="p">,</span> <span class="n">m_lon</span><span class="p">))</span>

    <span class="c1"># target locations</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">target_lat</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="c1">#  target_locations_dup = list(zip(target_lat, target_lon))</span>
        <span class="c1">#  target_locations = list(set(target_locations_dup))  # remove duplicated locations</span>
        <span class="n">target_locations</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">target_lat</span><span class="p">,</span> <span class="n">target_lon</span><span class="p">))</span>
        <span class="n">n_loc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">target_locations</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">target_locations</span> <span class="o">=</span> <span class="p">[(</span><span class="n">target_lat</span><span class="p">,</span> <span class="n">target_lon</span><span class="p">)]</span>
        <span class="n">n_loc</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="n">lat_ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n_loc</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">lon_ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n_loc</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>

    <span class="c1"># get the closest grid</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">target_loc</span> <span class="ow">in</span> <span class="p">(</span><span class="nb">enumerate</span><span class="p">(</span><span class="n">tqdm</span><span class="p">(</span><span class="n">target_locations</span><span class="p">))</span> <span class="k">if</span> <span class="n">verbose</span> <span class="k">else</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">target_locations</span><span class="p">)):</span>
        <span class="n">X</span> <span class="o">=</span> <span class="n">target_loc</span>
        <span class="n">Y</span> <span class="o">=</span> <span class="n">model_locations</span>
        <span class="n">distance</span><span class="p">,</span> <span class="n">index</span> <span class="o">=</span> <span class="n">spatial</span><span class="o">.</span><span class="n">KDTree</span><span class="p">(</span><span class="n">Y</span><span class="p">)</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
        <span class="n">closest</span> <span class="o">=</span> <span class="n">Y</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
        <span class="n">nlon</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">lon</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;list&#39;</span><span class="p">:</span>
            <span class="n">lat_ind</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">index</span> <span class="o">%</span> <span class="n">nlon</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">lat_ind</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">index</span> <span class="o">//</span> <span class="n">nlon</span>
        <span class="n">lon_ind</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">index</span> <span class="o">%</span> <span class="n">nlon</span>

        <span class="c1">#  if np.size(target_lat) &gt; 1:</span>
            <span class="c1">#  df_ind[i] = target_locations_dup.index(target_loc)</span>

    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">target_lat</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="c1">#  return lat_ind, lon_ind, df_ind</span>
        <span class="k">return</span> <span class="n">lat_ind</span><span class="p">,</span> <span class="n">lon_ind</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">lat_ind</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">lon_ind</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>


<span class="k">def</span> <span class="nf">search_nearest_not_nan</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">lat_ind</span><span class="p">,</span> <span class="n">lon_ind</span><span class="p">,</span> <span class="n">distance</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="n">fix_sum</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">lat_fix_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">lon_fix_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">lat_fix</span><span class="p">,</span> <span class="n">lon_fix</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">product</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="n">distance</span><span class="p">,</span> <span class="n">distance</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="n">distance</span><span class="p">,</span> <span class="n">distance</span><span class="o">+</span><span class="mi">1</span><span class="p">)):</span>
        <span class="n">lat_fix_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lat_fix</span><span class="p">)</span>
        <span class="n">lon_fix_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lon_fix</span><span class="p">)</span>
        <span class="n">fix_sum</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">lat_fix</span><span class="p">)</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">lon_fix</span><span class="p">))</span>

    <span class="n">lat_fix_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">lat_fix_list</span><span class="p">)</span>
    <span class="n">lon_fix_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">lon_fix_list</span><span class="p">)</span>

    <span class="n">sort_i</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">fix_sum</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">lat_fix</span><span class="p">,</span> <span class="n">lon_fix</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">lat_fix_list</span><span class="p">[</span><span class="n">sort_i</span><span class="p">],</span> <span class="n">lon_fix_list</span><span class="p">[</span><span class="n">sort_i</span><span class="p">]):</span>
        <span class="n">target</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">field</span><span class="p">[:,</span> <span class="n">lat_ind</span><span class="o">+</span><span class="n">lat_fix</span><span class="p">,</span> <span class="n">lon_ind</span><span class="o">+</span><span class="n">lon_fix</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">target</span><span class="p">)):</span>
            <span class="k">continue</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;Found not nan with (lat_fix, lon_fix): (</span><span class="si">{lat_fix}</span><span class="s1">, </span><span class="si">{lon_fix}</span><span class="s1">)&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">target</span><span class="p">,</span> <span class="n">lat_fix</span><span class="p">,</span> <span class="n">lon_fix</span>

    <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;Fail to find value not nan!&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>


<span class="k">def</span> <span class="nf">generate_latlon</span><span class="p">(</span><span class="n">nlats</span><span class="p">,</span> <span class="n">nlons</span><span class="p">,</span> <span class="n">include_endpts</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                    <span class="n">lat_bnd</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">90</span><span class="p">,</span><span class="mi">90</span><span class="p">),</span> <span class="n">lon_bnd</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">360</span><span class="p">)):</span>
    <span class="sd">&quot;&quot;&quot; Generate regularly spaced latitude and longitude arrays where each point</span>
<span class="sd">    is the center of the respective grid cell.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    nlats: int</span>
<span class="sd">        Number of latitude points</span>
<span class="sd">    nlons: int</span>
<span class="sd">        Number of longitude points</span>
<span class="sd">    lat_bnd: tuple(float), optional</span>
<span class="sd">        Bounding latitudes for gridcell edges (not centers).  Accepts values</span>
<span class="sd">        in range of [-90, 90].</span>
<span class="sd">    lon_bnd: tuple(float), optional</span>
<span class="sd">        Bounding longitudes for gridcell edges (not centers).  Accepts values</span>
<span class="sd">        in range of [-180, 360].</span>
<span class="sd">    include_endpts: bool</span>
<span class="sd">        Include the poles in the latitude array.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    lat_center_2d:</span>
<span class="sd">        Array of central latitide points (nlat x nlon)</span>
<span class="sd">    lon_center_2d:</span>
<span class="sd">        Array of central longitude points (nlat x nlon)</span>
<span class="sd">    lat_corner:</span>
<span class="sd">        Array of latitude boundaries for all grid cells (nlat+1)</span>
<span class="sd">    lon_corner:</span>
<span class="sd">        Array of longitude boundaries for all grid cells (nlon+1)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">lat_bnd</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">lon_bnd</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Bound tuples must be of length 2&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">lat_bnd</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">lon_bnd</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Lower bounds must be less than upper bounds.&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">lat_bnd</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">90</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Latitude bounds must be between -90 and 90&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">lon_bnd</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">360</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Longitude bound difference must not exceed 360&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">lon_bnd</span><span class="p">)</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">180</span><span class="p">)</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">lon_bnd</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">360</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Longitude bounds must be between -180 and 360&#39;</span><span class="p">)</span>

    <span class="n">lon_center</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">lon_bnd</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">lon_bnd</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">nlons</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">include_endpts</span><span class="p">:</span>
        <span class="n">lat_center</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">lat_bnd</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">lat_bnd</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">nlats</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">tmp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">lat_bnd</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">lat_bnd</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">nlats</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">lat_center</span> <span class="o">=</span> <span class="p">(</span><span class="n">tmp</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">tmp</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span> <span class="o">/</span> <span class="mf">2.</span>

    <span class="n">lon_center_2d</span><span class="p">,</span> <span class="n">lat_center_2d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">lon_center</span><span class="p">,</span> <span class="n">lat_center</span><span class="p">)</span>
    <span class="n">lat_corner</span><span class="p">,</span> <span class="n">lon_corner</span> <span class="o">=</span> <span class="n">calculate_latlon_bnds</span><span class="p">(</span><span class="n">lat_center</span><span class="p">,</span> <span class="n">lon_center</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">lat_center_2d</span><span class="p">,</span> <span class="n">lon_center_2d</span><span class="p">,</span> <span class="n">lat_corner</span><span class="p">,</span> <span class="n">lon_corner</span>


<span class="k">def</span> <span class="nf">calculate_latlon_bnds</span><span class="p">(</span><span class="n">lats</span><span class="p">,</span> <span class="n">lons</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Calculate the bounds for regularly gridded lats and lons.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    lats: ndarray</span>
<span class="sd">        Regularly spaced latitudes.  Must be 1-dimensional and monotonically</span>
<span class="sd">        increase with index.</span>
<span class="sd">    lons:  ndarray</span>
<span class="sd">        Regularly spaced longitudes.  Must be 1-dimensional and monotonically</span>
<span class="sd">        increase with index.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    lat_bnds:</span>
<span class="sd">        Array of latitude boundaries for each input latitude of length</span>
<span class="sd">        len(lats)+1.</span>
<span class="sd">    lon_bnds:</span>
<span class="sd">        Array of longitude boundaries for each input longitude of length</span>
<span class="sd">        len(lons)+1.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">lats</span><span class="o">.</span><span class="n">ndim</span> <span class="o">!=</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">lons</span><span class="o">.</span><span class="n">ndim</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Expected 1D-array for input lats and lons.&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">lats</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">lons</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Expected monotonic value increase with index for &#39;</span>
                         <span class="s1">&#39;input latitudes and longitudes&#39;</span><span class="p">)</span>

    <span class="c1"># Note: assumes lats are monotonic increase with index</span>
    <span class="n">dlat</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">lats</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">lats</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="mf">2.</span>
    <span class="n">dlon</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">lons</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">lons</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="mf">2.</span>

    <span class="c1"># Check that inputs are regularly spaced</span>
    <span class="n">lat_space</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">lats</span><span class="p">)</span>
    <span class="n">lon_space</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">lons</span><span class="p">)</span>

    <span class="n">lat_bnds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">lats</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">lon_bnds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">lons</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">lat_bnds</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">lats</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">lat_space</span><span class="o">/</span><span class="mf">2.</span>
    <span class="n">lat_bnds</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">lats</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">lat_space</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mf">2.</span>
    <span class="n">lat_bnds</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">lats</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">lat_space</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="mf">2.</span>

    <span class="k">if</span> <span class="n">lat_bnds</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">90</span><span class="p">:</span>
        <span class="n">lat_bnds</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mf">90.</span>
    <span class="k">if</span> <span class="n">lat_bnds</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">90</span><span class="p">:</span>
        <span class="n">lat_bnds</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mf">90.</span>

    <span class="n">lon_bnds</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">lons</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">lon_space</span><span class="o">/</span><span class="mf">2.</span>
    <span class="n">lon_bnds</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">lons</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">lon_space</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mf">2.</span>
    <span class="n">lon_bnds</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">lons</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">lon_space</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="mf">2.</span>

    <span class="k">return</span> <span class="n">lat_bnds</span><span class="p">,</span> <span class="n">lon_bnds</span>


<span class="k">def</span> <span class="nf">cov_localization</span><span class="p">(</span><span class="n">locRad</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">X_coords</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Originator: R. Tardif, Dept. Atmos. Sciences, Univ. of Washington</span>
<span class="sd">    -----------------------------------------------------------------</span>
<span class="sd">     Inputs:</span>
<span class="sd">        locRad : Localization radius (distance in km beyond which cov are forced to zero)</span>
<span class="sd">             Y : Proxy object, needed to get ob site lat/lon (to calculate distances w.r.t. grid pts</span>
<span class="sd">             X : Prior object, needed to get state vector info.</span>
<span class="sd">      X_coords : Array containing geographic location information of state vector elements</span>

<span class="sd">     Output:</span>
<span class="sd">        covLoc : Localization vector (weights) applied to ensemble covariance estimates.</span>
<span class="sd">                 Dims = (Nx x 1), with Nx the dimension of the state vector.</span>

<span class="sd">     Note: Uses the Gaspari-Cohn localization function.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># declare the localization array, filled with ones to start with (as in no localization)</span>
    <span class="n">stateVectDim</span><span class="p">,</span> <span class="n">nbdimcoord</span> <span class="o">=</span> <span class="n">X_coords</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">covLoc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">[</span><span class="n">stateVectDim</span><span class="p">],</span><span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>

    <span class="c1"># Mask to identify elements of state vector that are &quot;localizeable&quot;</span>
    <span class="c1"># i.e. fields with (lat,lon)</span>
    <span class="n">localizeable</span> <span class="o">=</span> <span class="n">covLoc</span> <span class="o">==</span> <span class="mf">1.</span> <span class="c1"># Initialize as True</span>

    <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">X</span><span class="o">.</span><span class="n">trunc_state_info</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="p">[</span><span class="n">var_state_pos_begin</span><span class="p">,</span><span class="n">var_state_pos_end</span><span class="p">]</span> <span class="o">=</span>  <span class="n">X</span><span class="o">.</span><span class="n">trunc_state_info</span><span class="p">[</span><span class="n">var</span><span class="p">][</span><span class="s1">&#39;pos&#39;</span><span class="p">]</span>
        <span class="c1"># if variable is not a field with lats &amp; lons, tag localizeable as False</span>
        <span class="k">if</span> <span class="n">X</span><span class="o">.</span><span class="n">trunc_state_info</span><span class="p">[</span><span class="n">var</span><span class="p">][</span><span class="s1">&#39;spacecoords&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="p">(</span><span class="s1">&#39;lat&#39;</span><span class="p">,</span> <span class="s1">&#39;lon&#39;</span><span class="p">):</span>
            <span class="n">localizeable</span><span class="p">[</span><span class="n">var_state_pos_begin</span><span class="p">:</span><span class="n">var_state_pos_end</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="c1"># array of distances between state vector elements &amp; proxy site</span>
    <span class="c1"># initialized as zeros: this is important!</span>
    <span class="n">dists</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">[</span><span class="n">stateVectDim</span><span class="p">])</span>

    <span class="c1"># geographic location of proxy site</span>
    <span class="n">site_lat</span> <span class="o">=</span> <span class="n">Y</span><span class="o">.</span><span class="n">lat</span>
    <span class="n">site_lon</span> <span class="o">=</span> <span class="n">Y</span><span class="o">.</span><span class="n">lon</span>
    <span class="c1"># geographic locations of elements of state vector</span>
    <span class="n">X_lon</span> <span class="o">=</span> <span class="n">X_coords</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">X_lat</span> <span class="o">=</span> <span class="n">X_coords</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span>

    <span class="c1"># calculate distances for elements tagged as &quot;localizeable&quot;.</span>
    <span class="n">dists</span><span class="p">[</span><span class="n">localizeable</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">haversine</span><span class="p">(</span><span class="n">site_lon</span><span class="p">,</span> <span class="n">site_lat</span><span class="p">,</span>
                                                       <span class="n">X_lon</span><span class="p">[</span><span class="n">localizeable</span><span class="p">],</span>
                                                       <span class="n">X_lat</span><span class="p">[</span><span class="n">localizeable</span><span class="p">]),</span><span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>

    <span class="c1"># those not &quot;localizeable&quot; are assigned with a disdtance of &quot;nan&quot;</span>
    <span class="c1"># so these elements will not be included in the indexing</span>
    <span class="c1"># according to distances (see below)</span>
    <span class="n">dists</span><span class="p">[</span><span class="o">~</span><span class="n">localizeable</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

    <span class="c1"># Some transformation to variables used in calculating localization weights</span>
    <span class="n">hlr</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">locRad</span><span class="p">;</span> <span class="c1"># work with half the localization radius</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">dists</span><span class="o">/</span><span class="n">hlr</span><span class="p">;</span>

    <span class="c1"># indexing w.r.t. distances</span>
    <span class="n">ind_inner</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">dists</span> <span class="o">&lt;=</span> <span class="n">hlr</span><span class="p">)</span>    <span class="c1"># closest</span>
    <span class="n">ind_outer</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">dists</span> <span class="o">&gt;</span>  <span class="n">hlr</span><span class="p">)</span>    <span class="c1"># close</span>
    <span class="n">ind_out</span>   <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">dists</span> <span class="o">&gt;</span>  <span class="mf">2.</span><span class="o">*</span><span class="n">hlr</span><span class="p">)</span> <span class="c1"># out</span>

    <span class="c1"># Gaspari-Cohn function</span>
    <span class="c1"># for pts within 1/2 of localization radius</span>
    <span class="n">covLoc</span><span class="p">[</span><span class="n">ind_inner</span><span class="p">]</span> <span class="o">=</span> <span class="p">(((</span><span class="o">-</span><span class="mf">0.25</span><span class="o">*</span><span class="n">r</span><span class="p">[</span><span class="n">ind_inner</span><span class="p">]</span><span class="o">+</span><span class="mf">0.5</span><span class="p">)</span><span class="o">*</span><span class="n">r</span><span class="p">[</span><span class="n">ind_inner</span><span class="p">]</span><span class="o">+</span><span class="mf">0.625</span><span class="p">)</span><span class="o">*</span> \
                         <span class="n">r</span><span class="p">[</span><span class="n">ind_inner</span><span class="p">]</span><span class="o">-</span><span class="p">(</span><span class="mf">5.0</span><span class="o">/</span><span class="mf">3.0</span><span class="p">))</span><span class="o">*</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="n">ind_inner</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">+</span><span class="mf">1.0</span>
    <span class="c1"># for pts between 1/2 and one localization radius</span>
    <span class="n">covLoc</span><span class="p">[</span><span class="n">ind_outer</span><span class="p">]</span> <span class="o">=</span> <span class="p">((((</span><span class="n">r</span><span class="p">[</span><span class="n">ind_outer</span><span class="p">]</span><span class="o">/</span><span class="mf">12.</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">)</span> <span class="o">*</span> <span class="n">r</span><span class="p">[</span><span class="n">ind_outer</span><span class="p">]</span> <span class="o">+</span> <span class="mf">0.625</span><span class="p">)</span> <span class="o">*</span> \
                          <span class="n">r</span><span class="p">[</span><span class="n">ind_outer</span><span class="p">]</span> <span class="o">+</span> <span class="mf">5.0</span><span class="o">/</span><span class="mf">3.0</span><span class="p">)</span> <span class="o">*</span> <span class="n">r</span><span class="p">[</span><span class="n">ind_outer</span><span class="p">]</span> <span class="o">-</span> <span class="mf">5.0</span><span class="p">)</span> <span class="o">*</span> \
                          <span class="n">r</span><span class="p">[</span><span class="n">ind_outer</span><span class="p">]</span> <span class="o">+</span> <span class="mf">4.0</span> <span class="o">-</span> <span class="mf">2.0</span><span class="o">/</span><span class="p">(</span><span class="mf">3.0</span><span class="o">*</span><span class="n">r</span><span class="p">[</span><span class="n">ind_outer</span><span class="p">])</span>
    <span class="c1"># Impose zero for pts outside of localization radius</span>
    <span class="n">covLoc</span><span class="p">[</span><span class="n">ind_out</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>

    <span class="c1"># prevent negative values: calc. above may produce tiny negative</span>
    <span class="c1"># values for distances very near the localization radius</span>
    <span class="c1"># TODO: revisit calculations to minimize round-off errors</span>
    <span class="n">covLoc</span><span class="p">[</span><span class="n">covLoc</span> <span class="o">&lt;</span> <span class="mf">0.0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>

    <span class="k">return</span> <span class="n">covLoc</span>


<span class="k">def</span> <span class="nf">haversine</span><span class="p">(</span><span class="n">lon1</span><span class="p">,</span> <span class="n">lat1</span><span class="p">,</span> <span class="n">lon2</span><span class="p">,</span> <span class="n">lat2</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Calculate the great circle distance between two points on the earth (specified in decimal degrees)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># convert decimal degrees to radians</span>
    <span class="n">lon1</span><span class="p">,</span> <span class="n">lat1</span><span class="p">,</span> <span class="n">lon2</span><span class="p">,</span> <span class="n">lat2</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">,</span> <span class="p">[</span><span class="n">lon1</span><span class="p">,</span> <span class="n">lat1</span><span class="p">,</span> <span class="n">lon2</span><span class="p">,</span> <span class="n">lat2</span><span class="p">]))</span>
    <span class="c1"># haversine formula</span>
    <span class="n">dlon</span> <span class="o">=</span> <span class="n">lon2</span> <span class="o">-</span> <span class="n">lon1</span>
    <span class="n">dlat</span> <span class="o">=</span> <span class="n">lat2</span> <span class="o">-</span> <span class="n">lat1</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">dlat</span><span class="o">/</span><span class="mf">2.</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">lat1</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">lat2</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">dlon</span><span class="o">/</span><span class="mf">2.</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>
    <span class="n">c</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">arcsin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">a</span><span class="p">))</span>
    <span class="n">km</span> <span class="o">=</span> <span class="mf">6367.0</span> <span class="o">*</span> <span class="n">c</span>
    <span class="k">return</span> <span class="n">km</span>


<span class="k">def</span> <span class="nf">enkf_update_array</span><span class="p">(</span><span class="n">Xb</span><span class="p">,</span> <span class="n">obvalue</span><span class="p">,</span> <span class="n">Ye</span><span class="p">,</span> <span class="n">ob_err</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">inflate</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">output_details</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Function to do the ensemble square-root filter (EnSRF) update</span>
<span class="sd">    (ref: Whitaker and Hamill, Mon. Wea. Rev., 2002)</span>

<span class="sd">    Originator: G. J. Hakim, with code borrowed from L. Madaus</span>
<span class="sd">                Dept. Atmos. Sciences, Univ. of Washington</span>

<span class="sd">    Revisions:</span>

<span class="sd">    1 September 2017:</span>
<span class="sd">                    - changed varye = np.var(Ye) to varye = np.var(Ye,ddof=1)</span>
<span class="sd">                    for an unbiased calculation of the variance.</span>
<span class="sd">                    (G. Hakim - U. Washington)</span>

<span class="sd">    -----------------------------------------------------------------</span>
<span class="sd">     Inputs:</span>
<span class="sd">          Xb: background ensemble estimates of state (Nx x Nens)</span>
<span class="sd">     obvalue: proxy value</span>
<span class="sd">          Ye: background ensemble estimate of the proxy (Nens x 1)</span>
<span class="sd">      ob_err: proxy error variance</span>
<span class="sd">         loc: localization vector (Nx x 1) [optional]</span>
<span class="sd">     inflate: scalar inflation factor [optional]</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Get ensemble size from passed array: Xb has dims [state vect.,ens. members]</span>
    <span class="n">Nens</span> <span class="o">=</span> <span class="n">Xb</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="c1"># ensemble mean background and perturbations</span>
    <span class="n">xbm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">Xb</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">Xbp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">Xb</span><span class="p">,</span><span class="n">xbm</span><span class="p">[:,</span><span class="kc">None</span><span class="p">])</span>  <span class="c1"># &quot;None&quot; means replicate in this dimension</span>

    <span class="c1"># ensemble mean and variance of the background estimate of the proxy</span>
    <span class="n">mye</span>   <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">Ye</span><span class="p">)</span>
    <span class="n">varye</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">Ye</span><span class="p">,</span><span class="n">ddof</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># lowercase ye has ensemble-mean removed</span>
    <span class="n">ye</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">Ye</span><span class="p">,</span> <span class="n">mye</span><span class="p">)</span>

    <span class="c1"># innovation</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">innov</span> <span class="o">=</span> <span class="n">obvalue</span> <span class="o">-</span> <span class="n">mye</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;innovation error. obvalue = &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">obvalue</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; mye = &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">mye</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;returning Xb unchanged...&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Xb</span>

    <span class="c1"># innovation variance (denominator of serial Kalman gain)</span>
    <span class="n">kdenom</span> <span class="o">=</span> <span class="p">(</span><span class="n">varye</span> <span class="o">+</span> <span class="n">ob_err</span><span class="p">)</span>

    <span class="c1"># numerator of serial Kalman gain (cov(x,Hx))</span>
    <span class="n">kcov</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Xbp</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">ye</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span><span class="n">Nens</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># Option to inflate the covariances by a certain factor</span>
    <span class="c1">#if inflate is not None:</span>
    <span class="c1">#    kcov = inflate * kcov # This implementation is not correct. To be revised later.</span>

    <span class="c1"># Option to localize the gain</span>
    <span class="k">if</span> <span class="n">loc</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">kcov</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">kcov</span><span class="p">,</span><span class="n">loc</span><span class="p">)</span>

    <span class="c1"># Kalman gain</span>
    <span class="n">kmat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">kcov</span><span class="p">,</span> <span class="n">kdenom</span><span class="p">)</span>

    <span class="c1"># update ensemble mean</span>
    <span class="n">xam</span> <span class="o">=</span> <span class="n">xbm</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">kmat</span><span class="p">,</span><span class="n">innov</span><span class="p">)</span>

    <span class="c1"># update the ensemble members using the square-root approach</span>
    <span class="n">beta</span> <span class="o">=</span> <span class="mf">1.</span><span class="o">/</span><span class="p">(</span><span class="mf">1.</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">ob_err</span><span class="o">/</span><span class="p">(</span><span class="n">varye</span><span class="o">+</span><span class="n">ob_err</span><span class="p">)))</span>
    <span class="n">kmat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">beta</span><span class="p">,</span><span class="n">kmat</span><span class="p">)</span>
    <span class="n">ye</span>   <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ye</span><span class="p">)[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
    <span class="n">kmat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">kmat</span><span class="p">)[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
    <span class="n">Xap</span>  <span class="o">=</span> <span class="n">Xbp</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">kmat</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">ye</span><span class="p">)</span>

    <span class="c1"># full state</span>
    <span class="n">Xa</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">xam</span><span class="p">[:,</span><span class="kc">None</span><span class="p">],</span> <span class="n">Xap</span><span class="p">)</span>

    <span class="c1"># if masked array, making sure that fill_value = nan in the new array</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">isMaskedArray</span><span class="p">(</span><span class="n">Xa</span><span class="p">):</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">set_fill_value</span><span class="p">(</span><span class="n">Xa</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>

    <span class="c1"># Return the full state</span>
    <span class="k">if</span> <span class="n">output_details</span><span class="p">:</span>
        <span class="n">details_dict</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;xbm&#39;</span><span class="p">:</span> <span class="n">xbm</span><span class="p">,</span>
            <span class="s1">&#39;xam&#39;</span><span class="p">:</span> <span class="n">xam</span><span class="p">,</span>
            <span class="s1">&#39;Xbp&#39;</span><span class="p">:</span> <span class="n">Xbp</span><span class="p">,</span>
            <span class="s1">&#39;Xap&#39;</span><span class="p">:</span> <span class="n">Xap</span><span class="p">,</span>
            <span class="s1">&#39;Xa&#39;</span><span class="p">:</span> <span class="n">Xa</span><span class="p">,</span>
            <span class="s1">&#39;Ye&#39;</span><span class="p">:</span> <span class="n">Ye</span><span class="p">,</span>
            <span class="s1">&#39;ye&#39;</span><span class="p">:</span> <span class="n">ye</span><span class="p">,</span>
            <span class="s1">&#39;mye&#39;</span><span class="p">:</span> <span class="n">mye</span><span class="p">,</span>
            <span class="s1">&#39;obvalue&#39;</span><span class="p">:</span> <span class="n">obvalue</span><span class="p">,</span>
            <span class="s1">&#39;kmat&#39;</span><span class="p">:</span> <span class="n">kmat</span><span class="p">,</span>
            <span class="s1">&#39;kcov&#39;</span><span class="p">:</span> <span class="n">kcov</span><span class="p">,</span>
            <span class="s1">&#39;kdenom&#39;</span><span class="p">:</span> <span class="n">kdenom</span><span class="p">,</span>
            <span class="s1">&#39;varye&#39;</span><span class="p">:</span> <span class="n">varye</span><span class="p">,</span>
            <span class="s1">&#39;beta&#39;</span><span class="p">:</span> <span class="n">beta</span><span class="p">,</span>
            <span class="s1">&#39;ob_err&#39;</span><span class="p">:</span> <span class="n">ob_err</span><span class="p">,</span>
            <span class="s1">&#39;innov&#39;</span><span class="p">:</span> <span class="n">innov</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">details_dict</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">Xa</span>


<span class="k">def</span> <span class="nf">Kalman_ESRF</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="n">vY</span><span class="p">,</span> <span class="n">vR</span><span class="p">,</span> <span class="n">vYe</span><span class="p">,</span> <span class="n">Xb_in</span><span class="p">,</span>
                <span class="n">proxy_manager</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">Xb_one_aug</span><span class="p">,</span> <span class="n">Xb_one_coords</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>

    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Ensemble square root filter...&#39;</span><span class="p">)</span>

    <span class="n">begin_time</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>

    <span class="c1"># number of state variables</span>
    <span class="n">nx</span> <span class="o">=</span> <span class="n">Xb_in</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="c1"># augmented state vector with Ye appended</span>
    <span class="c1"># Xb = np.append(Xb_in, vYe, axis=0)</span>
    <span class="n">Xb</span> <span class="o">=</span> <span class="n">Xb_one_aug</span>

    <span class="n">inflate</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">inflation_fact</span>

    <span class="c1"># need to add code block to compute localization factor</span>
    <span class="n">nobs</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">vY</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;appended state...&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nobs</span><span class="p">):</span>
        <span class="c1">#if np.mod(k,100)==0: print k</span>
        <span class="n">obvalue</span> <span class="o">=</span> <span class="n">vY</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
        <span class="n">ob_err</span> <span class="o">=</span> <span class="n">vR</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
        <span class="n">Ye</span> <span class="o">=</span> <span class="n">Xb</span><span class="p">[</span><span class="n">nx</span><span class="o">+</span><span class="n">k</span><span class="p">,:]</span>
        <span class="n">Y</span> <span class="o">=</span> <span class="n">proxy_manager</span><span class="o">.</span><span class="n">sites_assim_proxy_objs</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
        <span class="n">loc</span> <span class="o">=</span> <span class="n">cov_localization</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">loc_rad</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">Xb_one_coords</span><span class="p">)</span>
        <span class="n">Xa</span> <span class="o">=</span> <span class="n">enkf_update_array</span><span class="p">(</span><span class="n">Xb</span><span class="p">,</span> <span class="n">obvalue</span><span class="p">,</span> <span class="n">Ye</span><span class="p">,</span> <span class="n">ob_err</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="n">loc</span><span class="p">,</span> <span class="n">inflate</span><span class="o">=</span><span class="n">inflate</span><span class="p">)</span>
        <span class="n">Xb</span> <span class="o">=</span> <span class="n">Xa</span>

    <span class="c1"># ensemble mean and perturbations</span>
    <span class="n">Xap</span> <span class="o">=</span> <span class="n">Xa</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">nx</span><span class="p">,:]</span> <span class="o">-</span> <span class="n">Xa</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">nx</span><span class="p">,:]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">keepdims</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">xam</span> <span class="o">=</span> <span class="n">Xa</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">nx</span><span class="p">,:]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">elapsed_time</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">begin_time</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;-----------------------------------------------------&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;completed in &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">elapsed_time</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; seconds&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;-----------------------------------------------------&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">xam</span><span class="p">,</span> <span class="n">Xap</span><span class="p">,</span> <span class="n">Xa</span>


<span class="k">def</span> <span class="nf">Kalman_optimal</span><span class="p">(</span><span class="n">Y</span><span class="p">,</span> <span class="n">vR</span><span class="p">,</span> <span class="n">Ye</span><span class="p">,</span> <span class="n">Xb</span><span class="p">,</span> <span class="n">loc_rad</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">nsvs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">transform_only</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; Kalman Filter</span>

<span class="sd">    Args:</span>
<span class="sd">        Y: observation vector (p x 1)</span>
<span class="sd">        vR: observation error variance vector (p x 1)</span>
<span class="sd">        Ye: prior-estimated observation vector (p x n)</span>
<span class="sd">        Xbp: prior ensemble perturbation matrix (m x n)</span>

<span class="sd">    Originator:</span>

<span class="sd">        Greg Hakim</span>
<span class="sd">        University of Washington</span>
<span class="sd">        26 February 2018</span>

<span class="sd">    Modifications:</span>
<span class="sd">    11 April 2018: Fixed bug in handling singular value matrix (rectangular, not square)</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1"> all-at-once solve...</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="n">begin_time</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>

    <span class="n">nobs</span> <span class="o">=</span> <span class="n">Ye</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">nens</span> <span class="o">=</span> <span class="n">Ye</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">ndof</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">([</span><span class="n">nobs</span><span class="p">,</span> <span class="n">nens</span><span class="p">])</span>

    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;number of obs: &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">nobs</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;number of ensemble members: &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">nens</span><span class="p">))</span>

    <span class="c1"># ensemble prior mean and perturbations</span>
    <span class="n">xbm</span> <span class="o">=</span> <span class="n">Xb</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="c1">#Xbp = Xb - Xb.mean(axis=1,keepdims=True)</span>
    <span class="n">Xbp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">Xb</span><span class="p">,</span><span class="n">xbm</span><span class="p">[:,</span><span class="kc">None</span><span class="p">])</span>  <span class="c1"># &quot;None&quot; means replicate in this dimension</span>

    <span class="c1">#  R = np.diag(vR)</span>
    <span class="n">Risr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="mf">1.</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">vR</span><span class="p">))</span>
    <span class="c1"># (suffix key: m=ensemble mean, p=perturbation from ensemble mean; f=full value)</span>
    <span class="c1"># keepdims=True needed for broadcasting to work; (p,1) shape rather than (p,)</span>
    <span class="n">Yem</span> <span class="o">=</span> <span class="n">Ye</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">keepdims</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">Yep</span> <span class="o">=</span> <span class="n">Ye</span> <span class="o">-</span> <span class="n">Yem</span>
    <span class="n">Htp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Risr</span><span class="p">,</span> <span class="n">Yep</span><span class="p">)</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">nens</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">Htm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Risr</span><span class="p">,</span> <span class="n">Yem</span><span class="p">)</span>
    <span class="n">Yt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Risr</span><span class="p">,</span> <span class="n">Y</span><span class="p">)</span>
    <span class="c1"># numpy svd quirk: V is actually V^T!</span>
    <span class="n">U</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">V</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">svd</span><span class="p">(</span><span class="n">Htp</span><span class="p">,</span> <span class="n">full_matrices</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">nsvs</span><span class="p">:</span>
        <span class="n">nsvs</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;ndof :&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">ndof</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;U :&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">U</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;s :&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;V :&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">V</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;recontructing using &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">nsvs</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; singular values&#39;</span><span class="p">)</span>

    <span class="n">innov</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">U</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">Yt</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">Htm</span><span class="p">))</span>
    <span class="c1"># Kalman gain</span>
    <span class="n">Kpre</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">nsvs</span><span class="p">]</span><span class="o">/</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">nsvs</span><span class="p">]</span><span class="o">*</span><span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">nsvs</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">K</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">nens</span><span class="p">,</span> <span class="n">nobs</span><span class="p">])</span>
    <span class="n">np</span><span class="o">.</span><span class="n">fill_diagonal</span><span class="p">(</span><span class="n">K</span><span class="p">,</span> <span class="n">Kpre</span><span class="p">)</span>
    <span class="c1"># ensemble-mean analysis increment in transformed space</span>
    <span class="n">xhatinc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">K</span><span class="p">,</span> <span class="n">innov</span><span class="p">)</span>
    <span class="c1"># ensemble-mean analysis increment in the transformed ensemble space</span>
    <span class="n">xtinc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">V</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">xhatinc</span><span class="p">)</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">nens</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">transform_only</span><span class="p">:</span>
        <span class="n">xam</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">Xap</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># ensemble-mean analysis increment in the original space</span>
        <span class="n">xinc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Xbp</span><span class="p">,</span> <span class="n">xtinc</span><span class="p">)</span>
        <span class="c1"># ensemble mean analysis in the original space</span>
        <span class="n">xam</span> <span class="o">=</span> <span class="n">xbm</span> <span class="o">+</span> <span class="n">xinc</span>

        <span class="c1"># transform the ensemble perturbations</span>
        <span class="n">lam</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">nobs</span><span class="p">,</span> <span class="n">nens</span><span class="p">])</span>
        <span class="n">np</span><span class="o">.</span><span class="n">fill_diagonal</span><span class="p">(</span><span class="n">lam</span><span class="p">,</span> <span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">nsvs</span><span class="p">])</span>
        <span class="n">tmp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">lam</span><span class="p">,</span> <span class="n">lam</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">identity</span><span class="p">(</span><span class="n">nobs</span><span class="p">))</span>
        <span class="n">sigsq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">identity</span><span class="p">(</span><span class="n">nens</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">lam</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">tmp</span><span class="p">),</span> <span class="n">lam</span><span class="p">)</span>
        <span class="n">sig</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">sigsq</span><span class="p">)</span>
        <span class="n">T</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">V</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">sig</span><span class="p">)</span>
        <span class="n">Xap</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Xbp</span><span class="p">,</span> <span class="n">T</span><span class="p">)</span>
        <span class="c1"># perturbations must have zero mean</span>
        <span class="c1">#Xap = Xap - Xap.mean(axis=1,keepdims=True)</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;min s:&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">s</span><span class="p">))</span>
    <span class="n">elapsed_time</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">begin_time</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;shape of U: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">U</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;shape of s: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;shape of V: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">V</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;-----------------------------------------------------&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;completed in &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">elapsed_time</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; seconds&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;-----------------------------------------------------&#39;</span><span class="p">)</span>

    <span class="c1">#  readme =</span>
    <span class="c1">#  The SVD dictionary contains the SVD matrices U,s,V where V</span>
    <span class="c1">#  is the transpose of what numpy returns. xtinc is the ensemble-mean</span>
    <span class="c1">#  analysis increment in the intermediate space; *any* state variable</span>
    <span class="c1">#  can be reconstructed from this matrix.</span>
    <span class="n">SVD</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;U&#39;</span><span class="p">:</span> <span class="n">U</span><span class="p">,</span>
        <span class="s1">&#39;s&#39;</span><span class="p">:</span> <span class="n">s</span><span class="p">,</span>
        <span class="s1">&#39;V&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">V</span><span class="p">),</span>
        <span class="s1">&#39;xtinc&#39;</span><span class="p">:</span> <span class="n">xtinc</span><span class="p">,</span>
        <span class="c1">#  &#39;readme&#39;: readme,</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">xam</span><span class="p">,</span> <span class="n">Xap</span><span class="p">,</span> <span class="n">SVD</span>


<span class="k">def</span> <span class="nf">save_to_netcdf</span><span class="p">(</span><span class="n">prior</span><span class="p">,</span> <span class="n">field_ens_save</span><span class="p">,</span> <span class="n">recon_years</span><span class="p">,</span> <span class="n">seed</span><span class="p">,</span> <span class="n">save_dirpath</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span>
                   <span class="n">output_geo_mean</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">target_lats</span><span class="o">=</span><span class="p">[],</span> <span class="n">target_lons</span><span class="o">=</span><span class="p">[],</span>
                   <span class="n">compress_dict</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;zlib&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;least_significant_digit&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">},</span>
                   <span class="n">output_full_ens</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="n">grid</span> <span class="o">=</span> <span class="n">make_grid</span><span class="p">(</span><span class="n">prior</span><span class="p">)</span>
    <span class="n">lats</span> <span class="o">=</span> <span class="n">grid</span><span class="o">.</span><span class="n">lat</span>
    <span class="n">lons</span> <span class="o">=</span> <span class="n">grid</span><span class="o">.</span><span class="n">lon</span>
    <span class="n">nens</span> <span class="o">=</span> <span class="n">grid</span><span class="o">.</span><span class="n">nens</span>

    <span class="n">nyr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">recon_years</span><span class="p">)</span>

    <span class="n">var_names</span> <span class="o">=</span> <span class="n">prior</span><span class="o">.</span><span class="n">trunc_state_info</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>

    <span class="n">output_dict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="n">output_full_ens</span><span class="p">:</span>
        <span class="c1"># output full ensemble for field</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">var_names</span><span class="p">:</span>
            <span class="n">output_dict</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="s1">&#39;year&#39;</span><span class="p">,</span> <span class="s1">&#39;ens&#39;</span><span class="p">,</span> <span class="s1">&#39;lat&#39;</span><span class="p">,</span> <span class="s1">&#39;lon&#39;</span><span class="p">),</span> <span class="n">field_ens_save</span><span class="p">[</span><span class="n">name</span><span class="p">])</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># output ensemble means for field and full ensemble for timeseries</span>
        <span class="n">field_ens_mean</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">var_names</span><span class="p">:</span>
            <span class="n">field_ens_mean</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">field_ens_save</span><span class="p">[</span><span class="n">name</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">var_names</span><span class="p">:</span>
            <span class="n">field_tmp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">field_ens_mean</span><span class="p">[</span><span class="n">name</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
            <span class="n">output_dict</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="s1">&#39;year&#39;</span><span class="p">,</span> <span class="s1">&#39;lat&#39;</span><span class="p">,</span> <span class="s1">&#39;lon&#39;</span><span class="p">),</span> <span class="n">field_tmp</span><span class="p">)</span>

            <span class="n">gm_ens</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nyr</span><span class="p">,</span> <span class="n">nens</span><span class="p">))</span>
            <span class="n">nhm_ens</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nyr</span><span class="p">,</span> <span class="n">nens</span><span class="p">))</span>
            <span class="n">shm_ens</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nyr</span><span class="p">,</span> <span class="n">nens</span><span class="p">))</span>

            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nens</span><span class="p">):</span>
                <span class="n">gm_ens</span><span class="p">[:,</span> <span class="n">k</span><span class="p">],</span> <span class="n">nhm_ens</span><span class="p">[:,</span> <span class="n">k</span><span class="p">],</span> <span class="n">shm_ens</span><span class="p">[:,</span> <span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">global_hemispheric_means</span><span class="p">(</span>
                    <span class="n">field_ens_save</span><span class="p">[</span><span class="n">name</span><span class="p">][:,</span> <span class="n">k</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:],</span> <span class="n">lats</span><span class="p">)</span>

            <span class="c1"># compress to float32</span>
            <span class="n">gm_ens</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">gm_ens</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
            <span class="n">nhm_ens</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">nhm_ens</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
            <span class="n">shm_ens</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">shm_ens</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>

            <span class="n">output_dict</span><span class="p">[</span><span class="n">f</span><span class="s1">&#39;</span><span class="si">{name}</span><span class="s1">_gm_ens&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="s1">&#39;year&#39;</span><span class="p">,</span> <span class="s1">&#39;ens&#39;</span><span class="p">),</span> <span class="n">gm_ens</span><span class="p">)</span>
            <span class="n">output_dict</span><span class="p">[</span><span class="n">f</span><span class="s1">&#39;</span><span class="si">{name}</span><span class="s1">_nhm_ens&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="s1">&#39;year&#39;</span><span class="p">,</span> <span class="s1">&#39;ens&#39;</span><span class="p">),</span> <span class="n">nhm_ens</span><span class="p">)</span>
            <span class="n">output_dict</span><span class="p">[</span><span class="n">f</span><span class="s1">&#39;</span><span class="si">{name}</span><span class="s1">_shm_ens&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="s1">&#39;year&#39;</span><span class="p">,</span> <span class="s1">&#39;ens&#39;</span><span class="p">),</span> <span class="n">shm_ens</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;tas_sfc_Amon&#39;</span><span class="p">:</span>
                <span class="c1"># calculate NINO indices</span>
                <span class="n">nino_ind</span> <span class="o">=</span> <span class="n">nino_indices</span><span class="p">(</span><span class="n">field_ens_save</span><span class="p">[</span><span class="n">name</span><span class="p">],</span> <span class="n">lats</span><span class="p">,</span> <span class="n">lons</span><span class="p">)</span>
                <span class="n">nino12</span> <span class="o">=</span> <span class="n">nino_ind</span><span class="p">[</span><span class="s1">&#39;nino1+2&#39;</span><span class="p">]</span>
                <span class="n">nino3</span> <span class="o">=</span> <span class="n">nino_ind</span><span class="p">[</span><span class="s1">&#39;nino3&#39;</span><span class="p">]</span>
                <span class="n">nino34</span> <span class="o">=</span> <span class="n">nino_ind</span><span class="p">[</span><span class="s1">&#39;nino3.4&#39;</span><span class="p">]</span>
                <span class="n">nino4</span> <span class="o">=</span> <span class="n">nino_ind</span><span class="p">[</span><span class="s1">&#39;nino4&#39;</span><span class="p">]</span>

                <span class="n">nino12</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">nino12</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
                <span class="n">nino3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">nino3</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
                <span class="n">nino34</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">nino34</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
                <span class="n">nino4</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">nino4</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>

                <span class="n">output_dict</span><span class="p">[</span><span class="s1">&#39;nino1+2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="s1">&#39;year&#39;</span><span class="p">,</span> <span class="s1">&#39;ens&#39;</span><span class="p">),</span> <span class="n">nino12</span><span class="p">)</span>
                <span class="n">output_dict</span><span class="p">[</span><span class="s1">&#39;nino3&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="s1">&#39;year&#39;</span><span class="p">,</span> <span class="s1">&#39;ens&#39;</span><span class="p">),</span> <span class="n">nino3</span><span class="p">)</span>
                <span class="n">output_dict</span><span class="p">[</span><span class="s1">&#39;nino3.4&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="s1">&#39;year&#39;</span><span class="p">,</span> <span class="s1">&#39;ens&#39;</span><span class="p">),</span> <span class="n">nino34</span><span class="p">)</span>
                <span class="n">output_dict</span><span class="p">[</span><span class="s1">&#39;nino4&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="s1">&#39;year&#39;</span><span class="p">,</span> <span class="s1">&#39;ens&#39;</span><span class="p">),</span> <span class="n">nino4</span><span class="p">)</span>

                <span class="c1"># calculate tripole index (TPI)</span>
                <span class="n">tpi</span> <span class="o">=</span> <span class="n">calc_tpi</span><span class="p">(</span><span class="n">field_ens_save</span><span class="p">[</span><span class="n">name</span><span class="p">],</span> <span class="n">lats</span><span class="p">,</span> <span class="n">lons</span><span class="p">)</span>
                <span class="n">output_dict</span><span class="p">[</span><span class="s1">&#39;tpi&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="s1">&#39;year&#39;</span><span class="p">,</span> <span class="s1">&#39;ens&#39;</span><span class="p">),</span> <span class="n">tpi</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">output_geo_mean</span><span class="p">:</span>
                <span class="n">geo_mean_ts</span> <span class="o">=</span> <span class="n">geo_mean</span><span class="p">(</span><span class="n">field_ens_save</span><span class="p">[</span><span class="n">name</span><span class="p">],</span> <span class="n">lats</span><span class="p">,</span> <span class="n">lons</span><span class="p">,</span> <span class="n">target_lats</span><span class="p">,</span> <span class="n">target_lons</span><span class="p">)</span>
                <span class="n">output_dict</span><span class="p">[</span><span class="s1">&#39;geo_mean&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="s1">&#39;year&#39;</span><span class="p">,</span> <span class="s1">&#39;ens&#39;</span><span class="p">),</span> <span class="n">geo_mean_ts</span><span class="p">)</span>

    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">save_dirpath</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">save_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">save_dirpath</span><span class="p">,</span> <span class="n">f</span><span class="s1">&#39;job_r</span><span class="si">{seed:02d}</span><span class="s1">.nc&#39;</span><span class="p">)</span>

    <span class="n">ds</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">(</span>
        <span class="n">data_vars</span><span class="o">=</span><span class="n">output_dict</span><span class="p">,</span>
        <span class="n">coords</span><span class="o">=</span><span class="p">{</span>
            <span class="s1">&#39;year&#39;</span><span class="p">:</span> <span class="n">recon_years</span><span class="p">,</span>
            <span class="s1">&#39;lat&#39;</span><span class="p">:</span> <span class="n">lats</span><span class="p">,</span>
            <span class="s1">&#39;lon&#39;</span><span class="p">:</span> <span class="n">lons</span><span class="p">,</span>
            <span class="s1">&#39;ens&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">nens</span><span class="p">)</span>
        <span class="p">})</span>

    <span class="k">if</span> <span class="n">compress_dict</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">encoding_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">output_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">encoding_dict</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">compress_dict</span>

        <span class="n">ds</span><span class="o">.</span><span class="n">to_netcdf</span><span class="p">(</span><span class="n">save_path</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="n">encoding_dict</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ds</span><span class="o">.</span><span class="n">to_netcdf</span><span class="p">(</span><span class="n">save_path</span><span class="p">)</span>

<span class="c1"># ===============================================</span>
<span class="c1">#  Time axis handling</span>
<span class="c1"># -----------------------------------------------</span>
<span class="k">def</span> <span class="nf">ymd2year_float</span><span class="p">(</span><span class="n">year</span><span class="p">,</span> <span class="n">month</span><span class="p">,</span> <span class="n">day</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; Convert a set of (year, month, day) to an array of floats in unit of year</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">year_float</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">y</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">d</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">year</span><span class="p">,</span> <span class="n">month</span><span class="p">,</span> <span class="n">day</span><span class="p">):</span>
        <span class="n">date</span> <span class="o">=</span> <span class="n">datetime</span><span class="p">(</span><span class="n">year</span><span class="o">=</span><span class="n">y</span><span class="p">,</span> <span class="n">month</span><span class="o">=</span><span class="n">m</span><span class="p">,</span> <span class="n">day</span><span class="o">=</span><span class="n">d</span><span class="p">)</span>
        <span class="n">fst_day</span> <span class="o">=</span> <span class="n">datetime</span><span class="p">(</span><span class="n">year</span><span class="o">=</span><span class="n">y</span><span class="p">,</span> <span class="n">month</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">day</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">lst_day</span> <span class="o">=</span> <span class="n">datetime</span><span class="p">(</span><span class="n">year</span><span class="o">=</span><span class="n">y</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">month</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">day</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">year_part</span> <span class="o">=</span> <span class="n">date</span> <span class="o">-</span> <span class="n">fst_day</span>
        <span class="n">year_length</span> <span class="o">=</span> <span class="n">lst_day</span> <span class="o">-</span> <span class="n">fst_day</span>
        <span class="n">year_float</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">y</span> <span class="o">+</span> <span class="n">year_part</span><span class="o">/</span><span class="n">year_length</span><span class="p">)</span>

    <span class="n">year_float</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">year_float</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">year_float</span>


<span class="k">def</span> <span class="nf">datetime2year_float</span><span class="p">(</span><span class="n">date</span><span class="p">):</span>
    <span class="n">year</span> <span class="o">=</span> <span class="p">[</span><span class="n">d</span><span class="o">.</span><span class="n">year</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">date</span><span class="p">]</span>
    <span class="n">month</span> <span class="o">=</span> <span class="p">[</span><span class="n">d</span><span class="o">.</span><span class="n">month</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">date</span><span class="p">]</span>
    <span class="n">day</span> <span class="o">=</span> <span class="p">[</span><span class="n">d</span><span class="o">.</span><span class="n">day</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">date</span><span class="p">]</span>

    <span class="n">year_float</span> <span class="o">=</span> <span class="n">ymd2year_float</span><span class="p">(</span><span class="n">year</span><span class="p">,</span> <span class="n">month</span><span class="p">,</span> <span class="n">day</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">year_float</span>


<span class="k">def</span> <span class="nf">year_float2datetime</span><span class="p">(</span><span class="n">year_float</span><span class="p">,</span> <span class="n">resolution</span><span class="o">=</span><span class="s1">&#39;day&#39;</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">year_float</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Cannot handel negative years. Please truncate first.&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="sd">&#39;&#39;&#39; Convert an array of floats in unit of year to a datetime time; accuracy: one day</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">year</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="n">y</span><span class="p">)</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">year_float</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">month</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">year</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">day</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">year</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">year</span><span class="p">):</span>
        <span class="n">fst_day</span> <span class="o">=</span> <span class="n">datetime</span><span class="p">(</span><span class="n">year</span><span class="o">=</span><span class="n">y</span><span class="p">,</span> <span class="n">month</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">day</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">lst_day</span> <span class="o">=</span> <span class="n">datetime</span><span class="p">(</span><span class="n">year</span><span class="o">=</span><span class="n">y</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">month</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">day</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">year_length</span> <span class="o">=</span> <span class="n">lst_day</span> <span class="o">-</span> <span class="n">fst_day</span>

        <span class="n">year_part</span> <span class="o">=</span> <span class="p">(</span><span class="n">year_float</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">y</span><span class="p">)</span><span class="o">*</span><span class="n">year_length</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># to fix the numerical error</span>
        <span class="n">date</span> <span class="o">=</span> <span class="n">year_part</span> <span class="o">+</span> <span class="n">fst_day</span>
        <span class="n">month</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">date</span><span class="o">.</span><span class="n">month</span>
        <span class="n">day</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">date</span><span class="o">.</span><span class="n">day</span>

    <span class="k">if</span> <span class="n">resolution</span> <span class="o">==</span> <span class="s1">&#39;day&#39;</span><span class="p">:</span>
        <span class="n">time</span> <span class="o">=</span> <span class="p">[</span><span class="n">cftime</span><span class="o">.</span><span class="n">DatetimeNoLeap</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">y</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">d</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">year</span><span class="p">,</span> <span class="n">month</span><span class="p">,</span> <span class="n">day</span><span class="p">)]</span>
    <span class="k">elif</span> <span class="n">resolution</span> <span class="o">==</span> <span class="s1">&#39;month&#39;</span><span class="p">:</span>
        <span class="n">time</span> <span class="o">=</span> <span class="p">[</span><span class="n">cftime</span><span class="o">.</span><span class="n">DatetimeNoLeap</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">y</span><span class="p">,</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">year</span><span class="p">,</span> <span class="n">month</span><span class="p">)]</span>
    <span class="k">return</span> <span class="n">time</span>


<div class="viewcode-block" id="seasonal_var_xarray"><a class="viewcode-back" href="../../utils.html#LMRt.utils.seasonal_var_xarray">[docs]</a><span class="k">def</span> <span class="nf">seasonal_var_xarray</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">year_float</span><span class="p">,</span> <span class="n">avgMonths</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">12</span><span class="p">]):</span>
    <span class="sd">&#39;&#39;&#39; Annualize a variable array based on seasonality</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    var : ndarray</span>
<span class="sd">        The target variable array with 1st dim to be year</span>
<span class="sd">    year_float : array</span>
<span class="sd">        The time axis of the variable array</span>
<span class="sd">    avgMonths : list, optional</span>
<span class="sd">        The list of months to be averaged</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    var_ann : ndarray</span>
<span class="sd">        The annualized variable array</span>
<span class="sd">    year_ann : array</span>
<span class="sd">        The time axis of the annualized variable array</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">var</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">var</span><span class="p">)</span>
    <span class="n">year_float</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">year_float</span><span class="p">)</span>

    <span class="n">ndims</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">var</span><span class="p">))</span>
    <span class="n">dims</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ndims</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">dims</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;dim{i+1}&#39;</span><span class="p">)</span>

    <span class="n">time</span> <span class="o">=</span> <span class="n">year_float2datetime</span><span class="p">(</span><span class="n">year_float</span><span class="p">)</span>
    <span class="n">var_da</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">dims</span><span class="o">=</span><span class="n">dims</span><span class="p">,</span> <span class="n">coords</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;time&#39;</span><span class="p">:</span> <span class="n">time</span><span class="p">})</span>

    <span class="n">m_start</span><span class="p">,</span> <span class="n">m_end</span> <span class="o">=</span> <span class="n">avgMonths</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">avgMonths</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">m_start</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">offset_str</span> <span class="o">=</span> <span class="s1">&#39;A&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">offset_alias</span> <span class="o">=</span> <span class="p">{</span>
           <span class="o">-</span><span class="mi">12</span><span class="p">:</span> <span class="s1">&#39;DEC&#39;</span><span class="p">,</span>
           <span class="o">-</span><span class="mi">11</span><span class="p">:</span> <span class="s1">&#39;NOV&#39;</span><span class="p">,</span>
           <span class="o">-</span><span class="mi">10</span><span class="p">:</span> <span class="s1">&#39;OCT&#39;</span><span class="p">,</span>
           <span class="o">-</span><span class="mi">9</span><span class="p">:</span> <span class="s1">&#39;SEP&#39;</span><span class="p">,</span>
           <span class="o">-</span><span class="mi">8</span><span class="p">:</span> <span class="s1">&#39;AUG&#39;</span><span class="p">,</span>
           <span class="o">-</span><span class="mi">7</span><span class="p">:</span> <span class="s1">&#39;JUL&#39;</span><span class="p">,</span>
           <span class="o">-</span><span class="mi">6</span><span class="p">:</span> <span class="s1">&#39;JUN&#39;</span><span class="p">,</span>
           <span class="o">-</span><span class="mi">5</span><span class="p">:</span> <span class="s1">&#39;MAY&#39;</span><span class="p">,</span>
           <span class="o">-</span><span class="mi">4</span><span class="p">:</span> <span class="s1">&#39;APR&#39;</span><span class="p">,</span>
           <span class="o">-</span><span class="mi">3</span><span class="p">:</span> <span class="s1">&#39;MAR&#39;</span><span class="p">,</span>
           <span class="o">-</span><span class="mi">2</span><span class="p">:</span> <span class="s1">&#39;FEB&#39;</span><span class="p">,</span>
           <span class="o">-</span><span class="mi">1</span><span class="p">:</span> <span class="s1">&#39;JAN&#39;</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="n">offset_str</span> <span class="o">=</span> <span class="n">f</span><span class="s1">&#39;AS-</span><span class="si">{offset_alias[m_start]}</span><span class="s1">&#39;</span>

    <span class="k">if</span> <span class="n">avgMonths</span><span class="o">==</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">12</span><span class="p">]:</span>
        <span class="n">var_ann</span> <span class="o">=</span> <span class="n">var_da</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;time.year&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">)</span>
        <span class="n">year_ann</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">var_ann</span><span class="p">[</span><span class="s1">&#39;year&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">month</span> <span class="o">=</span> <span class="n">var_da</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;time.month&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">month</span>

        <span class="n">var_ann</span> <span class="o">=</span> <span class="n">var_da</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
            <span class="p">(</span><span class="n">month</span> <span class="o">&gt;=</span> <span class="n">m_start</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">month</span> <span class="o">&lt;=</span> <span class="n">m_end</span><span class="p">)</span>
        <span class="p">)</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="n">offset_str</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">m_start</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">year_ann</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">var_ann</span><span class="p">[</span><span class="s1">&#39;time.year&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">year_ann</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">var_ann</span><span class="p">[</span><span class="s1">&#39;time.year&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)))</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="n">var_ann</span> <span class="o">=</span> <span class="n">var_ann</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">year_ann</span> <span class="o">=</span> <span class="n">year_ann</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

    <span class="n">var_tmp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">var_ann</span><span class="p">)</span>
    <span class="n">var_ann</span> <span class="o">=</span> <span class="n">var_ann</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">var_tmp</span><span class="p">)]</span>
    <span class="n">year_ann</span> <span class="o">=</span> <span class="n">year_ann</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">var_tmp</span><span class="p">)]</span>
    <span class="k">return</span> <span class="n">var_ann</span><span class="p">,</span> <span class="n">year_ann</span></div>


<span class="k">def</span> <span class="nf">seasonal_var</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">year_float</span><span class="p">,</span> <span class="n">avgMonths</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">12</span><span class="p">],</span> <span class="n">make_yr_mm_nan</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; Annualize a variable array based on seasonality</span>

<span class="sd">    Args:</span>
<span class="sd">        var (ndarray): the target variable array with 1st dim to be year</span>
<span class="sd">        year_float (1-D array): the time axis of the variable array</span>
<span class="sd">        make_yr_mm_nan (bool): make year with missing months nan or not</span>

<span class="sd">    Returns:</span>
<span class="sd">        var_ann (ndarray): the annualized variable array</span>
<span class="sd">        year_ann (1-D array): the time axis of the annualized variable array</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">var</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">var</span><span class="p">)</span>
    <span class="n">var_shape</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">var</span><span class="p">)</span>
    <span class="n">ndim</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">var_shape</span><span class="p">)</span>
    <span class="n">year_float</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">year_float</span><span class="p">)</span>

    <span class="n">time</span> <span class="o">=</span> <span class="n">year_float2datetime</span><span class="p">(</span><span class="n">year_float</span><span class="p">)</span>

    <span class="n">nbmonths</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">avgMonths</span><span class="p">)</span>
    <span class="n">cyears</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">([</span><span class="n">t</span><span class="o">.</span><span class="n">year</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">time</span><span class="p">])))</span>
    <span class="n">year_ann</span> <span class="o">=</span> <span class="n">cyears</span>
    <span class="n">nbcyears</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">cyears</span><span class="p">)</span>

    <span class="n">var_ann_shape</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">var_shape</span><span class="p">)</span>
    <span class="n">var_ann_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">nbcyears</span>
    <span class="n">var_ann</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="n">var_ann_shape</span><span class="p">)</span>
    <span class="n">var_ann</span><span class="p">[:,</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span> <span class="c1"># initialize with nan&#39;s</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nbcyears</span><span class="p">):</span>
        <span class="c1"># monthly data from current year</span>
        <span class="n">indsyr</span> <span class="o">=</span> <span class="p">[</span><span class="n">j</span> <span class="k">for</span> <span class="n">j</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">time</span><span class="p">)</span> <span class="k">if</span> <span class="n">v</span><span class="o">.</span><span class="n">year</span> <span class="o">==</span> <span class="n">cyears</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">and</span> <span class="n">v</span><span class="o">.</span><span class="n">month</span> <span class="ow">in</span> <span class="n">avgMonths</span><span class="p">]</span>
        <span class="c1"># check if data from previous year is to be included</span>
        <span class="n">indsyrm1</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">m</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">avgMonths</span><span class="p">):</span>
            <span class="n">year_before</span> <span class="o">=</span> <span class="p">[</span><span class="nb">abs</span><span class="p">(</span><span class="n">m</span><span class="p">)</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">avgMonths</span> <span class="k">if</span> <span class="n">m</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">]</span>
            <span class="n">indsyrm1</span> <span class="o">=</span> <span class="p">[</span><span class="n">j</span> <span class="k">for</span> <span class="n">j</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">time</span><span class="p">)</span> <span class="k">if</span> <span class="n">v</span><span class="o">.</span><span class="n">year</span> <span class="o">==</span> <span class="n">cyears</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-</span><span class="mf">1.</span> <span class="ow">and</span> <span class="n">v</span><span class="o">.</span><span class="n">month</span> <span class="ow">in</span> <span class="n">year_before</span><span class="p">]</span>
        <span class="c1"># check if data from following year is to be included</span>
        <span class="n">indsyrp1</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">m</span> <span class="o">&gt;</span> <span class="mi">12</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">avgMonths</span><span class="p">):</span>
            <span class="n">year_follow</span> <span class="o">=</span> <span class="p">[</span><span class="n">m</span><span class="o">-</span><span class="mi">12</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">avgMonths</span> <span class="k">if</span> <span class="n">m</span> <span class="o">&gt;</span> <span class="mi">12</span><span class="p">]</span>
            <span class="n">indsyrp1</span> <span class="o">=</span> <span class="p">[</span><span class="n">j</span> <span class="k">for</span> <span class="n">j</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">time</span><span class="p">)</span> <span class="k">if</span> <span class="n">v</span><span class="o">.</span><span class="n">year</span> <span class="o">==</span> <span class="n">cyears</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">+</span><span class="mf">1.</span> <span class="ow">and</span> <span class="n">v</span><span class="o">.</span><span class="n">month</span> <span class="ow">in</span> <span class="n">year_follow</span><span class="p">]</span>

        <span class="n">inds</span> <span class="o">=</span> <span class="n">indsyrm1</span> <span class="o">+</span> <span class="n">indsyr</span> <span class="o">+</span> <span class="n">indsyrp1</span>

        <span class="k">if</span> <span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">tmp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">var</span><span class="p">[</span><span class="n">inds</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">nancount</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">var</span><span class="p">[</span><span class="n">inds</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">nancount</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">tmp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">tmp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">var</span><span class="p">[</span><span class="n">inds</span><span class="p">,</span> <span class="o">...</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">nancount</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">var</span><span class="p">[</span><span class="n">inds</span><span class="p">,</span> <span class="o">...</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">tmp</span><span class="p">[</span><span class="n">nancount</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

        <span class="k">if</span> <span class="n">make_yr_mm_nan</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">inds</span><span class="p">)</span> <span class="o">!=</span> <span class="n">nbmonths</span><span class="p">:</span>
                <span class="n">tmp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

        <span class="n">var_ann</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmp</span>

    <span class="k">return</span> <span class="n">var_ann</span><span class="p">,</span> <span class="n">year_ann</span>


<span class="k">def</span> <span class="nf">make_xr</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">year_float</span><span class="p">):</span>
    <span class="n">var</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">var</span><span class="p">)</span>
    <span class="n">year_float</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">year_float</span><span class="p">)</span>

    <span class="n">ndims</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">var</span><span class="p">))</span>
    <span class="n">dims</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ndims</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">dims</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;dim{i+1}&#39;</span><span class="p">)</span>

    <span class="n">time</span> <span class="o">=</span> <span class="n">year_float2datetime</span><span class="p">(</span><span class="n">year_float</span><span class="p">)</span>
    <span class="n">var_da</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">dims</span><span class="o">=</span><span class="n">dims</span><span class="p">,</span> <span class="n">coords</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;time&#39;</span><span class="p">:</span> <span class="n">time</span><span class="p">})</span>
    <span class="k">return</span> <span class="n">var_da</span>


<span class="k">def</span> <span class="nf">annualize_var</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">year_float</span><span class="p">,</span> <span class="n">resolution</span><span class="o">=</span><span class="s1">&#39;month&#39;</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; Annualize a variable array</span>

<span class="sd">    Args:</span>
<span class="sd">        var (ndarray): the target variable array with 1st dim to be year</span>
<span class="sd">        year_float (1-D array): the time axis of the variable array</span>
<span class="sd">        weights (ndarray): the weights that shares the same shape of the target variable array</span>

<span class="sd">    Returns:</span>
<span class="sd">        var_ann (ndarray): the annualized variable array</span>
<span class="sd">        year_ann (1-D array): the time axis of the annualized variable array</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">var</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">var</span><span class="p">)</span>
    <span class="n">year_float</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">year_float</span><span class="p">)</span>

    <span class="n">ndims</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">var</span><span class="p">))</span>
    <span class="n">dims</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ndims</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">dims</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;dim{i+1}&#39;</span><span class="p">)</span>

    <span class="n">time</span> <span class="o">=</span> <span class="n">year_float2datetime</span><span class="p">(</span><span class="n">year_float</span><span class="p">,</span> <span class="n">resolution</span><span class="o">=</span><span class="n">resolution</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">weights</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">weights_da</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span><span class="n">weights</span><span class="p">,</span> <span class="n">dims</span><span class="o">=</span><span class="n">dims</span><span class="p">,</span> <span class="n">coords</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;time&#39;</span><span class="p">:</span> <span class="n">time</span><span class="p">})</span>

        <span class="n">coeff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">weights</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">gp</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">weights_da</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;time.year&#39;</span><span class="p">))):</span>
            <span class="n">year</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">gp</span>
            <span class="n">k</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">value</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">coeff</span><span class="p">[</span><span class="n">k</span><span class="o">*</span><span class="n">i</span><span class="p">:</span><span class="n">k</span><span class="o">*</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)]</span> <span class="o">=</span> <span class="n">value</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="k">del</span> <span class="n">weights</span><span class="p">,</span> <span class="n">weights_da</span>  <span class="c1"># save the memory</span>

        <span class="n">var</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">coeff</span><span class="p">,</span> <span class="n">var</span><span class="p">)</span>
        <span class="n">var_da</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">dims</span><span class="o">=</span><span class="n">dims</span><span class="p">,</span> <span class="n">coords</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;time&#39;</span><span class="p">:</span> <span class="n">time</span><span class="p">})</span>
        <span class="n">var_ann</span> <span class="o">=</span> <span class="n">var_da</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;time.year&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">var_da</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">dims</span><span class="o">=</span><span class="n">dims</span><span class="p">,</span> <span class="n">coords</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;time&#39;</span><span class="p">:</span> <span class="n">time</span><span class="p">})</span>
        <span class="n">var_ann</span> <span class="o">=</span> <span class="n">var_da</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;time.year&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">)</span>

    <span class="n">var_ann</span> <span class="o">=</span> <span class="n">var_ann</span><span class="o">.</span><span class="n">values</span>

    <span class="n">year_ann</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">([</span><span class="n">t</span><span class="o">.</span><span class="n">year</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">time</span><span class="p">])))</span>
    <span class="k">return</span> <span class="n">var_ann</span><span class="p">,</span> <span class="n">year_ann</span>


<span class="k">def</span> <span class="nf">get_nc_vars</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="n">varnames</span><span class="p">,</span> <span class="n">useLib</span><span class="o">=</span><span class="s1">&#39;xarray&#39;</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; Get variables from given ncfile</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">var_list</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">varnames</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">varnames</span> <span class="o">=</span> <span class="p">[</span><span class="n">varnames</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">load_with_xarray</span><span class="p">():</span>
        <span class="k">with</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_dataset</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span> <span class="k">as</span> <span class="n">ds</span><span class="p">:</span>

            <span class="k">for</span> <span class="n">varname</span> <span class="ow">in</span> <span class="n">varnames</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">varname</span> <span class="o">==</span> <span class="s1">&#39;year_float&#39;</span><span class="p">:</span>
                    <span class="n">time</span> <span class="o">=</span> <span class="n">ds</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
                    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">time</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="ow">is</span> <span class="n">np</span><span class="o">.</span><span class="n">datetime64</span><span class="p">:</span>
                        <span class="n">time</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DatetimeIndex</span><span class="p">(</span><span class="n">time</span><span class="p">)</span>

                    <span class="n">year</span> <span class="o">=</span> <span class="p">[</span><span class="n">d</span><span class="o">.</span><span class="n">year</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">time</span><span class="p">]</span>
                    <span class="n">month</span> <span class="o">=</span> <span class="p">[</span><span class="n">d</span><span class="o">.</span><span class="n">month</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">time</span><span class="p">]</span>
                    <span class="n">day</span> <span class="o">=</span> <span class="p">[</span><span class="n">d</span><span class="o">.</span><span class="n">day</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">time</span><span class="p">]</span>

                    <span class="n">year_float</span> <span class="o">=</span> <span class="n">ymd2year_float</span><span class="p">(</span><span class="n">year</span><span class="p">,</span> <span class="n">month</span><span class="p">,</span> <span class="n">day</span><span class="p">)</span>
                    <span class="n">var_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">year_float</span><span class="p">)</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="n">var_tmp</span> <span class="o">=</span> <span class="n">ds</span><span class="p">[</span><span class="n">varname</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
                    <span class="k">if</span> <span class="n">varname</span> <span class="o">==</span> <span class="s1">&#39;lon&#39;</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">var_tmp</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">var_tmp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mod</span><span class="p">(</span><span class="n">var_tmp</span><span class="p">,</span> <span class="mi">360</span><span class="p">)</span>  <span class="c1"># convert from (-180, 180) to (0, 360)</span>
                    <span class="n">var_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">var_tmp</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">var_list</span>

    <span class="k">def</span> <span class="nf">load_with_netCDF4</span><span class="p">():</span>
        <span class="k">with</span> <span class="n">netCDF4</span><span class="o">.</span><span class="n">Dataset</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">ds</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">varname</span> <span class="ow">in</span> <span class="n">varnames</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">varname</span> <span class="o">==</span> <span class="s1">&#39;year_float&#39;</span><span class="p">:</span>
                    <span class="n">time</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span>
                    <span class="n">time_convert</span> <span class="o">=</span> <span class="n">netCDF4</span><span class="o">.</span><span class="n">num2date</span><span class="p">(</span><span class="n">time</span><span class="p">[:],</span> <span class="n">time</span><span class="o">.</span><span class="n">units</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">calendar</span><span class="p">)</span>

                    <span class="n">year_float</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">time_convert</span><span class="p">:</span>
                        <span class="n">y</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">d</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">year</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">month</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">day</span>
                        <span class="n">date</span> <span class="o">=</span> <span class="n">datetime</span><span class="p">(</span><span class="n">year</span><span class="o">=</span><span class="n">y</span><span class="p">,</span> <span class="n">month</span><span class="o">=</span><span class="n">m</span><span class="p">,</span> <span class="n">day</span><span class="o">=</span><span class="n">d</span><span class="p">)</span>
                        <span class="n">fst_day</span> <span class="o">=</span> <span class="n">datetime</span><span class="p">(</span><span class="n">year</span><span class="o">=</span><span class="n">y</span><span class="p">,</span> <span class="n">month</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">day</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                        <span class="n">lst_day</span> <span class="o">=</span> <span class="n">datetime</span><span class="p">(</span><span class="n">year</span><span class="o">=</span><span class="n">y</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">month</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">day</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                        <span class="n">year_part</span> <span class="o">=</span> <span class="n">date</span> <span class="o">-</span> <span class="n">fst_day</span>
                        <span class="n">year_length</span> <span class="o">=</span> <span class="n">lst_day</span> <span class="o">-</span> <span class="n">fst_day</span>
                        <span class="n">year_float</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">y</span> <span class="o">+</span> <span class="n">year_part</span><span class="o">/</span><span class="n">year_length</span><span class="p">)</span>

                    <span class="n">var_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">year_float</span><span class="p">))</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="n">var_tmp</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="n">varname</span><span class="p">][:]</span>
                    <span class="k">if</span> <span class="n">varname</span> <span class="o">==</span> <span class="s1">&#39;lon&#39;</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">var_tmp</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">var_tmp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mod</span><span class="p">(</span><span class="n">var_tmp</span><span class="p">,</span> <span class="mi">360</span><span class="p">)</span>  <span class="c1"># convert from (-180, 180) to (0, 360)</span>
                    <span class="n">var_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">var_tmp</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">var_list</span>

    <span class="n">load_nc</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;xarray&#39;</span><span class="p">:</span> <span class="n">load_with_xarray</span><span class="p">,</span>
        <span class="s1">&#39;netCDF4&#39;</span><span class="p">:</span> <span class="n">load_with_netCDF4</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="n">var_list</span> <span class="o">=</span> <span class="n">load_nc</span><span class="p">[</span><span class="n">useLib</span><span class="p">]()</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">var_list</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">var_list</span> <span class="o">=</span> <span class="n">var_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">var_list</span>


<span class="k">def</span> <span class="nf">get_anomaly</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">year_float</span><span class="p">,</span> <span class="n">ref_period</span><span class="o">=</span><span class="p">(</span><span class="mi">1951</span><span class="p">,</span> <span class="mi">1980</span><span class="p">)):</span>
    <span class="n">var_da</span> <span class="o">=</span> <span class="n">make_xr</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">year_float</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">ref_period</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">year_float</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;Time axis not overlap with the reference period </span><span class="si">{ref_period}</span><span class="s1">; use its own time period as reference {(int(np.min(year_float)), int(np.max(year_float)))}.&#39;</span><span class="p">)</span>
        <span class="n">var_ref</span> <span class="o">=</span> <span class="n">var_da</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">var_ref</span> <span class="o">=</span> <span class="n">var_da</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">ref_period</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span><span class="nb">str</span><span class="p">(</span><span class="n">ref_period</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])]</span>
    <span class="n">climatology</span> <span class="o">=</span> <span class="n">var_ref</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;time.month&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">)</span>
    <span class="n">var_anom</span> <span class="o">=</span> <span class="n">var_da</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;time.month&#39;</span><span class="p">)</span> <span class="o">-</span> <span class="n">climatology</span>
    <span class="k">return</span> <span class="n">var_anom</span><span class="o">.</span><span class="n">values</span>


<span class="k">def</span> <span class="nf">get_env_vars</span><span class="p">(</span><span class="n">prior_filesdict</span><span class="p">,</span>
                 <span class="n">rename_vars</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;tmp&#39;</span><span class="p">:</span> <span class="s1">&#39;tas&#39;</span><span class="p">,</span> <span class="s1">&#39;pre&#39;</span><span class="p">:</span> <span class="s1">&#39;pr&#39;</span><span class="p">,</span> <span class="s1">&#39;d18O&#39;</span><span class="p">:</span> <span class="s1">&#39;d18Opr&#39;</span><span class="p">,</span> <span class="s1">&#39;tos&#39;</span><span class="p">:</span> <span class="s1">&#39;sst&#39;</span><span class="p">,</span> <span class="s1">&#39;sos&#39;</span><span class="p">:</span> <span class="s1">&#39;sss&#39;</span><span class="p">},</span>
                 <span class="n">useLib</span><span class="o">=</span><span class="s1">&#39;xarray&#39;</span><span class="p">,</span> <span class="n">lat_str</span><span class="o">=</span><span class="s1">&#39;lat&#39;</span><span class="p">,</span> <span class="n">lon_str</span><span class="o">=</span><span class="s1">&#39;lon&#39;</span><span class="p">,</span>
                 <span class="n">calc_anomaly</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">ref_period</span><span class="o">=</span><span class="p">(</span><span class="mi">1951</span><span class="p">,</span> <span class="mi">1980</span><span class="p">),</span>
                 <span class="n">factor_vars</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;tas&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;pr&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;dNone8Opr&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;sst&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;sss&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">},</span>
                 <span class="n">bias_vars</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;tas&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;pr&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;d18Opr&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;sst&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;sss&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">},</span>
                 <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>

    <span class="n">prior_vars</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="n">first_item</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">for</span> <span class="n">prior_varname</span><span class="p">,</span> <span class="n">prior_filepath</span> <span class="ow">in</span> <span class="n">prior_filesdict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;Loading [</span><span class="si">{prior_varname}</span><span class="s1">] from </span><span class="si">{prior_filepath}</span><span class="s1"> ...&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">first_item</span><span class="p">:</span>
            <span class="n">lat_model</span><span class="p">,</span> <span class="n">lon_model</span><span class="p">,</span> <span class="n">time_model</span><span class="p">,</span> <span class="n">prior_vars</span><span class="p">[</span><span class="n">prior_varname</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_nc_vars</span><span class="p">(</span>
                <span class="n">prior_filepath</span><span class="p">,</span> <span class="p">[</span><span class="n">lat_str</span><span class="p">,</span> <span class="n">lon_str</span><span class="p">,</span> <span class="s1">&#39;year_float&#39;</span><span class="p">,</span> <span class="n">prior_varname</span><span class="p">],</span> <span class="n">useLib</span><span class="o">=</span><span class="n">useLib</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">first_item</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">prior_vars</span><span class="p">[</span><span class="n">prior_varname</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_nc_vars</span><span class="p">(</span><span class="n">prior_filepath</span><span class="p">,</span> <span class="n">prior_varname</span><span class="p">,</span> <span class="n">useLib</span><span class="o">=</span><span class="n">useLib</span><span class="p">)</span>

        <span class="c1"># calculate the anomaly</span>
        <span class="k">if</span> <span class="n">calc_anomaly</span><span class="p">:</span>
            <span class="n">prior_vars</span><span class="p">[</span><span class="n">prior_varname</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_anomaly</span><span class="p">(</span><span class="n">prior_vars</span><span class="p">[</span><span class="n">prior_varname</span><span class="p">],</span> <span class="n">time_model</span><span class="p">,</span> <span class="n">ref_period</span><span class="o">=</span><span class="n">ref_period</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">rename_vars</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">old_name</span><span class="p">,</span> <span class="n">new_name</span> <span class="ow">in</span> <span class="n">rename_vars</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">old_name</span> <span class="ow">in</span> <span class="n">prior_vars</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;Renaming var: </span><span class="si">{old_name}</span><span class="s1"> -&gt; </span><span class="si">{new_name}</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="n">prior_vars</span><span class="p">[</span><span class="n">new_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">prior_vars</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">old_name</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">prior_varname</span><span class="p">,</span> <span class="n">prior_var</span> <span class="ow">in</span> <span class="n">prior_vars</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">prior_varname</span> <span class="ow">in</span> <span class="n">factor_vars</span> <span class="ow">and</span> <span class="n">factor_vars</span><span class="p">[</span><span class="n">prior_varname</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">factor</span> <span class="o">=</span> <span class="n">factor_vars</span><span class="p">[</span><span class="n">prior_varname</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">factor</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="n">prior_varname</span> <span class="ow">in</span> <span class="n">bias_vars</span> <span class="ow">and</span> <span class="n">bias_vars</span><span class="p">[</span><span class="n">prior_varname</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">bias</span> <span class="o">=</span> <span class="n">bias_vars</span><span class="p">[</span><span class="n">prior_varname</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">bias</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">if</span> <span class="n">factor</span> <span class="o">!=</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">bias</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">prior_vars</span><span class="p">[</span><span class="n">prior_varname</span><span class="p">]</span> <span class="o">=</span> <span class="n">prior_var</span> <span class="o">*</span> <span class="n">factor</span> <span class="o">+</span> <span class="n">bias</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;Converting </span><span class="si">{prior_varname}</span><span class="s1">: </span><span class="si">{prior_varname}</span><span class="s1"> = </span><span class="si">{prior_varname}</span><span class="s1"> * (</span><span class="si">{factor}</span><span class="s1">) + (</span><span class="si">{bias}</span><span class="s1">)&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">lat_model</span><span class="p">,</span> <span class="n">lon_model</span><span class="p">,</span> <span class="n">time_model</span><span class="p">,</span> <span class="n">prior_vars</span>


<span class="k">def</span> <span class="nf">pick_range</span><span class="p">(</span><span class="n">ts</span><span class="p">,</span> <span class="n">ys</span><span class="p">,</span> <span class="n">lb</span><span class="p">,</span> <span class="n">ub</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; Pick range [lb, ub) from a timeseries pair (ts, ys)</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">range_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">ts</span> <span class="o">&gt;=</span> <span class="n">lb</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ts</span> <span class="o">&lt;</span> <span class="n">ub</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ts</span><span class="p">[</span><span class="n">range_mask</span><span class="p">],</span> <span class="n">ys</span><span class="p">[</span><span class="n">range_mask</span><span class="p">]</span>


<span class="k">def</span> <span class="nf">pick_years</span><span class="p">(</span><span class="n">year_int</span><span class="p">,</span> <span class="n">time_grid</span><span class="p">,</span> <span class="n">var_grid</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; Pick years from a timeseries pair (time_grid, var_grid) based on year_int</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">year_int</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">y</span><span class="p">)</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">year_int</span><span class="p">]</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">year_float</span> <span class="ow">in</span> <span class="n">time_grid</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">year_float</span><span class="p">)</span> <span class="ow">in</span> <span class="n">year_int</span><span class="p">:</span>
            <span class="n">mask</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">mask</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">time_grid</span><span class="p">[</span><span class="n">mask</span><span class="p">],</span> <span class="n">var_grid</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>


<span class="k">def</span> <span class="nf">clean_ts</span><span class="p">(</span><span class="n">ts</span><span class="p">,</span> <span class="n">ys</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="c1"># delete NaNs if there is any</span>
    <span class="n">ys</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">ys</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">)</span>
    <span class="n">ts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">ts</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">)</span>

    <span class="n">ys_tmp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">ys</span><span class="p">)</span>
    <span class="n">ys</span> <span class="o">=</span> <span class="n">ys</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">ys_tmp</span><span class="p">)]</span>
    <span class="n">ts</span> <span class="o">=</span> <span class="n">ts</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">ys_tmp</span><span class="p">)]</span>
    <span class="n">ts_tmp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">ts</span><span class="p">)</span>
    <span class="n">ys</span> <span class="o">=</span> <span class="n">ys</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">ts_tmp</span><span class="p">)]</span>
    <span class="n">ts</span> <span class="o">=</span> <span class="n">ts</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">ts_tmp</span><span class="p">)]</span>

    <span class="c1"># sort the time series so that the time axis will be ascending</span>
    <span class="n">sort_ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">ts</span><span class="p">)</span>
    <span class="n">ys</span> <span class="o">=</span> <span class="n">ys</span><span class="p">[</span><span class="n">sort_ind</span><span class="p">]</span>
    <span class="n">ts</span> <span class="o">=</span> <span class="n">ts</span><span class="p">[</span><span class="n">sort_ind</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">start</span><span class="p">:</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">ts</span> <span class="o">&gt;=</span> <span class="n">start</span>
        <span class="n">ts</span> <span class="o">=</span> <span class="n">ts</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
        <span class="n">ys</span> <span class="o">=</span> <span class="n">ys</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">ts</span><span class="p">,</span> <span class="n">ys</span>


<span class="k">def</span> <span class="nf">overlap_ts</span><span class="p">(</span><span class="n">t1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">t2</span><span class="p">,</span> <span class="n">y2</span><span class="p">):</span>
    <span class="n">t1</span><span class="p">,</span> <span class="n">y1</span> <span class="o">=</span> <span class="n">clean_ts</span><span class="p">(</span><span class="n">t1</span><span class="p">,</span> <span class="n">y1</span><span class="p">)</span>
    <span class="n">t2</span><span class="p">,</span> <span class="n">y2</span> <span class="o">=</span> <span class="n">clean_ts</span><span class="p">(</span><span class="n">t2</span><span class="p">,</span> <span class="n">y2</span><span class="p">)</span>

    <span class="c1"># get overlap range</span>
    <span class="n">overlap_yrs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">intersect1d</span><span class="p">(</span><span class="n">t1</span><span class="p">,</span> <span class="n">t2</span><span class="p">)</span>
    <span class="n">ind1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">t1</span><span class="p">,</span> <span class="n">overlap_yrs</span><span class="p">)</span>
    <span class="n">ind2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">t2</span><span class="p">,</span> <span class="n">overlap_yrs</span><span class="p">)</span>
    <span class="n">y1_overlap</span> <span class="o">=</span> <span class="n">y1</span><span class="p">[</span><span class="n">ind1</span><span class="p">]</span>
    <span class="n">y2_overlap</span> <span class="o">=</span> <span class="n">y2</span><span class="p">[</span><span class="n">ind2</span><span class="p">]</span>
    <span class="n">t1_overlap</span> <span class="o">=</span> <span class="n">t1</span><span class="p">[</span><span class="n">ind1</span><span class="p">]</span>
    <span class="n">t2_overlap</span> <span class="o">=</span> <span class="n">t2</span><span class="p">[</span><span class="n">ind2</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">t1_overlap</span><span class="p">,</span> <span class="n">y1_overlap</span><span class="p">,</span> <span class="n">t2_overlap</span><span class="p">,</span> <span class="n">y2_overlap</span>


<span class="k">def</span> <span class="nf">rolling_avg</span><span class="p">(</span><span class="n">ts</span><span class="p">,</span> <span class="n">ys</span><span class="p">,</span> <span class="n">win_len</span><span class="p">,</span> <span class="n">rolling_kws</span><span class="o">=</span><span class="p">{}):</span>
    <span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;time&#39;</span><span class="p">:</span> <span class="n">ts</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="n">ys</span><span class="p">}</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">)</span>
    <span class="n">df_avg</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">win_len</span><span class="p">,</span> <span class="o">**</span><span class="n">rolling_kws</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

    <span class="n">ts_out</span> <span class="o">=</span> <span class="n">df_avg</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">values</span>
    <span class="n">ys_out</span> <span class="o">=</span> <span class="n">df_avg</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>

    <span class="k">return</span> <span class="n">ts_out</span><span class="p">,</span> <span class="n">ys_out</span>


<span class="k">def</span> <span class="nf">rolling_std</span><span class="p">(</span><span class="n">ts</span><span class="p">,</span> <span class="n">ys</span><span class="p">,</span> <span class="n">win_len</span><span class="p">,</span> <span class="n">rolling_kws</span><span class="o">=</span><span class="p">{}):</span>
    <span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;time&#39;</span><span class="p">:</span> <span class="n">ts</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="n">ys</span><span class="p">}</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">)</span>
    <span class="n">df_std</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">win_len</span><span class="p">,</span> <span class="o">**</span><span class="n">rolling_kws</span><span class="p">)</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>

    <span class="n">ts_out</span> <span class="o">=</span> <span class="n">df_std</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">values</span>
    <span class="n">ys_out</span> <span class="o">=</span> <span class="n">df_std</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>

    <span class="k">return</span> <span class="n">ts_out</span><span class="p">,</span> <span class="n">ys_out</span>


<span class="k">def</span> <span class="nf">weighted_ma</span><span class="p">(</span><span class="n">ys</span><span class="p">,</span> <span class="n">weights</span><span class="p">):</span>
    <span class="n">nt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">ys</span><span class="p">)</span>
    <span class="n">ys_wma</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">nt</span><span class="p">)</span>

    <span class="n">nw</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">weights</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nw</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">ys_wma</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">ys</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nw</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">nt</span><span class="p">):</span>
        <span class="n">ys_wma</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">ys</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="n">nw</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span> <span class="n">weights</span><span class="o">=</span><span class="n">weights</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">ys_wma</span>


<span class="k">def</span> <span class="nf">get_distance</span><span class="p">(</span><span class="n">lon_pt</span><span class="p">,</span> <span class="n">lat_pt</span><span class="p">,</span> <span class="n">lon_ref</span><span class="p">,</span> <span class="n">lat_ref</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Vectorized calculation the great circle distances between lat-lon points</span>
<span class="sd">    on the Earth (lat/lon are specified in decimal degrees)</span>

<span class="sd">    Input:</span>
<span class="sd">    lon_pt , lat_pt  : longitude, latitude of site w.r.t. which distances</span>
<span class="sd">                       are to be calculated. Both should be scalars.</span>
<span class="sd">    lon_ref, lat_ref : longitudes, latitudes of reference field</span>
<span class="sd">                       (e.g. calibration dataset, reconstruction grid)</span>
<span class="sd">                       May be scalar, 1D arrays, or 2D arrays.</span>

<span class="sd">    Output: Returns array containing distances between (lon_pt, lat_pt) and all other points</span>
<span class="sd">            in (lon_ref,lat_ref). Array has dimensions [dim(lon_ref),dim(lat_ref)].</span>

<span class="sd">    Originator: R. Tardif, Atmospheric sciences, U. of Washington, January 2016</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Convert decimal degrees to radians</span>
    <span class="n">lon_pt</span><span class="p">,</span> <span class="n">lat_pt</span><span class="p">,</span> <span class="n">lon_ref</span><span class="p">,</span> <span class="n">lat_ref</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">,</span> <span class="p">[</span><span class="n">lon_pt</span><span class="p">,</span> <span class="n">lat_pt</span><span class="p">,</span> <span class="n">lon_ref</span><span class="p">,</span> <span class="n">lat_ref</span><span class="p">]))</span>

    <span class="c1"># check dimension of lon_ref and lat_ref</span>
    <span class="n">dims_ref</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">lon_ref</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">dims_ref</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">lats</span> <span class="o">=</span> <span class="n">lat_ref</span>
        <span class="n">lons</span> <span class="o">=</span> <span class="n">lon_ref</span>
    <span class="k">elif</span> <span class="n">dims_ref</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">lon_dim</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">lon_ref</span><span class="p">)</span>
        <span class="n">lat_dim</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">lat_ref</span><span class="p">)</span>
        <span class="n">nbpts</span> <span class="o">=</span> <span class="n">lon_dim</span><span class="o">*</span><span class="n">lat_dim</span>
        <span class="n">lats</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">lat_ref</span><span class="p">,]</span><span class="o">*</span><span class="n">lon_dim</span><span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span>
        <span class="n">lons</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">lon_ref</span><span class="p">,]</span><span class="o">*</span><span class="n">lat_dim</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">dims_ref</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">lats</span> <span class="o">=</span> <span class="n">lat_ref</span>
        <span class="n">lons</span> <span class="o">=</span> <span class="n">lon_ref</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;ERROR in get_distance!&#39;</span><span class="p">)</span>
        <span class="k">raise</span> <span class="ne">SystemExit</span><span class="p">()</span>

    <span class="c1"># Haversine formula using arrays as input</span>
    <span class="n">dlon</span> <span class="o">=</span> <span class="n">lons</span> <span class="o">-</span> <span class="n">lon_pt</span>
    <span class="n">dlat</span> <span class="o">=</span> <span class="n">lats</span> <span class="o">-</span> <span class="n">lat_pt</span>

    <span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">dlat</span><span class="o">/</span><span class="mf">2.</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">lat_pt</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">lats</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">dlon</span><span class="o">/</span><span class="mf">2.</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>
    <span class="n">c</span> <span class="o">=</span> <span class="mf">2.</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">arcsin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">a</span><span class="p">))</span>
    <span class="n">km</span> <span class="o">=</span> <span class="mf">6367.0</span> <span class="o">*</span> <span class="n">c</span>

    <span class="k">return</span> <span class="n">km</span>


<span class="k">def</span> <span class="nf">calc_seasonal_avg</span><span class="p">(</span>
    <span class="n">var</span><span class="p">,</span> <span class="n">year_float</span><span class="p">,</span>
    <span class="n">seasonality</span><span class="o">=</span><span class="p">[</span>
        <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">11</span><span class="p">,</span><span class="mi">12</span><span class="p">],</span>
        <span class="p">[</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">],</span>
        <span class="p">[</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">11</span><span class="p">],</span>
        <span class="p">[</span><span class="o">-</span><span class="mi">12</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">],</span>
        <span class="p">[</span><span class="o">-</span><span class="mi">12</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">],</span>
    <span class="p">],</span>
    <span class="n">lat</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">lon</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">save_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">make_yr_mm_nan</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; Pre-calculate the seasonal average of the target variable</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">var_ann_dict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">avgMonths</span> <span class="ow">in</span> <span class="n">seasonality</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;&gt;&gt;&gt; Processing </span><span class="si">{avgMonths}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="n">var_ann</span><span class="p">,</span> <span class="n">year_ann</span> <span class="o">=</span> <span class="n">seasonal_var</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">year_float</span><span class="p">,</span> <span class="n">avgMonths</span><span class="o">=</span><span class="n">avgMonths</span><span class="p">,</span> <span class="n">make_yr_mm_nan</span><span class="o">=</span><span class="n">make_yr_mm_nan</span><span class="p">)</span>

        <span class="n">season_tag</span> <span class="o">=</span> <span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">m</span><span class="p">)</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">avgMonths</span><span class="p">)</span>
        <span class="n">var_ann_dict</span><span class="p">[</span><span class="n">season_tag</span><span class="p">]</span> <span class="o">=</span> <span class="n">var_ann</span>

    <span class="k">if</span> <span class="n">save_path</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">save_path</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">lat</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">lon</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">([</span><span class="n">var_ann_dict</span><span class="p">,</span> <span class="n">year_ann</span><span class="p">],</span> <span class="n">f</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">([</span><span class="n">var_ann_dict</span><span class="p">,</span> <span class="n">year_ann</span><span class="p">,</span> <span class="n">lat</span><span class="p">,</span> <span class="n">lon</span><span class="p">],</span> <span class="n">f</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">var_ann_dict</span><span class="p">,</span> <span class="n">year_ann</span>


<span class="k">def</span> <span class="nf">ts_matching</span><span class="p">(</span><span class="n">time_target</span><span class="p">,</span> <span class="n">value_target</span><span class="p">,</span> <span class="n">time_ref</span><span class="p">,</span> <span class="n">value_ref</span><span class="p">,</span> <span class="n">match_std</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">match_mean</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; Perform mean correction and variance matching against the reference timeseries over overlapped time interval</span>

<span class="sd">    Args:</span>
<span class="sd">        time_target (1-D array): the time axis of the target timeseries</span>
<span class="sd">        value_target (1-D array): the value axis of the target timeseries</span>
<span class="sd">        time_ref (1-D array): the time axis of the reference timeseries</span>
<span class="sd">        value_ref (1-D array): the value axis of the reference timeseries</span>

<span class="sd">    Returns:</span>
<span class="sd">        time_corrected (1-D array): the time axis of the target timeseries after correction</span>
<span class="sd">        value_corrected (1-D array): the value axis of the target timeseries after correction</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">value_target</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">value_target</span><span class="p">)</span>
    <span class="n">value_ref</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">value_ref</span><span class="p">)</span>

    <span class="n">value_target_bak</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">value_target</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">match_std</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">t_target</span><span class="p">,</span> <span class="n">v_target</span><span class="p">,</span> <span class="n">t_ref</span><span class="p">,</span> <span class="n">v_ref</span> <span class="o">=</span> <span class="n">overlap_ts</span><span class="p">(</span><span class="n">time_target</span><span class="p">,</span> <span class="n">value_target</span><span class="p">,</span> <span class="n">time_ref</span><span class="p">,</span> <span class="n">value_ref</span><span class="p">)</span>
        <span class="n">factor</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">v_ref</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">v_target</span><span class="p">)</span>
        <span class="n">value_target</span> <span class="o">=</span> <span class="n">factor</span> <span class="o">*</span> <span class="n">value_target</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">factor</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

    <span class="c1"># order matters: match_std first and then match_mean</span>
    <span class="k">if</span> <span class="n">match_mean</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">t_target</span><span class="p">,</span> <span class="n">v_target</span><span class="p">,</span> <span class="n">t_ref</span><span class="p">,</span> <span class="n">v_ref</span> <span class="o">=</span> <span class="n">overlap_ts</span><span class="p">(</span><span class="n">time_target</span><span class="p">,</span> <span class="n">value_target</span><span class="p">,</span> <span class="n">time_ref</span><span class="p">,</span> <span class="n">value_ref</span><span class="p">)</span>
        <span class="n">bias</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">v_ref</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">v_target</span><span class="p">)</span>
        <span class="n">value_target</span> <span class="o">=</span> <span class="n">value_target</span> <span class="o">+</span> <span class="n">bias</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">bias</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="n">t_target</span><span class="p">,</span> <span class="n">v_target_bak</span><span class="p">,</span> <span class="n">t_ref</span><span class="p">,</span> <span class="n">v_ref</span> <span class="o">=</span> <span class="n">overlap_ts</span><span class="p">(</span><span class="n">time_target</span><span class="p">,</span> <span class="n">value_target_bak</span><span class="p">,</span> <span class="n">time_ref</span><span class="p">,</span> <span class="n">value_ref</span><span class="p">)</span>
        <span class="n">t_target</span><span class="p">,</span> <span class="n">v_target</span><span class="p">,</span> <span class="n">t_ref</span><span class="p">,</span> <span class="n">v_ref</span> <span class="o">=</span> <span class="n">overlap_ts</span><span class="p">(</span><span class="n">time_target</span><span class="p">,</span> <span class="n">value_target</span><span class="p">,</span> <span class="n">time_ref</span><span class="p">,</span> <span class="n">value_ref</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;---------------------------&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;overlapped timepoints: {len(t_ref)}&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;---------------------------&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">mean</span><span class="se">\t</span><span class="s1">std&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;---------------------------&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;ref:</span><span class="se">\t</span><span class="s1">{np.mean(v_ref):.2f}</span><span class="se">\t</span><span class="s1">{np.std(v_ref):.2f}&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;before:</span><span class="se">\t</span><span class="s1">{np.mean(v_target_bak):.2f}</span><span class="se">\t</span><span class="s1">{np.std(v_target_bak):.2f}&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;after:</span><span class="se">\t</span><span class="s1">{np.mean(v_target):.2f}</span><span class="se">\t</span><span class="s1">{np.std(v_target):.2f}&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">()</span>

    <span class="n">res_dict</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;value_target&#39;</span><span class="p">:</span> <span class="n">value_target</span><span class="p">,</span>
        <span class="s1">&#39;factor&#39;</span><span class="p">:</span> <span class="n">factor</span><span class="p">,</span>
        <span class="s1">&#39;bias&#39;</span><span class="p">:</span> <span class="n">bias</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">res_dict</span>


<span class="k">def</span> <span class="nf">compute_annual_means</span><span class="p">(</span><span class="n">time_raw</span><span class="p">,</span><span class="n">data_raw</span><span class="p">,</span><span class="n">valid_frac</span><span class="p">,</span><span class="n">year_type</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Computes annual-means from raw data.</span>
<span class="sd">    Inputs:</span>
<span class="sd">        time_raw   : Original time axis</span>
<span class="sd">        data_raw   : Original data</span>
<span class="sd">        valid_frac : The fraction of sub-annual data necessary to create annual mean.  Otherwise NaN.</span>
<span class="sd">        year_type  : &quot;calendar year&quot; (Jan-Dec) or &quot;tropical year&quot; (Apr-Mar)</span>

<span class="sd">    Outputs: time_annual, data_annual</span>

<span class="sd">    Authors: R. Tardif, Univ. of Washington; M. Erb, Univ. of Southern California</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Check if dealing with multiple chronologies in one data stream (for NCDC files)</span>
    <span class="n">array_shape</span> <span class="o">=</span> <span class="n">data_raw</span><span class="o">.</span><span class="n">shape</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">array_shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">nbtimes</span><span class="p">,</span> <span class="n">nbvalid</span> <span class="o">=</span> <span class="n">data_raw</span><span class="o">.</span><span class="n">shape</span>
    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">array_shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">nbtimes</span><span class="p">,</span> <span class="o">=</span> <span class="n">data_raw</span><span class="o">.</span><span class="n">shape</span>
        <span class="n">nbvalid</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">SystemExit</span><span class="p">(</span><span class="s1">&#39;ERROR in compute_annual_means: Unrecognized shape of data input array.&#39;</span><span class="p">)</span>

    <span class="c1"># -------------------------------------------</span>
    <span class="c1"># Determine temporal resolution of the record</span>
    <span class="c1"># -------------------------------------------</span>

    <span class="c1"># time differences between adjacent data pts</span>
    <span class="n">time_between_records</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">time_raw</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># Temporal resolution taken as the mode of the time differences</span>
    <span class="n">mode_time_between_records</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">mode</span><span class="p">(</span><span class="n">time_between_records</span><span class="p">)</span>
    <span class="n">time_resolution</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">mode_time_between_records</span><span class="o">.</span><span class="n">mode</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

    <span class="c1"># check if time_resolution = 0.0 !!! sometimes adjacent records are tagged at same time ...</span>
    <span class="k">if</span> <span class="n">time_resolution</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;***WARNING! Found adjacent records with same times!&#39;</span><span class="p">)</span>
        <span class="n">inderr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">time_between_records</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">inderr</span><span class="p">)</span>
        <span class="n">time_between_records</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">time_between_records</span><span class="p">,</span><span class="n">inderr</span><span class="p">)</span>
        <span class="n">time_resolution</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">stats</span><span class="o">.</span><span class="n">mode</span><span class="p">(</span><span class="n">time_between_records</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>

    <span class="c1"># some extra checks</span>
    <span class="k">if</span> <span class="n">mode_time_between_records</span><span class="o">.</span><span class="n">count</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="c1"># all unique time differences</span>
        <span class="c1"># subannual or annual+ ?</span>
        <span class="n">years_in_dataset</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">time_raw</span><span class="p">)</span>
        <span class="n">years_between_records</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">years_in_dataset</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">mode_years_between_records</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">mode</span><span class="p">(</span><span class="n">years_between_records</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">mode_years_between_records</span><span class="o">.</span><span class="n">mode</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># annual+ resolution</span>
            <span class="c1"># take resolution as smallest detected interval that is annual or longer</span>
            <span class="n">time_resolution</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">years_between_records</span><span class="p">[</span><span class="n">years_between_records</span><span class="o">&gt;</span><span class="mf">0.</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># subannual</span>
            <span class="n">time_resolution</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">time_between_records</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">time_resolution</span> <span class="o">&lt;=</span> <span class="mf">1.0</span><span class="p">:</span>
        <span class="n">proxy_resolution</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span> <span class="c1"># coarse-graining to annual</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">proxy_resolution</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time_resolution</span><span class="p">)</span>


    <span class="c1"># Get rounded integer values of all years present in record.</span>
    <span class="n">years_all</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">time_raw</span><span class="p">[</span><span class="n">k</span><span class="p">]))</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">time_raw</span><span class="p">))]</span>
    <span class="n">years</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">years_all</span><span class="p">))</span> <span class="c1"># &#39;set&#39; is used to get unique values in list</span>
    <span class="n">years</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">years</span><span class="p">)</span> <span class="c1"># sort the list</span>

    <span class="n">years</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">years</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">years</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># M. Erb</span>

    <span class="c1"># bounds, for calendar year : [years_beg,years_end[</span>
    <span class="n">years_beg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">years</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span> <span class="c1"># inclusive lower bound</span>
    <span class="n">years_end</span> <span class="o">=</span> <span class="n">years_beg</span> <span class="o">+</span> <span class="mf">1.</span>                     <span class="c1"># exclusive upper bound</span>

    <span class="c1"># If some of the time values are floats (sub-annual resolution)</span>
    <span class="c1"># and year_type is tropical_year, adjust the years to cover the</span>
    <span class="c1"># tropical year (Apr-Mar).</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">equal</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mod</span><span class="p">(</span><span class="n">time_raw</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span> <span class="o">==</span> <span class="kc">False</span> <span class="ow">and</span> <span class="n">year_type</span> <span class="o">==</span> <span class="s1">&#39;tropical year&#39;</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Tropical year averaging...&quot;</span><span class="p">)</span>

        <span class="c1"># modify bounds defining the &quot;year&quot;</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">yr</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">years</span><span class="p">):</span>
            <span class="c1"># beginning of interval</span>
            <span class="k">if</span> <span class="n">calendar</span><span class="o">.</span><span class="n">isleap</span><span class="p">(</span><span class="n">yr</span><span class="p">):</span>
                <span class="n">years_beg</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">yr</span><span class="p">)</span><span class="o">+</span><span class="p">((</span><span class="mi">31</span><span class="o">+</span><span class="mi">29</span><span class="o">+</span><span class="mi">31</span><span class="p">)</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="mi">366</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">years_beg</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">yr</span><span class="p">)</span><span class="o">+</span><span class="p">((</span><span class="mi">31</span><span class="o">+</span><span class="mi">28</span><span class="o">+</span><span class="mi">31</span><span class="p">)</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="mi">365</span><span class="p">))</span>
            <span class="c1"># end of interval</span>
            <span class="k">if</span> <span class="n">calendar</span><span class="o">.</span><span class="n">isleap</span><span class="p">(</span><span class="n">yr</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
                <span class="n">years_end</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">yr</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="p">((</span><span class="mi">31</span><span class="o">+</span><span class="mi">29</span><span class="o">+</span><span class="mi">31</span><span class="p">)</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="mi">366</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">years_end</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">yr</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="p">((</span><span class="mi">31</span><span class="o">+</span><span class="mi">28</span><span class="o">+</span><span class="mi">31</span><span class="p">)</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="mi">365</span><span class="p">))</span>

    <span class="n">time_annual</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">years</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
    <span class="n">data_annual</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">years</span><span class="p">),</span><span class="n">nbvalid</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
    <span class="c1"># fill with NaNs for default values</span>
    <span class="n">data_annual</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">NAN</span>

    <span class="c1"># Calculate the mean of all data points with the same year.</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">years</span><span class="p">)):</span>
        <span class="n">ind</span> <span class="o">=</span> <span class="p">[</span><span class="n">j</span> <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">year</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">time_raw</span><span class="p">)</span> <span class="k">if</span> <span class="p">(</span><span class="n">year</span> <span class="o">&gt;=</span> <span class="n">years_beg</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="ow">and</span> <span class="p">(</span><span class="n">year</span> <span class="o">&lt;</span> <span class="n">years_end</span><span class="p">[</span><span class="n">i</span><span class="p">])]</span>
        <span class="n">nbdat</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ind</span><span class="p">)</span>

        <span class="c1"># TODO: check nb of non-NaN values !!!!! ... ... ... ... ... ...</span>

        <span class="k">if</span> <span class="n">time_resolution</span> <span class="o">&lt;=</span> <span class="mf">1.0</span><span class="p">:</span>
            <span class="n">max_nb_per_year</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mf">1.0</span><span class="o">/</span><span class="n">time_resolution</span><span class="p">)</span>
            <span class="n">frac</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">nbdat</span><span class="p">)</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="n">max_nb_per_year</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">frac</span> <span class="o">&gt;</span> <span class="n">valid_frac</span><span class="p">:</span>
                <span class="n">data_annual</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">data_raw</span><span class="p">[</span><span class="n">ind</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">nbdat</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;***WARNING! Found multiple records in same year in data with multiyear resolution!&#39;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;   year= </span><span class="si">%d</span><span class="s1"> </span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">years</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">nbdat</span><span class="p">))</span>
            <span class="c1"># Note: this calculates the mean if multiple entries found</span>
            <span class="n">data_annual</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">data_raw</span><span class="p">[</span><span class="n">ind</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>


    <span class="c1"># check and modify time_annual array to reflect only the valid data present in the annual record</span>
    <span class="c1"># for correct tagging of &quot;Oldest&quot; and &quot;Youngest&quot; data</span>
    <span class="n">indok</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">data_annual</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">keep</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">indok</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">indok</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>


    <span class="k">return</span> <span class="n">time_annual</span><span class="p">[</span><span class="n">keep</span><span class="p">],</span> <span class="n">data_annual</span><span class="p">[</span><span class="n">keep</span><span class="p">,:],</span> <span class="n">proxy_resolution</span>


<span class="k">def</span> <span class="nf">make_groups</span><span class="p">(</span><span class="n">ys</span><span class="p">,</span> <span class="n">window</span><span class="p">,</span> <span class="n">apply_func</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">apply_kws</span><span class="o">=</span><span class="p">{}):</span>
    <span class="n">nt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">ys</span><span class="p">)</span>
    <span class="n">ngrp</span> <span class="o">=</span> <span class="n">nt</span> <span class="o">//</span> <span class="n">window</span>
    <span class="n">grp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">((</span><span class="n">ngrp</span><span class="p">,</span> <span class="n">window</span><span class="p">))</span>
    <span class="n">grp</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ngrp</span><span class="p">):</span>
        <span class="n">grp</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">ys</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="n">window</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">apply_func</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">grp</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">ngrp</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">g</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">grp</span><span class="p">):</span>
            <span class="n">res</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">apply_func</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="o">**</span><span class="n">apply_kws</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">res</span>

<span class="c1"># ===============================================</span>
<span class="c1">#  Multivariate bias correction</span>
<span class="c1"># -----------------------------------------------</span>
<span class="k">def</span> <span class="nf">mbc</span><span class="p">(</span><span class="n">tas</span><span class="p">,</span> <span class="n">pr</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span>
         <span class="n">ref_tas</span><span class="p">,</span> <span class="n">ref_pr</span><span class="p">,</span> <span class="n">ref_time</span><span class="p">,</span>
         <span class="n">seed</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">Rlib_path</span><span class="o">=</span><span class="s1">&#39;/Library/Frameworks/R.framework/Versions/3.6/Resources/library&#39;</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; Perform multivariate bias correction</span>

<span class="sd">    Args:</span>
<span class="sd">        tas (1-D array): the temperature timeseries at the proxy location</span>
<span class="sd">        pr (1-D array): the precipitation timeseries at the proxy location</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="kn">from</span> <span class="nn">rpy2.robjects.packages</span> <span class="k">import</span> <span class="n">importr</span>
    <span class="kn">import</span> <span class="nn">rpy2.robjects.numpy2ri</span>
    <span class="kn">import</span> <span class="nn">rpy2.robjects</span> <span class="k">as</span> <span class="nn">ro</span>
    <span class="n">rpy2</span><span class="o">.</span><span class="n">robjects</span><span class="o">.</span><span class="n">numpy2ri</span><span class="o">.</span><span class="n">activate</span><span class="p">()</span>

    <span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">ref_tas</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">200</span><span class="p">:</span>
        <span class="n">ref_tas</span> <span class="o">+=</span> <span class="mf">273.15</span>  <span class="c1"># convert to [K]</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">ref_pr</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">ref_pr</span> <span class="o">=</span> <span class="n">ref_pr</span> <span class="o">/</span> <span class="p">(</span><span class="mi">3000</span><span class="o">*</span><span class="mi">24</span><span class="o">*</span><span class="mi">30</span><span class="p">)</span>  <span class="c1"># convert to precipitation rate in [kg/m2/s]</span>

    <span class="c1"># make the resolution of the time axis be month</span>
    <span class="n">ref_date</span> <span class="o">=</span> <span class="n">year_float2datetime</span><span class="p">(</span><span class="n">ref_time</span><span class="p">,</span> <span class="n">resolution</span><span class="o">=</span><span class="s1">&#39;month&#39;</span><span class="p">)</span>
    <span class="n">ref_time_fix</span> <span class="o">=</span> <span class="n">datetime2year_float</span><span class="p">(</span><span class="n">ref_date</span><span class="p">)</span>

    <span class="n">model_date</span> <span class="o">=</span> <span class="n">year_float2datetime</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">resolution</span><span class="o">=</span><span class="s1">&#39;month&#39;</span><span class="p">)</span>
    <span class="n">model_time_fix</span> <span class="o">=</span> <span class="n">datetime2year_float</span><span class="p">(</span><span class="n">model_date</span><span class="p">)</span>

    <span class="c1"># get the overlapped timespan for calibration</span>
    <span class="n">overlap_yrs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">intersect1d</span><span class="p">(</span><span class="n">ref_time_fix</span><span class="p">,</span> <span class="n">model_time_fix</span><span class="p">)</span>
    <span class="n">ind_ref</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">ref_time</span><span class="p">,</span> <span class="n">overlap_yrs</span><span class="p">)</span>
    <span class="n">ind_model</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">overlap_yrs</span><span class="p">)</span>

    <span class="n">ref_tas_c</span> <span class="o">=</span> <span class="n">ref_tas</span><span class="p">[</span><span class="n">ind_ref</span><span class="p">]</span>
    <span class="n">ref_pr_c</span> <span class="o">=</span> <span class="n">ref_pr</span><span class="p">[</span><span class="n">ind_ref</span><span class="p">]</span>
    <span class="n">ref_vars_c</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">ref_pr_c</span><span class="p">,</span> <span class="n">ref_tas_c</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>

    <span class="n">model_tas_c</span> <span class="o">=</span> <span class="n">tas</span><span class="p">[</span><span class="n">ind_model</span><span class="p">]</span>
    <span class="n">model_pr_c</span> <span class="o">=</span> <span class="n">pr</span><span class="p">[</span><span class="n">ind_model</span><span class="p">]</span>
    <span class="n">model_vars_c</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">model_pr_c</span><span class="p">,</span> <span class="n">model_tas_c</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>
    <span class="n">model_vars</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">pr</span><span class="p">,</span> <span class="n">tas</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>
    <span class="c1"># run the multivariate bias correction function</span>
    <span class="n">ro</span><span class="o">.</span><span class="n">r</span><span class="p">(</span><span class="s1">&#39;.libPaths(&quot;</span><span class="si">{}</span><span class="s1">&quot;)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">Rlib_path</span><span class="p">))</span>
    <span class="n">MBCn_R</span> <span class="o">=</span> <span class="n">importr</span><span class="p">(</span><span class="s1">&#39;MBC&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">MBCn</span>

    <span class="n">res</span> <span class="o">=</span> <span class="n">MBCn_R</span><span class="p">(</span><span class="n">o_c</span><span class="o">=</span><span class="n">ref_vars_c</span><span class="p">,</span> <span class="n">m_c</span><span class="o">=</span><span class="n">model_vars_c</span><span class="p">,</span> <span class="n">m_p</span><span class="o">=</span><span class="n">model_vars</span><span class="p">)</span>
    <span class="n">res_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

    <span class="n">pr_corrected</span> <span class="o">=</span> <span class="n">res_array</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
    <span class="n">tas_corrected</span> <span class="o">=</span> <span class="n">res_array</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">tas_corrected</span><span class="p">,</span> <span class="n">pr_corrected</span>

<span class="c1"># ===============================================</span>
<span class="c1">#  Noise</span>
<span class="c1"># -----------------------------------------------</span>
<span class="k">def</span> <span class="nf">ar1_noise</span><span class="p">(</span><span class="n">ts</span><span class="p">,</span> <span class="n">ys</span><span class="p">,</span> <span class="n">g</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">sig_noise</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">nt_noise</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Returns the AR1 noise</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
    <span class="n">ts</span><span class="p">,</span> <span class="n">ys</span> <span class="o">=</span> <span class="n">clean_ts</span><span class="p">(</span><span class="n">ts</span><span class="p">,</span> <span class="n">ys</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">nt_noise</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">nt_noise</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">ts</span><span class="p">)</span>

    <span class="n">nt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">ts</span><span class="p">)</span>
    <span class="n">dts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">ts</span><span class="p">)</span>
    <span class="n">dt_mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dts</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">dt</span> <span class="o">==</span> <span class="n">dt_mean</span> <span class="k">for</span> <span class="n">dt</span> <span class="ow">in</span> <span class="n">dts</span><span class="p">):</span>
        <span class="n">evenly_spaced</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">evenly_spaced</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">if</span> <span class="n">evenly_spaced</span><span class="p">:</span>
        <span class="c1"># evenly spaced case</span>
        <span class="k">if</span> <span class="n">g</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ar1_mod</span> <span class="o">=</span> <span class="n">sm</span><span class="o">.</span><span class="n">tsa</span><span class="o">.</span><span class="n">AR</span><span class="p">(</span><span class="n">ys</span><span class="p">,</span> <span class="n">missing</span><span class="o">=</span><span class="s1">&#39;drop&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">maxlag</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">g</span> <span class="o">=</span> <span class="n">ar1_mod</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

        <span class="n">ar</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">r_</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="n">g</span><span class="p">]</span>
        <span class="n">ma</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">r_</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">]</span>

        <span class="n">noise</span> <span class="o">=</span> <span class="n">sm</span><span class="o">.</span><span class="n">tsa</span><span class="o">.</span><span class="n">arma_generate_sample</span><span class="p">(</span><span class="n">ar</span><span class="o">=</span><span class="n">ar</span><span class="p">,</span> <span class="n">ma</span><span class="o">=</span><span class="n">ma</span><span class="p">,</span> <span class="n">nsample</span><span class="o">=</span><span class="n">nt_noise</span><span class="p">,</span> <span class="n">burnin</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># unevenly spaced case</span>
        <span class="k">def</span> <span class="nf">ar1_func</span><span class="p">(</span><span class="n">a</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">ys</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">-</span> <span class="n">ys</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">a</span><span class="o">**</span><span class="n">dts</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">g</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">a_est</span> <span class="o">=</span> <span class="n">optimize</span><span class="o">.</span><span class="n">minimize_scalar</span><span class="p">(</span><span class="n">ar1_func</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;bounded&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">x</span>
            <span class="n">g</span> <span class="o">=</span> <span class="n">a_est</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">a_est</span> <span class="o">=</span> <span class="n">g</span>

        <span class="n">tau_est</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">a_est</span><span class="p">)</span>

        <span class="n">noise</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">nt_noise</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">nt_noise</span><span class="p">):</span>
            <span class="n">scaled_dt</span> <span class="o">=</span>  <span class="p">(</span><span class="n">ts</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">ts</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="n">tau_est</span>
            <span class="n">rho</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">scaled_dt</span><span class="p">)</span>
            <span class="n">err</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span> <span class="n">rho</span><span class="o">**</span><span class="mi">2</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">noise</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">noise</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">rho</span> <span class="o">+</span> <span class="n">err</span>

    <span class="n">noise</span> <span class="o">=</span> <span class="n">noise</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">nanstd</span><span class="p">(</span><span class="n">noise</span><span class="p">)</span> <span class="o">*</span> <span class="n">sig_noise</span>

    <span class="k">return</span> <span class="n">noise</span><span class="p">,</span> <span class="n">g</span>


<span class="k">def</span> <span class="nf">colored_noise_2regimes</span><span class="p">(</span><span class="n">alpha1</span><span class="p">,</span> <span class="n">alpha2</span><span class="p">,</span> <span class="n">f_break</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">f0</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">m</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; Generate a colored noise timeseries with two regimes</span>

<span class="sd">    Args:</span>
<span class="sd">        alpha1, alpha2 (float): the exponent of the 1/f^alpha noise</span>
<span class="sd">        f_break (float): the frequency where the scaling breaks</span>
<span class="sd">        t (float): time vector of the generated noise</span>
<span class="sd">        f0 (float): fundamental frequency</span>
<span class="sd">        m (int): maximum number of the waves, which determines the</span>
<span class="sd">            highest frequency of the components in the synthetic noise</span>

<span class="sd">    Returns:</span>
<span class="sd">        y (array): the generated 1/f^alpha noise</span>

<span class="sd">    References:</span>
<span class="sd">        Eq. (15) in Kirchner, J. W. Aliasing in 1/f(alpha) noise spectra: origins, consequences, and remedies.</span>
<span class="sd">            Phys Rev E Stat Nonlin Soft Matter Phys 71, 066110 (2005).</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">n</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>  <span class="c1"># number of time points</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">f0</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">f0</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="n">n</span>  <span class="c1"># fundamental frequency</span>
    <span class="k">if</span> <span class="n">m</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">n</span><span class="o">//</span><span class="mi">2</span>  <span class="c1"># so the aliasing is limited</span>

    <span class="n">k</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">m</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>  <span class="c1"># wave numbers</span>

    <span class="k">if</span> <span class="n">seed</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>

    <span class="n">theta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">m</span><span class="p">))</span><span class="o">*</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span>  <span class="c1"># random phase</span>

    <span class="n">f_vec</span> <span class="o">=</span> <span class="n">k</span><span class="o">*</span><span class="n">f0</span>
    <span class="n">regime1</span><span class="o">=</span> <span class="n">k</span><span class="o">*</span><span class="n">f0</span><span class="o">&gt;=</span><span class="n">f_break</span>
    <span class="n">regime2</span><span class="o">=</span> <span class="n">k</span><span class="o">*</span><span class="n">f0</span><span class="o">&lt;=</span><span class="n">f_break</span>
    <span class="n">f_vec1</span> <span class="o">=</span> <span class="n">f_vec</span><span class="p">[</span><span class="n">regime1</span><span class="p">]</span>
    <span class="n">f_vec2</span> <span class="o">=</span> <span class="n">f_vec</span><span class="p">[</span><span class="n">regime2</span><span class="p">]</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">alpha1</span><span class="o">/</span><span class="n">alpha2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">f_vec1</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span> <span class="o">/</span> <span class="n">f_vec2</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
        <span class="n">coeff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">f_vec</span><span class="p">)))</span>
        <span class="n">coeff</span><span class="p">[</span><span class="n">regime1</span><span class="p">]</span> <span class="o">=</span> <span class="n">f_vec1</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="n">alpha1</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">coeff</span><span class="p">[</span><span class="n">regime2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">s</span><span class="o">*</span><span class="n">f_vec2</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="n">alpha2</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">sin_func</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">k</span><span class="o">*</span><span class="n">f0</span><span class="o">*</span><span class="n">t</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">+</span> <span class="n">theta</span><span class="p">)</span>
        <span class="n">y</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">coeff</span><span class="o">*</span><span class="n">sin_func</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">y</span>


<span class="k">def</span> <span class="nf">colored_noise</span><span class="p">(</span><span class="n">alpha</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">f0</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">m</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; Generate a colored noise timeseries</span>

<span class="sd">    Args:</span>
<span class="sd">        alpha (float): exponent of the 1/f^alpha noise</span>
<span class="sd">        t (float): time vector of the generated noise</span>
<span class="sd">        f0 (float): fundamental frequency</span>
<span class="sd">        m (int): maximum number of the waves, which determines the</span>
<span class="sd">            highest frequency of the components in the synthetic noise</span>

<span class="sd">    Returns:</span>
<span class="sd">        y (array): the generated 1/f^alpha noise</span>

<span class="sd">    References:</span>
<span class="sd">        Eq. (15) in Kirchner, J. W. Aliasing in 1/f(alpha) noise spectra: origins, consequences, and remedies.</span>
<span class="sd">            Phys Rev E Stat Nonlin Soft Matter Phys 71, 066110 (2005).</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">n</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>  <span class="c1"># number of time points</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">f0</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">f0</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="n">n</span>  <span class="c1"># fundamental frequency</span>
    <span class="k">if</span> <span class="n">m</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">n</span><span class="o">//</span><span class="mi">2</span>

    <span class="n">k</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">m</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>  <span class="c1"># wave numbers</span>

    <span class="k">if</span> <span class="n">seed</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>

    <span class="n">theta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">m</span><span class="p">))</span><span class="o">*</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span>  <span class="c1"># random phase</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
        <span class="n">coeff</span> <span class="o">=</span> <span class="p">(</span><span class="n">k</span><span class="o">*</span><span class="n">f0</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="n">alpha</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">sin_func</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">k</span><span class="o">*</span><span class="n">f0</span><span class="o">*</span><span class="n">t</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">+</span> <span class="n">theta</span><span class="p">)</span>
        <span class="n">y</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">coeff</span><span class="o">*</span><span class="n">sin_func</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">y</span>

<span class="c1"># ===============================================</span>
<span class="c1">#  Post processing</span>
<span class="c1"># -----------------------------------------------</span>
<span class="k">def</span> <span class="nf">global_hemispheric_means</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">lat</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Adapted from LMR_utils.py by Greg Hakim &amp; Robert Tardif | U. of Washington</span>

<span class="sd">     compute global and hemispheric mean valuee for all times in the input (i.e. field) array</span>
<span class="sd">     input:  field[ntime,nlat,nlon] or field[nlat,nlon]</span>
<span class="sd">             lat[nlat,nlon] in degrees</span>

<span class="sd">     output: gm : global mean of &quot;field&quot;</span>
<span class="sd">            nhm : northern hemispheric mean of &quot;field&quot;</span>
<span class="sd">            shm : southern hemispheric mean of &quot;field&quot;</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Originator: Greg Hakim</span>
    <span class="c1">#             University of Washington</span>
    <span class="c1">#             August 2015</span>
    <span class="c1">#</span>
    <span class="c1"># Modifications:</span>
    <span class="c1">#           - Modified to handle presence of missing values (nan) in arrays</span>
    <span class="c1">#             in calculation of spatial averages [ R. Tardif, November 2015 ]</span>
    <span class="c1">#           - Enhanced flexibility in the handling of missing values</span>
    <span class="c1">#             [ R. Tardif, Aug. 2017 ]</span>

    <span class="c1"># set number of times, lats, lons; array indices for lat and lon</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">field</span><span class="p">))</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span> <span class="c1"># time is a dimension</span>
        <span class="n">ntime</span><span class="p">,</span><span class="n">nlat</span><span class="p">,</span><span class="n">nlon</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">field</span><span class="p">)</span>
        <span class="n">lati</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">loni</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="k">else</span><span class="p">:</span> <span class="c1"># only spatial dims</span>
        <span class="n">ntime</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">nlat</span><span class="p">,</span><span class="n">nlon</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">field</span><span class="p">)</span>
        <span class="n">field</span> <span class="o">=</span> <span class="n">field</span><span class="p">[</span><span class="kc">None</span><span class="p">,:]</span> <span class="c1"># add time dim of size 1 for consistent array dims</span>
        <span class="n">lati</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">loni</span> <span class="o">=</span> <span class="mi">2</span>

    <span class="c1"># latitude weighting</span>
    <span class="n">lat_weight</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="n">lat</span><span class="p">))</span>
    <span class="n">tmp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">([</span><span class="n">nlon</span><span class="p">,</span><span class="n">nlat</span><span class="p">])</span>
    <span class="n">W</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">lat_weight</span><span class="p">,</span><span class="n">tmp</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>

    <span class="c1"># define hemispheres</span>
    <span class="n">eqind</span> <span class="o">=</span> <span class="n">nlat</span><span class="o">//</span><span class="mi">2</span>

    <span class="k">if</span> <span class="n">lat</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="c1"># data has NH -&gt; SH format</span>
        <span class="n">W_NH</span> <span class="o">=</span> <span class="n">W</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">eqind</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">field_NH</span> <span class="o">=</span> <span class="n">field</span><span class="p">[:,</span><span class="mi">0</span><span class="p">:</span><span class="n">eqind</span><span class="o">+</span><span class="mi">1</span><span class="p">,:]</span>
        <span class="n">W_SH</span> <span class="o">=</span> <span class="n">W</span><span class="p">[</span><span class="n">eqind</span><span class="o">+</span><span class="mi">1</span><span class="p">:]</span>
        <span class="n">field_SH</span> <span class="o">=</span> <span class="n">field</span><span class="p">[:,</span><span class="n">eqind</span><span class="o">+</span><span class="mi">1</span><span class="p">:,:]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># data has SH -&gt; NH format</span>
        <span class="n">W_NH</span> <span class="o">=</span> <span class="n">W</span><span class="p">[</span><span class="n">eqind</span><span class="p">:]</span>
        <span class="n">field_NH</span> <span class="o">=</span> <span class="n">field</span><span class="p">[:,</span><span class="n">eqind</span><span class="p">:,:]</span>
        <span class="n">W_SH</span> <span class="o">=</span> <span class="n">W</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">eqind</span><span class="p">]</span>
        <span class="n">field_SH</span> <span class="o">=</span> <span class="n">field</span><span class="p">[:,</span><span class="mi">0</span><span class="p">:</span><span class="n">eqind</span><span class="p">,:]</span>

    <span class="n">gm</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">ntime</span><span class="p">)</span>
    <span class="n">nhm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">ntime</span><span class="p">)</span>
    <span class="n">shm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">ntime</span><span class="p">)</span>

    <span class="c1"># Check for valid (non-NAN) values &amp; use numpy average function (includes weighted avg calculation)</span>
    <span class="c1"># Get arrays indices of valid values</span>
    <span class="n">indok</span>    <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">field</span><span class="p">)</span>
    <span class="n">indok_nh</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">field_NH</span><span class="p">)</span>
    <span class="n">indok_sh</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">field_SH</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ntime</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">lati</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># Global</span>
            <span class="n">gm</span><span class="p">[</span><span class="n">t</span><span class="p">]</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">field</span><span class="p">[</span><span class="n">indok</span><span class="p">],</span><span class="n">weights</span><span class="o">=</span><span class="n">W</span><span class="p">[</span><span class="n">indok</span><span class="p">])</span>
            <span class="c1"># NH</span>
            <span class="n">nhm</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">field_NH</span><span class="p">[</span><span class="n">indok_nh</span><span class="p">],</span><span class="n">weights</span><span class="o">=</span><span class="n">W_NH</span><span class="p">[</span><span class="n">indok_nh</span><span class="p">])</span>
            <span class="c1"># SH</span>
            <span class="n">shm</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">field_SH</span><span class="p">[</span><span class="n">indok_sh</span><span class="p">],</span><span class="n">weights</span><span class="o">=</span><span class="n">W_SH</span><span class="p">[</span><span class="n">indok_sh</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Global</span>
            <span class="n">indok_2d</span>    <span class="o">=</span> <span class="n">indok</span><span class="p">[</span><span class="n">t</span><span class="p">,:,:]</span>
            <span class="k">if</span> <span class="n">indok_2d</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                <span class="n">field_2d</span>    <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">field</span><span class="p">[</span><span class="n">t</span><span class="p">,:,:])</span>
                <span class="n">gm</span><span class="p">[</span><span class="n">t</span><span class="p">]</span>       <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">field_2d</span><span class="p">[</span><span class="n">indok_2d</span><span class="p">],</span><span class="n">weights</span><span class="o">=</span><span class="n">W</span><span class="p">[</span><span class="n">indok_2d</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">gm</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            <span class="c1"># NH</span>
            <span class="n">indok_nh_2d</span> <span class="o">=</span> <span class="n">indok_nh</span><span class="p">[</span><span class="n">t</span><span class="p">,:,:]</span>
            <span class="k">if</span> <span class="n">indok_nh_2d</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                <span class="n">field_nh_2d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">field_NH</span><span class="p">[</span><span class="n">t</span><span class="p">,:,:])</span>
                <span class="n">nhm</span><span class="p">[</span><span class="n">t</span><span class="p">]</span>      <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">field_nh_2d</span><span class="p">[</span><span class="n">indok_nh_2d</span><span class="p">],</span><span class="n">weights</span><span class="o">=</span><span class="n">W_NH</span><span class="p">[</span><span class="n">indok_nh_2d</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">nhm</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            <span class="c1"># SH</span>
            <span class="n">indok_sh_2d</span> <span class="o">=</span> <span class="n">indok_sh</span><span class="p">[</span><span class="n">t</span><span class="p">,:,:]</span>
            <span class="k">if</span> <span class="n">indok_sh_2d</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                <span class="n">field_sh_2d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">field_SH</span><span class="p">[</span><span class="n">t</span><span class="p">,:,:])</span>
                <span class="n">shm</span><span class="p">[</span><span class="n">t</span><span class="p">]</span>      <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">field_sh_2d</span><span class="p">[</span><span class="n">indok_sh_2d</span><span class="p">],</span><span class="n">weights</span><span class="o">=</span><span class="n">W_SH</span><span class="p">[</span><span class="n">indok_sh_2d</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">shm</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

    <span class="k">return</span> <span class="n">gm</span><span class="p">,</span> <span class="n">nhm</span><span class="p">,</span> <span class="n">shm</span>


<span class="k">def</span> <span class="nf">geo_mean</span><span class="p">(</span><span class="n">field_value</span><span class="p">,</span> <span class="n">field_lat</span><span class="p">,</span> <span class="n">field_lon</span><span class="p">,</span> <span class="n">lats</span><span class="p">,</span> <span class="n">lons</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; Calculate the average value of the given field over a list of lat/lon locations</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">value_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">weight_list</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">tot_weight</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">lat</span><span class="p">,</span> <span class="n">lon</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">lats</span><span class="p">,</span> <span class="n">lons</span><span class="p">),</span> <span class="n">total</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">lats</span><span class="p">)):</span>
        <span class="n">lat_ind</span><span class="p">,</span> <span class="n">lon_ind</span> <span class="o">=</span> <span class="n">find_closest_loc</span><span class="p">(</span><span class="n">field_lat</span><span class="p">,</span> <span class="n">field_lon</span><span class="p">,</span> <span class="n">lat</span><span class="p">,</span> <span class="n">lon</span><span class="p">)</span>

        <span class="n">lat_weight</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="n">lat</span><span class="p">))</span>
        <span class="n">weight_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lat_weight</span><span class="p">)</span>

        <span class="n">value</span> <span class="o">=</span> <span class="n">field_value</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">lat_ind</span><span class="p">,</span> <span class="n">lon_ind</span><span class="p">]</span>
        <span class="n">value_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

    <span class="n">value_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">value_list</span><span class="p">)</span>
    <span class="n">value_avg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">value_array</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">weight_list</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">value_avg</span>


<span class="k">def</span> <span class="nf">nino_indices</span><span class="p">(</span><span class="n">sst</span><span class="p">,</span> <span class="n">lats</span><span class="p">,</span> <span class="n">lons</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; Calculate Nino indices</span>

<span class="sd">    Args:</span>
<span class="sd">        sst: sea-surface temperature, the last two dimensions are assumed to be (lat, lon)</span>
<span class="sd">        lats: the latitudes in format of (-90, 90)</span>
<span class="sd">        lons: the longitudes in format of (0, 360)</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">def</span> <span class="nf">lon360</span><span class="p">(</span><span class="n">lon</span><span class="p">):</span>
        <span class="c1"># convert from (-180, 180) to (0, 360)</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">mod</span><span class="p">(</span><span class="n">lon</span><span class="p">,</span> <span class="mi">360</span><span class="p">)</span>

    <span class="n">lats</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">lats</span><span class="p">)</span>
    <span class="n">lons</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">lons</span><span class="p">)</span>

    <span class="n">lat_mask</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">lon_mask</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">ind</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="n">lat_mask</span><span class="p">[</span><span class="s1">&#39;nino1+2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">lats</span> <span class="o">&gt;=</span> <span class="o">-</span><span class="mi">10</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">lats</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">lon_mask</span><span class="p">[</span><span class="s1">&#39;nino1+2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">lons</span> <span class="o">&gt;=</span> <span class="n">lon360</span><span class="p">(</span><span class="o">-</span><span class="mi">90</span><span class="p">))</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">lons</span> <span class="o">&lt;=</span> <span class="n">lon360</span><span class="p">(</span><span class="o">-</span><span class="mi">80</span><span class="p">))</span>

    <span class="n">lat_mask</span><span class="p">[</span><span class="s1">&#39;nino3&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">lats</span> <span class="o">&gt;=</span> <span class="o">-</span><span class="mi">5</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">lats</span> <span class="o">&lt;=</span> <span class="mi">5</span><span class="p">)</span>
    <span class="n">lon_mask</span><span class="p">[</span><span class="s1">&#39;nino3&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">lons</span> <span class="o">&gt;=</span> <span class="n">lon360</span><span class="p">(</span><span class="o">-</span><span class="mi">150</span><span class="p">))</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">lons</span> <span class="o">&lt;=</span> <span class="n">lon360</span><span class="p">(</span><span class="o">-</span><span class="mi">90</span><span class="p">))</span>

    <span class="n">lat_mask</span><span class="p">[</span><span class="s1">&#39;nino3.4&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">lats</span> <span class="o">&gt;=</span> <span class="o">-</span><span class="mi">5</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">lats</span> <span class="o">&lt;=</span> <span class="mi">5</span><span class="p">)</span>
    <span class="n">lon_mask</span><span class="p">[</span><span class="s1">&#39;nino3.4&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">lons</span> <span class="o">&gt;=</span> <span class="n">lon360</span><span class="p">(</span><span class="o">-</span><span class="mi">170</span><span class="p">))</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">lons</span> <span class="o">&lt;=</span> <span class="n">lon360</span><span class="p">(</span><span class="o">-</span><span class="mi">120</span><span class="p">))</span>

    <span class="n">lat_mask</span><span class="p">[</span><span class="s1">&#39;nino4&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">lats</span> <span class="o">&gt;=</span> <span class="o">-</span><span class="mi">5</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">lats</span> <span class="o">&lt;=</span> <span class="mi">5</span><span class="p">)</span>
    <span class="n">lon_mask</span><span class="p">[</span><span class="s1">&#39;nino4&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">lons</span> <span class="o">&gt;=</span> <span class="n">lon360</span><span class="p">(</span><span class="mi">160</span><span class="p">))</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">lons</span> <span class="o">&lt;=</span> <span class="n">lon360</span><span class="p">(</span><span class="o">-</span><span class="mi">150</span><span class="p">))</span>

    <span class="k">for</span> <span class="n">region</span> <span class="ow">in</span> <span class="n">lat_mask</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">sst_sub</span> <span class="o">=</span> <span class="n">sst</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">lon_mask</span><span class="p">[</span><span class="n">region</span><span class="p">]]</span>
        <span class="n">sst_sub</span> <span class="o">=</span> <span class="n">sst_sub</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">lat_mask</span><span class="p">[</span><span class="n">region</span><span class="p">],</span> <span class="p">:]</span>
        <span class="n">ind</span><span class="p">[</span><span class="n">region</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">sst_sub</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">),</span>
            <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">weights</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="n">lats</span><span class="p">[</span><span class="n">lat_mask</span><span class="p">[</span><span class="n">region</span><span class="p">]])),</span>
        <span class="p">)</span>
    <span class="k">return</span> <span class="n">ind</span>


<span class="k">def</span> <span class="nf">calc_tpi</span><span class="p">(</span><span class="n">sst</span><span class="p">,</span> <span class="n">lats</span><span class="p">,</span> <span class="n">lons</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; Calculate Nino indices</span>

<span class="sd">    Args:</span>
<span class="sd">        sst: sea-surface temperature, the last two dimensions are assumed to be (lat, lon)</span>
<span class="sd">        lats: the latitudes in format of (-90, 90)</span>
<span class="sd">        lons: the longitudes in format of (0, 360)</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">def</span> <span class="nf">lon360</span><span class="p">(</span><span class="n">lon</span><span class="p">):</span>
        <span class="c1"># convert from (-180, 180) to (0, 360)</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">mod</span><span class="p">(</span><span class="n">lon</span><span class="p">,</span> <span class="mi">360</span><span class="p">)</span>

    <span class="n">lats</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">lats</span><span class="p">)</span>
    <span class="n">lons</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">lons</span><span class="p">)</span>

    <span class="n">lat_mask</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">lon_mask</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">ssta</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="n">lat_mask</span><span class="p">[</span><span class="s1">&#39;1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">lats</span> <span class="o">&gt;=</span> <span class="mi">25</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">lats</span> <span class="o">&lt;=</span> <span class="mi">45</span><span class="p">)</span>
    <span class="n">lon_mask</span><span class="p">[</span><span class="s1">&#39;1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">lons</span> <span class="o">&gt;=</span> <span class="n">lon360</span><span class="p">(</span><span class="mi">140</span><span class="p">))</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">lons</span> <span class="o">&lt;=</span> <span class="n">lon360</span><span class="p">(</span><span class="o">-</span><span class="mi">145</span><span class="p">))</span>

    <span class="n">lat_mask</span><span class="p">[</span><span class="s1">&#39;2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">lats</span> <span class="o">&gt;=</span> <span class="o">-</span><span class="mi">10</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">lats</span> <span class="o">&lt;=</span> <span class="mi">10</span><span class="p">)</span>
    <span class="n">lon_mask</span><span class="p">[</span><span class="s1">&#39;2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">lons</span> <span class="o">&gt;=</span> <span class="n">lon360</span><span class="p">(</span><span class="mi">170</span><span class="p">))</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">lons</span> <span class="o">&lt;=</span> <span class="n">lon360</span><span class="p">(</span><span class="o">-</span><span class="mi">90</span><span class="p">))</span>

    <span class="n">lat_mask</span><span class="p">[</span><span class="s1">&#39;3&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">lats</span> <span class="o">&gt;=</span> <span class="o">-</span><span class="mi">50</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">lats</span> <span class="o">&lt;=</span> <span class="o">-</span><span class="mi">15</span><span class="p">)</span>
    <span class="n">lon_mask</span><span class="p">[</span><span class="s1">&#39;3&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">lons</span> <span class="o">&gt;=</span> <span class="n">lon360</span><span class="p">(</span><span class="mi">150</span><span class="p">))</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">lons</span> <span class="o">&lt;=</span> <span class="n">lon360</span><span class="p">(</span><span class="o">-</span><span class="mi">160</span><span class="p">))</span>

    <span class="k">for</span> <span class="n">region</span> <span class="ow">in</span> <span class="n">lat_mask</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">sst_sub</span> <span class="o">=</span> <span class="n">sst</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">lon_mask</span><span class="p">[</span><span class="n">region</span><span class="p">]]</span>
        <span class="n">sst_sub</span> <span class="o">=</span> <span class="n">sst_sub</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">lat_mask</span><span class="p">[</span><span class="n">region</span><span class="p">],</span> <span class="p">:]</span>
        <span class="n">ssta</span><span class="p">[</span><span class="n">region</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">sst_sub</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">),</span>
            <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">weights</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="n">lats</span><span class="p">[</span><span class="n">lat_mask</span><span class="p">[</span><span class="n">region</span><span class="p">]])),</span>
        <span class="p">)</span>

    <span class="n">tpi</span> <span class="o">=</span> <span class="n">ssta</span><span class="p">[</span><span class="s1">&#39;2&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="p">(</span><span class="n">ssta</span><span class="p">[</span><span class="s1">&#39;1&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">ssta</span><span class="p">[</span><span class="s1">&#39;3&#39;</span><span class="p">])</span><span class="o">/</span><span class="mi">2</span>
    <span class="k">return</span> <span class="n">tpi</span>


<span class="k">def</span> <span class="nf">pobjs2df</span><span class="p">(</span><span class="n">pobjs</span><span class="p">,</span>
             <span class="n">col_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;type&#39;</span><span class="p">,</span> <span class="s1">&#39;start_yr&#39;</span><span class="p">,</span> <span class="s1">&#39;end_yr&#39;</span><span class="p">,</span> <span class="s1">&#39;lat&#39;</span><span class="p">,</span> <span class="s1">&#39;lon&#39;</span><span class="p">,</span> <span class="s1">&#39;elev&#39;</span><span class="p">,</span> <span class="s1">&#39;seasonality&#39;</span><span class="p">,</span> <span class="s1">&#39;values&#39;</span><span class="p">,</span> <span class="s1">&#39;time&#39;</span><span class="p">]):</span>

    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">pobjs</span><span class="p">)),</span> <span class="n">columns</span><span class="o">=</span><span class="n">col_names</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">pobj</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">pobjs</span><span class="p">):</span>
        <span class="n">pobj_dict</span> <span class="o">=</span> <span class="n">pobj</span><span class="o">.</span><span class="n">_asdict</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">col_names</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;values&#39;</span><span class="p">:</span>
                <span class="n">entry</span> <span class="o">=</span> <span class="n">pobj_dict</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">entry</span> <span class="o">=</span> <span class="n">pobj_dict</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>

            <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">entry</span>

    <span class="k">return</span> <span class="n">df</span>


<span class="k">def</span> <span class="nf">detrend</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;hht&#39;</span><span class="p">,</span> <span class="n">detrend_kws</span><span class="o">=</span><span class="p">{}):</span>
    <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;hht&#39;</span><span class="p">:</span>
        <span class="n">imfs</span> <span class="o">=</span> <span class="n">EMD</span><span class="p">(</span><span class="n">y</span><span class="p">)</span><span class="o">.</span><span class="n">decompose</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">imfs</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">trend</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">y</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">trend</span> <span class="o">=</span> <span class="n">imfs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">y_detrend</span> <span class="o">=</span> <span class="n">y</span> <span class="o">-</span> <span class="n">trend</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">y_detrended</span> <span class="o">=</span> <span class="n">signal</span><span class="o">.</span><span class="n">detrend</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="o">**</span><span class="n">detrend_kws</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">y_detrended</span>


<span class="k">def</span> <span class="nf">compare_ts</span><span class="p">(</span><span class="n">t1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">t2</span><span class="p">,</span> <span class="n">y2</span><span class="p">,</span> <span class="n">stats</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;corr&#39;</span><span class="p">,</span> <span class="s1">&#39;ce&#39;</span><span class="p">,</span> <span class="s1">&#39;rmse&#39;</span><span class="p">],</span> <span class="n">valid_frac</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">mask_period</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
               <span class="n">ref_period</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">detrend</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">detrend_kws</span><span class="o">=</span><span class="p">{},</span> <span class="n">npts_lb</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span> <span class="n">corr_method</span><span class="o">=</span><span class="s1">&#39;corr_sig&#39;</span><span class="p">,</span>
               <span class="n">corr_sig_nsim</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">corr_sig_method</span><span class="o">=</span><span class="s1">&#39;isospectral&#39;</span><span class="p">,</span> <span class="n">corr_sig_alpha</span><span class="o">=</span><span class="mf">0.05</span><span class="p">):</span>
    <span class="c1"># mask the timeseries</span>
    <span class="k">if</span> <span class="n">mask_period</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">mask_ref1</span> <span class="o">=</span> <span class="p">(</span><span class="n">t1</span> <span class="o">&gt;=</span> <span class="n">mask_period</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">t1</span> <span class="o">&lt;=</span> <span class="n">mask_period</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">mask_ref2</span> <span class="o">=</span> <span class="p">(</span><span class="n">t2</span> <span class="o">&gt;=</span> <span class="n">mask_period</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">t2</span> <span class="o">&lt;=</span> <span class="n">mask_period</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">y1</span> <span class="o">=</span> <span class="n">y1</span><span class="p">[</span><span class="n">mask_ref1</span><span class="p">]</span>
        <span class="n">y2</span> <span class="o">=</span> <span class="n">y2</span><span class="p">[</span><span class="n">mask_ref2</span><span class="p">]</span>
        <span class="n">t1</span> <span class="o">=</span> <span class="n">t1</span><span class="p">[</span><span class="n">mask_ref1</span><span class="p">]</span>
        <span class="n">t2</span> <span class="o">=</span> <span class="n">t2</span><span class="p">[</span><span class="n">mask_ref2</span><span class="p">]</span>

    <span class="c1"># remove mean over ref_period</span>
    <span class="k">if</span> <span class="n">ref_period</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">mask_ref1</span> <span class="o">=</span> <span class="p">(</span><span class="n">t1</span> <span class="o">&gt;=</span> <span class="n">ref_period</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">t1</span> <span class="o">&lt;=</span> <span class="n">ref_period</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">mask_ref2</span> <span class="o">=</span> <span class="p">(</span><span class="n">t2</span> <span class="o">&gt;=</span> <span class="n">ref_period</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">t2</span> <span class="o">&lt;=</span> <span class="n">ref_period</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">y1</span> <span class="o">-=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">y1</span><span class="p">[</span><span class="n">mask_ref1</span><span class="p">])</span>
        <span class="n">y2</span> <span class="o">-=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">y2</span><span class="p">[</span><span class="n">mask_ref2</span><span class="p">])</span>

    <span class="k">if</span> <span class="n">detrend</span><span class="p">:</span>
        <span class="n">y1</span> <span class="o">=</span> <span class="n">signal</span><span class="o">.</span><span class="n">detrend</span><span class="p">(</span><span class="n">y1</span><span class="p">,</span> <span class="o">**</span><span class="n">detrend_kws</span><span class="p">)</span>
        <span class="n">y2</span> <span class="o">=</span> <span class="n">signal</span><span class="o">.</span><span class="n">detrend</span><span class="p">(</span><span class="n">y2</span><span class="p">,</span> <span class="o">**</span><span class="n">detrend_kws</span><span class="p">)</span>

    <span class="n">t1_overlap</span><span class="p">,</span> <span class="n">y1_overlap</span><span class="p">,</span> <span class="n">t2_overlap</span><span class="p">,</span> <span class="n">y2_overlap</span> <span class="o">=</span> <span class="n">overlap_ts</span><span class="p">(</span><span class="n">t1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">t2</span><span class="p">,</span> <span class="n">y2</span><span class="p">)</span>

    <span class="n">res</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="s1">&#39;corr&#39;</span> <span class="ow">in</span> <span class="n">stats</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">y1_overlap</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">npts_lb</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">y2_overlap</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">npts_lb</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;compare_ts() &gt;&gt;&gt; Warning: overlapped timeseries is too short for correlation calculation (npts &lt; 25). Returnning NaN ...&#39;</span><span class="p">)</span>
            <span class="n">res</span><span class="p">[</span><span class="s1">&#39;corr&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">corr_method</span> <span class="o">==</span> <span class="s1">&#39;corr_sig&#39;</span><span class="p">:</span>
                <span class="n">res</span><span class="p">[</span><span class="s1">&#39;corr&#39;</span><span class="p">],</span> <span class="n">res</span><span class="p">[</span><span class="s1">&#39;signif&#39;</span><span class="p">],</span> <span class="n">res</span><span class="p">[</span><span class="s1">&#39;pvalue&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">corr_sig</span><span class="p">(</span>
                    <span class="n">y1_overlap</span><span class="p">,</span> <span class="n">y2_overlap</span><span class="p">,</span>
                    <span class="n">nsim</span><span class="o">=</span><span class="n">corr_sig_nsim</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="n">corr_sig_method</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">corr_sig_alpha</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">res</span><span class="p">[</span><span class="s1">&#39;corr&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">corrcoef</span><span class="p">(</span><span class="n">y1_overlap</span><span class="p">,</span> <span class="n">y2_overlap</span><span class="p">)[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>

    <span class="k">if</span> <span class="s1">&#39;rmse&#39;</span> <span class="ow">in</span> <span class="n">stats</span><span class="p">:</span>
        <span class="n">res</span><span class="p">[</span><span class="s1">&#39;rmse&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(((</span><span class="n">y1_overlap</span> <span class="o">-</span> <span class="n">y2_overlap</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span>

    <span class="k">if</span> <span class="s1">&#39;ce&#39;</span> <span class="ow">in</span> <span class="n">stats</span><span class="p">:</span>
        <span class="n">res</span><span class="p">[</span><span class="s1">&#39;ce&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">coefficient_efficiency</span><span class="p">(</span><span class="n">y1_overlap</span><span class="p">,</span> <span class="n">y2_overlap</span><span class="p">,</span> <span class="n">valid_frac</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">res</span>


<span class="k">def</span> <span class="nf">coefficient_efficiency</span><span class="p">(</span><span class="n">ref</span><span class="p">,</span> <span class="n">test</span><span class="p">,</span> <span class="n">valid</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Compute the coefficient of efficiency for a test time series, with respect to a reference time series.</span>

<span class="sd">    Inputs:</span>
<span class="sd">    test:  test array</span>
<span class="sd">    ref:   reference array, of same size as test</span>
<span class="sd">    valid: fraction of valid data required to calculate the statistic</span>

<span class="sd">    Note: Assumes that the first dimension in test and ref arrays is time!!!</span>

<span class="sd">    Outputs:</span>
<span class="sd">    CE: CE statistic calculated following Nash &amp; Sutcliffe (1970)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># check array dimensions</span>
    <span class="n">dims_test</span> <span class="o">=</span> <span class="n">test</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">dims_ref</span>  <span class="o">=</span> <span class="n">ref</span><span class="o">.</span><span class="n">shape</span>
    <span class="c1">#print(&#39;dims_test: &#39;, dims_test, &#39; dims_ref: &#39;, dims_ref)</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">dims_ref</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>   <span class="c1"># 3D: time + 2D spatial</span>
        <span class="n">dims</span> <span class="o">=</span> <span class="n">dims_ref</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span>
    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">dims_ref</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span> <span class="c1"># 2D: time + 1D spatial</span>
        <span class="n">dims</span> <span class="o">=</span> <span class="n">dims_ref</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span>
    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">dims_ref</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span> <span class="c1"># 0D: time series</span>
        <span class="n">dims</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;In coefficient_efficiency(): Problem with input array dimension! Exiting...&#39;</span><span class="p">)</span>
        <span class="ne">SystemExit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">CE</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">dims</span><span class="p">)</span>

    <span class="c1"># error</span>
    <span class="n">error</span> <span class="o">=</span> <span class="n">test</span> <span class="o">-</span> <span class="n">ref</span>

    <span class="c1"># CE</span>
    <span class="n">numer</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">error</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">denom</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">ref</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">ref</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span><span class="mi">2</span><span class="p">),</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">CE</span>    <span class="o">=</span> <span class="mf">1.</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">numer</span><span class="p">,</span><span class="n">denom</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">valid</span><span class="p">:</span>
        <span class="n">nbok</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">ref</span><span class="p">),</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">nball</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">dims_ref</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">ratio</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">nbok</span><span class="p">,</span><span class="n">nball</span><span class="p">)</span>
        <span class="n">indok</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">ratio</span> <span class="o">&gt;=</span> <span class="n">valid</span><span class="p">)</span>
        <span class="n">indbad</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">ratio</span> <span class="o">&lt;</span> <span class="n">valid</span><span class="p">)</span>
        <span class="n">dim_indbad</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">indbad</span><span class="p">)</span>
        <span class="n">testlist</span> <span class="o">=</span> <span class="p">[</span><span class="n">indbad</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">size</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">dim_indbad</span><span class="p">)]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="n">v</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">testlist</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dims</span><span class="p">,(</span><span class="nb">tuple</span><span class="p">,</span><span class="nb">list</span><span class="p">)):</span>
                <span class="n">CE</span><span class="p">[</span><span class="n">indbad</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">CE</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

    <span class="k">return</span> <span class="n">CE</span>


<span class="k">def</span> <span class="nf">calc_ens_calib_ratio</span><span class="p">(</span><span class="n">pobjs</span><span class="p">,</span> <span class="n">ye_filepath</span><span class="p">,</span> <span class="n">calc_period</span><span class="o">=</span><span class="p">[</span><span class="mi">1850</span><span class="p">,</span> <span class="mi">2000</span><span class="p">],</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">exclude_list</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">ye</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">ye_filepath</span><span class="p">,</span> <span class="n">allow_pickle</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">pid_index_map</span> <span class="o">=</span> <span class="n">ye</span><span class="p">[</span><span class="s1">&#39;pid_index_map&#39;</span><span class="p">][()]</span>
    <span class="n">ye_vals</span> <span class="o">=</span> <span class="n">ye</span><span class="p">[</span><span class="s1">&#39;ye_vals&#39;</span><span class="p">]</span>

    <span class="n">start_yr</span><span class="p">,</span> <span class="n">end_yr</span> <span class="o">=</span> <span class="n">calc_period</span>

    <span class="n">calib_ratio</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">Y</span> <span class="ow">in</span> <span class="n">pobjs</span><span class="p">:</span>
        <span class="n">pid</span> <span class="o">=</span> <span class="n">Y</span><span class="o">.</span><span class="n">id</span>
        <span class="k">if</span> <span class="n">exclude_list</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">pid</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">exclude_list</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">pid</span> <span class="ow">in</span> <span class="n">pid_index_map</span><span class="p">:</span>
                <span class="n">idx</span> <span class="o">=</span> <span class="n">pid_index_map</span><span class="p">[</span><span class="n">pid</span><span class="p">]</span>
                <span class="n">ye_mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">ye_vals</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span>
                <span class="n">Yvals</span> <span class="o">=</span> <span class="n">Y</span><span class="o">.</span><span class="n">values</span><span class="p">[(</span><span class="n">Y</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">index</span> <span class="o">&gt;</span> <span class="n">start_yr</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">Y</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">index</span> <span class="o">&lt;=</span> <span class="n">end_yr</span><span class="p">)]</span><span class="o">.</span><span class="n">values</span>
                <span class="n">ye_mean_err</span> <span class="o">=</span> <span class="n">ye_mean</span> <span class="o">-</span> <span class="n">Yvals</span>
                <span class="n">ye_mean_err_var</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">ye_mean_err</span><span class="p">,</span> <span class="n">ddof</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">evar</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">ye_vals</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">ddof</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

                <span class="n">ratio</span> <span class="o">=</span> <span class="n">ye_mean_err_var</span> <span class="o">/</span> <span class="p">(</span><span class="n">evar</span> <span class="o">+</span> <span class="n">Y</span><span class="o">.</span><span class="n">psm_obj</span><span class="o">.</span><span class="n">R</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">ratio</span><span class="p">):</span>
                    <span class="n">calib_ratio</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ratio</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;</span><span class="si">{pid}</span><span class="s1">, ye_mean: </span><span class="si">{ye_mean:.2f}</span><span class="s1">, ye_mean_err_var: </span><span class="si">{ye_mean_err_var:.2f}</span><span class="s1">, evar: </span><span class="si">{evar:.2f}</span><span class="s1">, Y.psm_obj.R: </span><span class="si">{Y.psm_obj.R:.2f}</span><span class="s1">, ratio: </span><span class="si">{ratio:.2f}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">calib_ratio</span>

<span class="c1"># -----------------------------------------------</span>
<span class="c1"># Correlation and coefficient Efficiency (CE)</span>
<span class="c1"># -----------------------------------------------</span>
<span class="k">def</span> <span class="nf">get_ts_from_jobs</span><span class="p">(</span><span class="n">exp_dir</span><span class="p">,</span> <span class="n">var</span><span class="o">=</span><span class="s1">&#39;tas_sfc_Amon&#39;</span><span class="p">,</span> <span class="n">load_num</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">calc_list</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;gm_ens&#39;</span><span class="p">],</span>
                     <span class="n">target_lats</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">target_lons</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

    <span class="n">paths</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">exp_dir</span><span class="p">,</span> <span class="s1">&#39;job_r*&#39;</span><span class="p">)))</span>
    <span class="k">if</span> <span class="n">load_num</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">paths</span> <span class="o">=</span> <span class="n">paths</span><span class="p">[:</span><span class="n">load_num</span><span class="p">]</span>

    <span class="k">with</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_dataset</span><span class="p">(</span><span class="n">paths</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">as</span> <span class="n">ds</span><span class="p">:</span>
        <span class="n">ts_tmp</span> <span class="o">=</span> <span class="n">ds</span><span class="p">[</span><span class="n">var</span><span class="p">]</span>
        <span class="n">year</span> <span class="o">=</span> <span class="n">ds</span><span class="p">[</span><span class="s1">&#39;year&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        <span class="n">lats</span> <span class="o">=</span> <span class="n">ds</span><span class="p">[</span><span class="s1">&#39;lat&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        <span class="n">lons</span> <span class="o">=</span> <span class="n">ds</span><span class="p">[</span><span class="s1">&#39;lon&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>

    <span class="n">nMC</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">paths</span><span class="p">)</span>
    <span class="n">nt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">ts_tmp</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">nEN</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">ts_tmp</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>

    <span class="n">res_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;year&#39;</span><span class="p">:</span> <span class="n">year</span><span class="p">}</span>
    <span class="k">if</span> <span class="s1">&#39;gm_ens&#39;</span> <span class="ow">in</span> <span class="n">calc_list</span><span class="p">:</span>
        <span class="n">gm_ens</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nt</span><span class="p">,</span> <span class="n">nEN</span><span class="p">,</span> <span class="n">nMC</span><span class="p">))</span>
        <span class="n">nhm_ens</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nt</span><span class="p">,</span> <span class="n">nEN</span><span class="p">,</span> <span class="n">nMC</span><span class="p">))</span>
        <span class="n">shm_ens</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nt</span><span class="p">,</span> <span class="n">nEN</span><span class="p">,</span> <span class="n">nMC</span><span class="p">))</span>

    <span class="k">if</span> <span class="s1">&#39;nino&#39;</span> <span class="ow">in</span> <span class="n">calc_list</span><span class="p">:</span>
        <span class="n">nino12</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nt</span><span class="p">,</span> <span class="n">nEN</span><span class="p">,</span> <span class="n">nMC</span><span class="p">))</span>
        <span class="n">nino3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nt</span><span class="p">,</span> <span class="n">nEN</span><span class="p">,</span> <span class="n">nMC</span><span class="p">))</span>
        <span class="n">nino34</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nt</span><span class="p">,</span> <span class="n">nEN</span><span class="p">,</span> <span class="n">nMC</span><span class="p">))</span>
        <span class="n">nino4</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nt</span><span class="p">,</span> <span class="n">nEN</span><span class="p">,</span> <span class="n">nMC</span><span class="p">))</span>

    <span class="k">if</span> <span class="s1">&#39;tpi&#39;</span> <span class="ow">in</span> <span class="n">calc_list</span><span class="p">:</span>
        <span class="n">tpi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nt</span><span class="p">,</span> <span class="n">nEN</span><span class="p">,</span> <span class="n">nMC</span><span class="p">))</span>

    <span class="k">if</span> <span class="s1">&#39;geo_mean&#39;</span> <span class="ow">in</span> <span class="n">calc_list</span><span class="p">:</span>
        <span class="n">geo_mean_ts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nt</span><span class="p">,</span> <span class="n">nEN</span><span class="p">,</span> <span class="n">nMC</span><span class="p">))</span>

    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">nMC</span><span class="p">)):</span>
        <span class="k">with</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_dataset</span><span class="p">(</span><span class="n">paths</span><span class="p">[</span><span class="n">j</span><span class="p">])</span> <span class="k">as</span> <span class="n">ds</span><span class="p">:</span>
            <span class="n">ts_tmp</span> <span class="o">=</span> <span class="n">ds</span><span class="p">[</span><span class="n">var</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>

        <span class="k">if</span> <span class="s1">&#39;gm_ens&#39;</span> <span class="ow">in</span> <span class="n">calc_list</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nEN</span><span class="p">):</span>
                <span class="n">gm_ens</span><span class="p">[:,</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">],</span> <span class="n">nhm_ens</span><span class="p">[:,</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">],</span> <span class="n">shm_ens</span><span class="p">[:,</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">global_hemispheric_means</span><span class="p">(</span><span class="n">ts_tmp</span><span class="p">[:,</span><span class="n">i</span><span class="p">,:,:],</span> <span class="n">lats</span><span class="p">)</span>

        <span class="k">if</span> <span class="s1">&#39;nino&#39;</span> <span class="ow">in</span> <span class="n">calc_list</span><span class="p">:</span>
            <span class="n">nino_ind</span> <span class="o">=</span> <span class="n">nino_indices</span><span class="p">(</span><span class="n">ts_tmp</span><span class="p">,</span> <span class="n">lats</span><span class="p">,</span> <span class="n">lons</span><span class="p">)</span>
            <span class="n">nino12</span><span class="p">[:,:,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">nino_ind</span><span class="p">[</span><span class="s1">&#39;nino1+2&#39;</span><span class="p">]</span>
            <span class="n">nino3</span><span class="p">[:,:,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">nino_ind</span><span class="p">[</span><span class="s1">&#39;nino3&#39;</span><span class="p">]</span>
            <span class="n">nino34</span><span class="p">[:,:,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">nino_ind</span><span class="p">[</span><span class="s1">&#39;nino3.4&#39;</span><span class="p">]</span>
            <span class="n">nino4</span><span class="p">[:,:,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">nino_ind</span><span class="p">[</span><span class="s1">&#39;nino4&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="s1">&#39;tpi&#39;</span> <span class="ow">in</span> <span class="n">calc_list</span><span class="p">:</span>
            <span class="n">tpi</span><span class="p">[:,:,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">calc_tpi</span><span class="p">(</span><span class="n">ts_tmp</span><span class="p">,</span> <span class="n">lats</span><span class="p">,</span> <span class="n">lons</span><span class="p">)</span>

        <span class="k">if</span> <span class="s1">&#39;geo_mean&#39;</span> <span class="ow">in</span> <span class="n">calc_list</span><span class="p">:</span>
            <span class="n">geo_mean_ts</span><span class="p">[:,:,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">geo_mean</span><span class="p">(</span><span class="n">ts_tmp</span><span class="p">,</span> <span class="n">lats</span><span class="p">,</span> <span class="n">lons</span><span class="p">,</span> <span class="n">target_lats</span><span class="p">,</span> <span class="n">target_lons</span><span class="p">)</span>

    <span class="k">if</span> <span class="s1">&#39;gm_ens&#39;</span> <span class="ow">in</span> <span class="n">calc_list</span><span class="p">:</span>
        <span class="n">res_dict</span><span class="p">[</span><span class="s1">&#39;gm_ens&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">gm_ens</span>
        <span class="n">res_dict</span><span class="p">[</span><span class="s1">&#39;nhm_ens&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">nhm_ens</span>
        <span class="n">res_dict</span><span class="p">[</span><span class="s1">&#39;shm_ens&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">shm_ens</span>

    <span class="k">if</span> <span class="s1">&#39;nino&#39;</span> <span class="ow">in</span> <span class="n">calc_list</span><span class="p">:</span>
        <span class="n">res_dict</span><span class="p">[</span><span class="s1">&#39;nino12&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">nino12</span>
        <span class="n">res_dict</span><span class="p">[</span><span class="s1">&#39;nino3&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">nino3</span>
        <span class="n">res_dict</span><span class="p">[</span><span class="s1">&#39;nino34&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">nino34</span>
        <span class="n">res_dict</span><span class="p">[</span><span class="s1">&#39;nino4&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">nino4</span>

    <span class="k">if</span> <span class="s1">&#39;tpi&#39;</span> <span class="ow">in</span> <span class="n">calc_list</span><span class="p">:</span>
        <span class="n">res_dict</span><span class="p">[</span><span class="s1">&#39;tpi&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tpi</span>

    <span class="k">if</span> <span class="s1">&#39;geo_mean&#39;</span> <span class="ow">in</span> <span class="n">calc_list</span><span class="p">:</span>
        <span class="n">res_dict</span><span class="p">[</span><span class="s1">&#39;geo_mean&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">geo_mean_ts</span>

    <span class="k">return</span> <span class="n">res_dict</span>


<span class="k">def</span> <span class="nf">load_ts_from_jobs</span><span class="p">(</span><span class="n">exp_dir</span><span class="p">,</span> <span class="n">qs</span><span class="o">=</span><span class="p">[</span><span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">],</span> <span class="n">var</span><span class="o">=</span><span class="s1">&#39;tas_sfc_Amon_gm_ens&#39;</span><span class="p">,</span> <span class="n">ref_period</span><span class="o">=</span><span class="p">[</span><span class="mi">1951</span><span class="p">,</span> <span class="mi">1980</span><span class="p">],</span>
                      <span class="n">return_MC_mean</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">load_num</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">exp_dir</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;ERROR: Specified path of the results directory does not exist!!!&#39;</span><span class="p">)</span>

    <span class="n">paths</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">exp_dir</span><span class="p">,</span> <span class="s1">&#39;job_r*&#39;</span><span class="p">)))</span>
    <span class="k">if</span> <span class="n">load_num</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">paths</span> <span class="o">=</span> <span class="n">paths</span><span class="p">[:</span><span class="n">load_num</span><span class="p">]</span>

    <span class="k">with</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_dataset</span><span class="p">(</span><span class="n">paths</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">as</span> <span class="n">ds</span><span class="p">:</span>
        <span class="n">ts_tmp</span> <span class="o">=</span> <span class="n">ds</span><span class="p">[</span><span class="n">var</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        <span class="n">year</span> <span class="o">=</span> <span class="n">ds</span><span class="p">[</span><span class="s1">&#39;year&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>

    <span class="n">nt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">ts_tmp</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">nEN</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">ts_tmp</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">nMC</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">paths</span><span class="p">)</span>

    <span class="n">ts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">((</span><span class="n">nt</span><span class="p">,</span> <span class="n">nEN</span><span class="o">*</span><span class="n">nMC</span><span class="p">))</span>
    <span class="n">ts_MC</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">((</span><span class="n">nt</span><span class="p">,</span> <span class="n">nMC</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">path</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">paths</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_dataset</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="k">as</span> <span class="n">ds</span><span class="p">:</span>
            <span class="n">ts_ens</span> <span class="o">=</span> <span class="n">ds</span><span class="p">[</span><span class="n">var</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>

        <span class="n">ts</span><span class="p">[:,</span> <span class="n">nEN</span><span class="o">*</span><span class="n">i</span><span class="p">:</span><span class="n">nEN</span><span class="o">+</span><span class="n">nEN</span><span class="o">*</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">ts_ens</span>
        <span class="n">ts_MC</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">ts_ens</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">return_MC_mean</span><span class="p">:</span>
        <span class="n">ts_qs</span> <span class="o">=</span> <span class="n">ts_MC</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">qs</span><span class="p">:</span>
            <span class="n">ts_qs</span> <span class="o">=</span> <span class="n">mquantiles</span><span class="p">(</span><span class="n">ts</span><span class="p">,</span> <span class="n">qs</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ts_qs</span> <span class="o">=</span> <span class="n">ts</span>

    <span class="k">return</span> <span class="n">ts_qs</span><span class="p">,</span> <span class="n">year</span>


<span class="k">def</span> <span class="nf">load_field_from_jobs</span><span class="p">(</span><span class="n">exp_dir</span><span class="p">,</span> <span class="n">var</span><span class="o">=</span><span class="s1">&#39;tas_sfc_Amon&#39;</span><span class="p">,</span> <span class="n">average_iter</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">load_num</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">exp_dir</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;ERROR: Specified path of the results directory does not exist!!!&#39;</span><span class="p">)</span>

    <span class="n">paths</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">exp_dir</span><span class="p">,</span> <span class="s1">&#39;job_r*&#39;</span><span class="p">)))</span>
    <span class="k">if</span> <span class="n">load_num</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">paths</span> <span class="o">=</span> <span class="n">paths</span><span class="p">[:</span><span class="n">load_num</span><span class="p">]</span>

    <span class="n">field_ens_mean</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">path</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">paths</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_dataset</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="k">as</span> <span class="n">ds</span><span class="p">:</span>
                <span class="n">year</span> <span class="o">=</span> <span class="n">ds</span><span class="p">[</span><span class="s1">&#39;year&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
                <span class="n">lat</span> <span class="o">=</span> <span class="n">ds</span><span class="p">[</span><span class="s1">&#39;lat&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
                <span class="n">lon</span> <span class="o">=</span> <span class="n">ds</span><span class="p">[</span><span class="s1">&#39;lon&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>

        <span class="k">with</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_dataset</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="k">as</span> <span class="n">ds</span><span class="p">:</span>
            <span class="n">field_ens_mean</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ds</span><span class="p">[</span><span class="n">var</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">average_iter</span><span class="p">:</span>
        <span class="n">field_em</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">field_ens_mean</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">field_em</span> <span class="o">=</span> <span class="n">field_ens_mean</span>

    <span class="k">return</span> <span class="n">field_em</span><span class="p">,</span> <span class="n">year</span><span class="p">,</span> <span class="n">lat</span><span class="p">,</span> <span class="n">lon</span>


<span class="k">def</span> <span class="nf">rotate_lon</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">lon</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; Make lon to be sorted with range (0, 360)</span>

<span class="sd">    Args:</span>
<span class="sd">        field (ndarray): the last axis is assumed to be lon</span>
<span class="sd">        lon (1d array): the longitude axis</span>

<span class="sd">    Returns:</span>
<span class="sd">        field (ndarray): the field with longitude rotated</span>
<span class="sd">        lon (1d array): the sorted longitude axis with range (0, 360)</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">lon</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">lon</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mod</span><span class="p">(</span><span class="n">lon</span><span class="p">,</span> <span class="mi">360</span><span class="p">)</span>

    <span class="n">sorted_lon</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">lon</span><span class="p">)</span>
    <span class="n">idx</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">lon_gs</span> <span class="ow">in</span> <span class="n">sorted_lon</span><span class="p">:</span>
        <span class="n">idx</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">lon</span><span class="p">)</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">lon_gs</span><span class="p">))</span>
    <span class="n">lon</span> <span class="o">=</span> <span class="n">lon</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
    <span class="n">field</span> <span class="o">=</span> <span class="n">field</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">idx</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">field</span><span class="p">,</span> <span class="n">lon</span>


<span class="k">def</span> <span class="nf">load_inst_analyses</span><span class="p">(</span><span class="n">ana_pathdict</span><span class="p">,</span> <span class="n">var</span><span class="o">=</span><span class="s1">&#39;gm&#39;</span><span class="p">,</span> <span class="n">verif_yrs</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1880</span><span class="p">,</span> <span class="mi">2000</span><span class="p">),</span> <span class="n">ref_period</span><span class="o">=</span><span class="p">[</span><span class="mi">1951</span><span class="p">,</span> <span class="mi">1980</span><span class="p">],</span>
                       <span class="n">sort_lon</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">avgInterval</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">13</span><span class="p">))):</span>
    <span class="n">load_func</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;GISTEMP&#39;</span><span class="p">:</span> <span class="n">load_gridded_data</span><span class="o">.</span><span class="n">read_gridded_data_GISTEMP</span><span class="p">,</span>
        <span class="s1">&#39;HadCRUT&#39;</span><span class="p">:</span> <span class="n">load_gridded_data</span><span class="o">.</span><span class="n">read_gridded_data_HadCRUT</span><span class="p">,</span>
        <span class="s1">&#39;BerkeleyEarth&#39;</span><span class="p">:</span> <span class="n">load_gridded_data</span><span class="o">.</span><span class="n">read_gridded_data_BerkeleyEarth</span><span class="p">,</span>
        <span class="s1">&#39;MLOST&#39;</span><span class="p">:</span> <span class="n">load_gridded_data</span><span class="o">.</span><span class="n">read_gridded_data_MLOST</span><span class="p">,</span>
        <span class="s1">&#39;ERA20-20C&#39;</span><span class="p">:</span> <span class="n">load_gridded_data</span><span class="o">.</span><span class="n">read_gridded_data_CMIP5_model</span><span class="p">,</span>
        <span class="s1">&#39;20CR-V2&#39;</span><span class="p">:</span> <span class="n">load_gridded_data</span><span class="o">.</span><span class="n">read_gridded_data_CMIP5_model</span><span class="p">,</span>
        <span class="s1">&#39;GPCC&#39;</span><span class="p">:</span> <span class="n">load_gridded_data</span><span class="o">.</span><span class="n">read_gridded_data_GPCC</span><span class="p">,</span>
        <span class="s1">&#39;PREC&#39;</span><span class="p">:</span> <span class="n">get_env_vars</span><span class="p">,</span>
        <span class="s1">&#39;20CR-V2C&#39;</span><span class="p">:</span> <span class="n">get_env_vars</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="n">calib_vars</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;GISTEMP&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;Tsfc&#39;</span><span class="p">],</span>
        <span class="s1">&#39;HadCRUT&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;Tsfc&#39;</span><span class="p">],</span>
        <span class="s1">&#39;BerkeleyEarth&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;Tsfc&#39;</span><span class="p">],</span>
        <span class="s1">&#39;MLOST&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;air&#39;</span><span class="p">],</span>
        <span class="s1">&#39;ERA20-20C&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;tas_sfc_Amon&#39;</span><span class="p">:</span> <span class="s1">&#39;anom&#39;</span><span class="p">},</span>
        <span class="s1">&#39;20CR-V2&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;tas_sfc_Amon&#39;</span><span class="p">:</span> <span class="s1">&#39;anom&#39;</span><span class="p">},</span>
        <span class="s1">&#39;GPCC&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;precip&#39;</span><span class="p">],</span>
        <span class="s1">&#39;PREC&#39;</span><span class="p">:</span> <span class="s1">&#39;precip&#39;</span><span class="p">,</span>
        <span class="s1">&#39;20CR-V2C&#39;</span><span class="p">:</span> <span class="s1">&#39;precip&#39;</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="n">inst_field</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">inst_lat</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">inst_lon</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">inst_gm</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">inst_nhm</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">inst_shm</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">inst_time</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">ana_pathdict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;Loading </span><span class="si">{name}</span><span class="s1">: </span><span class="si">{path}</span><span class="s1"> ...&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;ERA20-20C&#39;</span><span class="p">,</span> <span class="s1">&#39;20CR-V2&#39;</span><span class="p">]:</span>
            <span class="c1"># load_gridded_data.read_gridded_data_CMIP5_model</span>
            <span class="n">dd</span> <span class="o">=</span> <span class="n">load_func</span><span class="p">[</span><span class="n">name</span><span class="p">](</span>
                <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">path</span><span class="p">),</span>
                <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">path</span><span class="p">),</span>
                <span class="n">calib_vars</span><span class="p">[</span><span class="n">name</span><span class="p">],</span>
                <span class="n">outtimeavg</span><span class="o">=</span><span class="n">avgInterval</span><span class="p">,</span>
                <span class="n">anom_ref</span><span class="o">=</span><span class="n">ref_period</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">time_grid</span> <span class="o">=</span> <span class="n">dd</span><span class="p">[</span><span class="s1">&#39;tas_sfc_Amon&#39;</span><span class="p">][</span><span class="s1">&#39;years&#39;</span><span class="p">]</span>
            <span class="n">lat_grid</span> <span class="o">=</span> <span class="n">dd</span><span class="p">[</span><span class="s1">&#39;tas_sfc_Amon&#39;</span><span class="p">][</span><span class="s1">&#39;lat&#39;</span><span class="p">][:,</span> <span class="mi">0</span><span class="p">]</span>
            <span class="n">lon_grid</span> <span class="o">=</span> <span class="n">dd</span><span class="p">[</span><span class="s1">&#39;tas_sfc_Amon&#39;</span><span class="p">][</span><span class="s1">&#39;lon&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span>
            <span class="n">anomaly_grid</span> <span class="o">=</span> <span class="n">dd</span><span class="p">[</span><span class="s1">&#39;tas_sfc_Amon&#39;</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">]</span>

        <span class="k">elif</span> <span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;GPCC&#39;</span><span class="p">:</span>
            <span class="c1"># load_gridded_data.read_gridded_data_GPCC</span>
            <span class="k">if</span> <span class="n">avgInterval</span> <span class="o">==</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">13</span><span class="p">)):</span>
                <span class="n">outfreq</span> <span class="o">=</span> <span class="s1">&#39;annual&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">outfreq</span> <span class="o">=</span> <span class="s1">&#39;monthly&#39;</span>

            <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;outfreq: </span><span class="si">{outfreq}</span><span class="s1">&#39;</span><span class="p">)</span>

            <span class="n">time_grid</span><span class="p">,</span> <span class="n">lat_grid</span><span class="p">,</span> <span class="n">lon_grid</span><span class="p">,</span> <span class="n">anomaly_grid</span> <span class="o">=</span> <span class="n">load_func</span><span class="p">[</span><span class="n">name</span><span class="p">](</span>
                <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">path</span><span class="p">),</span>
                <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">path</span><span class="p">),</span>
                <span class="n">calib_vars</span><span class="p">[</span><span class="n">name</span><span class="p">],</span>
                <span class="kc">True</span><span class="p">,</span>
                <span class="n">ref_period</span><span class="p">,</span>
                <span class="n">outfreq</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">elif</span> <span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;PREC&#39;</span><span class="p">:</span>
            <span class="c1"># get_env_vars</span>
            <span class="n">lat_grid</span><span class="p">,</span> <span class="n">lon_grid</span><span class="p">,</span> <span class="n">time_grid</span><span class="p">,</span> <span class="n">vars_grid</span> <span class="o">=</span> <span class="n">load_func</span><span class="p">[</span><span class="n">name</span><span class="p">](</span>
                <span class="p">{</span><span class="s1">&#39;precip&#39;</span><span class="p">:</span> <span class="n">path</span><span class="p">},</span>
                <span class="n">calc_anomaly</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">ref_period</span><span class="o">=</span><span class="n">ref_period</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">prate</span> <span class="o">=</span> <span class="n">vars_grid</span><span class="p">[</span><span class="s1">&#39;precip&#39;</span><span class="p">]</span><span class="o">/</span><span class="mi">24</span><span class="o">/</span><span class="mi">3600</span>  <span class="c1"># convert from mm/day to kg/m^2/s</span>
            <span class="k">if</span> <span class="n">avgInterval</span> <span class="o">==</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">13</span><span class="p">)):</span>
                <span class="n">anomaly_grid</span><span class="p">,</span> <span class="n">time_grid</span> <span class="o">=</span> <span class="n">annualize_var</span><span class="p">(</span><span class="n">vars_grid</span><span class="p">[</span><span class="s1">&#39;prate&#39;</span><span class="p">],</span> <span class="n">time_grid</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">anomaly_grid</span><span class="p">,</span> <span class="n">time_grid</span> <span class="o">=</span> <span class="n">seasonal_var</span><span class="p">(</span><span class="n">vars_grid</span><span class="p">[</span><span class="s1">&#39;prate&#39;</span><span class="p">],</span> <span class="n">time_grid</span><span class="p">,</span> <span class="n">avgMonths</span><span class="o">=</span><span class="n">avgInterval</span><span class="p">)</span>
            <span class="n">time_grid</span> <span class="o">=</span> <span class="n">year_float2datetime</span><span class="p">(</span><span class="n">time_grid</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;20CR-V2C&#39;</span><span class="p">:</span>
            <span class="c1"># get_env_vars</span>
            <span class="n">lat_grid</span><span class="p">,</span> <span class="n">lon_grid</span><span class="p">,</span> <span class="n">time_grid</span><span class="p">,</span> <span class="n">vars_grid</span> <span class="o">=</span> <span class="n">load_func</span><span class="p">[</span><span class="n">name</span><span class="p">](</span>
                <span class="p">{</span><span class="s1">&#39;prate&#39;</span><span class="p">:</span> <span class="n">path</span><span class="p">},</span>
                <span class="n">calc_anomaly</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">ref_period</span><span class="o">=</span><span class="n">ref_period</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">avgInterval</span> <span class="o">==</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">13</span><span class="p">)):</span>
                <span class="n">anomaly_grid</span><span class="p">,</span> <span class="n">time_grid</span> <span class="o">=</span> <span class="n">annualize_var</span><span class="p">(</span><span class="n">vars_grid</span><span class="p">[</span><span class="s1">&#39;prate&#39;</span><span class="p">],</span> <span class="n">time_grid</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">anomaly_grid</span><span class="p">,</span> <span class="n">time_grid</span> <span class="o">=</span> <span class="n">seasonal_var</span><span class="p">(</span><span class="n">vars_grid</span><span class="p">[</span><span class="s1">&#39;prate&#39;</span><span class="p">],</span> <span class="n">time_grid</span><span class="p">,</span> <span class="n">avgMonths</span><span class="o">=</span><span class="n">avgInterval</span><span class="p">)</span>

            <span class="n">time_grid</span> <span class="o">=</span> <span class="n">year_float2datetime</span><span class="p">(</span><span class="n">time_grid</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># GISTEMP, MLOST, HadCRUT, BerkeleyEarth</span>
            <span class="k">if</span> <span class="n">avgInterval</span> <span class="o">==</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">13</span><span class="p">)):</span>
                <span class="n">outfreq</span> <span class="o">=</span> <span class="s1">&#39;annual&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">outfreq</span> <span class="o">=</span> <span class="s1">&#39;monthly&#39;</span>

            <span class="n">time_grid</span><span class="p">,</span> <span class="n">lat_grid</span><span class="p">,</span> <span class="n">lon_grid</span><span class="p">,</span> <span class="n">anomaly_grid</span> <span class="o">=</span> <span class="n">load_func</span><span class="p">[</span><span class="n">name</span><span class="p">](</span>
                <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">path</span><span class="p">),</span>
                <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">path</span><span class="p">),</span>
                <span class="n">calib_vars</span><span class="p">[</span><span class="n">name</span><span class="p">],</span>
                <span class="n">outfreq</span><span class="o">=</span><span class="n">outfreq</span><span class="p">,</span>
                <span class="n">ref_period</span><span class="o">=</span><span class="n">ref_period</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">year_float</span> <span class="o">=</span> <span class="n">datetime2year_float</span><span class="p">(</span><span class="n">time_grid</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">outfreq</span> <span class="o">==</span> <span class="s1">&#39;monthly&#39;</span> <span class="ow">and</span> <span class="nb">type</span><span class="p">(</span><span class="n">avgInterval</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">:</span>
                <span class="n">anomaly_grid</span><span class="p">,</span> <span class="n">time_grid</span> <span class="o">=</span> <span class="n">seasonal_var</span><span class="p">(</span><span class="n">anomaly_grid</span><span class="p">,</span> <span class="n">year_float</span><span class="p">,</span> <span class="n">avgMonths</span><span class="o">=</span><span class="n">avgInterval</span><span class="p">)</span>
                <span class="n">time_grid</span> <span class="o">=</span> <span class="n">year_float2datetime</span><span class="p">(</span><span class="n">time_grid</span><span class="p">)</span>


        <span class="k">if</span> <span class="n">sort_lon</span><span class="p">:</span>
            <span class="n">anomaly_grid</span><span class="p">,</span> <span class="n">lon_grid</span> <span class="o">=</span> <span class="n">rotate_lon</span><span class="p">(</span><span class="n">anomaly_grid</span><span class="p">,</span> <span class="n">lon_grid</span><span class="p">)</span>

        <span class="n">gm</span><span class="p">,</span> <span class="n">nhm</span><span class="p">,</span> <span class="n">shm</span> <span class="o">=</span> <span class="n">global_hemispheric_means</span><span class="p">(</span><span class="n">anomaly_grid</span><span class="p">,</span> <span class="n">lat_grid</span><span class="p">)</span>
        <span class="n">year</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">t</span><span class="o">.</span><span class="n">year</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">time_grid</span><span class="p">])</span>
        <span class="n">month</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">t</span><span class="o">.</span><span class="n">month</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">time_grid</span><span class="p">])</span>
        <span class="n">day</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">t</span><span class="o">.</span><span class="n">day</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">time_grid</span><span class="p">])</span>
        <span class="n">year_float</span> <span class="o">=</span> <span class="n">ymd2year_float</span><span class="p">(</span><span class="n">year</span><span class="p">,</span> <span class="n">month</span><span class="p">,</span> <span class="n">day</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">verif_yrs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">syear</span><span class="p">,</span> <span class="n">eyear</span> <span class="o">=</span> <span class="n">verif_yrs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">verif_yrs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">year_int</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="n">y</span><span class="p">)</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">year_float</span><span class="p">])</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">year_int</span> <span class="o">&gt;=</span> <span class="n">syear</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">year_int</span> <span class="o">&lt;=</span> <span class="n">eyear</span><span class="p">)</span>

            <span class="n">inst_gm</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">gm</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
            <span class="n">inst_nhm</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">nhm</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
            <span class="n">inst_shm</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">shm</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
            <span class="n">inst_time</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">year_float</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
            <span class="n">inst_field</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">anomaly_grid</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">inst_gm</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">gm</span>
            <span class="n">inst_nhm</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">nhm</span>
            <span class="n">inst_shm</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">shm</span>
            <span class="n">inst_time</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">year_float</span>
            <span class="n">inst_field</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">anomaly_grid</span>

        <span class="n">inst_lat</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">lat_grid</span>
        <span class="n">inst_lon</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">lon_grid</span>

    <span class="k">if</span> <span class="n">var</span> <span class="o">==</span> <span class="s1">&#39;field&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">inst_field</span><span class="p">,</span> <span class="n">inst_time</span><span class="p">,</span> <span class="n">inst_lat</span><span class="p">,</span> <span class="n">inst_lon</span>
    <span class="k">elif</span> <span class="n">var</span> <span class="o">==</span> <span class="s1">&#39;gm&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">inst_gm</span><span class="p">,</span> <span class="n">inst_time</span>
    <span class="k">elif</span> <span class="n">var</span> <span class="o">==</span> <span class="s1">&#39;nhm&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">inst_nhm</span><span class="p">,</span> <span class="n">inst_time</span>
    <span class="k">elif</span> <span class="n">var</span> <span class="o">==</span> <span class="s1">&#39;shm&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">inst_shm</span><span class="p">,</span> <span class="n">inst_time</span>


<span class="k">def</span> <span class="nf">calc_field_inst_corr_ce</span><span class="p">(</span><span class="n">exp_dir</span><span class="p">,</span> <span class="n">ana_pathdict</span><span class="p">,</span> <span class="n">verif_yrs</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1880</span><span class="p">,</span> <span class="mi">2000</span><span class="p">),</span> <span class="n">ref_period</span><span class="o">=</span><span class="p">[</span><span class="mi">1951</span><span class="p">,</span> <span class="mi">1980</span><span class="p">],</span> <span class="n">field</span><span class="o">=</span><span class="s1">&#39;LMR&#39;</span><span class="p">,</span> <span class="n">load_num</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                            <span class="n">valid_frac</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">var_name</span><span class="o">=</span><span class="s1">&#39;tas_sfc_Amon&#39;</span><span class="p">,</span> <span class="n">avgInterval</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">13</span><span class="p">)),</span> <span class="n">detrend</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">detrend_kws</span><span class="o">=</span><span class="p">{}):</span>
    <span class="sd">&#39;&#39;&#39; Calculate corr and CE between LMR and instrumental fields</span>

<span class="sd">    Note: The time axis of the LMR field is assumed to fully cover the range of verif_yrs</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">exp_dir</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;ERROR: Specified path of the results directory does not exist!!!&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">field</span> <span class="o">==</span> <span class="s1">&#39;LMR&#39;</span><span class="p">:</span>
        <span class="n">field_em</span><span class="p">,</span> <span class="n">year</span><span class="p">,</span> <span class="n">lat</span><span class="p">,</span> <span class="n">lon</span> <span class="o">=</span> <span class="n">load_field_from_jobs</span><span class="p">(</span><span class="n">exp_dir</span><span class="p">,</span> <span class="n">var</span><span class="o">=</span><span class="n">var_name</span><span class="p">,</span> <span class="n">load_num</span><span class="o">=</span><span class="n">load_num</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">filepath</span> <span class="o">=</span> <span class="n">exp_dir</span>
        <span class="n">filesdict</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">var_name</span><span class="p">:</span> <span class="n">filepath</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="n">lat</span><span class="p">,</span> <span class="n">lon</span><span class="p">,</span> <span class="n">time_model</span><span class="p">,</span> <span class="n">prior_vars</span> <span class="o">=</span> <span class="n">get_env_vars</span><span class="p">(</span><span class="n">filesdict</span><span class="p">,</span> <span class="n">calc_anomaly</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">var_model</span> <span class="o">=</span>  <span class="n">prior_vars</span><span class="p">[</span><span class="n">var_name</span><span class="p">]</span>
        <span class="n">field_em</span><span class="p">,</span> <span class="n">year</span> <span class="o">=</span> <span class="n">seasonal_var</span><span class="p">(</span><span class="n">var_model</span><span class="p">,</span> <span class="n">time_model</span><span class="p">,</span> <span class="n">avgMonths</span><span class="o">=</span><span class="n">avgInterval</span><span class="p">)</span>

    <span class="n">syear</span><span class="p">,</span> <span class="n">eyear</span> <span class="o">=</span> <span class="n">verif_yrs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">verif_yrs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">syear</span> <span class="o">&lt;</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">year</span><span class="p">)</span> <span class="ow">or</span> <span class="n">eyear</span> <span class="o">&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">year</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;ERROR: The time axis of the </span><span class="si">{field}</span><span class="s1"> field is not fully covering the range of verif_yrs!!!&#39;</span><span class="p">)</span>

    <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">year</span> <span class="o">&gt;=</span> <span class="n">syear</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">year</span> <span class="o">&lt;=</span> <span class="n">eyear</span><span class="p">)</span>
    <span class="n">mask_ref</span> <span class="o">=</span> <span class="p">(</span><span class="n">year</span> <span class="o">&gt;=</span> <span class="n">ref_period</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">year</span> <span class="o">&lt;=</span> <span class="n">ref_period</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">field_lmr</span> <span class="o">=</span> <span class="n">field_em</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">field_em</span><span class="p">[</span><span class="n">mask_ref</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># remove the mean w.r.t. the ref_period</span>

    <span class="n">inst_field</span><span class="p">,</span> <span class="n">inst_time</span><span class="p">,</span> <span class="n">inst_lat</span><span class="p">,</span> <span class="n">inst_lon</span> <span class="o">=</span> <span class="n">load_inst_analyses</span><span class="p">(</span>
        <span class="n">ana_pathdict</span><span class="p">,</span> <span class="n">var</span><span class="o">=</span><span class="s1">&#39;field&#39;</span><span class="p">,</span> <span class="n">verif_yrs</span><span class="o">=</span><span class="n">verif_yrs</span><span class="p">,</span> <span class="n">ref_period</span><span class="o">=</span><span class="n">ref_period</span><span class="p">,</span> <span class="n">avgInterval</span><span class="o">=</span><span class="n">avgInterval</span><span class="p">)</span>

    <span class="n">nlat_lmr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">lat</span><span class="p">)</span>
    <span class="n">nlon_lmr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">lon</span><span class="p">)</span>
    <span class="n">specob_lmr</span> <span class="o">=</span> <span class="n">Spharmt</span><span class="p">(</span><span class="n">nlon_lmr</span><span class="p">,</span> <span class="n">nlat_lmr</span><span class="p">,</span> <span class="n">gridtype</span><span class="o">=</span><span class="s1">&#39;regular&#39;</span><span class="p">,</span> <span class="n">legfunc</span><span class="o">=</span><span class="s1">&#39;computed&#39;</span><span class="p">)</span>

    <span class="n">corr</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">ce</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">inst_field</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">mask_ref</span> <span class="o">=</span> <span class="p">(</span><span class="n">inst_time</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">ref_period</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">inst_time</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">ref_period</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">inst_field</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">-=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">inst_field</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="n">mask_ref</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># remove the mean w.r.t. the ref_period</span>

        <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;Regridding </span><span class="si">{field}</span><span class="s1"> onto </span><span class="si">{name}</span><span class="s1"> ...&#39;</span><span class="p">)</span>

        <span class="n">nlat_inst</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">inst_lat</span><span class="p">[</span><span class="n">name</span><span class="p">])</span>
        <span class="n">nlon_inst</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">inst_lon</span><span class="p">[</span><span class="n">name</span><span class="p">])</span>

        <span class="n">corr</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">((</span><span class="n">nlat_inst</span><span class="p">,</span> <span class="n">nlon_inst</span><span class="p">))</span>
        <span class="n">ce</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">((</span><span class="n">nlat_inst</span><span class="p">,</span> <span class="n">nlon_inst</span><span class="p">))</span>

        <span class="n">specob_inst</span> <span class="o">=</span> <span class="n">Spharmt</span><span class="p">(</span><span class="n">nlon_inst</span><span class="p">,</span> <span class="n">nlat_inst</span><span class="p">,</span> <span class="n">gridtype</span><span class="o">=</span><span class="s1">&#39;regular&#39;</span><span class="p">,</span> <span class="n">legfunc</span><span class="o">=</span><span class="s1">&#39;computed&#39;</span><span class="p">)</span>

        <span class="n">overlap_yrs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">intersect1d</span><span class="p">(</span><span class="n">verif_yrs</span><span class="p">,</span> <span class="n">inst_time</span><span class="p">[</span><span class="n">name</span><span class="p">])</span>
        <span class="n">ind_lmr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">verif_yrs</span><span class="p">,</span> <span class="n">overlap_yrs</span><span class="p">)</span>
        <span class="n">ind_inst</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">inst_time</span><span class="p">[</span><span class="n">name</span><span class="p">],</span> <span class="n">overlap_yrs</span><span class="p">)</span>

        <span class="n">lmr_on_inst</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">ind_lmr</span><span class="p">:</span>
            <span class="n">lmr_on_inst_each_yr</span> <span class="o">=</span> <span class="n">regrid</span><span class="p">(</span><span class="n">specob_lmr</span><span class="p">,</span> <span class="n">specob_inst</span><span class="p">,</span> <span class="n">field_lmr</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">ntrunc</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">smooth</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
            <span class="n">lmr_on_inst</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lmr_on_inst_each_yr</span><span class="p">)</span>

        <span class="n">lmr_on_inst</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">lmr_on_inst</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nlat_inst</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nlon_inst</span><span class="p">):</span>
                <span class="n">ts_inst</span> <span class="o">=</span> <span class="n">inst_field</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="n">ind_inst</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span>
                <span class="n">ts_lmr</span> <span class="o">=</span> <span class="n">lmr_on_inst</span><span class="p">[:,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span>

                <span class="n">ts_inst_notnan</span> <span class="o">=</span> <span class="n">ts_inst</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">ts_inst</span><span class="p">)]</span>
                <span class="n">ts_lmr_notnan</span> <span class="o">=</span> <span class="n">ts_lmr</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">ts_inst</span><span class="p">)]</span>
                <span class="n">nt</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ind_inst</span><span class="p">)</span>
                <span class="n">nt_notnan</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">ts_inst_notnan</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

                <span class="k">if</span> <span class="n">detrend</span><span class="p">:</span>
                    <span class="n">ts_inst_notnan</span> <span class="o">=</span> <span class="n">signal</span><span class="o">.</span><span class="n">detrend</span><span class="p">(</span><span class="n">ts_inst_notnan</span><span class="p">,</span> <span class="o">**</span><span class="n">detrend_kws</span><span class="p">)</span>
                    <span class="n">ts_lmr_notnan</span> <span class="o">=</span> <span class="n">signal</span><span class="o">.</span><span class="n">detrend</span><span class="p">(</span><span class="n">ts_lmr_notnan</span><span class="p">,</span> <span class="o">**</span><span class="n">detrend_kws</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">nt_notnan</span><span class="o">/</span><span class="n">nt</span> <span class="o">&gt;=</span> <span class="n">valid_frac</span><span class="p">:</span>

                    <span class="n">corr</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">corrcoef</span><span class="p">(</span><span class="n">ts_inst_notnan</span><span class="p">,</span> <span class="n">ts_lmr_notnan</span><span class="p">)[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">corr</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

                <span class="n">ce</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">coefficient_efficiency</span><span class="p">(</span><span class="n">ts_inst</span><span class="p">,</span> <span class="n">ts_lmr</span><span class="p">,</span> <span class="n">valid_frac</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">corr</span><span class="p">,</span> <span class="n">ce</span><span class="p">,</span> <span class="n">inst_lat</span><span class="p">,</span> <span class="n">inst_lon</span>


<span class="k">def</span> <span class="nf">calc_field_corr_ce</span><span class="p">(</span><span class="n">exp_dir</span><span class="p">,</span> <span class="n">field_model</span><span class="p">,</span> <span class="n">time_model</span><span class="p">,</span> <span class="n">lat_model</span><span class="p">,</span> <span class="n">lon_model</span><span class="p">,</span>
                       <span class="n">verif_yrs</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1880</span><span class="p">,</span> <span class="mi">2000</span><span class="p">),</span> <span class="n">ref_period</span><span class="o">=</span><span class="p">[</span><span class="mi">1951</span><span class="p">,</span> <span class="mi">1980</span><span class="p">],</span>
                       <span class="n">valid_frac</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">var_name</span><span class="o">=</span><span class="s1">&#39;tas_sfc_Amon&#39;</span><span class="p">,</span>
                       <span class="n">avgMonths</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">11</span><span class="p">,</span><span class="mi">12</span><span class="p">],</span> <span class="n">detrend</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">detrend_kws</span><span class="o">=</span><span class="p">{}):</span>
    <span class="sd">&#39;&#39;&#39; Calculate corr and CE between LMR and model field</span>

<span class="sd">    Note: The time axis of the LMR field is assumed to fully cover the range of verif_yrs</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="n">avgMonths</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">field_model</span><span class="p">,</span> <span class="n">time_model</span> <span class="o">=</span> <span class="n">seasonal_var</span><span class="p">(</span><span class="n">field_model</span><span class="p">,</span> <span class="n">time_model</span><span class="p">,</span> <span class="n">avgMonths</span><span class="o">=</span><span class="n">avgMonths</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">exp_dir</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;ERROR: Specified path of the results directory does not exist!!!&#39;</span><span class="p">)</span>

    <span class="n">field_em</span><span class="p">,</span> <span class="n">year</span><span class="p">,</span> <span class="n">lat</span><span class="p">,</span> <span class="n">lon</span> <span class="o">=</span> <span class="n">load_field_from_jobs</span><span class="p">(</span><span class="n">exp_dir</span><span class="p">,</span> <span class="n">var</span><span class="o">=</span><span class="n">var_name</span><span class="p">)</span>
    <span class="n">syear</span><span class="p">,</span> <span class="n">eyear</span> <span class="o">=</span> <span class="n">verif_yrs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">verif_yrs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">syear</span> <span class="o">&lt;</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">year</span><span class="p">)</span> <span class="ow">or</span> <span class="n">eyear</span> <span class="o">&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">year</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;ERROR: The time axis of the LMR field is not fully covering the range of verif_yrs!!!&#39;</span><span class="p">)</span>

    <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">year</span> <span class="o">&gt;=</span> <span class="n">syear</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">year</span> <span class="o">&lt;=</span> <span class="n">eyear</span><span class="p">)</span>
    <span class="n">mask_ref</span> <span class="o">=</span> <span class="p">(</span><span class="n">year</span> <span class="o">&gt;=</span> <span class="n">ref_period</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">year</span> <span class="o">&lt;=</span> <span class="n">ref_period</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">field_lmr</span> <span class="o">=</span> <span class="n">field_em</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">field_em</span><span class="p">[</span><span class="n">mask_ref</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># remove the mean w.r.t. the ref_period</span>

    <span class="n">nlat_lmr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">lat</span><span class="p">)</span>
    <span class="n">nlon_lmr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">lon</span><span class="p">)</span>
    <span class="n">specob_lmr</span> <span class="o">=</span> <span class="n">Spharmt</span><span class="p">(</span><span class="n">nlon_lmr</span><span class="p">,</span> <span class="n">nlat_lmr</span><span class="p">,</span> <span class="n">gridtype</span><span class="o">=</span><span class="s1">&#39;regular&#39;</span><span class="p">,</span> <span class="n">legfunc</span><span class="o">=</span><span class="s1">&#39;computed&#39;</span><span class="p">)</span>

    <span class="n">mask_ref</span> <span class="o">=</span> <span class="p">(</span><span class="n">time_model</span> <span class="o">&gt;=</span> <span class="n">ref_period</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">time_model</span> <span class="o">&lt;=</span> <span class="n">ref_period</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">field_model</span> <span class="o">-=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">field_model</span><span class="p">[</span><span class="n">mask_ref</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># remove the mean w.r.t. the ref_period</span>

    <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;Regridding LMR onto model grid ...&#39;</span><span class="p">)</span>

    <span class="n">nlat_model</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">lat_model</span><span class="p">)</span>
    <span class="n">nlon_model</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">lon_model</span><span class="p">)</span>

    <span class="n">corr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">((</span><span class="n">nlat_model</span><span class="p">,</span> <span class="n">nlon_model</span><span class="p">))</span>
    <span class="n">ce</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">((</span><span class="n">nlat_model</span><span class="p">,</span> <span class="n">nlon_model</span><span class="p">))</span>

    <span class="n">specob_model</span> <span class="o">=</span> <span class="n">Spharmt</span><span class="p">(</span><span class="n">nlon_model</span><span class="p">,</span> <span class="n">nlat_model</span><span class="p">,</span> <span class="n">gridtype</span><span class="o">=</span><span class="s1">&#39;regular&#39;</span><span class="p">,</span> <span class="n">legfunc</span><span class="o">=</span><span class="s1">&#39;computed&#39;</span><span class="p">)</span>

    <span class="n">overlap_yrs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">intersect1d</span><span class="p">(</span><span class="n">verif_yrs</span><span class="p">,</span> <span class="n">time_model</span><span class="p">)</span>
    <span class="n">ind_lmr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">verif_yrs</span><span class="p">,</span> <span class="n">overlap_yrs</span><span class="p">)</span>
    <span class="n">ind_model</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">time_model</span><span class="p">,</span> <span class="n">overlap_yrs</span><span class="p">)</span>

    <span class="n">lmr_on_model</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">ind_lmr</span><span class="p">:</span>
        <span class="n">lmr_on_model_each_yr</span> <span class="o">=</span> <span class="n">regrid</span><span class="p">(</span><span class="n">specob_lmr</span><span class="p">,</span> <span class="n">specob_model</span><span class="p">,</span> <span class="n">field_lmr</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">ntrunc</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">smooth</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="n">lmr_on_model</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lmr_on_model_each_yr</span><span class="p">)</span>

    <span class="n">lmr_on_model</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">lmr_on_model</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nlat_model</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nlon_model</span><span class="p">):</span>
            <span class="n">ts_model</span> <span class="o">=</span> <span class="n">field_model</span><span class="p">[</span><span class="n">ind_model</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span>
            <span class="n">ts_lmr</span> <span class="o">=</span> <span class="n">lmr_on_model</span><span class="p">[:,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span>

            <span class="n">ts_model_notnan</span> <span class="o">=</span> <span class="n">ts_model</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">ts_model</span><span class="p">)]</span>
            <span class="n">ts_lmr_notnan</span> <span class="o">=</span> <span class="n">ts_lmr</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">ts_model</span><span class="p">)]</span>
            <span class="n">nt</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ind_model</span><span class="p">)</span>
            <span class="n">nt_notnan</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">ts_model_notnan</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">detrend</span><span class="p">:</span>
                <span class="n">ts_model_notnan</span> <span class="o">=</span> <span class="n">signal</span><span class="o">.</span><span class="n">detrend</span><span class="p">(</span><span class="n">ts_model_notnan</span><span class="p">,</span> <span class="o">**</span><span class="n">detrend_kws</span><span class="p">)</span>
                <span class="n">ts_lmr_notnan</span> <span class="o">=</span> <span class="n">signal</span><span class="o">.</span><span class="n">detrend</span><span class="p">(</span><span class="n">ts_lmr_notnan</span><span class="p">,</span> <span class="o">**</span><span class="n">detrend_kws</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">nt_notnan</span><span class="o">/</span><span class="n">nt</span> <span class="o">&gt;=</span> <span class="n">valid_frac</span><span class="p">:</span>
                <span class="n">corr</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">corrcoef</span><span class="p">(</span><span class="n">ts_model_notnan</span><span class="p">,</span> <span class="n">ts_lmr_notnan</span><span class="p">)[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">corr</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

            <span class="n">ce</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">coefficient_efficiency</span><span class="p">(</span><span class="n">ts_model</span><span class="p">,</span> <span class="n">ts_lmr</span><span class="p">,</span> <span class="n">valid_frac</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">corr</span><span class="p">,</span> <span class="n">ce</span><span class="p">,</span> <span class="n">lat_model</span><span class="p">,</span> <span class="n">lon_model</span>


<span class="k">def</span> <span class="nf">calc_field_cov</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">lat</span><span class="p">,</span> <span class="n">lon</span><span class="p">,</span> <span class="n">year</span><span class="p">,</span>
                   <span class="n">target_field</span><span class="p">,</span> <span class="n">target_lat</span><span class="p">,</span> <span class="n">target_lon</span><span class="p">,</span> <span class="n">target_year</span><span class="p">,</span>
                   <span class="n">verif_yrs</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1880</span><span class="p">,</span> <span class="mi">2000</span><span class="p">),</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                   <span class="n">npts_lb</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span> <span class="n">detrend</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">detrend_kws</span><span class="o">=</span><span class="p">{}):</span>
    <span class="sd">&#39;&#39;&#39; Calculate the correlation map between the field and the timeseries of a target field at the target location</span>

<span class="sd">    Args:</span>
<span class="sd">        field (ndarray): the field in dims (nt x nlat x nlon)</span>
<span class="sd">        lat/lon (array): the lat/lon array of the field</span>
<span class="sd">        year (array): the time axis in float</span>
<span class="sd">        target_field (ndarray): the target field in dims (nt x nlat x nlon)</span>
<span class="sd">        target_lat/lon (float): the target location</span>
<span class="sd">        verif_yrs (tuple): the time period to calculate correlation</span>

<span class="sd">    Returns:</span>
<span class="sd">        corr (ndarray): the correlation map in dims (nlat x nlon)</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">nt</span><span class="p">,</span> <span class="n">nlat</span><span class="p">,</span> <span class="n">nlon</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">field</span><span class="p">)</span>
    <span class="n">lat_ind</span><span class="p">,</span> <span class="n">lon_ind</span> <span class="o">=</span> <span class="n">find_closest_loc</span><span class="p">(</span><span class="n">lat</span><span class="p">,</span> <span class="n">lon</span><span class="p">,</span> <span class="n">target_lat</span><span class="p">,</span> <span class="n">target_lon</span><span class="p">)</span>
    <span class="n">found_lat</span><span class="p">,</span> <span class="n">found_lon</span> <span class="o">=</span> <span class="n">lat</span><span class="p">[</span><span class="n">lat_ind</span><span class="p">],</span> <span class="n">lon</span><span class="p">[</span><span class="n">lon_ind</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;Target: (</span><span class="si">{target_lat}</span><span class="s1">, </span><span class="si">{target_lon}</span><span class="s1">); Found: (</span><span class="si">{found_lat:.2f}</span><span class="s1">, </span><span class="si">{found_lon:.2f}</span><span class="s1">)&#39;</span><span class="p">)</span>

    <span class="n">syear</span><span class="p">,</span> <span class="n">eyear</span> <span class="o">=</span> <span class="n">verif_yrs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">verif_yrs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">syear</span> <span class="o">&lt;</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">year</span><span class="p">)</span> <span class="ow">or</span> <span class="n">eyear</span> <span class="o">&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">year</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;ERROR: The time axis of the field is not fully covering the range of verif_yrs!!!&#39;</span><span class="p">)</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">year</span> <span class="o">&gt;=</span> <span class="n">syear</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">year</span> <span class="o">&lt;=</span> <span class="n">eyear</span><span class="p">)</span>

    <span class="n">corr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">((</span><span class="n">nlat</span><span class="p">,</span> <span class="n">nlon</span><span class="p">))</span>
    <span class="n">target_ts</span> <span class="o">=</span> <span class="n">target_field</span><span class="p">[:,</span> <span class="n">lat_ind</span><span class="p">,</span> <span class="n">lon_ind</span><span class="p">]</span>
    <span class="n">target_year</span><span class="p">,</span> <span class="n">target_ts</span> <span class="o">=</span> <span class="n">clean_ts</span><span class="p">(</span><span class="n">target_year</span><span class="p">,</span> <span class="n">target_ts</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nlat</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nlon</span><span class="p">):</span>
            <span class="n">ij_ts</span> <span class="o">=</span> <span class="n">field</span><span class="p">[</span><span class="n">mask</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span>
            <span class="n">ij_year</span><span class="p">,</span> <span class="n">ij_ts</span> <span class="o">=</span> <span class="n">clean_ts</span><span class="p">(</span><span class="n">year</span><span class="p">[</span><span class="n">mask</span><span class="p">],</span> <span class="n">ij_ts</span><span class="p">)</span>

            <span class="n">overlap_yrs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">intersect1d</span><span class="p">(</span><span class="n">ij_year</span><span class="p">,</span> <span class="n">target_year</span><span class="p">)</span>
            <span class="n">ind1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">ij_year</span><span class="p">,</span> <span class="n">overlap_yrs</span><span class="p">)</span>
            <span class="n">ind2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">target_year</span><span class="p">,</span> <span class="n">overlap_yrs</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">ind1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">npts_lb</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">ind2</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">npts_lb</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;(i, j) &gt;&gt;&gt; Warning: overlapped timeseries is too short for correlation calculation (npts &lt; 25). Returnning NaN ...&#39;</span><span class="p">)</span>
                <span class="n">corr</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ij_ts_overlap</span> <span class="o">=</span> <span class="n">ij_ts</span><span class="p">[</span><span class="n">ind1</span><span class="p">]</span>
                <span class="n">target_ts_overlap</span> <span class="o">=</span> <span class="n">target_ts</span><span class="p">[</span><span class="n">ind2</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">detrend</span><span class="p">:</span>
                    <span class="n">target_ts_overlap</span> <span class="o">=</span> <span class="n">signal</span><span class="o">.</span><span class="n">detrend</span><span class="p">(</span><span class="n">target_ts_overlap</span><span class="p">,</span> <span class="o">**</span><span class="n">detrend_kws</span><span class="p">)</span>
                    <span class="n">ij_ts_overlap</span> <span class="o">=</span> <span class="n">signal</span><span class="o">.</span><span class="n">detrend</span><span class="p">(</span><span class="n">ij_ts_overlap</span><span class="p">,</span> <span class="o">**</span><span class="n">detrend_kws</span><span class="p">)</span>

                <span class="n">corr</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">corrcoef</span><span class="p">(</span><span class="n">target_ts_overlap</span><span class="p">,</span> <span class="n">ij_ts_overlap</span><span class="p">)[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>

    <span class="n">res</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;corr&#39;</span><span class="p">:</span> <span class="n">corr</span><span class="p">,</span>
        <span class="s1">&#39;found_lat&#39;</span><span class="p">:</span> <span class="n">found_lat</span><span class="p">,</span>
        <span class="s1">&#39;found_lon&#39;</span><span class="p">:</span> <span class="n">found_lon</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">res</span>


<span class="k">def</span> <span class="nf">calc_corr_between_fields</span><span class="p">(</span>
    <span class="n">field1</span><span class="p">,</span> <span class="n">time1</span><span class="p">,</span> <span class="n">lat1</span><span class="p">,</span> <span class="n">lon1</span><span class="p">,</span>
    <span class="n">field2</span><span class="p">,</span> <span class="n">time2</span><span class="p">,</span> <span class="n">lat2</span><span class="p">,</span> <span class="n">lon2</span><span class="p">,</span>
    <span class="n">verif_yrs</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1880</span><span class="p">,</span> <span class="mi">2000</span><span class="p">),</span>
    <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">detrend</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">detrend_kws</span><span class="o">=</span><span class="p">{}</span>
<span class="p">):</span>
    <span class="n">syear</span><span class="p">,</span> <span class="n">eyear</span> <span class="o">=</span> <span class="n">verif_yrs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">verif_yrs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">mask1</span> <span class="o">=</span> <span class="p">(</span><span class="n">time1</span> <span class="o">&gt;=</span> <span class="n">syear</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">time1</span> <span class="o">&lt;=</span> <span class="n">eyear</span><span class="p">)</span>
    <span class="n">mask2</span> <span class="o">=</span> <span class="p">(</span><span class="n">time2</span> <span class="o">&gt;=</span> <span class="n">syear</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">time2</span> <span class="o">&lt;=</span> <span class="n">eyear</span><span class="p">)</span>
    <span class="n">field1_inside</span> <span class="o">=</span> <span class="n">field1</span><span class="p">[</span><span class="n">mask1</span><span class="p">]</span>
    <span class="n">field2_inside</span> <span class="o">=</span> <span class="n">field2</span><span class="p">[</span><span class="n">mask2</span><span class="p">]</span>
    <span class="n">time1_inside</span> <span class="o">=</span> <span class="n">time1</span><span class="p">[</span><span class="n">mask1</span><span class="p">]</span>
    <span class="n">time2_inside</span> <span class="o">=</span> <span class="n">time2</span><span class="p">[</span><span class="n">mask2</span><span class="p">]</span>

    <span class="n">overlap_yrs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">intersect1d</span><span class="p">(</span><span class="n">time1_inside</span><span class="p">,</span> <span class="n">time2_inside</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;Timespan: {np.min(overlap_yrs)} - {np.max(overlap_yrs)}&#39;</span><span class="p">)</span>
    <span class="n">ind1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">time1_inside</span><span class="p">,</span> <span class="n">overlap_yrs</span><span class="p">)</span>
    <span class="n">ind2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">time2_inside</span><span class="p">,</span> <span class="n">overlap_yrs</span><span class="p">)</span>

    <span class="n">nlat1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">lat1</span><span class="p">)</span>
    <span class="n">nlon1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">lon1</span><span class="p">)</span>
    <span class="n">nlat2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">lat2</span><span class="p">)</span>
    <span class="n">nlon2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">lon2</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">nlat1</span> <span class="o">==</span> <span class="n">nlat2</span> <span class="ow">and</span> <span class="n">nlon1</span> <span class="o">==</span> <span class="n">nlon2</span><span class="p">:</span>
        <span class="n">field1_on_field2</span> <span class="o">=</span> <span class="n">field1_inside</span><span class="p">[</span><span class="n">ind1</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">specob1</span> <span class="o">=</span> <span class="n">Spharmt</span><span class="p">(</span><span class="n">nlon1</span><span class="p">,</span> <span class="n">nlat1</span><span class="p">,</span> <span class="n">gridtype</span><span class="o">=</span><span class="s1">&#39;regular&#39;</span><span class="p">,</span> <span class="n">legfunc</span><span class="o">=</span><span class="s1">&#39;computed&#39;</span><span class="p">)</span>
        <span class="n">specob2</span> <span class="o">=</span> <span class="n">Spharmt</span><span class="p">(</span><span class="n">nlon2</span><span class="p">,</span> <span class="n">nlat2</span><span class="p">,</span> <span class="n">gridtype</span><span class="o">=</span><span class="s1">&#39;regular&#39;</span><span class="p">,</span> <span class="n">legfunc</span><span class="o">=</span><span class="s1">&#39;computed&#39;</span><span class="p">)</span>

        <span class="n">field1_on_field2</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">ind1</span><span class="p">:</span>
            <span class="n">field1_on_field2_each_yr</span> <span class="o">=</span> <span class="n">regrid</span><span class="p">(</span><span class="n">specob1</span><span class="p">,</span> <span class="n">specob2</span><span class="p">,</span> <span class="n">field1_inside</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">ntrunc</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">smooth</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
            <span class="n">field1_on_field2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">field1_on_field2_each_yr</span><span class="p">)</span>

        <span class="n">field1_on_field2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">field1_on_field2</span><span class="p">)</span>

    <span class="n">corr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">((</span><span class="n">nlat2</span><span class="p">,</span> <span class="n">nlon2</span><span class="p">))</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">nlat2</span><span class="p">)):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nlon2</span><span class="p">):</span>
            <span class="n">ts1</span> <span class="o">=</span> <span class="n">field1_on_field2</span><span class="p">[</span><span class="n">ind1</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span>
            <span class="n">ts2</span> <span class="o">=</span> <span class="n">field2_inside</span><span class="p">[</span><span class="n">ind2</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">ts1</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">ts2</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
                <span class="n">corr</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
                <span class="k">continue</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">corr</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">compare_ts</span><span class="p">(</span>
                    <span class="n">time1_inside</span><span class="p">[</span><span class="n">ind1</span><span class="p">],</span> <span class="n">ts1</span><span class="p">,</span> <span class="n">time2_inside</span><span class="p">[</span><span class="n">ind2</span><span class="p">],</span> <span class="n">ts2</span><span class="p">,</span>
                    <span class="n">detrend</span><span class="o">=</span><span class="n">detrend</span><span class="p">,</span> <span class="n">detrend_kws</span><span class="o">=</span><span class="n">detrend_kws</span>
                <span class="p">)[</span><span class="s1">&#39;corr&#39;</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">corr</span>

<span class="c1"># -----------------------------------------------</span>
<span class="c1">#  Superposed Epoch Analysis</span>
<span class="c1"># -----------------------------------------------</span>
<span class="k">def</span> <span class="nf">tsPad</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">t</span><span class="p">,</span><span class="n">params</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span><span class="n">padFrac</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span><span class="n">diag</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; tsPad: pad a timeseries based on timeseries model predictions</span>

<span class="sd">        Args:</span>
<span class="sd">        - x: Evenly-spaced timeseries [np.array]</span>
<span class="sd">        - t: Time axis  [np.array]</span>
<span class="sd">        - params: ARIMA model order parameters (p,d,q)</span>
<span class="sd">        - padFrac: padding fraction (scalar) such that padLength = padFrac*length(series)</span>
<span class="sd">        - diag: if True, outputs diagnostics of the fitted ARIMA model</span>

<span class="sd">        Output:</span>
<span class="sd">         - xp, tp, padded timeseries and augmented axis</span>

<span class="sd">        Author: Julien Emile-Geay</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">padLength</span> <span class="o">=</span>  <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">t</span><span class="p">)</span><span class="o">*</span><span class="n">padFrac</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>

    <span class="c1">#if (n-p1 &lt;0)</span>
    <span class="c1">#   disp(&#39;Timeseries is too short for desired padding&#39;)</span>
    <span class="c1">#elseif p1 &gt; round(n/5) % Heuristic Bound to ensure AR model stability</span>
    <span class="c1">#   p = round(n/5);</span>
    <span class="c1">#else</span>
    <span class="c1">#   p= p1;</span>
    <span class="c1">#end</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">t</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;t needs to be composed of even increments&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">dt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">t</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="c1"># computp time interval</span>

    <span class="c1"># fit ARIMA model</span>
    <span class="n">fwd_mod</span> <span class="o">=</span> <span class="n">sm</span><span class="o">.</span><span class="n">tsa</span><span class="o">.</span><span class="n">ARIMA</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">params</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>  <span class="c1"># model with time going forward</span>
    <span class="n">bwd_mod</span> <span class="o">=</span> <span class="n">sm</span><span class="o">.</span><span class="n">tsa</span><span class="o">.</span><span class="n">ARIMA</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">flip</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span><span class="n">params</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>  <span class="c1"># model with time going backwards</span>

    <span class="c1"># predict forward &amp; backward</span>
    <span class="n">fwd_pred</span>  <span class="o">=</span> <span class="n">fwd_mod</span><span class="o">.</span><span class="n">forecast</span><span class="p">(</span><span class="n">padLength</span><span class="p">);</span> <span class="n">xf</span> <span class="o">=</span> <span class="n">fwd_pred</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">bwd_pred</span>  <span class="o">=</span> <span class="n">bwd_mod</span><span class="o">.</span><span class="n">forecast</span><span class="p">(</span><span class="n">padLength</span><span class="p">);</span> <span class="n">xb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">flip</span><span class="p">(</span><span class="n">bwd_pred</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mi">0</span><span class="p">)</span>

    <span class="c1"># define extra time axes</span>
    <span class="n">tf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">t</span><span class="p">)</span><span class="o">+</span><span class="n">dt</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="n">t</span><span class="p">)</span><span class="o">+</span><span class="n">padLength</span><span class="o">*</span><span class="n">dt</span><span class="p">,</span><span class="n">padLength</span><span class="p">)</span>
    <span class="n">tb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">t</span><span class="p">)</span><span class="o">-</span><span class="n">padLength</span><span class="o">*</span><span class="n">dt</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="n">t</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">padLength</span><span class="p">)</span>

    <span class="c1"># extend time series</span>
    <span class="n">tp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">padLength</span><span class="o">*</span><span class="n">dt</span><span class="p">,</span><span class="n">t</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">padLength</span><span class="o">*</span><span class="n">dt</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">dt</span><span class="p">)</span>
    <span class="n">xp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">tp</span><span class="p">))</span>
    <span class="n">xp</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span><span class="n">t</span><span class="p">)]</span> <span class="o">=</span><span class="n">x</span>
    <span class="n">xp</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span><span class="n">tb</span><span class="p">)]</span><span class="o">=</span><span class="n">xb</span>
    <span class="n">xp</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span><span class="n">tf</span><span class="p">)]</span><span class="o">=</span><span class="n">xf</span>

    <span class="k">return</span> <span class="n">xp</span><span class="p">,</span> <span class="n">tp</span>


<span class="k">def</span> <span class="nf">butterworth</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">fc</span><span class="p">,</span><span class="n">fs</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">filter_order</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span><span class="n">pad</span><span class="o">=</span><span class="s1">&#39;reflect&#39;</span><span class="p">,</span><span class="n">reflect_type</span><span class="o">=</span><span class="s1">&#39;odd&#39;</span><span class="p">,</span><span class="n">params</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span><span class="n">padFrac</span><span class="o">=</span><span class="mf">0.1</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Applies a Butterworth filter with frequency fc, with padding</span>

<span class="sd">    Arguments:</span>
<span class="sd">        - X = 1d numpy array</span>
<span class="sd">        - fc = cutoff frequency. If scalar, it is interpreted as a low-frequency cutoff (lowpass)</span>
<span class="sd">                 If fc is a 2-tuple,  it is interpreted as a frequency band (f1, f2), with f1 &lt; f2 (bandpass)</span>
<span class="sd">        - fs = sampling frequency</span>
<span class="sd">        - filter_order = order n of Butterworth filter</span>
<span class="sd">        - pad = boolean indicating whether tsPad needs to be applied</span>
<span class="sd">        - params = model parameters for ARIMA model (if pad = True)</span>
<span class="sd">        - padFrac = fraction of the series to be padded</span>

<span class="sd">    Output : xf, filtered array</span>

<span class="sd">    Author: Julien Emile-Geay</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">nyq</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">fs</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fc</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">fc</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">fl</span> <span class="o">=</span> <span class="n">fc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="n">nyq</span>
        <span class="n">fh</span> <span class="o">=</span> <span class="n">fc</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">nyq</span>
        <span class="n">b</span><span class="p">,</span> <span class="n">a</span> <span class="o">=</span> <span class="n">signal</span><span class="o">.</span><span class="n">butter</span><span class="p">(</span><span class="n">filter_order</span><span class="p">,</span> <span class="p">[</span><span class="n">fl</span><span class="p">,</span> <span class="n">fh</span><span class="p">],</span> <span class="n">btype</span><span class="o">=</span><span class="s1">&#39;bandpass&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">fl</span> <span class="o">=</span> <span class="n">fc</span> <span class="o">/</span> <span class="n">nyq</span>
        <span class="n">b</span><span class="p">,</span> <span class="n">a</span> <span class="o">=</span> <span class="n">signal</span><span class="o">.</span><span class="n">butter</span><span class="p">(</span><span class="n">filter_order</span><span class="p">,</span> <span class="n">fl</span>      <span class="p">,</span> <span class="n">btype</span><span class="o">=</span><span class="s1">&#39;lowpass&#39;</span><span class="p">)</span>

    <span class="n">t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">))</span> <span class="c1"># define time axis</span>
    <span class="n">padLength</span> <span class="o">=</span>  <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">*</span><span class="n">padFrac</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">pad</span><span class="o">==</span><span class="s1">&#39;ARIMA&#39;</span><span class="p">):</span>
        <span class="n">xp</span><span class="p">,</span><span class="n">tp</span> <span class="o">=</span> <span class="n">tsPad</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">t</span><span class="p">,</span><span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">)</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">pad</span><span class="o">==</span><span class="s1">&#39;reflect&#39;</span><span class="p">):</span>
        <span class="c1"># extend time series</span>
        <span class="n">xp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">x</span><span class="p">,(</span><span class="n">padLength</span><span class="p">,</span><span class="n">padLength</span><span class="p">),</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;reflect&#39;</span><span class="p">,</span><span class="n">reflect_type</span><span class="o">=</span><span class="n">reflect_type</span><span class="p">)</span>
        <span class="n">tp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">padLength</span><span class="p">,</span><span class="n">t</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">padLength</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">xp</span> <span class="o">=</span> <span class="n">x</span><span class="p">;</span> <span class="n">tp</span> <span class="o">=</span> <span class="n">t</span>

    <span class="n">xpf</span> <span class="o">=</span> <span class="n">signal</span><span class="o">.</span><span class="n">filtfilt</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">xp</span><span class="p">)</span>
    <span class="n">xf</span>  <span class="o">=</span> <span class="n">xpf</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span><span class="n">t</span><span class="p">)]</span>

    <span class="k">return</span> <span class="n">xf</span>


<span class="k">def</span> <span class="nf">sea</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">events</span><span class="p">,</span> <span class="n">start_yr</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">preyr</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">postyr</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">qs</span><span class="o">=</span><span class="p">[</span><span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">],</span> <span class="n">highpass</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Applies superposed Epoch Analysis to N-dim array X, at indices &#39;events&#39;,</span>
<span class="sd">        and on a window [-preyr,postyr]</span>
<span class="sd">    Inputs:</span>
<span class="sd">        - X: numpy array [time assumed to be the first dimension]</span>
<span class="sd">        - events: indices of events of interest</span>
<span class="sd">        - start_yr (int): the start year of X</span>
<span class="sd">        - preyr: # years over which the pre-event mean is computed</span>
<span class="sd">        - postyr: length of post-event window</span>

<span class="sd">    Outputs:</span>
<span class="sd">        - Xevents : X lined up on events; removes mean of &quot;preyr&quot; years in shape of (time, ensemble, events)</span>
<span class="sd">        - Xcomp  : composite of Xevents (same dimensions as X, minus the last one)</span>
<span class="sd">        - tcomp  : the time axis relative to events</span>

<span class="sd">    by Julien Emile-Geay</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">events</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">events</span><span class="p">)</span>

    <span class="c1"># exception handling : the first extreme year must not happen within the &quot;preyr&quot; indices</span>
    <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">events</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">preyr</span><span class="p">)</span><span class="o">+</span><span class="n">start_yr</span><span class="p">))</span> <span class="ow">or</span> <span class="nb">any</span><span class="p">(</span><span class="n">events</span><span class="o">+</span><span class="n">postyr</span><span class="o">&gt;=</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">start_yr</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;event outside range (either before &#39;tmin-preyr&#39; or after &#39;tmax+postyr&#39;)&quot;</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>

    <span class="n">tcomp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="n">preyr</span><span class="p">,</span><span class="n">postyr</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># time axis</span>
    <span class="c1"># reshape X to 2d</span>
    <span class="k">if</span> <span class="n">highpass</span><span class="p">:</span>
        <span class="c1"># high-pass filter X along first axis</span>
        <span class="n">fc</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">tcomp</span><span class="p">)</span>
        <span class="n">sh</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="n">Xr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">X</span><span class="p">,(</span><span class="n">sh</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="n">sh</span><span class="p">[</span><span class="mi">1</span><span class="p">:])))</span>
        <span class="n">Xr_hp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty_like</span><span class="p">(</span><span class="n">Xr</span><span class="p">)</span>
        <span class="n">ncols</span> <span class="o">=</span> <span class="n">Xr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ncols</span><span class="p">):</span>
            <span class="n">Xlp</span> <span class="o">=</span> <span class="n">butterworth</span><span class="p">(</span><span class="n">Xr</span><span class="p">[:,</span> <span class="n">k</span><span class="p">],</span> <span class="n">fc</span><span class="p">)</span>
            <span class="n">Xr_hp</span><span class="p">[:,</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">Xr</span><span class="p">[:,</span> <span class="n">k</span><span class="p">]</span> <span class="o">-</span> <span class="n">Xlp</span>

        <span class="n">Xhp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">Xr_hp</span><span class="p">,</span><span class="n">sh</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">Xhp</span> <span class="o">=</span> <span class="n">X</span>

    <span class="n">n_events</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">events</span><span class="p">)</span>
    <span class="c1"># define array shape</span>
    <span class="n">sh</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">Xhp</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">sh</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">n_events</span><span class="p">)</span> <span class="c1"># add number of events</span>
    <span class="n">sh</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">preyr</span><span class="o">+</span><span class="n">postyr</span><span class="o">+</span><span class="mi">1</span>  <span class="c1"># replace time axis by time relative to window</span>
    <span class="n">Xevents</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">sh</span><span class="p">)</span> <span class="c1"># define empty array to hold the result</span>


    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_events</span><span class="p">):</span>
        <span class="n">Xevents</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">Xhp</span><span class="p">[</span><span class="n">events</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-</span><span class="n">preyr</span><span class="o">-</span><span class="n">start_yr</span><span class="p">:</span><span class="n">events</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">+</span><span class="n">postyr</span><span class="o">+</span><span class="mi">1</span><span class="o">-</span><span class="n">start_yr</span><span class="p">,</span><span class="o">...</span><span class="p">]</span>
        <span class="n">Xevents</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="n">i</span><span class="p">]</span> <span class="o">-=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">Xevents</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">preyr</span><span class="p">,</span><span class="o">...</span><span class="p">,</span><span class="n">i</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="c1"># remove mean over &quot;preyr&quot; of window</span>

    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;SEA &gt;&gt;&gt; shape(Xevents):&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">Xevents</span><span class="p">))</span>

    <span class="n">Xcomp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">Xevents</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># compute composite</span>

    <span class="n">composite</span> <span class="o">=</span> <span class="n">Xcomp</span><span class="o">.</span><span class="n">T</span>
    <span class="n">ndim</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">composite</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">ndim</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">composite_qs</span> <span class="o">=</span> <span class="n">mquantiles</span><span class="p">(</span><span class="n">composite</span><span class="p">,</span> <span class="n">qs</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="n">res</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;events&#39;</span><span class="p">:</span> <span class="n">events</span><span class="p">,</span>
            <span class="s1">&#39;Xevents&#39;</span><span class="p">:</span> <span class="n">Xevents</span><span class="p">,</span>
            <span class="s1">&#39;composite&#39;</span><span class="p">:</span> <span class="n">composite</span><span class="p">,</span>
            <span class="s1">&#39;qs&#39;</span><span class="p">:</span> <span class="n">qs</span><span class="p">,</span>
            <span class="s1">&#39;composite_qs&#39;</span><span class="p">:</span> <span class="n">composite_qs</span><span class="p">,</span>
            <span class="s1">&#39;composite_yr&#39;</span><span class="p">:</span> <span class="n">tcomp</span><span class="p">,</span>
        <span class="p">}</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">res</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;events&#39;</span><span class="p">:</span> <span class="n">events</span><span class="p">,</span>
            <span class="s1">&#39;Xevents&#39;</span><span class="p">:</span> <span class="n">Xevents</span><span class="p">,</span>
            <span class="s1">&#39;composite&#39;</span><span class="p">:</span> <span class="n">composite</span><span class="p">,</span>
            <span class="s1">&#39;composite_yr&#39;</span><span class="p">:</span> <span class="n">tcomp</span><span class="p">,</span>
        <span class="p">}</span>

    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;SEA &gt;&gt;&gt; shape(composite): {np.shape(composite)}&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;SEA &gt;&gt;&gt; res.keys(): {list(res.keys())}&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">res</span>


<span class="k">def</span> <span class="nf">sea_dbl</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">events</span><span class="p">,</span> <span class="n">preyr</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">postyr</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> <span class="n">seeds</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">nsample</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
            <span class="n">qs</span><span class="o">=</span><span class="p">[</span><span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">],</span> <span class="n">qs_signif</span><span class="o">=</span><span class="p">[</span><span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.10</span><span class="p">,</span> <span class="mf">0.90</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">,</span> <span class="mf">0.99</span><span class="p">],</span>
            <span class="n">nboot_event</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; A double bootstrap approach to Superposed Epoch Analysis to evaluate response uncertainty</span>

<span class="sd">    Args:</span>
<span class="sd">        time (1-D array): time axis</span>
<span class="sd">        value (1-D array): value axis</span>
<span class="sd">        events (1-D array): event years</span>

<span class="sd">    Returns:</span>
<span class="sd">        res (dict): result dictionary</span>

<span class="sd">    References:</span>
<span class="sd">        Rao MP, Cook ER, Cook BI, et al (2019) A double bootstrap approach to Superposed Epoch Analysis to evaluate response uncertainty.</span>
<span class="sd">            Dendrochronologia 55:119124. doi: 10.1016/j.dendro.2019.05.001</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">events</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">:</span>
        <span class="n">events</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">events</span><span class="p">)</span>

    <span class="n">nevents</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">events</span><span class="p">)</span>
    <span class="n">total_draws</span> <span class="o">=</span> <span class="n">factorial</span><span class="p">(</span><span class="n">nevents</span><span class="p">)</span><span class="o">/</span><span class="n">factorial</span><span class="p">(</span><span class="n">nsample</span><span class="p">)</span><span class="o">/</span><span class="n">factorial</span><span class="p">(</span><span class="n">nevents</span><span class="o">-</span><span class="n">nsample</span><span class="p">)</span>
    <span class="n">nyr</span> <span class="o">=</span> <span class="n">preyr</span> <span class="o">+</span> <span class="n">postyr</span> <span class="o">+</span> <span class="mi">1</span>

    <span class="c1"># embed()</span>
    <span class="c1"># avoid edges</span>
    <span class="n">time_inner</span> <span class="o">=</span> <span class="n">time</span><span class="p">[</span><span class="n">preyr</span><span class="p">:</span><span class="o">-</span><span class="n">postyr</span><span class="p">]</span>
    <span class="n">events_inner</span> <span class="o">=</span> <span class="n">events</span><span class="p">[(</span><span class="n">events</span><span class="o">&gt;=</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">time_inner</span><span class="p">))</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">events</span><span class="o">&lt;=</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">time_inner</span><span class="p">))]</span>

    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;SEA &gt;&gt;&gt; valid events: </span><span class="si">{events_inner}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;SEA &gt;&gt;&gt; nevents: </span><span class="si">{nevents}</span><span class="s1">, nsample: </span><span class="si">{nsample}</span><span class="s1">, total draws: </span><span class="si">{total_draws:g}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;SEA &gt;&gt;&gt; nboot_event: </span><span class="si">{nboot_event}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;SEA &gt;&gt;&gt; preyr: </span><span class="si">{preyr}</span><span class="s1">, postyr: </span><span class="si">{postyr}</span><span class="s1">, window length: </span><span class="si">{nyr}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;SEA &gt;&gt;&gt; qs: </span><span class="si">{qs}</span><span class="s1">, qs_signif: </span><span class="si">{qs_signif}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="c1"># generate unique draws without replacement</span>
    <span class="n">draws</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">draws_signif</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nboot_event</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">seeds</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">seeds</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

        <span class="n">draw_tmp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">events_inner</span><span class="p">,</span> <span class="n">nsample</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">draws</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">draw_tmp</span><span class="p">))</span>

        <span class="n">draw_tmp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">time_inner</span><span class="p">,</span> <span class="n">nsample</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">draws_signif</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">draw_tmp</span><span class="p">))</span>

    <span class="n">draws</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">draws</span><span class="p">)</span>
    <span class="n">draws_signif</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">draws_signif</span><span class="p">)</span>

    <span class="c1"># generate composite ndarrays</span>
    <span class="n">composite_raw</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">((</span><span class="n">nboot_event</span><span class="p">,</span> <span class="n">nsample</span><span class="p">,</span> <span class="n">nyr</span><span class="p">))</span>
    <span class="n">composite_raw_signif</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">((</span><span class="n">nboot_event</span><span class="p">,</span> <span class="n">nsample</span><span class="p">,</span> <span class="n">nyr</span><span class="p">))</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nboot_event</span><span class="p">):</span>
        <span class="n">sample_yrs</span> <span class="o">=</span> <span class="n">draws</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">sample_yrs_signif</span> <span class="o">=</span> <span class="n">draws_signif</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nsample</span><span class="p">):</span>
            <span class="n">center_yr</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">time</span><span class="p">)</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">sample_yrs</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
            <span class="n">composite_raw</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">value</span><span class="p">[</span><span class="n">center_yr</span><span class="o">-</span><span class="n">preyr</span><span class="p">:</span><span class="n">center_yr</span><span class="o">+</span><span class="n">postyr</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>

            <span class="n">center_yr_signif</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">time</span><span class="p">)</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">sample_yrs_signif</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
            <span class="n">composite_raw_signif</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">value</span><span class="p">[</span><span class="n">center_yr_signif</span><span class="o">-</span><span class="n">preyr</span><span class="p">:</span><span class="n">center_yr_signif</span><span class="o">+</span><span class="n">postyr</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>

    <span class="c1"># normalization: remove the mean of the pre-years</span>
    <span class="n">composite_norm</span> <span class="o">=</span> <span class="n">composite_raw</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">composite_raw</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:</span><span class="n">preyr</span><span class="p">],</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)[:,</span> <span class="p">:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
    <span class="n">composite_norm_signif</span> <span class="o">=</span> <span class="n">composite_raw_signif</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">composite_raw_signif</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:</span><span class="n">preyr</span><span class="p">],</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)[:,</span> <span class="p">:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>

    <span class="n">composite</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">composite_norm</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">composite_qs</span> <span class="o">=</span> <span class="n">mquantiles</span><span class="p">(</span><span class="n">composite</span><span class="p">,</span> <span class="n">qs</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="n">composite_signif</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">composite_norm_signif</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">composite_qs_signif</span> <span class="o">=</span> <span class="n">mquantiles</span><span class="p">(</span><span class="n">composite_signif</span><span class="p">,</span> <span class="n">qs_signif</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="n">composite_yr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="n">preyr</span><span class="p">,</span> <span class="n">postyr</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">res</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;events&#39;</span><span class="p">:</span> <span class="n">events_inner</span><span class="p">,</span>
        <span class="s1">&#39;draws&#39;</span><span class="p">:</span> <span class="n">draws</span><span class="p">,</span>
        <span class="s1">&#39;composite&#39;</span><span class="p">:</span> <span class="n">composite</span><span class="p">,</span>
        <span class="s1">&#39;qs&#39;</span><span class="p">:</span> <span class="n">qs</span><span class="p">,</span>
        <span class="s1">&#39;composite_qs&#39;</span><span class="p">:</span> <span class="n">composite_qs</span><span class="p">,</span>
        <span class="s1">&#39;draws_signif&#39;</span><span class="p">:</span> <span class="n">draws_signif</span><span class="p">,</span>
        <span class="s1">&#39;composite_signif&#39;</span><span class="p">:</span> <span class="n">composite_signif</span><span class="p">,</span>
        <span class="s1">&#39;qs_signif&#39;</span><span class="p">:</span> <span class="n">qs_signif</span><span class="p">,</span>
        <span class="s1">&#39;composite_qs_signif&#39;</span><span class="p">:</span> <span class="n">composite_qs_signif</span><span class="p">,</span>
        <span class="s1">&#39;composite_yr&#39;</span><span class="p">:</span> <span class="n">composite_yr</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;SEA &gt;&gt;&gt; shape(composite): {np.shape(composite)}&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;SEA &gt;&gt;&gt; res.keys(): {list(res.keys())}&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">res</span>


<span class="k">def</span> <span class="nf">sea_field</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">events</span><span class="p">,</span> <span class="n">preyr</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">post_avg_range</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
    <span class="sd">&#39;&#39;&#39; Perform a simple SEA on a 3-D field</span>

<span class="sd">    Args:</span>
<span class="sd">        post_avg_range (list): e.g. [0] refers to the event year; [1, 5] refers to the 1-5 yrs after the event</span>

<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">def</span> <span class="nf">post_avg_func</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">post_avg_range</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">post_avg_range</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">field</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="n">post_avg_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">field</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="n">post_avg_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">i</span><span class="o">+</span><span class="n">post_avg_range</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">list</span><span class="p">(</span><span class="n">time</span><span class="p">)</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">events</span><span class="p">])</span>
    <span class="n">field_anom</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">idx</span><span class="p">:</span>
        <span class="n">pre_avg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">field</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="n">preyr</span><span class="p">:</span><span class="n">i</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">post_avg</span> <span class="o">=</span> <span class="n">post_avg_func</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">post_avg_range</span><span class="p">)</span>
        <span class="n">field_anom_tmp</span> <span class="o">=</span> <span class="n">post_avg</span> <span class="o">-</span> <span class="n">pre_avg</span>
        <span class="n">field_anom</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">field_anom_tmp</span><span class="p">)</span>

    <span class="n">composite</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">field_anom</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">composite</span>


<span class="k">def</span> <span class="nf">sea_dbl_field</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">events</span><span class="p">,</span> <span class="n">preyr</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">post_avg_range</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">seeds</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">nsample</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
            <span class="n">qs</span><span class="o">=</span><span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">95</span><span class="p">],</span> <span class="n">qs_signif</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">90</span><span class="p">,</span> <span class="mi">95</span><span class="p">,</span> <span class="mi">99</span><span class="p">],</span>
            <span class="n">nboot_event</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; A double bootstrap approach to Superposed Epoch Analysis to evaluate response uncertainty</span>

<span class="sd">    Args:</span>
<span class="sd">        time (1-D array): time axis</span>
<span class="sd">        field (3-D array): filed with 1st dim be time</span>
<span class="sd">        events (1-D array): event years</span>

<span class="sd">    Returns:</span>
<span class="sd">        res (dict): result dictionary</span>

<span class="sd">    References:</span>
<span class="sd">        Rao MP, Cook ER, Cook BI, et al (2019) A double bootstrap approach to Superposed Epoch Analysis to evaluate response uncertainty.</span>
<span class="sd">            Dendrochronologia 55:119124. doi: 10.1016/j.dendro.2019.05.001</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">events</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">:</span>
        <span class="n">events</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">events</span><span class="p">)</span>

    <span class="n">nevents</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">events</span><span class="p">)</span>
    <span class="n">total_draws</span> <span class="o">=</span> <span class="n">factorial</span><span class="p">(</span><span class="n">nevents</span><span class="p">)</span><span class="o">/</span><span class="n">factorial</span><span class="p">(</span><span class="n">nsample</span><span class="p">)</span><span class="o">/</span><span class="n">factorial</span><span class="p">(</span><span class="n">nevents</span><span class="o">-</span><span class="n">nsample</span><span class="p">)</span>

    <span class="c1"># avoid edges</span>
    <span class="k">if</span> <span class="n">post_avg_range</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">time_inner</span> <span class="o">=</span> <span class="n">time</span><span class="p">[</span><span class="n">preyr</span><span class="p">:]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">time_inner</span> <span class="o">=</span> <span class="n">time</span><span class="p">[</span><span class="n">preyr</span><span class="p">:</span><span class="o">-</span><span class="n">post_avg_range</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span>

    <span class="n">events_inner</span> <span class="o">=</span> <span class="n">events</span><span class="p">[(</span><span class="n">events</span><span class="o">&gt;=</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">time_inner</span><span class="p">))</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">events</span><span class="o">&lt;=</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">time_inner</span><span class="p">))]</span>

    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;SEA &gt;&gt;&gt; valid events: </span><span class="si">{events_inner}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;SEA &gt;&gt;&gt; nevents: </span><span class="si">{nevents}</span><span class="s1">, nsample: </span><span class="si">{nsample}</span><span class="s1">, total draws: </span><span class="si">{total_draws:g}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;SEA &gt;&gt;&gt; nboot_event: </span><span class="si">{nboot_event}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;SEA &gt;&gt;&gt; preyr: </span><span class="si">{preyr}</span><span class="s1">, post_avg_range: </span><span class="si">{post_avg_range}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;SEA &gt;&gt;&gt; qs: </span><span class="si">{qs}</span><span class="s1">, qs_signif: </span><span class="si">{qs_signif}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="c1"># generate unique draws without replacement</span>
    <span class="n">draws</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">draws_signif</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nboot_event</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">seeds</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">seeds</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

        <span class="n">draw_tmp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">events_inner</span><span class="p">,</span> <span class="n">nsample</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">draws</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">draw_tmp</span><span class="p">))</span>

        <span class="n">draw_tmp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">time_inner</span><span class="p">,</span> <span class="n">nsample</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">draws_signif</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">draw_tmp</span><span class="p">))</span>

    <span class="n">draws</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">draws</span><span class="p">)</span>
    <span class="n">draws_signif</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">draws_signif</span><span class="p">)</span>

    <span class="c1"># calculate composites</span>
    <span class="n">composite</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">composite_signif</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nboot_event</span><span class="p">):</span>
        <span class="n">sample_yrs</span> <span class="o">=</span> <span class="n">draws</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">sample_yrs_signif</span> <span class="o">=</span> <span class="n">draws_signif</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

        <span class="n">composite</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="n">sea_field</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">sample_yrs</span><span class="p">,</span> <span class="n">preyr</span><span class="o">=</span><span class="n">preyr</span><span class="p">,</span> <span class="n">post_avg_range</span><span class="o">=</span><span class="n">post_avg_range</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">composite_signif</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="n">sea_field</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">sample_yrs_signif</span><span class="p">,</span> <span class="n">preyr</span><span class="o">=</span><span class="n">preyr</span><span class="p">,</span> <span class="n">post_avg_range</span><span class="o">=</span><span class="n">post_avg_range</span><span class="p">)</span>
        <span class="p">)</span>

    <span class="n">composite</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">composite</span><span class="p">)</span>
    <span class="n">composite_qs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">composite</span><span class="p">,</span> <span class="n">qs</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="n">composite_signif</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">composite_signif</span><span class="p">)</span>
    <span class="n">composite_qs_signif</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">composite_signif</span><span class="p">,</span> <span class="n">qs_signif</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="c1"># return results</span>
    <span class="n">res</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;events&#39;</span><span class="p">:</span> <span class="n">events_inner</span><span class="p">,</span>
        <span class="s1">&#39;draws&#39;</span><span class="p">:</span> <span class="n">draws</span><span class="p">,</span>
        <span class="s1">&#39;composite&#39;</span><span class="p">:</span> <span class="n">composite</span><span class="p">,</span>
        <span class="s1">&#39;qs&#39;</span><span class="p">:</span> <span class="n">qs</span><span class="p">,</span>
        <span class="s1">&#39;composite_qs&#39;</span><span class="p">:</span> <span class="n">composite_qs</span><span class="p">,</span>
        <span class="s1">&#39;draws_signif&#39;</span><span class="p">:</span> <span class="n">draws_signif</span><span class="p">,</span>
        <span class="s1">&#39;composite_signif&#39;</span><span class="p">:</span> <span class="n">composite_signif</span><span class="p">,</span>
        <span class="s1">&#39;qs_signif&#39;</span><span class="p">:</span> <span class="n">qs_signif</span><span class="p">,</span>
        <span class="s1">&#39;composite_qs_signif&#39;</span><span class="p">:</span> <span class="n">composite_qs_signif</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;SEA &gt;&gt;&gt; shape(composite): {np.shape(composite)}&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;SEA &gt;&gt;&gt; res.keys(): {list(res.keys())}&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">res</span>
<span class="c1"># ===============================================</span>

<span class="c1"># -----------------------------------------------</span>
<span class="c1">#  corr_sig adapated from Pyleoclim</span>
<span class="c1"># -----------------------------------------------</span>
<span class="k">def</span> <span class="nf">corr_sig</span><span class="p">(</span><span class="n">y1</span><span class="p">,</span> <span class="n">y2</span><span class="p">,</span> <span class="n">nsim</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;isospectral&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.05</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Estimates the significance of correlations between non IID time series by 3 independent methods:</span>
<span class="sd">    1) &#39;ttest&#39;: T-test where d.o.f are corrected for the effect of serial correlation</span>
<span class="sd">    2) &#39;isopersistent&#39;: AR(1) modeling of x and y.</span>
<span class="sd">    3) &#39;isospectral&#39;: phase randomization of original inputs. (default)</span>
<span class="sd">    The T-test is parametric test, hence cheap but usually wrong except in idyllic circumstances.</span>
<span class="sd">    The others are non-parametric, but their computational requirements scales with nsim.</span>

<span class="sd">    Args:</span>
<span class="sd">        y1, y2 (array)- vector of (real) numbers of identical length, no NaNs allowed</span>
<span class="sd">        nsim (int)- the number of simulations [1000]</span>
<span class="sd">        method (str)- methods 1-3 above [&#39;isospectral&#39;]</span>
<span class="sd">        alpha (float)- significance level for critical value estimation [0.05]</span>

<span class="sd">    Returns:</span>
<span class="sd">         r (real): correlation between x and y \n</span>
<span class="sd">         signif (boolean): true (1) if significant; false (0) otherwise \n</span>
<span class="sd">         p (real): Fraction of time series with higher correlation coefficents than observed (approximates the p-value). \n</span>
<span class="sd">            Note that signif = True if and only if p &lt;= alpha.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">y1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">y1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">y2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">y2</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">y1</span><span class="p">)</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">y2</span><span class="p">),</span> <span class="s1">&#39;The size of X and the size of Y should be the same!&#39;</span>

    <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;ttest&#39;</span><span class="p">:</span>
        <span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">signif</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span> <span class="o">=</span> <span class="n">corr_ttest</span><span class="p">(</span><span class="n">y1</span><span class="p">,</span> <span class="n">y2</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;isopersistent&#39;</span><span class="p">:</span>
        <span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">signif</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span> <span class="o">=</span> <span class="n">corr_isopersist</span><span class="p">(</span><span class="n">y1</span><span class="p">,</span> <span class="n">y2</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">,</span> <span class="n">nsim</span><span class="o">=</span><span class="n">nsim</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;isospectral&#39;</span><span class="p">:</span>
        <span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">signif</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span> <span class="o">=</span> <span class="n">corr_isospec</span><span class="p">(</span><span class="n">y1</span><span class="p">,</span> <span class="n">y2</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">,</span> <span class="n">nsim</span><span class="o">=</span><span class="n">nsim</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;</span><span class="si">{method}</span><span class="s1"> is not a valid method&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">r</span><span class="p">,</span> <span class="n">signif</span><span class="p">,</span> <span class="n">p</span>


<span class="k">def</span> <span class="nf">corr_ttest</span><span class="p">(</span><span class="n">y1</span><span class="p">,</span> <span class="n">y2</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.05</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Estimates the significance of correlations between 2 time series using</span>
<span class="sd">    the classical T-test with degrees of freedom modified for autocorrelation.</span>
<span class="sd">    This function creates &#39;nsim&#39; random time series that have the same power</span>
<span class="sd">    spectrum as the original time series but with random phases.</span>

<span class="sd">    Args:</span>
<span class="sd">        y1, y2 (array): vectors of (real) numbers with identical length, no NaNs allowed</span>
<span class="sd">        alpha (real): significance level for critical value estimation [default: 0.05]</span>

<span class="sd">    Returns:</span>
<span class="sd">        r (real)- correlation between x and y \n</span>
<span class="sd">        signif (boolean)- true (1) if significant; false (0) otherwise \n</span>
<span class="sd">        pval (real)- test p-value (the probability of the test statstic exceeding the observed one by chance alone)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">pearsonr</span><span class="p">(</span><span class="n">y1</span><span class="p">,</span> <span class="n">y2</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

    <span class="n">g1</span> <span class="o">=</span> <span class="n">ar1_fit</span><span class="p">(</span><span class="n">y1</span><span class="p">)</span>
    <span class="n">g2</span> <span class="o">=</span> <span class="n">ar1_fit</span><span class="p">(</span><span class="n">y2</span><span class="p">)</span>

    <span class="n">N</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">y1</span><span class="p">)</span>

    <span class="n">Ney1</span> <span class="o">=</span> <span class="n">N</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">g1</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">g1</span><span class="p">)</span>
    <span class="n">Ney2</span> <span class="o">=</span> <span class="n">N</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">g2</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">g2</span><span class="p">)</span>

    <span class="n">Ne</span> <span class="o">=</span> <span class="n">gmean</span><span class="p">([</span><span class="n">Ney1</span><span class="o">+</span><span class="n">Ney2</span><span class="p">])</span>
    <span class="k">assert</span> <span class="n">Ne</span> <span class="o">&gt;=</span> <span class="mi">10</span><span class="p">,</span> <span class="n">f</span><span class="s1">&#39;Too few effective d.o.f. to apply this method! Ne=</span><span class="si">{Ne}</span><span class="s1">, Ney1=</span><span class="si">{Ney1:.2f}</span><span class="s1">, Ney2=</span><span class="si">{Ney2:.2f}</span><span class="s1">, g1=</span><span class="si">{g1:.2f}</span><span class="s1">, g2=</span><span class="si">{g2:.2f}</span><span class="s1">&#39;</span>

    <span class="n">df</span> <span class="o">=</span> <span class="n">Ne</span> <span class="o">-</span> <span class="mi">2</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">df</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">r</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>

    <span class="n">pval</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">stu</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">t</span><span class="p">),</span> <span class="n">df</span><span class="p">)</span>

    <span class="n">signif</span> <span class="o">=</span> <span class="n">pval</span> <span class="o">&lt;=</span> <span class="n">alpha</span>

    <span class="k">return</span> <span class="n">r</span><span class="p">,</span> <span class="n">signif</span><span class="p">,</span> <span class="n">pval</span>


<span class="k">def</span> <span class="nf">corr_isopersist</span><span class="p">(</span><span class="n">y1</span><span class="p">,</span> <span class="n">y2</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">nsim</span><span class="o">=</span><span class="mi">1000</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; Computes correlation between two timeseries, and their significance.</span>
<span class="sd">    The latter is gauged via a non-parametric (Monte Carlo) simulation of</span>
<span class="sd">    correlations with nsim AR(1) processes with identical persistence</span>
<span class="sd">    properties as x and y ; the measure of which is the lag-1 autocorrelation (g).</span>

<span class="sd">    Args:</span>
<span class="sd">        y1, y2 (array): vectors of (real) numbers with identical length, no NaNs allowed</span>
<span class="sd">        alpha (real): significance level for critical value estimation [default: 0.05]</span>
<span class="sd">        nsim (int): number of simulations [default: 1000]</span>

<span class="sd">    Returns:</span>
<span class="sd">        r (real) - correlation between x and y \n</span>
<span class="sd">        signif (boolean) - true (1) if significant; false (0) otherwise \n</span>
<span class="sd">        pval (real) - test p-value (the probability of the test statstic exceeding the observed one by chance alone)</span>

<span class="sd">    Remarks:</span>
<span class="sd">        The probability of obtaining a test statistic at least as extreme as the one actually observed,</span>
<span class="sd">        assuming that the null hypothesis is true. \n</span>
<span class="sd">        The test is 1 tailed on |r|: Ho = { |r| = 0 }, Ha = { |r| &gt; 0 } \n</span>
<span class="sd">        The test is rejected (signif = 1) if pval &lt;= alpha, otherwise signif=0; \n</span>
<span class="sd">        (Some Rights Reserved) Hepta Technologies, 2009 \n</span>
<span class="sd">        v1.0 USC, Aug 10 2012, based on corr_signif.m</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">r</span> <span class="o">=</span> <span class="n">pearsonr</span><span class="p">(</span><span class="n">y1</span><span class="p">,</span> <span class="n">y2</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">ra</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>

    <span class="n">y1_red</span><span class="p">,</span> <span class="n">g1</span> <span class="o">=</span> <span class="n">isopersistent_rn</span><span class="p">(</span><span class="n">y1</span><span class="p">,</span> <span class="n">nsim</span><span class="p">)</span>
    <span class="n">y2_red</span><span class="p">,</span> <span class="n">g2</span> <span class="o">=</span> <span class="n">isopersistent_rn</span><span class="p">(</span><span class="n">y2</span><span class="p">,</span> <span class="n">nsim</span><span class="p">)</span>

    <span class="n">rs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nsim</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">nsim</span><span class="p">):</span>
        <span class="n">rs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">pearsonr</span><span class="p">(</span><span class="n">y1_red</span><span class="p">[:,</span> <span class="n">i</span><span class="p">],</span> <span class="n">y2_red</span><span class="p">[:,</span> <span class="n">i</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>

    <span class="n">rsa</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">rs</span><span class="p">)</span>

    <span class="n">xi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">1.1</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">([</span><span class="n">ra</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">rsa</span><span class="p">)]),</span> <span class="mi">200</span><span class="p">)</span>
    <span class="n">kde</span> <span class="o">=</span> <span class="n">gaussian_kde</span><span class="p">(</span><span class="n">rsa</span><span class="p">)</span>
    <span class="n">prob</span> <span class="o">=</span> <span class="n">kde</span><span class="p">(</span><span class="n">xi</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>

    <span class="n">diff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">ra</span> <span class="o">-</span> <span class="n">xi</span><span class="p">)</span>
    <span class="c1">#  min_diff = np.min(diff)</span>
    <span class="n">pos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">diff</span><span class="p">)</span>

    <span class="n">pval</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">trapz</span><span class="p">(</span><span class="n">prob</span><span class="p">[</span><span class="n">pos</span><span class="p">:],</span> <span class="n">xi</span><span class="p">[</span><span class="n">pos</span><span class="p">:])</span>

    <span class="n">rcrit</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">rsa</span><span class="p">,</span> <span class="mi">100</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">alpha</span><span class="p">))</span>
    <span class="n">signif</span> <span class="o">=</span> <span class="n">ra</span> <span class="o">&gt;=</span> <span class="n">rcrit</span>

    <span class="k">return</span> <span class="n">r</span><span class="p">,</span> <span class="n">signif</span><span class="p">,</span> <span class="n">pval</span>


<span class="k">def</span> <span class="nf">corr_isospec</span><span class="p">(</span><span class="n">y1</span><span class="p">,</span> <span class="n">y2</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">nsim</span><span class="o">=</span><span class="mi">1000</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; Phase randomization correltation estimates</span>

<span class="sd">    Estimates the significance of correlations between non IID</span>
<span class="sd">    time series by phase randomization of original inputs.</span>
<span class="sd">    This function creates &#39;nsim&#39; random time series that have the same power</span>
<span class="sd">    spectrum as the original time series but random phases.</span>

<span class="sd">    Args:</span>
<span class="sd">        y1, y2 (array): vectors of (real) numbers with identical length, no NaNs allowed</span>
<span class="sd">        alpha (real): significance level for critical value estimation [default: 0.05]</span>
<span class="sd">        nsim (int): number of simulations [default: 1000]</span>

<span class="sd">    Returns:</span>
<span class="sd">        r (real): correlation between y1 and y2 \n</span>
<span class="sd">        signif (boolean): true (1) if significant; false (0) otherwise \n</span>
<span class="sd">        F : Fraction of time series with higher correlation coefficents than observed (approximates the p-value).</span>

<span class="sd">    References:</span>
<span class="sd">        - Ebisuzaki, W, 1997: A method to estimate the statistical</span>
<span class="sd">        significance of a correlation when the data are serially correlated.</span>
<span class="sd">        J. of Climate, 10, 2147-2153.</span>
<span class="sd">        - Prichard, D., Theiler, J. Generating Surrogate Data for Time Series</span>
<span class="sd">        with Several Simultaneously Measured Variables (1994)</span>
<span class="sd">        Physical Review Letters, Vol 73, Number 7</span>
<span class="sd">        (Some Rights Reserved) USC Climate Dynamics Lab, 2012.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">pearsonr</span><span class="p">(</span><span class="n">y1</span><span class="p">,</span> <span class="n">y2</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

    <span class="c1"># generate phase-randomized samples using the Theiler &amp; Prichard method</span>
    <span class="n">Y1surr</span> <span class="o">=</span> <span class="n">phaseran</span><span class="p">(</span><span class="n">y1</span><span class="p">,</span> <span class="n">nsim</span><span class="p">)</span>
    <span class="n">Y2surr</span> <span class="o">=</span> <span class="n">phaseran</span><span class="p">(</span><span class="n">y2</span><span class="p">,</span> <span class="n">nsim</span><span class="p">)</span>

    <span class="c1"># compute correlations</span>
    <span class="n">Y1s</span> <span class="o">=</span> <span class="n">preprocessing</span><span class="o">.</span><span class="n">scale</span><span class="p">(</span><span class="n">Y1surr</span><span class="p">)</span>
    <span class="n">Y2s</span> <span class="o">=</span> <span class="n">preprocessing</span><span class="o">.</span><span class="n">scale</span><span class="p">(</span><span class="n">Y2surr</span><span class="p">)</span>

    <span class="n">n</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">y1</span><span class="p">)</span>
    <span class="n">C</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">Y1s</span><span class="p">),</span> <span class="n">Y2s</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">rSim</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">C</span><span class="p">)</span>

    <span class="c1"># compute fraction of values higher than observed</span>
    <span class="n">F</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">rSim</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">r</span><span class="p">))</span> <span class="o">/</span> <span class="n">nsim</span>

    <span class="c1"># establish significance</span>
    <span class="n">signif</span> <span class="o">=</span> <span class="n">F</span> <span class="o">&lt;</span> <span class="n">alpha</span>  <span class="c1"># significant or not?</span>

    <span class="k">return</span> <span class="n">r</span><span class="p">,</span> <span class="n">signif</span><span class="p">,</span> <span class="n">F</span>


<span class="k">def</span> <span class="nf">isopersistent_rn</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">p</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; Generates p realization of a red noise [i.e. AR(1)] process</span>
<span class="sd">    with same persistence properties as X (Mean and variance are also preserved).</span>

<span class="sd">    Args:</span>
<span class="sd">        X (array): vector of (real) numbers as a time series, no NaNs allowed</span>
<span class="sd">        p (int): number of simulations</span>

<span class="sd">    Returns:</span>
<span class="sd">        red (matrix) - n rows by p columns matrix of an AR1 process, where n is the size of X \n</span>
<span class="sd">        g (real) - lag-1 autocorrelation coefficient</span>

<span class="sd">    Remarks:</span>
<span class="sd">        (Some Rights Reserved) Hepta Technologies, 2008</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">n</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
    <span class="n">sig</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">ddof</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">g</span> <span class="o">=</span> <span class="n">ar1_fit</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
    <span class="n">red</span> <span class="o">=</span> <span class="n">ar1_sim</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">sig</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">red</span><span class="p">,</span> <span class="n">g</span>


<span class="k">def</span> <span class="nf">ar1_fit</span><span class="p">(</span><span class="n">ts</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; Return the lag-1 autocorrelation from ar1 fit.</span>

<span class="sd">    Args:</span>
<span class="sd">        ts (array): vector of (real) numbers as a time series</span>

<span class="sd">    Returns:</span>
<span class="sd">        g (real): lag-1 autocorrelation coefficient</span>
<span class="sd">    &#39;&#39;&#39;</span>


    <span class="n">ar1_mod</span> <span class="o">=</span> <span class="n">sm</span><span class="o">.</span><span class="n">tsa</span><span class="o">.</span><span class="n">AR</span><span class="p">(</span><span class="n">ts</span><span class="p">,</span> <span class="n">missing</span><span class="o">=</span><span class="s1">&#39;drop&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">maxlag</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">g</span> <span class="o">=</span> <span class="n">ar1_mod</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">g</span>


<span class="k">def</span> <span class="nf">ar1_sim</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">sig</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; Produce p realizations of an AR1 process of length n with lag-1 autocorrelation g</span>

<span class="sd">    Args:</span>
<span class="sd">        n, p (int): dimensions as n rows by p columns</span>
<span class="sd">        g (real): lag-1 autocorrelation coefficient</span>
<span class="sd">        sig (real): the standard deviation of the original time series</span>

<span class="sd">    Returns:</span>
<span class="sd">        red (matrix): n rows by p columns matrix of an AR1 process</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="c1"># specify model parameters (statsmodel wants lag0 coefficents as unity)</span>
    <span class="n">ar</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">r_</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="n">g</span><span class="p">]</span>  <span class="c1"># AR model parameter</span>
    <span class="n">ma</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">r_</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">]</span> <span class="c1"># MA model parameters</span>
    <span class="n">sig_n</span> <span class="o">=</span> <span class="n">sig</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">g</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="c1"># theoretical noise variance for red to achieve the same variance as X</span>

    <span class="n">red</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">p</span><span class="p">))</span> <span class="c1"># declare array</span>

    <span class="c1"># simulate AR(1) model for each column</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
        <span class="n">red</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">sm</span><span class="o">.</span><span class="n">tsa</span><span class="o">.</span><span class="n">arma_generate_sample</span><span class="p">(</span><span class="n">ar</span><span class="o">=</span><span class="n">ar</span><span class="p">,</span> <span class="n">ma</span><span class="o">=</span><span class="n">ma</span><span class="p">,</span> <span class="n">nsample</span><span class="o">=</span><span class="n">n</span><span class="p">,</span> <span class="n">burnin</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="n">sig_n</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">red</span>


<span class="k">def</span> <span class="nf">phaseran</span><span class="p">(</span><span class="n">recblk</span><span class="p">,</span> <span class="n">nsurr</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; Phaseran by Carlos Gias</span>

<span class="sd">    http://www.mathworks.nl/matlabcentral/fileexchange/32621-phase-randomization/content/phaseran.m</span>

<span class="sd">    Args:</span>
<span class="sd">        recblk (2D array): Row: time sample. Column: recording.</span>
<span class="sd">            An odd number of time samples (height) is expected.</span>
<span class="sd">            If that is not the case, recblock is reduced by 1 sample before the surrogate data is created.</span>
<span class="sd">            The class must be double and it must be nonsparse.</span>
<span class="sd">        nsurr (int): is the number of image block surrogates that you want to generate.</span>

<span class="sd">    Returns:</span>
<span class="sd">        surrblk: 3D multidimensional array image block with the surrogate datasets along the third dimension</span>

<span class="sd">    Reference:</span>
<span class="sd">        Prichard, D., Theiler, J. Generating Surrogate Data for Time Series with Several Simultaneously Measured Variables (1994)</span>
<span class="sd">        Physical Review Letters, Vol 73, Number 7</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="c1"># Get parameters</span>
    <span class="n">nfrms</span> <span class="o">=</span> <span class="n">recblk</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">nfrms</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">nfrms</span> <span class="o">=</span> <span class="n">nfrms</span><span class="o">-</span><span class="mi">1</span>
        <span class="n">recblk</span> <span class="o">=</span> <span class="n">recblk</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">nfrms</span><span class="p">]</span>

    <span class="n">len_ser</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">nfrms</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">interv1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">len_ser</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">interv2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">len_ser</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">nfrms</span><span class="p">)</span>

    <span class="c1"># Fourier transform of the original dataset</span>
    <span class="n">fft_recblk</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fft</span><span class="p">(</span><span class="n">recblk</span><span class="p">)</span>

    <span class="n">surrblk</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nfrms</span><span class="p">,</span> <span class="n">nsurr</span><span class="p">))</span>

    <span class="c1">#  for k in tqdm(np.arange(nsurr)):</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">nsurr</span><span class="p">):</span>
        <span class="n">ph_rnd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">len_ser</span><span class="p">)</span>

        <span class="c1"># Create the random phases for all the time series</span>
        <span class="n">ph_interv1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="mi">1</span><span class="n">j</span><span class="o">*</span><span class="n">ph_rnd</span><span class="p">)</span>
        <span class="n">ph_interv2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">conj</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">flipud</span><span class="p">(</span><span class="n">ph_interv1</span><span class="p">))</span>

        <span class="c1"># Randomize all the time series simultaneously</span>
        <span class="n">fft_recblk_surr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">fft_recblk</span><span class="p">)</span>
        <span class="n">fft_recblk_surr</span><span class="p">[</span><span class="n">interv1</span><span class="p">]</span> <span class="o">=</span> <span class="n">fft_recblk</span><span class="p">[</span><span class="n">interv1</span><span class="p">]</span> <span class="o">*</span> <span class="n">ph_interv1</span>
        <span class="n">fft_recblk_surr</span><span class="p">[</span><span class="n">interv2</span><span class="p">]</span> <span class="o">=</span> <span class="n">fft_recblk</span><span class="p">[</span><span class="n">interv2</span><span class="p">]</span> <span class="o">*</span> <span class="n">ph_interv2</span>

        <span class="c1"># Inverse transform</span>
        <span class="n">surrblk</span><span class="p">[:,</span> <span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">ifft</span><span class="p">(</span><span class="n">fft_recblk_surr</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">surrblk</span>

<span class="c1"># -----------------------------------------------</span>
<span class="c1">#  filters</span>
<span class="c1"># -----------------------------------------------</span>
<span class="k">def</span> <span class="nf">butter_lowpass</span><span class="p">(</span><span class="n">cutoff</span><span class="p">,</span> <span class="n">fs</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
    <span class="n">nyq</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">fs</span>
    <span class="n">normal_cutoff</span> <span class="o">=</span> <span class="n">cutoff</span> <span class="o">/</span> <span class="n">nyq</span>
    <span class="n">b</span><span class="p">,</span> <span class="n">a</span> <span class="o">=</span> <span class="n">signal</span><span class="o">.</span><span class="n">butter</span><span class="p">(</span><span class="n">order</span><span class="p">,</span> <span class="n">normal_cutoff</span><span class="p">,</span> <span class="n">btype</span><span class="o">=</span><span class="s1">&#39;low&#39;</span><span class="p">,</span> <span class="n">analog</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">b</span><span class="p">,</span> <span class="n">a</span>

<span class="k">def</span> <span class="nf">butter_lowpass_filter</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">cutoff</span><span class="p">,</span> <span class="n">fs</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
    <span class="n">b</span><span class="p">,</span> <span class="n">a</span> <span class="o">=</span> <span class="n">butter_lowpass</span><span class="p">(</span><span class="n">cutoff</span><span class="p">,</span> <span class="n">fs</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="n">order</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">signal</span><span class="o">.</span><span class="n">filtfilt</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">y</span>

<span class="k">def</span> <span class="nf">butter_bandpass</span><span class="p">(</span><span class="n">lowcut</span><span class="p">,</span> <span class="n">highcut</span><span class="p">,</span> <span class="n">fs</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
    <span class="n">nyq</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">fs</span>
    <span class="n">low</span> <span class="o">=</span> <span class="n">lowcut</span> <span class="o">/</span> <span class="n">nyq</span>
    <span class="n">high</span> <span class="o">=</span> <span class="n">highcut</span> <span class="o">/</span> <span class="n">nyq</span>
    <span class="n">sos</span> <span class="o">=</span> <span class="n">signal</span><span class="o">.</span><span class="n">butter</span><span class="p">(</span><span class="n">order</span><span class="p">,</span> <span class="p">[</span><span class="n">low</span><span class="p">,</span> <span class="n">high</span><span class="p">],</span> <span class="n">btype</span><span class="o">=</span><span class="s1">&#39;band&#39;</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="s1">&#39;sos&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">sos</span>

<span class="k">def</span> <span class="nf">butter_bandpass_filter</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">lowcut</span><span class="p">,</span> <span class="n">highcut</span><span class="p">,</span> <span class="n">fs</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
    <span class="n">sos</span> <span class="o">=</span> <span class="n">butter_bandpass</span><span class="p">(</span><span class="n">lowcut</span><span class="p">,</span> <span class="n">highcut</span><span class="p">,</span> <span class="n">fs</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="n">order</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">signal</span><span class="o">.</span><span class="n">sosfilt</span><span class="p">(</span><span class="n">sos</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">y</span>

<span class="c1"># -----------------------------------------------</span>
<span class="c1">#  linear regression analysis</span>
<span class="c1"># -----------------------------------------------</span>
<span class="k">def</span> <span class="nf">calc_autocorr</span><span class="p">(</span><span class="n">series</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; Return the autocorrelations from a pandas series</span>

<span class="sd">    Args:</span>
<span class="sd">        series (Series): the pandas series</span>
<span class="sd">    Returns:</span>
<span class="sd">        autocorr (array): the array of autocorrelations</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">series</span><span class="p">)</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">series</span><span class="p">)</span>
    <span class="n">mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="n">c0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">data</span> <span class="o">-</span> <span class="n">mean</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">r</span><span class="p">(</span><span class="n">h</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">((</span><span class="n">data</span><span class="p">[:</span> <span class="n">n</span> <span class="o">-</span> <span class="n">h</span><span class="p">]</span> <span class="o">-</span> <span class="n">mean</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">h</span><span class="p">:]</span> <span class="o">-</span> <span class="n">mean</span><span class="p">))</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">/</span> <span class="n">c0</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="n">autocorr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">r</span><span class="p">(</span><span class="n">loc</span><span class="p">)</span> <span class="k">for</span> <span class="n">loc</span> <span class="ow">in</span> <span class="n">x</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">autocorr</span>


<span class="k">def</span> <span class="nf">get_autocorrs_from_calib_data</span><span class="p">(</span><span class="n">calib_data</span><span class="p">):</span>
    <span class="n">autocorrs</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">calib_data</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
        <span class="n">ptype</span><span class="p">,</span> <span class="n">pid</span> <span class="o">=</span> <span class="n">k</span>
        <span class="n">resid</span> <span class="o">=</span> <span class="n">v</span><span class="p">[</span><span class="s1">&#39;PSMresid&#39;</span><span class="p">]</span>
        <span class="n">autocorr</span> <span class="o">=</span> <span class="n">calc_autocorr</span><span class="p">(</span><span class="n">resid</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ptype</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">autocorrs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">autocorrs</span><span class="p">[</span><span class="n">ptype</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">autocorr</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">autocorrs</span><span class="p">[</span><span class="n">ptype</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">autocorr</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">autocorrs</span>

<span class="c1"># -----------------------------------------------</span>
<span class="c1">#  spectral analysis</span>
<span class="c1"># -----------------------------------------------</span>
<span class="k">def</span> <span class="nf">calc_psd_from_proxyDB</span><span class="p">(</span><span class="n">proxy_manager</span><span class="p">,</span> <span class="n">ptype</span><span class="p">,</span> <span class="n">normalize</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">ntau</span><span class="o">=</span><span class="mi">11</span><span class="p">):</span>
    <span class="kn">import</span> <span class="nn">p2k</span>
    <span class="n">psd</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">freqs</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">for</span> <span class="n">pobj</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">proxy_manager</span><span class="o">.</span><span class="n">all_proxies</span><span class="p">,</span> <span class="n">total</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">proxy_manager</span><span class="o">.</span><span class="n">all_proxies</span><span class="p">)):</span>
        <span class="n">ptype</span> <span class="o">=</span> <span class="n">pobj</span><span class="o">.</span><span class="n">type</span>
        <span class="n">proxy_value</span> <span class="o">=</span> <span class="n">pobj</span><span class="o">.</span><span class="n">values</span>
        <span class="n">proxy_time</span> <span class="o">=</span> <span class="n">pobj</span><span class="o">.</span><span class="n">time</span>

        <span class="k">if</span> <span class="n">normalize</span><span class="p">:</span>
            <span class="n">proxy_value</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">proxy_value</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">ptype</span> <span class="o">==</span> <span class="n">ptype</span><span class="p">:</span>
            <span class="n">psd</span><span class="p">[</span><span class="n">pobj</span><span class="o">.</span><span class="n">id</span><span class="p">],</span> <span class="n">freqs</span><span class="p">[</span><span class="n">pobj</span><span class="o">.</span><span class="n">id</span><span class="p">]</span> <span class="o">=</span> <span class="n">p2k</span><span class="o">.</span><span class="n">calc_plot_psd</span><span class="p">(</span><span class="n">proxy_value</span><span class="p">,</span> <span class="n">proxy_time</span><span class="p">,</span> <span class="n">plot_fig</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">ntau</span><span class="o">=</span><span class="n">ntau</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">psd</span><span class="p">,</span> <span class="n">freqs</span>

</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2020, Feng Zhu

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>